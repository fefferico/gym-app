import{a as _}from"./chunk-HEVFYMGY.js";import{A as R,E as y,I as A,M as f,Ub as v,a as c,b as d,f as u,j as D,m as h,o as b,p as g,q as T,qc as O,rc as w,sc as I,yc as j}from"./chunk-ZPPFHB7I.js";function S(m,e){return j(m,e?.in).getDay()}var k=class m{storageService=f(w);workoutService=f(I);alertService=f(O);toastService=f(_);PROGRAMS_STORAGE_KEY="fitTrackPro_trainingPrograms";programsSubject=new D(this._loadProgramsFromStorage());programs$=this.programsSubject.asObservable();constructor(){}_loadProgramsFromStorage(){let e=this.storageService.getItem(this.PROGRAMS_STORAGE_KEY);return e||[]}_saveProgramsToStorage(e){this.storageService.setItem(this.PROGRAMS_STORAGE_KEY,e),this.programsSubject.next([...e])}getAllPrograms(){return this.programs$}getProgramById(e){return this.programs$.pipe(g(t=>t.find(r=>r.id===e)))}addProgram(e){return u(this,null,function*(){let t=this.programsSubject.getValue(),r=d(c({},e),{id:v(),isActive:!1,schedule:e.schedule.map(a=>d(c({},a),{id:v()}))}),o=[...t,r];return this._saveProgramsToStorage(o),this.toastService.success(`Program "${r.name}" created.`,3e3,"Program Created"),r})}updateProgram(e){return u(this,null,function*(){let t=this.programsSubject.getValue(),r=t.findIndex(o=>o.id===e.id);if(r>-1){let o=e.schedule.map(s=>d(c({},s),{id:s.id||v()})),a=d(c({},e),{schedule:o}),i=[...t];return i[r]=a,a.isActive&&(i=i.map(s=>s.id===a.id?s:d(c({},s),{isActive:!1}))),this._saveProgramsToStorage(i),this.toastService.success(`Program "${a.name}" updated.`,3e3,"Program Updated"),a}this.toastService.error(`Program with ID ${e.id} not found.`,0,"Update Error")})}deleteProgram(e){return u(this,null,function*(){let t=yield b(this.getProgramById(e).pipe(R(1)));if(!t){this.toastService.error("Program not found.",0,"Delete Error");return}let r=yield this.alertService.showConfirm("Delete Program",`Are you sure you want to delete the program "${t.name}"? This action cannot be undone.`,"Delete");if(r&&r.data){let a=this.programsSubject.getValue().filter(i=>i.id!==e);this._saveProgramsToStorage(a),this.toastService.info(`Program "${t.name}" deleted.`,3e3,"Program Deleted")}})}setActiveProgram(e){return u(this,null,function*(){let t=this.programsSubject.getValue(),r=t.find(a=>a.id===e);if(!r){this.toastService.error("Program not found to activate.",0,"Activation Error");return}let o=t.map(a=>d(c({},a),{isActive:a.id===e}));this._saveProgramsToStorage(o),this.toastService.success(`Program "${r.name}" is now active.`,3e3,"Program Activated")})}deactivateAllPrograms(){return u(this,null,function*(){let e=this.programsSubject.getValue();if(e.length>0){let t=e.map(r=>d(c({},r),{isActive:!1}));this._saveProgramsToStorage(t)}})}deactivateProgram(e){return u(this,null,function*(){let t=this.programsSubject.getValue(),r=t.find(a=>a.id===e);if(!r){this.toastService.error("Program not found to deactivate.",0,"Deactivation Error");return}if(!r.isActive){this.toastService.info(`Program "${r.name}" is already inactive.`,3e3,"Already Inactive");return}let o=t.map(a=>a.id===e?d(c({},a),{isActive:!1}):a);this._saveProgramsToStorage(o),this.toastService.success(`Program "${r.name}" has been deactivated.`,3e3,"Program Deactivated")})}getActiveProgram(){return this.programs$.pipe(g(e=>e.find(t=>t.isActive)))}getRoutineForDay(e){return this.getActiveProgram().pipe(y(t=>{if(!t)return h(null);let r;if(t.cycleLength&&t.cycleLength>0&&t.startDate){let a=new Date(t.startDate),i=Math.abs(e.getTime()-a.getTime()),l=Math.floor(i/(1e3*60*60*24))%t.cycleLength+1;r=n=>n.dayOfWeek===l}else{let a=S(e);r=i=>i.dayOfWeek===a}let o=t.schedule.find(r);return o?this.workoutService.getRoutineById(o.routineId).pipe(g(a=>a?{routine:a,scheduledDayInfo:o}:(console.warn(`Routine with ID ${o.routineId} not found for scheduled day.`),null))):h(null)}))}getScheduledRoutinesForDateRange(e,t){return this.getActiveProgram().pipe(y(r=>{if(!r||!r.schedule||r.schedule.length===0)return h([]);let o=[],a=new Date(e);for(;a<=t;){let i,s=new Date(a);if(r.cycleLength&&r.cycleLength>0&&r.startDate){let n=new Date(r.startDate),p=Math.abs(s.getTime()-n.getTime()),P=s>=n?Math.floor(p/(1e3*60*60*24)):-1;if(P>=0){let $=P%r.cycleLength+1;i=E=>E.dayOfWeek===$}else i=()=>!1}else{let n=S(s);i=p=>p.dayOfWeek===n}let l=r.schedule.find(i);l&&o.push(this.workoutService.getRoutineById(l.routineId).pipe(g(n=>n?{date:s,routine:n,scheduledDayInfo:l}:null))),a.setDate(a.getDate()+1)}return o.length===0?h([]):T(o).pipe(g(i=>i.filter(s=>s!==null)))}))}static \u0275fac=function(t){return new(t||m)};static \u0275prov=A({token:m,factory:m.\u0275fac,providedIn:"root"})};export{k as a};

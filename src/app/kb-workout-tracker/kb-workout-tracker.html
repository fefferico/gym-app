<div class="workout-tracker-container">
    <div class="video-area">
        <video #videoElement autoplay playsinline muted class="video-feed" [class.hidden]="!isCameraReady"></video>
        <!-- Canvas for drawing poses, MUST be on top of video -->
        <canvas #canvasElement class="pose-canvas"></canvas>

        <div *ngIf="!isCameraReady && !modelReady" class="video-placeholder">
            <p *ngIf="!videoStream">Requesting camera access...</p>
            <p *ngIf="videoStream && !isCameraReady">Loading video feed...</p>
            <p *ngIf="isCameraReady && !modelReady">Loading AI model, please wait...</p>
        </div>
        <div *ngIf="isCameraReady && !isWorkoutActive && (!videoStream?.active || !modelReady)"
            class="video-placeholder">
            <p *ngIf="!videoStream?.active">Camera access was lost or denied. Please reload or check permissions.</p>
            <p *ngIf="!modelReady && videoStream?.active">AI Model failed to load. Try reloading.</p>
            <button (click)="setupCamera()" *ngIf="!videoStream?.active">Retry Camera</button>
            <button (click)="loadPoseDetectionModel()" *ngIf="!modelReady && videoStream?.active">Retry AI
                Model</button>
        </div>
    </div>

    <div class="controls-status">
        <div class="exercise-selector">
            <label for="exercise">Choose Exercise: </label>
            <select id="exercise" [(ngModel)]="currentExercise" (ngModelChange)="setExerciseLogic($event)">
                <option value="Right Bicep Curl">Right Bicep Curl</option>
                <option value="Kettlebell Snatch">Kettlebell Snatch (Placeholder)</option>
                <!-- Add more exercises -->
            </select>
        </div>

        <h2>{{ currentExercise }} - {{ modelReady ? 'AI Ready' : 'AI Loading...' }}</h2>
        <div class="status-bar">
            <div class="reps">
                Reps: <span>{{ repCount }}</span>
            </div>
            <div class="timer">
                Time: <span>{{ formatTime(elapsedTime) }}</span>
            </div>
        </div>

        <div class="actions">
            <button *ngIf="!isWorkoutActive" (click)="startWorkout()" [disabled]="!isCameraReady || !modelReady"
                class="start-btn">
                Start Workout
            </button>
            <button *ngIf="isWorkoutActive" (click)="stopWorkout()" class="stop-btn">
                Stop Workout
            </button>
            <button *ngIf="isCameraReady && videoStream?.active" (click)="toggleRecording()" class="record-btn"
                [class.recording]="isRecording">
                {{ isRecording ? 'Stop Recording' : 'Start Recording' }}
            </button>
        </div>
    </div>

    <div class="feedback-area">
        <h3>Feedback & Log:</h3>
        <ul>
            <li *ngFor="let item of feedbackMessages" [ngClass]="'feedback-' + item.type">
                [{{item.type | uppercase}}] {{ item.message }}
            </li>
        </ul>
        <div *ngIf="feedbackMessages.length === 0" class="no-feedback">
            No feedback yet.
        </div>
    </div>
</div>
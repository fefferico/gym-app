<div *ngIf="isVisible()" @fade
  class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-black/70 backdrop-blur-2xl">

  <!-- Top Section: Session Timer & Mode Switcher -->
  <div class="w-full max-w-md mx-auto flex justify-between items-center mb-5 px-4">
    <!-- Session Timer -->
    <div
      class="flex items-center gap-x-2 font-mono bg-black/40 px-4 py-2 rounded-full text-lg text-gray-200 border border-white/10">
      <app-icon name="clock" class="h-6 w-6 opacity-80"></app-icon>
      <span>{{ mainTimer() }}</span>
    </div>
  </div>

  <!-- START: OPTIMIZED MIDDLE SECTION -->
  <!-- This container now defines the size, allowing the SVG to be an overlay -->
  <div class="relative w-64 h-64 md:w-72 md:h-72 flex items-center justify-center text-white">

    <!-- Circular Timer SVG (Absolutely positioned inside the container, only for 'timer' mode) -->
    <svg *ngIf="mode() === 'timer'" #progressCircleSvg class="absolute inset-0 transform -rotate-90" viewBox="0 0 200 200">
      <circle cx="100" cy="100" [attr.r]="getCircleRadius()" fill="transparent" stroke="rgba(255, 255, 255, 0.15)" stroke-width="18" />
      <circle cx="100" cy="100" [attr.r]="getCircleRadius()" fill="transparent" stroke="currentColor"
        class="text-yellow-400" stroke-width="12" [attr.stroke-dasharray]="getCircleCircumference()"
        [attr.stroke-dashoffset]="strokeDashoffset()" stroke-linecap="round" />
    </svg>

    <!-- Timer Text Content (Now a simple flex item, always perfectly centered) -->
    <div class="flex flex-col items-center justify-center text-center">
      <div class="text-6xl md:text-7xl font-bold font-mono tabular-nums tracking-tighter">
        {{ displayTime() }}<span class="text-4xl md:text-5xl opacity-60">{{ displayTentsTime() }}</span>
      </div>
      <div class="mt-1 text-lg md:text-xl font-semibold uppercase tracking-widest text-gray-300">
        {{ mode() === 'timer' ? mainText() : ('restTimer.elapsed' | translate) }}
                <p><app-icon name="rest" class="h-12 w-12 text-yellow-400"></app-icon></p>
      </div>
    </div>
  </div>
  <!-- END: OPTIMIZED MIDDLE SECTION -->

  <!-- Bottom Section: Controls and Next Up Card -->
  <div class="w-full max-w-md mx-auto flex flex-col items-center gap-6 p-1">
    <!-- Next Up Card (Explicitly hidden in stopwatch mode) -->
    <div *ngIf="mode() === 'timer' && nextUpText()"
      class="w-full p-2 bg-black/30 rounded-2xl border border-white/10 shadow-lg flex items-center space-x-4">
      <div class="bg-white/10 p-3 rounded-xl flex-shrink-0">
        <app-icon name="flame-2" class="h-12 w-12 text-yellow-400"></app-icon>
      </div>
      <div class="min-w-0 flex-1 overflow-y-auto max-h-40 pr-2 custom-scrollbar">
        <h3 class="font-semibold text-gray-300 uppercase tracking-wider text-sm">{{ 'restTimer.nextUp' | translate }}</h3>
        <div class="text-white text-lg font-medium text-wrap leading-tight" [innerHTML]="nextUpText()"></div>
      </div>
    </div>

    <!-- Timer Control Buttons -->
    <div class="flex items-center justify-center space-x-4">
      <!-- -15s Button (Unchanged, already correct) -->
      <button *ngIf="mode() === 'timer'" (click)="adjustTimer(-15)"
        class="h-16 w-16 flex items-center justify-center bg-white/10 hover:bg-white/20 text-white font-bold rounded-full transition-colors duration-150 text-xl disabled:opacity-50"
        [disabled]="remainingTime() <= 0">
        -15
      </button>

      <!-- Main Action Button (Unchanged, already correct) -->
      <button appPress (shortPress)="handleMainAction()"
        class="py-4 px-12 bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold rounded-full shadow-lg transition-transform duration-150 text-lg uppercase tracking-wider transform active:scale-95">
        {{ mode() === 'timer' ? ('restTimer.skip' | translate) : ('restTimer.stop' | translate) }}
      </button>

      <!-- +15s Button (Unchanged, already correct) -->
      <button *ngIf="mode() === 'timer'" (click)="adjustTimer(15)"
        class="h-16 w-16 flex items-center justify-center bg-white/10 hover:bg-white/20 text-white font-bold rounded-full transition-colors duration-150 text-xl">
        +15
      </button>
    </div>
  </div>
</div>
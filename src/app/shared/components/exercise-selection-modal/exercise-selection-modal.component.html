<div *ngIf="isOpen()" class="fixed inset-0 z-[70] flex flex-col bg-white dark:bg-gray-800 transition-opacity">

    <div (clickOutside)="onClose()"
        class="relative flex flex-col w-full h-full overflow-hidden text-left transition-all">

        <!-- Header -->
        <div class="px-5 py-2 flex-shrink-0 border-b border-gray-200 dark:border-gray-600">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">{{ title() }}</h3>
                <button type="button" (click)="onClose()"
                    class="p-1 rounded-full text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 focus:outline-none">
                    <app-icon name="cancel" class="w-6 h-6"></app-icon>
                </button>
            </div>
        </div>

        <!-- Filter and Sort Accordion Section -->
        <div class="px-4 pt-2 flex-shrink-0">
            <div class="flex justify-between items-center">
                <h4 class="font-semibold text-gray-700 dark:text-gray-200">{{ 'exerciseSelectionModal.filtersTitle' |
                    translate }}</h4>
                <!-- MODIFIED: This is now just one button -->
                <button (click)="toggleFilterAccordion()"
                    class="rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none transition-all duration-300 ease-in-out">
                    <app-icon name="filter" class="w-10 h-10 transition-transform duration-300"
                        [class.rotate-180]="isFilterAccordionOpen()"></app-icon>
                </button>
            </div>
        </div>
        <div class="overflow-hidden transition-all duration-300 ease-in-out px-4 flex-shrink-0"
            [style.maxHeight]="isFilterAccordionOpen() ? '600px' : '0px'">
            <div class="py-4 space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- Category -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{{
                            'exerciseSelectionModal.categoryLabel' | translate }}</label>
                        <select (change)="onCategoryChange($event)" [value]="selectedCategory() || ''"
                            class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-gray-200">
                            <option value="">{{ 'exerciseSelectionModal.allCategories' | translate }}</option>
                            <option *ngFor="let cat of categories$ | async" [value]="cat">{{ cat | titlecase }}</option>
                        </select>
                    </div>
                    <!-- Muscle Group -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{{
                            'exerciseSelectionModal.muscleGroupLabel' | translate }}</label>
                        <select (change)="onMuscleGroupChange($event)" [value]="selectedMuscleGroup() || ''"
                            class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-gray-200">
                            <option value="">{{ 'exerciseSelectionModal.allMuscles' | translate }}</option>
                            <option *ngFor="let muscle of primaryMuscleGroups$ | async" [value]="muscle">{{ muscle |
                                titlecase }}</option>
                        </select>
                    </div>
                </div>

                <!-- =================== START OF CORRECTION =================== -->
                <!-- Search Input and Similar Buttons Container -->
                <div class="text-center">
                    <!-- Main Search Bar (visible in default view) -->
                    <div *ngIf="!isShowingSimilarView()">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 text-left">{{
                            'exerciseSelectionModal.searchLabel' | translate }}</label>
                        <input #exerciseSearchFied type="text" [placeholder]="searchPlaceholder()"
                            [(ngModel)]="searchTerm" (keydown.enter)="onSearchEnter()"
                            class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-gray-200" />
                    </div>

                    <!-- "Show Similar" button (conditionally rendered) -->
                    <button *ngIf="showSimilarButton() && !isShowingSimilarView()" (click)="onFindSimilar()"
                        class="justify-center inline-flex items-center mt-2 px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
                        {{ 'exerciseSelectionModal.showSimilar' | translate }}
                    </button>

                    <!-- "Back to Search" button (visible in 'similar' view) -->
                    <button *ngIf="isShowingSimilarView()" (click)="onBackToSearch()"
                        class="justify-center inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md shadow-sm text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        <app-icon name="back" class="w-5 h-5 mr-2"></app-icon>
                        {{ 'exerciseSelectionModal.backToSearch' | translate }}
                    </button>
                </div>
                <!-- =================== END OF CORRECTION =================== -->

                <!-- Sort By -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{{
                        'exerciseSelectionModal.sortByLabel' | translate }}</label>
                    <select (change)="onSortModeChange($event)" [value]="sortMode()"
                        class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-gray-200">
                        <option value="alpha">{{ 'exerciseSelectionModal.sort.alpha' | translate }}</option>
                        <option value="lastUsed">{{ 'exerciseSelectionModal.sort.lastUsed' | translate }}</option>
                        <option value="frequency">{{ 'exerciseSelectionModal.sort.frequency' | translate }}</option>
                    </select>
                </div>
                <!-- Clear Button -->
                <div class="text-right">
                    <button (click)="clearFilters()" class="inline-flex text-sm text-blue-600 dark:text-blue-400 hover:bg-blue-500 dark:hover:text-white rounded-xl p-2">
                        <app-icon name="trash" class="h-6 w-6 mr-1"></app-icon>
                        {{
                        'exerciseSelectionModal.clearFilters' | translate }}</button>
                </div>
            </div>
        </div>
        <!-- +++ END: Filter Section +++ -->

        <!-- Scrollable Exercise List -->
        <div #scrollContainer class="flex-grow min-h-0 px-4 sm:px-6 py-2 overflow-y-auto custom-scrollbar">
            <ul class="space-y-1">
                <ng-container *ngFor="let item of processedExercises(); let odd = odd">
                    <!-- Case 1: Item is an Alphabetical Header -->
                    <div *ngIf="!isExercise(item)"
                        class="py-2 px-3 sticky top-0 bg-gray-200 dark:bg-gray-800 text-gray-600 dark:text-gray-200 font-bold text-lg z-10">
                        {{ item.label }}
                    </div>

                    <!-- Case 2: Item is an Exercise (Unchanged) -->
                    <li appBumpClick *ngIf="isExercise(item)" (click)="onExerciseClicked(item)"
                        class="p-3 mx-1 rounded-md cursor-pointer transition-colors duration-150 ease-in-out flex justify-between items-center"
                        [ngClass]="{
                            'selected-item': isSelected(item),
                            'bg-gray-200 dark:bg-gray-600': odd && !isSelected(item),
                            'bg-gray-100 dark:bg-gray-500': !odd && !isSelected(item)
                        }">
                        <div class="flex-grow">
                            <span class="font-medium text-gray-800 dark:text-gray-200">{{ item.name }}</span>
                            <span *ngIf="item.category" class="block text-xs text-gray-500 dark:text-gray-400">{{
                                item.category | titlecase }} {{ item.primaryMuscleGroup ? (' - ' +
                                item.primaryMuscleGroup | titlecase) : '' }}</span>
                            <span *ngIf="item.isCustom || item.lastUsedAt || item.usageCount != null"
                                class="block text-xs text-gray-500 dark:text-gray-400 italic">
                                [
                                <ng-container *ngIf="item.isCustom">{{ 'exerciseSelectionModal.custom' | translate
                                    }}</ng-container>

                                <!-- Separator 1 -->
                                <ng-container *ngIf="item.isCustom && (item.usageCount != null || item.lastUsedAt)"> |
                                </ng-container>

                                <ng-container *ngIf="item.usageCount != null">{{ 'exerciseSelectionModal.count' |
                                    translate:{count: item.usageCount} }}</ng-container>

                                <!-- Separator 2 -->
                                <ng-container *ngIf="item.usageCount != null && item.lastUsedAt"> | </ng-container>

                                <ng-container *ngIf="item.lastUsedAt">{{ 'exerciseSelectionModal.lastUsed' |
                                    translate:{date: (item.lastUsedAt | date:'dd-MM-yy':'UTC')} }}</ng-container>
                                ]
                            </span>
                        </div>
                        <ng-container *ngIf="isMultiSelect(); else singleSelectIcon">
                            <input type="checkbox" [checked]="isSelected(item)" (change)="toggleSelection(item)"
                                (click)="$event.stopPropagation()"
                                class="form-checkbox h-6 w-6 rounded-full flex-shrink-0 text-primary dark:text-primary-light bg-gray-200 dark:bg-gray-800 border-gray-400 dark:border-gray-500 focus:ring-primary-focus dark:focus:ring-primary-dark cursor-pointer">
                        </ng-container>

                        <ng-template #singleSelectIcon>
                            <app-icon [name]="itemIconName()"
                                [class]="'h-6 w-6 mr-1 flex-shrink-0 ' + itemIconClass()"></app-icon>
                        </ng-template>
                    </li>
                </ng-container>
                <li *ngIf="processedExercises().length === 0" class="text-gray-500 dark:text-gray-400 text-center p-4">
                    {{ (isShowingSimilarView() ? 'exerciseSelectionModal.noSimilar' :
                    'exerciseSelectionModal.noMatches') | translate }}
                </li>
            </ul>
        </div>


        <!-- Footer -->
        <div
            class="bg-gray-50 dark:bg-gray-800 px-4 py-2 sm:flex sm:flex-row-reverse sm:px-6 flex-shrink-0 justify-center gap-2">
            <!-- NEW: Primary Action for Multi-Select -->
            <button *ngIf="isMultiSelect() && processedExercises()?.length" type="button" (click)="confirmSelection()"
                [disabled]="selectionCount() === 0" class="inline-flex w-full justify-center items-center rounded-md px-4 py-2 text-xl font-semibold text-white shadow-sm sm:w-auto
                   bg-primary hover:bg-primary-dark focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-focus
                   disabled:opacity-50 disabled:cursor-not-allowed">
                <app-icon name="done" class="w-6 h-6 mr-2"></app-icon>
                {{ 'exerciseSelectionModal.addSelected' | translate }} {{ selectionCount() > 0 ? '(' + selectionCount()
                + ')' : '' }}
            </button>

            <div *ngIf="showCreateCustomLink() || (!processedExercises() || !processedExercises().length)" class="px-4 text-center flex-shrink-0">
                <!-- <p class="text-gray-500 dark:text-gray-400">Otherwise....</p> -->
                <button type="button" (click)="onCreateCustom()"
                    class="inline-flex w-full justify-center items-center rounded-md px-4 py-2 text-lg font-semibold text-white shadow-sm sm:w-auto bg-green-500 hover:bg-green-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-focus disabled:opacity-50 disabled:cursor-not-allowed">
                    {{ 'exerciseSelectionModal.createCustom' | translate }}
                </button>
            </div>

            <!-- Existing Cancel/Close Button -->
            <button type="button" (click)="onClose()"
                class="mt-3 sm:mt-0 inline-flex w-full justify-center items-center rounded-md bg-white dark:bg-gray-600 px-3 py-2 text-xl font-semibold text-gray-900 dark:text-gray-200 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-500 hover:bg-gray-50 dark:hover:bg-gray-500 sm:w-auto">
                <app-icon name="cancel" class="w-6 h-6 mr-1"></app-icon>
                {{ 'exerciseSelectionModal.cancel' | translate }}
            </button>
        </div>
    </div>
</div>
<div class="modal-overlay" (click)="onClose()">
    <div class="calculator-modal" (click)="$event.stopPropagation()">

        <div class="header">
            <div class="mode-toggle">
                <button [class.active]="mode() === 'calculate'" (click)="setMode('calculate')">Calculate</button>
                <button [class.active]="mode() === 'reverse'" (click)="setMode('reverse')">Reverse</button>
            </div>
            <button class="close-btn" (click)="onClose()">&times;</button>
        </div>

        <div class="modal-body custom-scrollbar">

            <div class="visualization-container">
                <div class="barbell">
                    <!-- Left Sleeve -->
                    <div class="sleeve left">
                        <!-- +++ FIX: The DOM order is now reversed for the left sleeve +++ -->
                        <!-- Plates come first in the markup -->
                        <ng-container *ngFor="let item of loadout()">
                            <div *ngFor="let i of [].constructor(item.count)"
                                class="{{ getPlateClass(item.plate.weight, item.plate.unit) }}"
                                [style.background-color]="item.plate.color"
                                [style.border-color]="item.plate.color === '#FAFAFA' ? '#ccc' : item.plate.color"
                                (click)="removePlate(item.plate)">
                                <span [style.color]="getPlateTextColor(item.plate.color)">{{ item.plate.weight }}</span>
                            </div>
                        </ng-container>
                        <!-- The collar is last, so flex-direction:row-reverse places it at the visual start (far left) -->
                        <div *ngIf="selectedCollar() && selectedCollar()!.weight > 0" class="collar"></div>
                    </div>

                    <div class="shaft"></div>

                    <!-- Right Sleeve (Order remains the same here) -->
                    <div class="sleeve right">
                        <ng-container *ngFor="let item of loadout()">
                            <div *ngFor="let i of [].constructor(item.count)"
                                class="{{ getPlateClass(item.plate.weight, item.plate.unit) }}"
                                [style.background-color]="item.plate.color"
                                [style.border-color]="item.plate.color === '#FAFAFA' ? '#ccc' : item.plate.color"
                                (click)="removePlate(item.plate)">
                                <span [style.color]="getPlateTextColor(item.plate.color)">{{ item.plate.weight }}</span>
                            </div>
                        </ng-container>
                        <div *ngIf="selectedCollar() && selectedCollar()!.weight > 0" class="collar"></div>
                    </div>
                </div>
            </div>

            <div class="total-weight-display">
                <h2>{{ totalWeight() | number:'1.0-2' }} {{ unit() }}</h2>
            </div>

            <div class="input-group calculate-mode-input" *ngIf="mode() === 'calculate'">

                <!-- +++ START: New Stepper Buttons and Wrapper +++ -->
                <div class="weight-control">
                    <!-- Decrease Button -->
                    <button type="button" class="stepper-btn" (mousedown)="startChangingWeight('decrease')"
                        (mouseup)="stopChangingWeight()" (mouseleave)="stopChangingWeight()"
                        (touchstart)="startChangingWeight('decrease'); $event.preventDefault()"
                        (touchend)="stopChangingWeight()" aria-label="Decrease weight">
                        <app-icon name="minus" class="h-5 w-5"></app-icon>
                    </button>

                    <input type="number" [ngModel]="targetWeight()"
                        (ngModelChange)="targetWeight.set($event); calculateFromTargetWeight()" class="weight-input"
                        [step]="weightStep()" [min]="minPossibleWeight()" />

                    <!-- Increase Button -->
                    <button type="button" class="stepper-btn" (mousedown)="startChangingWeight('increase')"
                        (mouseup)="stopChangingWeight()" (mouseleave)="stopChangingWeight()"
                        (touchstart)="startChangingWeight('increase'); $event.preventDefault()"
                        (touchend)="stopChangingWeight()" aria-label="Increase weight">
                        <app-icon name="plus" class="h-5 w-5"></app-icon>
                    </button>
                </div>
                <!-- +++ END: New Stepper Buttons and Wrapper +++ -->

                <div class="unit-toggle">
                    <button [class.active]="unit() === 'kg'" (click)="setUnit('kg')">KG</button>
                    <button [class.active]="unit() === 'lb'" (click)="setUnit('lb')">LB</button>
                </div>
            </div>

            <div class="reverse-mode-controls" *ngIf="mode() === 'reverse'">
                <p>TAP PLATES TO LOAD/UNLOAD BAR</p>
                <div class="plate-selection">
                    <div *ngFor="let plate of availablePlates()" class="plate-option" (click)="addPlate(plate)">
                        <div class="plate-visual" [style.background-color]="plate.color"
                            [style.border-color]="plate.color === '#FAFAFA' ? '#ccc' : plate.color">
                        </div>
                        <span>{{ plate.weight }}</span>

                        <!-- This badge now shows the count of plates currently ON THE BAR -->
                        <span *ngIf="plateCountMap().has(plate.weight)" class="plate-quantity">
                            {{ plateCountMap().get(plate.weight) }}x
                        </span>
                    </div>
                </div>
                <button class="clear-btn inline-flex items-center" (click)="clearLoadout()">
                    <app-icon name="cancel" class="h-4 w-4 mr-1"></app-icon>
                    CLEAR BAR</button>
            </div>

            <div class="config-settings">
                <!-- +++ START: New Toggles +++ -->
                <div class="toggle-group" *ngIf="isPremiumUser()">
                    <label for="personalGymToggle">Use Personal Gym</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="personalGymToggle" [checked]="usePersonalGym()"
                            (change)="togglePersonalGym($any($event.target).checked)">
                        <span class="slider round"></span>
                    </label>
                </div>
                <div *ngIf="unit() === 'kg'" class="toggle-group">
                    <label for="50kgToggle">Enable 50{{ unit() }} Plate</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="50kgToggle" [checked]="enable50kgPlate()"
                            (change)="toggle50kgPlate($any($event.target).checked)">
                        <span class="slider round"></span>
                    </label>
                </div>
                <!-- +++ END: New Toggles +++ -->

                <div class="form-group">
                    <label for="barbell">Barbell</label>
                    <select id="barbell" [ngModel]="selectedBarbell()" (ngModelChange)="handleBarChange($event)">
                        <!-- +++ Use the new barbells() signal +++ -->
                        <option *ngFor="let bar of barbells()" [ngValue]="bar">{{ bar.name }} ({{ bar.weight }}{{
                            bar.unit }})</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="collar">Collars</label>
                    <select id="collar" [ngModel]="selectedCollar()" (ngModelChange)="handleCollarChange($event)">
                        <!-- +++ Use the new collars() signal +++ -->
                        <option *ngFor="let collar of collars()" [ngValue]="collar">{{ collar.name }} ({{ collar.weight
                            }}{{ collar.unit }})</option>
                    </select>
                </div>
            </div>

            <div class="loadout-summary">
                <h4 *ngIf="platesWeightPerSide()>0">Plates Needed (Per Side)</h4>
                
                <!-- This is the new component in action -->
                <app-plate-summary [loadout]="loadout()"></app-plate-summary>

                <div *ngIf="loadout().length === 0" class="summary-item-empty">
                    Bar and collars only
                </div>

                <div class="math-breakdown" *ngIf="selectedBarbell() && selectedCollar()">
                    <p class="title">How the total is calculated:</p>
                    <p class="formula">
                        <span>{{ selectedBarbell()!.weight | number:'1.0-2' }} {{ unit() }}</span>
                        <span class="label"> (Bar)</span>
                        <span class="op"> + </span>
                        <span>{{ selectedCollar()!.weight | number:'1.0-2' }} {{ unit() }}</span>
                        <span class="label"> (Collars)</span>
                        <span class="op"> + </span>
                        <span>2 * {{ platesWeightPerSide() | number:'1.0-2' }} {{ unit() }}</span>
                        <span class="label"> (Plates)</span>
                    </p>
                </div>
            </div>

        </div>
    </div>
</div>
<div class="modal-overlay" (click)="onClose()">
  <div class="calculator-modal" (click)="$event.stopPropagation()">
    
    <div class="header">
      <div class="mode-toggle">
        <button [class.active]="mode() === 'calculate'" (click)="setMode('calculate')">Calculate</button>
        <button [class.active]="mode() === 'reverse'" (click)="setMode('reverse')">Reverse</button>
      </div>
      <button class="close-btn" (click)="onClose()">&times;</button>
    </div>

    <div class="modal-body">

      <div class="visualization-container">
        <div class="barbell">
          <!-- Left Sleeve -->
          <div class="sleeve left">
            <!-- +++ FIX: The DOM order is now reversed for the left sleeve +++ -->
            <!-- Plates come first in the markup -->
            <ng-container *ngFor="let item of loadout()">
              <div *ngFor="let i of [].constructor(item.count)" 
                   class="plate plate-{{ item.plate.weight | number:'1.0-0' }}" 
                   [style.background-color]="item.plate.color"
                   [style.border-color]="item.plate.color === '#FAFAFA' ? '#ccc' : item.plate.color"
                   (click)="removePlate(item.plate)">
                   <span>{{ item.plate.weight }}</span>
              </div>
            </ng-container>
            <!-- The collar is last, so flex-direction:row-reverse places it at the visual start (far left) -->
            <div *ngIf="selectedCollar() && selectedCollar()!.weight > 0" class="collar"></div>
          </div>

          <div class="shaft"></div>

          <!-- Right Sleeve (Order remains the same here) -->
          <div class="sleeve right">
            <ng-container *ngFor="let item of loadout()">
              <div *ngFor="let i of [].constructor(item.count)" 
                   class="plate plate-{{ item.plate.weight | number:'1.0-0' }}" 
                   [style.background-color]="item.plate.color"
                   [style.border-color]="item.plate.color === '#FAFAFA' ? '#ccc' : item.plate.color"
                   (click)="removePlate(item.plate)">
                   <span>{{ item.plate.weight }}</span>
              </div>
            </ng-container>
            <div *ngIf="selectedCollar() && selectedCollar()!.weight > 0" class="collar"></div>
          </div>
        </div>
      </div>

      <div class="total-weight-display">
        <h2>{{ totalWeight() | number:'1.0-2' }} {{ unit() }}</h2>
      </div>

      <div class="input-group calculate-mode-input" *ngIf="mode() === 'calculate'">
        <input type="number" 
               [ngModel]="targetWeight()" 
               (ngModelChange)="targetWeight.set($event); calculateFromTargetWeight()" 
               class="weight-input" />
        <div class="unit-toggle">
          <button [class.active]="unit() === 'kg'" (click)="setUnit('kg')">KG</button>
          <button [class.active]="unit() === 'lb'" (click)="setUnit('lb')">LB</button>
        </div>
      </div>

      <div class="reverse-mode-controls" *ngIf="mode() === 'reverse'">
        <p>TAP PLATES TO LOAD/UNLOAD BAR</p>
        <div class="plate-selection">
            <div *ngFor="let plate of availablePlates()" 
                 class="plate-option"
                 (click)="addPlate(plate)">
                 <div class="plate-visual" 
                      [style.background-color]="plate.color"
                      [style.border-color]="plate.color === '#FAFAFA' ? '#ccc' : plate.color">
                 </div>
                 <span>{{ plate.weight }}</span>
            </div>
        </div>
        <button class="clear-btn" (click)="clearLoadout()">Clear Bar</button>
      </div>

      <div class="config-settings">
        <div class="form-group">
          <label for="barbell">Barbell</label>
          <select id="barbell" 
                  [ngModel]="selectedBarbell()" 
                  (ngModelChange)="handleBarChange($event)">
            <option *ngFor="let bar of barbells" [ngValue]="bar">{{ bar.name }} ({{ bar.weight }}{{ bar.unit }})</option>
          </select>
        </div>
        <div class="form-group">
          <label for="collar">Collars</label>
          <select id="collar" 
                  [ngModel]="selectedCollar()" 
                  (ngModelChange)="handleCollarChange($event)">
            <option *ngFor="let collar of collars" [ngValue]="collar">{{ collar.name }} ({{ collar.weight }}{{ collar.unit }})</option>
          </select>
        </div>
      </div>

      <div class="loadout-summary">
        <h4>Plates Needed (Per Side)</h4>
        <div class="summary-list">
          <div *ngFor="let item of loadout()" class="summary-item">
            <div class="plate-count">{{ item.count }}x</div>
            <div class="plate-weight">{{ item.plate.weight }} {{ item.plate.unit }}</div>
          </div>
          <div *ngIf="loadout().length === 0" class="summary-item-empty">
            Bar and collars only
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
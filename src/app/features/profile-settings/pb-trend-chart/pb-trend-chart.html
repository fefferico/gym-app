<!-- src/app/features/profile-settings/pb-trend-chart/pb-trend-chart.component.html -->
<div class="container mx-auto p-4" (window:resize)="onResize($event)">
  <div class="mb-6 flex items-center">
    <button (click)="goBack()"
      class="text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light p-2 -ml-2 rounded-full focus:outline-none focus:ring-2 focus:ring-primary-focus">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
    </button>
    <h1 class="text-xl sm:text-2xl font-bold text-gray-800 dark:text-gray-200 ml-2">
      {{ 'pbTrend.title' | translate:{exercise: currentExerciseName(), pbType: (currentPbType || ('pbTrend.defaultTitle' | translate))} }}
    </h1>
  </div>

  <div *ngIf="isLoading()" class="text-center py-10">
    <p class="text-lg text-gray-600 dark:text-gray-400">{{ 'pbTrend.loading' | translate }}</p>
    <div class="mt-4 animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"></div>
  </div>

  <div *ngIf="errorMessage()" class="text-center py-10 bg-red-50 dark:bg-red-900/30 p-4 rounded-md shadow">
    <p class="text-lg font-semibold text-red-700 dark:text-red-300">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
        class="w-6 h-6 inline-block mr-2 align-middle">
        <path stroke-linecap="round" stroke-linejoin="round"
          d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
      </svg>
      {{ errorMessage() }}
    </p>
    <button (click)="goBack()"
      class="mt-4 px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark transition-colors">
      {{ 'pbTrend.backButton' | translate }}
    </button>
  </div>

  <div *ngIf="!isLoading() && !errorMessage() && chartData()"
    class="bg-white dark:bg-gray-800 p-2 sm:p-4 rounded-md shadow-xl">
    <ngx-charts-line-chart [view]="view" [scheme]="chartColorScheme" [results]="chartData()!" [legend]="legend"
      [xAxis]="xAxis" [yAxis]="yAxis" [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel"
      [xAxisLabel]="'pbTrend.chart.xAxisLabel' | translate" [yAxisLabel]="yAxisLabel()" [timeline]="timeline" [autoScale]="autoScale"
      [roundDomains]="roundDomains" [xAxisTickFormatting]="xAxisTickFormatting" [curve]="lineChartCurve"
      [referenceLines]="lineChartReferenceLines()" (select)="onChartSelect($event)" class="pb-chart-container">

      <ng-template ngx-charts-tooltip-template let-model="model">
        <div class="chart-tooltip bg-gray-700 text-white p-2 rounded shadow-lg text-xs">
          <div><strong>{{ model.name | date:'mediumDate' }}</strong></div>
          <div>{{ 'pbTrend.chart.tooltip.value' | translate:{value: model.value, unit: yAxisLabel().split(' ')[0]} }}</div>
          <div *ngIf="model.extra?.reps">{{ 'pbTrend.chart.tooltip.reps' | translate:{reps: model.extra.reps} }}</div>
          <div *ngIf="model.extra?.notes" class="max-w-xs truncate">{{ 'pbTrend.chart.tooltip.notes' | translate:{notes: model.extra.notes} }}</div>
          <div *ngIf="model.extra?.workoutLogId" class="mt-1 text-indigo-300">{{ 'pbTrend.chart.tooltip.viewLog' | translate }}</div>
        </div>
      </ng-template>

    </ngx-charts-line-chart>

    <div *ngIf="historyTableData().length > 0" class="mt-8">
      <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-4 border-t pt-4 dark:border-gray-700">
        {{ 'pbTrend.history.title' | translate }}
      </h2>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
          <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <th scope="col"
                class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider rounded-tl-md">
                {{ 'pbTrend.history.dateHeader' | translate }}
              </th>
              <th scope="col"
                class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                {{ yAxisLabel() }}
              </th>
              <th scope="col" *ngIf="currentPbType?.includes('RM') || currentPbType?.includes('Heaviest Lifted')"
                class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                {{ 'pbTrend.history.repsHeader' | translate }}
              </th>
              <th scope="col" class="relative px-4 py-3 border-l-0 rounded-tr-md">
                <span class="sr-only">{{ 'pbTrend.history.logHeader' | translate }}</span>
              </th>
            </tr>
          </thead>
          <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
            <tr *ngFor="let record of historyTableData()" class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
              <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-200">
                {{ record.name | date:'mediumDate' }}
              </td>
              <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
                {{ record.value }}
              </td>
              <td *ngIf="currentPbType?.includes('RM') || currentPbType?.includes('Heaviest Lifted')"
                class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
                {{ record.extra?.reps }}
              </td>
              <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                <a *ngIf="record.extra?.workoutLogId" [routerLink]="['/history/log', record.extra?.workoutLogId]"
                  class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-focus dark:focus:ring-offset-gray-800">
                  <app-icon name="eye" class="h-5 w-5 mr-1"></app-icon>
                  {{ 'pbTrend.history.viewLog' | translate }}
                </a>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ========================================================== -->
<!-- START: NEW STYLES SECTION                                  -->
<!-- ========================================================== -->
<style>
  :host ::ng-deep .pb-chart-container .line-series .circle {
    fill: #ffffff;
    /* White fill for the dot */
    stroke: #10B981;
    /* Primary color from the scheme */
    stroke-width: 2px;
    r: 4px !important;
    /* Make the radius larger */
  }

  :host ::ng-deep .pb-chart-container .x.axis .tick text {
    transform: rotate(-45deg) translate(-10px, -5px);
    text-anchor: end !important;
  }

  /* Ensure chart text color respects the component variable */
  :host ::ng-deep .pb-chart-container .ngx-charts-outer,
  :host ::ng-deep .pb-chart-container .axis-label,
  :host ::ng-deep .pb-chart-container .tick text {
    fill: var(--ngx-charts-text-color, #374151);
  }
</style>
<!-- ========================================================== -->
<!-- END: NEW STYLES SECTION                                    -->
<!-- ========================================================== -->
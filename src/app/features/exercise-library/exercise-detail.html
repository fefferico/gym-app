<ng-container *ngIf="exercise() as ex; else loadingOrNotFound"
  class="{{ isModal ? 'fixed inset-0 z-[70] flex flex-col bg-white dark:bg-gray-800 transition-opacity' : '' }}">
  <header class="flex items-center justify-between p-2">
    <div *ngIf="!isModal" class="flex justify-between items-center">
      <button [routerLink]="'/library'"
        class="text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light p-2 -ml-1">
        <app-icon name="back" class="h-7 w-7"></app-icon>
      </button>
      <div class="w-10 h-10"></div> <!-- Spacer -->
    </div>
    <!-- Action Buttons Group -->
    <div class="flex items-center space-x-2 flex-shrink-0">
      <!-- Wrapper for "More Actions" button and its dropdown -->
      <div *ngIf="exercise() as exercise" class="">
        <div *ngIf="!isModal" class="relative">
          <button (click)="toggleActions(exercise.id, $event)"
            class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-500 rounded-full focus:outline-none flex items-center">
            <app-icon name="menu-action" class="h-10 w-10"></app-icon>
          </button>
          <app-action-menu *ngIf="areActionsVisible(exercise.id)" displayMode="dropdown"
            [items]="getExerciseDropdownActionItems(exercise.id, 'dropdown')"
            [isVisible]="areActionsVisible(exercise.id)" (itemClick)="handleActionMenuItemClick($event)"
            (closeMenu)="onCloseActionMenu()">
          </app-action-menu>
        </div>
      </div>
    </div>

  </header>


  <!-- 
    =================== START: NEW TAB NAVIGATION ===================
  -->
  <div class="border-b border-gray-200 dark:border-gray-700 px-3 mb-2">
    <nav class="-mb-px flex space-x-4 sm:space-x-6" aria-label="Tabs">
      <button (click)="selectTab('description')" [ngClass]="{
          'border-primary dark:border-primary-light text-primary dark:text-primary-light': activeTab() === 'description',
          'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:border-gray-300 dark:hover:border-gray-500': activeTab() !== 'description'
        }" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">
        {{ 'exerciseDetail.tabs.description' | translate | uppercase }}
      </button>
      <button (click)="selectTab('history')" [ngClass]="{
          'border-primary dark:border-primary-light text-primary dark:text-primary-light': activeTab() === 'history',
          'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:border-gray-300 dark:hover:border-gray-500': activeTab() !== 'history'
        }" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">
        {{ 'exerciseDetail.tabs.history' | translate | uppercase }}
      </button>
      <button (click)="selectTab('graphs')" [ngClass]="{
          'border-primary dark:border-primary-light text-primary dark:text-primary-light': activeTab() === 'graphs',
          'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:border-gray-300 dark:hover:border-gray-500': activeTab() !== 'graphs'
        }" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">
        {{ 'exerciseDetail.tabs.graphs' | translate | uppercase }}
      </button>
      <button (click)="selectTab('records')" [ngClass]="{
          'border-primary dark:border-primary-light text-primary dark:text-primary-light': activeTab() === 'records',
          'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:border-gray-300 dark:hover:border-gray-500': activeTab() !== 'records'
        }" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">
        {{ 'exerciseDetail.tabs.records' | translate | uppercase }}
      </button>
    </nav>
  </div>
  <!-- =================== END: NEW TAB NAVIGATION =================== -->


  <div class="rounded-md shadow-xl overflow-hidden mx-1">

    <!-- Tab Content Area -->
    <div (swipeleft)="onSwipe('left')" (swiperight)="onSwipe('right')">
      <div [ngSwitch]="activeTab()" [@tabSlide]="activeTabIndex()" [style.height]="contentHeight" class="relative">

        <!-- =================== DESCRIPTION TAB =================== -->
        <div *ngSwitchCase="'description'" class="tab-content bg-white dark:bg-gray-800 p-2"
          [class.tab-content-active]="activeTab() === 'description'">
          <div class="p-4">
            <!-- DESCRIPTION TAB -->
            <!-- Image Carousel -->
            <div *ngIf="false" class="relative">
              <!-- <div *ngIf="ex.imageUrls && ex.imageUrls.length > 0" class="relative"> -->
              <img [src]="ex.imageUrls[currentImageIndex()]" [alt]="ex.name + ' form ' + (currentImageIndex() + 1)"
                class="w-full h-64 sm:h-80 md:h-96 object-contain bg-gray-200 dark:bg-gray-700">
              <button *ngIf="ex.imageUrls.length > 1" (click)="prevImage()"
                class="absolute top-1/2 left-2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 focus:outline-none">
                ❮ <!-- Left arrow -->
              </button>
              <button *ngIf="ex.imageUrls.length > 1" (click)="nextImage()"
                class="absolute top-1/2 right-2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 focus:outline-none">
                ❯ <!-- Right arrow -->
              </button>
              <!-- Image dots/indicators -->
              <div *ngIf="ex.imageUrls.length > 1"
                class="absolute bottom-2 left-1/2 transform -translate-x-1/2 flex space-x-2">
                <span *ngFor="let img of ex.imageUrls; let i = index" (click)="currentImageIndex.set(i)"
                  class="w-3 h-3 rounded-full cursor-pointer"
                  [ngClass]="{'bg-white dark:bg-gray-300': currentImageIndex() === i, 'bg-gray-400 dark:bg-gray-700': currentImageIndex() !== i}">
                </span>
              </div>
            </div>

            <div class="p-3">
              <div *ngIf="!isModal" class="flex justify-between pb-1 sm:flex-row">
                <h1 class="flex text-3xl md:text-4xl font-bold mb-3 text-gray-800 dark:text-gray-100">{{ ex.name }}
                </h1>
              </div>

              <div class="mb-4">
                <span
                  class="px-3 py-1 text-xs font-semibold rounded-full bg-primary-light text-white dark:bg-primary-dark dark:text-primary-light capitalize">
                  {{ ex.category }}
                </span>
              </div>

              <div class="mb-6">
                <h2 class="text-xl font-semibold mb-2 text-gray-700 dark:text-gray-300">{{
                  'exerciseDetail.tabs.description' | translate }}</h2>
                <p class="text-gray-600 dark:text-gray-400 leading-relaxed">{{ ex.description }}</p>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                  <h3 class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-300">{{
                    'exerciseDetail.tabs.primaryMuscleGroup' | translate }}</h3>
                  <p class="text-gray-600 dark:text-gray-400">{{ ex.primaryMuscleGroup?.name ?? '' | translate }}</p>
                </div>
                <div>
                  <h3 class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-300">{{
                    'exerciseDetail.tabs.otherMuscleGroup' | translate }}</h3>
                  <ul class="list-disc list-inside text-gray-600 dark:text-gray-400">
                    <li *ngFor="let group of ex.muscleGroups">{{ group.name | translate }}</li>
                  </ul>
                </div>
              </div>

              <div *ngIf="ex.equipmentNeeded && ex.equipmentNeeded.length > 0" class="mb-6">
                <h3 class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-300">{{
                  'exerciseDetail.tabs.equipment' | translate }}</h3>
                <ul class="list-disc list-inside text-gray-600 dark:text-gray-400">
                  <li *ngFor="let item of ex.equipmentNeeded"> {{ item.name | translate }}
                  </li>
                </ul>
              </div>

              <div *ngIf="ex.notes" class="mb-6">
                <h3 class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-300">{{ 'exerciseDetail.tabs.notes' |
                  translate }}</h3>
                <p class="text-gray-600 dark:text-gray-400 whitespace-pre-line">{{ ex.notes }}</p>
              </div>

              <div *ngIf="ex.videoUrl" class="mb-6">
                <a [href]="ex.videoUrl" target="_blank" rel="noopener noreferrer"
                  class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                  <app-icon name="video" class="h-6 w-6 mr-1"></app-icon>
                  {{ 'exerciseDetail.actions.watchVideo' | translate}}
                </a>
              </div>

              <!-- PBs -->

              <div *ngIf="exercisePBs().length > 0" class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-semibold mb-3 text-gray-700 dark:text-gray-300">{{
                  'exerciseDetail.records.title' | translate }}</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-2">
                  <div *ngFor="let pb of exercisePBs()"
                    class="p-4 bg-gray-50 dark:bg-gray-700 rounded-md border dark:border-gray-600 shadow-sm">
                    <p class="text-sm font-medium text-primary dark:text-primary-light">{{ pb.pbType }}</p>
                    <p class="text-2xl font-bold text-gray-800 dark:text-gray-100 mt-1">{{ formatPbValue(pb) }}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                      {{ 'exerciseDetail.records.achievedOn' | translate }}: {{ pb.timestamp | date:'mediumDate' }}
                    </p>
                    <p *ngIf="pb.notes" class="mt-2 text-xs italic text-gray-500 dark:text-gray-400 line-clamp-2"
                      [title]="pb.notes">
                      {{ 'exerciseDetail.records.notes' | translate }}: {{ pb.notes }}
                    </p>
                  </div>
                </div>
              </div>

              <ng-container *ngIf="trackingService.workoutLogs$ | async as workoutLogs">
                <div *ngIf="exercise() && exercisePBs().length === 0 && workoutLogs.length > 0"
                  class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                  <p class="text-md text-gray-600 dark:text-gray-400 italic">{{ 'compactPlayer.insights.noPBs' |
                    translate
                    }}
                  </p>
                </div>
              </ng-container>

              <div *ngIf="exercise() && hasSufficientProgressData"
                class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300">Progress: {{
                  progressChartYAxisLabel //
                  }} Over Time</h3>
                <div class="bg-white dark:bg-gray-700 p-1 rounded-md shadow-md min-h-[350px] overflow-auto">
                  <ngx-charts-line-chart [view]="progressChartView" [scheme]="progressChartColorScheme"
                    [results]="exerciseProgressChartData()" [legend]="false" [xAxis]="progressChartShowXAxis"
                    [yAxis]="progressChartShowYAxis" [xAxisLabel]="progressChartXAxisLabel"
                    [yAxisLabel]="progressChartYAxisLabel" [timeline]="progressChartTimeline"
                    [showXAxisLabel]="progressChartShowXAxisLabel" [showYAxisLabel]="progressChartShowYAxisLabel"
                    [autoScale]="progressChartAutoScale" (select)="onProgressChartSelect($event)">
                    <!-- Optional: Custom tooltips -->
                    <ng-template #tooltipTemplate let-model="model">
                      <div class="p-2 bg-gray-700 text-white rounded shadow-lg text-xs">
                        <div><strong>{{ model.name | date:'mediumDate' }}</strong></div>
                        <div>{{ model.series }}: {{ model.value | number:'1.0-2' }}
                          {{this.unitService.getWeightUnitSuffix()}}
                        </div>
                        <div *ngIf="model.extra && model.extra.reps">Reps: {{ model.extra.reps }}</div>
                      </div>
                    </ng-template>
                    <ng-template #seriesTooltipTemplate let-model="model">
                      <!-- For multi-series if legend is on; less relevant for single series weight chart -->
                    </ng-template>
                  </ngx-charts-line-chart>
                </div>
              </div>
              <ng-container *ngIf="exercise() && (trackingService.workoutLogs$ | async) as allLogsGlobally">
                <div *ngIf="allLogsGlobally && allLogsGlobally.length > 0 && !hasSufficientProgressData"
                  class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                  <p class="text-md text-gray-600 dark:text-gray-400 italic"
                    [innerHTML]="updateSanitizedDescription('exerciseDetail.exercise.noHistory' | translate:{ name: exercise()?.name })">
                  </p>
                </div>
              </ng-container>
            </div>
          </div>
        </div>

        <!-- =================== HISTORY TAB =================== -->
        <div *ngSwitchCase="'history'" class="tab-content bg-white dark:bg-gray-800 p-2"
          [class.tab-content-active]="activeTab() === 'history'">
          <div class="p-4 space-y-4">
            <div *ngIf="exerciseHistory().length > 0; else noHistory">
              <div *ngFor="let log of exerciseHistory()"
                class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg border dark:border-gray-600 mb-2">
                <div class="flex justify-between items-baseline mb-2">
                  <h3 class="font-semibold text-gray-800 dark:text-gray-100">{{ log.routineName || 'Ad-hoc Workout' }}
                  </h3>
                  <p class="text-xs text-gray-500 dark:text-gray-400">{{ log.startTime | date:'medium' }}</p>
                </div>
                <ul class="space-y-1 text-sm text-gray-600 dark:text-gray-300">
                  <!-- --- START: USE THE NEW HELPER FUNCTION --- -->
                  <li *ngFor="let set of getSetsForExerciseInLog(log); let i = index" class="flex justify-between">
                    <span>Set {{i + 1}}: <strong class="text-gray-800 dark:text-white">{{ formatSetDisplay(set)
                        }}</strong></span>
                    <!-- Hide 1RM for cardio sets -->
                    <span *ngIf="ex.category !== 'cardio' && set.weightLogged && set.repsLogged"
                      class="font-mono text-xs text-gray-500">
                      1RM: {{ (getWeightValue(set.weightLogged) ?? 0) * (36 / (37 - repsTargetRepsToReps(set.repsLogged))) | number:'1.0-1' }}
                    </span>
                  </li>
                  <!-- --- END: USE THE NEW HELPER FUNCTION --- -->
                </ul>
              </div>
            </div>
          </div>
          <ng-template #noHistory>
            <p class="text-center text-gray-500 dark:text-gray-400 py-8">{{ 'exerciseDetail.historyDisplay.noHistory' |
              translate }}</p>
          </ng-template>
        </div>

        <!-- =================== GRAPHS TAB =================== -->
        <div *ngSwitchCase="'graphs'" class="tab-content bg-white dark:bg-gray-800 p-2"
          [class.tab-content-active]="activeTab() === 'graphs'">
          <div class="">
            <!-- --- START: CONDITIONAL CHARTS FOR STRENGTH --- -->

            <!-- <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-4 px-4">{{ 'exerciseDetail.tabs.graphs' | translate }}</h2> -->

            <ng-container *ngIf="ex.category !== 'cardio'">
              <div>
                <h3 class="font-semibold text-gray-800 dark:text-gray-100 mb-2">{{ 'exerciseDetail.charts.est1rmSeries'
                  | translate }}</h3>
                <div *ngIf="est1rmChartData().length > 0; else noChartData"
                  class="bg-white dark:bg-gray-700 p-1 rounded-md shadow-md h-64">
                  <ngx-charts-line-chart [results]="est1rmChartData()" [scheme]="progressChartColorScheme"
                    [xAxis]="true" [yAxis]="true" [timeline]="true" [autoScale]="true"></ngx-charts-line-chart>
                </div>
              </div>
              <div>
                <h3 class="font-semibold text-gray-800 dark:text-gray-100 mb-2">{{
                  'exerciseDetail.charts.maxWeightSeries' | translate }}</h3>
                <div *ngIf="maxWeightChartData().length > 0; else noChartData"
                  class="bg-white dark:bg-gray-700 p-1 rounded-md shadow-md h-64">
                  <ngx-charts-line-chart [results]="maxWeightChartData()" [scheme]="progressChartColorScheme"
                    [xAxis]="true" [yAxis]="true" [timeline]="true" [autoScale]="true"></ngx-charts-line-chart>
                </div>
              </div>
              <div>
                <h3 class="font-semibold text-gray-800 dark:text-gray-100 mb-2">{{
                  'exerciseDetail.charts.totalVolumeSeries' | translate }}</h3>
                <div *ngIf="totalVolumeChartData().length > 0; else noChartData"
                  class="bg-white dark:bg-gray-700 p-1 rounded-md shadow-md h-64">
                  <ngx-charts-line-chart [results]="totalVolumeChartData()" [scheme]="progressChartColorScheme"
                    [xAxis]="true" [yAxis]="true" [timeline]="true" [autoScale]="true"></ngx-charts-line-chart>
                </div>
              </div>
            </ng-container>
            <!-- --- END: CONDITIONAL CHARTS FOR STRENGTH --- -->
          </div>
          <!-- --- START: CONDITIONAL CHARTS FOR CARDIO --- -->
          <ng-container *ngIf="ex.category === 'cardio'">
            <div>
              <h3 class="font-semibold text-gray-800 dark:text-gray-100 mb-2">{{
                'exerciseDetail.charts.maxDistanceTitle' | translate: { unit: unitService.getDistanceMeasureUnitSuffix()
                } }}</h3>

              <div *ngIf="maxDistanceChartData().length > 0; else noChartData"
                class="bg-white dark:bg-gray-700 p-1 rounded-md shadow-md h-64">
                <ngx-charts-line-chart [results]="maxDistanceChartData()" [scheme]="progressChartColorScheme"
                  [xAxis]="true" [yAxis]="true" [timeline]="true" [autoScale]="true"></ngx-charts-line-chart>
              </div>
            </div>
            <div>
              <h3 class="font-semibold text-gray-800 dark:text-gray-100 mb-2">{{
                'exerciseDetail.charts.maxDurationTitle' | translate }}</h3>
              <div *ngIf="maxDurationChartData().length > 0; else noChartData"
                class="bg-white dark:bg-gray-700 p-1 rounded-md shadow-md h-64">
                <ngx-charts-line-chart [results]="maxDurationChartData()" [scheme]="progressChartColorScheme"
                  [xAxis]="true" [yAxis]="true" [timeline]="true" [autoScale]="true"></ngx-charts-line-chart>
              </div>
            </div>
          </ng-container>
          <!-- --- END: CONDITIONAL CHARTS FOR CARDIO --- -->

          <ng-template #noChartData>
            <p class="text-center text-gray-500 dark:text-gray-400 py-8 text-sm">{{ 'exerciseDetail.charts.noData' |
              translate }}</p>

          </ng-template>
        </div>

        <!-- =================== RECORDS TAB =================== -->
        <div *ngSwitchCase="'records'" class="tab-content bg-white dark:bg-gray-800 p-2"
          [class.tab-content-active]="activeTab() === 'records'">
          <div class="p-4">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">{{ 'exerciseDetail.records.title' |
              translate | uppercase }}</h3>
            <div *ngIf="personalRecords().length > 0; else noRecords" class="grid grid-cols-3 gap-4 mb-8">
              <div *ngFor="let record of personalRecords()"
                class="text-center bg-gray-100 dark:bg-gray-700 p-3 rounded-lg">
                <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ record.value }}<span
                    class="text-base font-medium ml-1">{{ record.unit }}</span></p>
                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">{{ record.label }}</p>
              </div>
            </div>
            <ng-template #noRecords>
              <p class="text-center text-gray-500 dark:text-gray-400 mb-8">{{ 'exerciseDetail.records.noRecords' |
                translate }}</p>

            </ng-template>

            <!-- --- START: CONDITIONALLY HIDE REP RECORDS TABLE --- -->
            <ng-container *ngIf="personalRecords().length > 0 && ex.category !== 'cardio'; else cardioRepRecords">
              <div class="overflow-x-auto">
                <table class="min-w-full text-sm text-left text-gray-500 dark:text-gray-400">
                  <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                    <tr>
                      <th scope="col" class="py-3 px-4">{{ 'exerciseDetail.repRecords.repsHeader' | translate }}</th>
                      <th scope="col" class="py-3 px-4">{{ 'exerciseDetail.repRecords.bestHeader' | translate }}</th>
                      <th scope="col" class="py-3 px-4 text-right">{{ 'exerciseDetail.repRecords.est1rmHeader' |
                        translate }}</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let record of repRecords()"
                      class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                      <td class="py-3 px-4 font-bold text-gray-900 dark:text-white">{{ record.reps }}</td>
                      <td class="py-3 px-4">
                        <ng-container *ngIf="record.bestPerformance as bestPerformance; else noPerformance">
                          <span class="font-semibold">{{ bestPerformance.weight | weightUnit }} (×{{
                            bestPerformance.reps
                            }})</span>
                          <span class="block text-xs text-gray-500">{{ bestPerformance.date | date:'mediumDate'
                            }}</span>
                        </ng-container>
                        <ng-template #noPerformance>-</ng-template>
                      </td>
                      <td class="py-3 px-4 text-right">{{ record.estimated1RM | number:'1.0-1' }} kg</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </ng-container>
            <ng-template #cardioRepRecords>
              <p class="text-center text-gray-500 dark:text-gray-400 text-sm">{{
                'exerciseDetail.repRecords.notApplicable' | translate }}</p>
            </ng-template>
            <!-- --- END: CONDITIONALLY HIDE REP RECORDS TABLE --- -->
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-container>





<ng-template #loadingOrNotFound>
  <div *ngIf="exercise() === undefined; else notFound" class="text-center py-10">
    <p class="text-xl text-gray-600 dark:text-gray-400">Loading exercise details...</p>
    <!-- You can add a spinner here -->
  </div>
  <ng-template #notFound>
    <div class="text-center py-10">
      <h2 class="text-2xl font-semibold mb-4 text-gray-700 dark:text-gray-200">Exercise Not Found</h2>
      <p class="text-gray-600 dark:text-gray-400">The exercise you are looking for does not exist or could not be
        loaded</p>
      <a *ngIf="!isModal" routerLink="/library"
        class="mt-4 inline-block bg-primary hover:bg-primary-dark text-white font-semibold py-2 px-4 rounded-md">Go to
        Library</a>
    </div>
  </ng-template>
</ng-template>

<!-- <app-muscle-map [muscles]="muscleDataForMap"></app-muscle-map> -->
<div class="container mx-auto p-4">
  <div class="mb-4">
    <a routerLink="/library" class="text-primary dark:text-primary-light hover:underline">← Back to Library</a>
  </div>

  <ng-container *ngIf="exercise() as ex; else loadingOrNotFound">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden">
      <!-- Image Carousel -->
      <div *ngIf="ex.imageUrls && ex.imageUrls.length > 0" class="relative">
        <img [src]="ex.imageUrls[currentImageIndex()]" [alt]="ex.name + ' form ' + (currentImageIndex() + 1)" class="w-full h-64 sm:h-80 md:h-96 object-contain bg-gray-200 dark:bg-gray-700">
        <button *ngIf="ex.imageUrls.length > 1"
                (click)="prevImage()"
                class="absolute top-1/2 left-2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 focus:outline-none">
          ❮ <!-- Left arrow -->
        </button>
        <button *ngIf="ex.imageUrls.length > 1"
                (click)="nextImage()"
                class="absolute top-1/2 right-2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 focus:outline-none">
          ❯ <!-- Right arrow -->
        </button>
        <!-- Image dots/indicators -->
        <div *ngIf="ex.imageUrls.length > 1" class="absolute bottom-2 left-1/2 transform -translate-x-1/2 flex space-x-2">
          <span *ngFor="let img of ex.imageUrls; let i = index"
                (click)="currentImageIndex.set(i)"
                class="w-3 h-3 rounded-full cursor-pointer"
                [ngClass]="{'bg-white dark:bg-gray-300': currentImageIndex() === i, 'bg-gray-400 dark:bg-gray-600': currentImageIndex() !== i}">
          </span>
        </div>
      </div>
      <div *ngIf="!ex.imageUrls || ex.imageUrls.length === 0" class="w-full h-64 sm:h-80 md:h-96 bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
        <p class="text-gray-500 dark:text-gray-400">No image available</p>
      </div>

      <div class="p-6 md:p-8">
        <h1 class="text-3xl md:text-4xl font-bold mb-3 text-gray-800 dark:text-gray-100">{{ ex.name }}</h1>
        <div class="mb-4">
          <span class="px-3 py-1 text-xs font-semibold rounded-full bg-primary-light text-primary-dark dark:bg-primary-dark dark:text-primary-light capitalize">
            {{ ex.category }}
          </span>
        </div>

        <div class="mb-6">
          <h2 class="text-xl font-semibold mb-2 text-gray-700 dark:text-gray-300">Description</h2>
          <p class="text-gray-600 dark:text-gray-400 leading-relaxed">{{ ex.description }}</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div>
            <h3 class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-300">Primary Muscle Group</h3>
            <p class="text-gray-600 dark:text-gray-400">{{ ex.primaryMuscleGroup }}</p>
          </div>
          <div>
            <h3 class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-300">Other Muscle Groups</h3>
            <ul class="list-disc list-inside text-gray-600 dark:text-gray-400">
              <li *ngFor="let group of ex.muscleGroups">{{ group }}</li>
            </ul>
          </div>
        </div>

        <div *ngIf="ex.equipmentNeeded && ex.equipmentNeeded.length > 0" class="mb-6">
          <h3 class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-300">Equipment Needed</h3>
          <ul class="list-disc list-inside text-gray-600 dark:text-gray-400">
            <li *ngFor="let item of ex.equipmentNeeded">{{ item }}</li>
          </ul>
        </div>

        <div *ngIf="ex.notes" class="mb-6">
          <h3 class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-300">Notes & Tips</h3>
          <p class="text-gray-600 dark:text-gray-400 whitespace-pre-line">{{ ex.notes }}</p>
        </div>

        <div *ngIf="ex.videoUrl" class="mb-6">
          <a [href]="ex.videoUrl" target="_blank" rel="noopener noreferrer"
             class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2">
              <path d="M3 4a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H3Zm10 6.004a.75.75 0 0 0-.504-.705l-4.25-2.125a.75.75 0 0 0-1.042.705v4.25a.75.75 0 0 0 1.042.705l4.25-2.125A.75.75 0 0 0 13 10.004Z" />
            </svg>
            Watch Video
          </a>
        </div>

      </div>
    </div>
  </ng-container>

  <ng-template #loadingOrNotFound>
    <div *ngIf="exercise() === undefined; else notFound" class="text-center py-10">
      <p class="text-xl text-gray-600 dark:text-gray-400">Loading exercise details...</p>
      <!-- You can add a spinner here -->
    </div>
    <ng-template #notFound>
      <div class="text-center py-10">
        <h2 class="text-2xl font-semibold mb-4 text-gray-700 dark:text-gray-200">Exercise Not Found</h2>
        <p class="text-gray-600 dark:text-gray-400">The exercise you are looking for does not exist or could not be loaded.</p>
        <a routerLink="/library" class="mt-4 inline-block bg-primary hover:bg-primary-dark text-white font-semibold py-2 px-4 rounded-md">Go to Library</a>
      </div>
    </ng-template>
  </ng-template>
</div>
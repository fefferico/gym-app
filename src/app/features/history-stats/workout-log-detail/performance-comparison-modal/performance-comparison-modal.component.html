<ng-container *ngIf="comparisonData() as data; else loading">
  <div *ngIf="data; else noData" class="bg-gray-900 text-white p-4 font-sans max-h-[80vh] overflow-y-auto">

    <!-- Header and Dropdown -->
    <div class="text-center mb-6">
      <p class="font-semibold text-lg">{{ exercise.exerciseName }}</p>
      <div *ngIf="allHistoricalLogs().length > 0; else noHistory" class="mt-2">
        <label for="log-select" class="text-md text-gray-400">COMPARED TO</label>
        <select id="log-select" [value]="selectedLogId" (change)="onComparisonLogChange($event)" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-primary-light focus:border-primary-light block w-full p-1.5 mt-1">
          <option *ngFor="let log of allHistoricalLogs()" [value]="log.id">
            {{ log.date | date:'fullDate' }}
          </option>
        </select>
      </div>
      <ng-template #noHistory>
        <p class="text-md text-gray-400">COMPARED TO PREVIOUS</p>
      </ng-template>
    </div>

    <!-- Dynamic Comparison Grid -->
    <div class="grid grid-cols-2 gap-x-4 gap-y-6 mb-8 text-center">
      <!-- Sets -->
      <div>
        <div class="text-4xl font-bold">{{ data.currentSummary.setsCount }}</div>
        <div class="text-md text-gray-400">Sets</div>
        <div class="flex items-center justify-center mt-1" [ngClass]="{'text-green-400': data.comparison.setsDiff > 0, 'text-red-400': data.comparison.setsDiff < 0, 'text-gray-500': data.comparison.setsDiff === 0}">
          <app-icon [name]="getTrendIcon(data.comparison.setsDiff)" class="w-3 h-3 mr-1"></app-icon>
          <span class="text-xs font-medium">{{ data.comparison.setsDiff > 0 ? '+' : '' }}{{ data.comparison.setsDiff }} ({{ data.comparison.setsPercentChange | number:'1.0-0' }}%)</span>
        </div>
      </div>
      <!-- Repetitions (if applicable) -->
      <div *ngIf="data.currentSummary.totalReps > 0 || data.previousSummary.totalReps > 0">
        <div class="text-4xl font-bold">{{ data.currentSummary.totalReps }}</div>
        <div class="text-md text-gray-400">Repetitions</div>
        <div class="flex items-center justify-center mt-1" [ngClass]="{'text-green-400': data.comparison.repsDiff > 0, 'text-red-400': data.comparison.repsDiff < 0, 'text-gray-500': data.comparison.repsDiff === 0}">
          <app-icon [name]="getTrendIcon(data.comparison.repsDiff)" class="w-3 h-3 mr-1"></app-icon>
          <span class="text-xs font-medium">{{ data.comparison.repsDiff > 0 ? '+' : '' }}{{ data.comparison.repsDiff }} ({{ data.comparison.repsPercentChange | number:'1.0-0' }}%)</span>
        </div>
      </div>

      <!-- WEIGHTED METRICS -->
      <ng-container *ngIf="showWeightMetrics()">
        <div>
          <div class="text-4xl font-bold">{{ data.currentSummary.maxWeight | number:'1.0-1' }}</div>
          <div class="text-md text-gray-400">Max Weight ({{ unitService.getWeightUnitSuffix() }})</div>
          <div class="flex items-center justify-center mt-1" [ngClass]="{'text-green-400': data.comparison.maxWeightDiff > 0, 'text-red-400': data.comparison.maxWeightDiff < 0, 'text-gray-500': data.comparison.maxWeightDiff === 0}">
            <app-icon [name]="getTrendIcon(data.comparison.maxWeightDiff)" class="w-3 h-3 mr-1"></app-icon>
            <span class="text-xs font-medium">{{ data.comparison.maxWeightDiff > 0 ? '+' : '' }}{{ data.comparison.maxWeightDiff | number:'1.0-1' }} ({{ data.comparison.maxWeightPercentChange | number:'1.0-0' }}%)</span>
          </div>
        </div>
        <div>
          <div class="text-4xl font-bold">{{ data.currentSummary.totalVolume | number:'1.0-0' }}</div>
          <div class="text-md text-gray-400">Volume ({{ unitService.getWeightUnitSuffix() }})</div>
          <div class="flex items-center justify-center mt-1" [ngClass]="{'text-green-400': data.comparison.volumeDiff > 0, 'text-red-400': data.comparison.volumeDiff < 0, 'text-gray-500': data.comparison.volumeDiff === 0}">
            <app-icon [name]="getTrendIcon(data.comparison.volumeDiff)" class="w-3 h-3 mr-1"></app-icon>
            <span class="text-xs font-medium">{{ data.comparison.volumeDiff > 0 ? '+' : '' }}{{ data.comparison.volumeDiff | number:'1.0-0' }} ({{ data.comparison.volumePercentChange | number:'1.0-0' }}%)</span>
          </div>
        </div>
      </ng-container>

      <!-- CARDIO METRICS -->
      <ng-container *ngIf="showCardioMetrics()">
        <div *ngIf="data.currentSummary.totalDuration > 0 || data.previousSummary.totalDuration > 0">
          <div class="text-4xl font-bold">{{ formatDuration(data.currentSummary.totalDuration) }}</div>
          <div class="text-md text-gray-400">Duration</div>
          <div class="flex items-center justify-center mt-1" [ngClass]="{'text-green-400': data.comparison.durationDiff > 0, 'text-red-400': data.comparison.durationDiff < 0, 'text-gray-500': data.comparison.durationDiff === 0}">
            <app-icon [name]="getTrendIcon(data.comparison.durationDiff)" class="w-3 h-3 mr-1"></app-icon>
            <span class="text-xs font-medium">{{ data.comparison.durationDiff > 0 ? '+' : '' }}{{ formatDuration(data.comparison.durationDiff) }} ({{ data.comparison.durationPercentChange | number:'1.0-0' }}%)</span>
          </div>
        </div>
        <div *ngIf="data.currentSummary.totalDistance > 0 || data.previousSummary.totalDistance > 0">
          <div class="text-4xl font-bold">{{ data.currentSummary.totalDistance | number:'1.0-2' }}</div>
          <div class="text-md text-gray-400">Distance ({{ unitService.getDistanceMeasureUnitSuffix() }})</div>
          <div class="flex items-center justify-center mt-1" [ngClass]="{'text-green-400': data.comparison.distanceDiff > 0, 'text-red-400': data.comparison.distanceDiff < 0, 'text-gray-500': data.comparison.distanceDiff === 0}">
            <app-icon [name]="getTrendIcon(data.comparison.distanceDiff)" class="w-3 h-3 mr-1"></app-icon>
            <span class="text-xs font-medium">{{ data.comparison.distanceDiff > 0 ? '+' : '' }}{{ data.comparison.distanceDiff | number:'1.0-2' }} ({{ data.comparison.distancePercentChange | number:'1.0-0' }}%)</span>
          </div>
        </div>
      </ng-container>
    </div>

    <!-- Today's Sets -->
    <div class="space-y-2">
        <h3 class="text-sm font-bold tracking-wider text-gray-300">TODAY</h3>
        <ul class="space-y-1">
            <li *ngFor="let set of data.currentSets; let i = index" class="bg-gray-800 p-2 rounded-md">
                <div class="flex justify-between items-center text-md text-gray-400">
                    <span>{{ set.timestamp || data.currentLog.startTime | date:'shortTime' }}</span>
                    <span>SET {{ i + 1 }}</span>
                </div>
                <div class="flex justify-end items-baseline space-x-4 mt-1 text-right text-base">
                    <span *ngIf="(set.distanceAchieved || 0) > 0" class="font-semibold text-cyan-400">{{ set.distanceAchieved | number:'1.0-2' }} {{ unitService.getDistanceMeasureUnitSuffix() }}</span>
                    <span *ngIf="(set.durationPerformed || 0) > 0" class="font-semibold text-purple-400">{{ formatDuration(set.durationPerformed!) }}</span>
                    <span *ngIf="(set.repsAchieved || 0) > 0" class="font-semibold text-green-400">{{ set.repsAchieved }} reps</span>
                    <span *ngIf="set.weightUsed != null && set.weightUsed > 0" class="font-semibold text-yellow-400">{{ set.weightUsed | weightUnit:'1.0-2' }}</span>
                </div>
            </li>
        </ul>
    </div>
    
    <!-- Previous Sets -->
    <div class="mt-6 space-y-2" *ngIf="data.previousLog && data.previousSets.length > 0">
        <div class="flex items-center">
            <h3 class="text-sm font-bold tracking-wider text-gray-300">{{ data.previousLog.date | date:'mediumDate' | uppercase
                }}</h3>
            <button type="button" (click)="goToPreviousLogDetail(data.previousLog?.id)"
                title="Go to previous log"
                class="ml-1 px-1 flex justify-center items-center w-fit bg-primary hover:bg-primary-dark text-white font-semibold rounded-md shadow-sm text-lg disabled:opacity-50 disabled:cursor-not-allowed">
                <app-icon name="right-arrow" class="w-8 h-8"></app-icon>
            </button>
        </div>
        
        <ul class="space-y-1">
            <li *ngFor="let set of data.previousSets; let i = index" class="bg-gray-800 p-2 rounded-md">
                <div class="flex justify-between items-center text-md text-gray-400">
                    <span>{{ data.previousLog.startTime | date:'shortTime' }}</span>
                    <span>SET {{ i + 1 }}</span>
                </div>
                <div class="flex justify-end items-baseline space-x-4 mt-1 text-right text-base">
                    <span *ngIf="(set.distanceAchieved || 0) > 0" class="font-semibold text-cyan-400">{{ set.distanceAchieved | number:'1.0-2' }} {{ unitService.getDistanceMeasureUnitSuffix() }}</span>
                    <span *ngIf="(set.durationPerformed || 0) > 0" class="font-semibold text-purple-400">{{ formatDuration(set.durationPerformed!) }}</span>
                    <span *ngIf="(set.repsAchieved || 0) > 0" class="font-semibold text-green-400">{{ set.repsAchieved }} reps</span>
                    <span *ngIf="set.weightUsed != null && set.weightUsed > 0" class="font-semibold text-yellow-400">{{ set.weightUsed | weightUnit:'1.0-2' }}</span>
                </div>
            </li>
        </ul>
    </div>

    <!-- Fallback messages -->
    <div *ngIf="!data.previousLog" class="mt-6 text-center text-sm text-gray-500">
      No previous performance found for this routine.
    </div>
    <div *ngIf="data.previousLog && data.previousSets.length === 0" class="mt-6 text-center text-sm text-gray-500">
      This exercise was not performed in the selected session.
    </div>
  </div>
</ng-container>

<ng-template #loading>
  <div class="p-8 text-center text-gray-400">Loading comparison...</div>
</ng-template>

<ng-template #noData>
    <div class="p-8 text-center text-gray-400">Could not load comparison data. This workout may not be part of a routine.</div>
</ng-template>
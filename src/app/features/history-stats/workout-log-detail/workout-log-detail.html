<!-- In workout-log-detail.html -->

<div class="container mx-auto p-2 sm:p-4">
  <!-- Header row for Back button, Title, and Action Buttons -->
  <header class="flex items-center justify-between p-2">
    <button routerLink="/history/list"
      class="text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
      <app-icon name="back" class="h-6 w-6"></app-icon>
    </button>

    <!-- Action Buttons Group -->
    <div class="flex items-center space-x-2 flex-shrink-0">
      <!-- Wrapper for "More Actions" button and its dropdown -->
      <div *ngIf="workoutLog() as log" class="">
        <div class="relative">
          <button (click)="toggleActions(log.id, $event)"
            class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-500 rounded-full focus:outline-none flex items-center">
            <app-icon name="menu-action" class="h-10 w-10"></app-icon>
          </button>
          <app-action-menu *ngIf="areActionsVisible(log.id)" displayMode="dropdown"
            [items]="getLogDropdownActionItems(log.id, 'dropdown')" [isVisible]="areActionsVisible(log.id)"
            (itemClick)="handleActionMenuItemClick($event)" (closeMenu)="onCloseActionMenu()">
          </app-action-menu>
        </div>
      </div>
    </div>
  </header>

  <ng-container *ngIf="workoutLog() as log; else loadingOrNotFound">
    <div class="bg-white dark:bg-gray-700 rounded-md shadow-xl overflow-hidden">
      <div class="px-2 py-2">
        <h1 class="text-xl sm:text-2xl font-bold text-gray-800 dark:text-gray-100 text-left flex-grow truncate mb-2"
          [title]="workoutLog()?.routineName || 'Ad-hoc Workout'">
          {{ workoutLog()?.routineName || 'Ad-hoc Workout' }}
        </h1>

        <h2 *ngIf="checkIfLogForProgram()" class="font-bold text-gray-800 dark:text-gray-200 mb-2">
          <span>{{getLogTitleForProgramEntry()}}</span>
        </h2>

        <div class="flex items-center align-center text-md text-gray-600 dark:text-gray-400 gap-x-2">
          <app-icon name="calendar" class="w-7 h-7 mr-1"></app-icon>
          <div>
            <p class="font-bold">{{ log.startTime | date:'fullDate' }}</p>
            <p class="text-sm text-gray-600 dark:text-gray-400">
              From {{ log.startTime | date:'shortTime' }} to {{ log.endTime | date:'shortTime' }}
            </p>
          </div>

        </div>
        <!-- EXERCISES DIV -->
        <div class="flex items-center text-md text-gray-600 dark:text-gray-400 mt-1 gap-x-2">
          <app-icon name="muscle" class="h-7 w-7"></app-icon>
          <span class="ml-1"> Exercises: {{ log.exercises.length }}</span>
        </div>

        <!-- DURATION DIV -->
        <div class="flex items-center text-md text-gray-600 dark:text-gray-400 mt-1 gap-x-2">
          <app-icon name="clock" class="h-7 w-7 mr-1"></app-icon>
          <span *ngIf="log.durationSeconds">Duration: {{ secondsToDateTime(log.durationSeconds) | date:'HH:mm:ss'
            }}</span>
          <span *ngIf="!log.durationSeconds">Duration: {{ log.durationMinutes }} minutes</span>
        </div>

        <p *ngIf="log.notes" class="mt-2 text-m text-gray-600 dark:text-gray-400 italic">
          <strong>Overall Notes:</strong> {{ log.notes }}
        </p>
      </div>

      <div class="px-2 pb-5 mb-3">
        <!-- <h2 class="text-xl sm:text-2xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Exercises performed:</h2> -->
        <div *ngIf="displayExercises().length > 0; else noLoggedExercises">

          <div *ngFor="let loggedEx of displayExercises(); let exIdx = index" class="overflow-hidden shadow-md"
            [ngClass]="{
              'border border-gray-200 dark:border-gray-600 rounded-md mt-4': !loggedEx.supersetId,
              'mb-3': loggedEx.supersetId && loggedEx.supersetOrder === (loggedEx.supersetSize ?? 0),
              'mt-3': loggedEx.supersetId && loggedEx.supersetOrder === 0,
              'border-l border-r border-orange-400 dark:border-orange-600': loggedEx.supersetId,
              'bg-orange-50 dark:bg-orange-900/20': loggedEx.supersetId,
              'rounded-t-lg border-t': loggedEx.supersetId && loggedEx.supersetOrder === 0,
              'rounded-b-lg border-b': loggedEx.supersetId && loggedEx.supersetOrder === ((loggedEx.supersetSize ?? 0) - 1),
            }">

            <button (click)="toggleExerciseAccordion(loggedEx)"
              class="w-full flex justify-between items-center p-1 text-left transition-colors focus:outline-none"
              [ngClass]="{
                'dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700': !loggedEx.supersetId,
                'hover:bg-orange-100 dark:hover:bg-orange-800/40': loggedEx.supersetId,
                'rounded-b': loggedEx.supersetId && loggedEx.supersetOrder === ((loggedEx.supersetSize ?? 0) - 1) && !loggedEx.isExpanded && (loggedEx.supersetOrder > 0 && loggedEx.supersetOrder < ((loggedEx.supersetSize ?? 0) - 1) ),
              }">
              <div class="flex items-center min-w-0"> <!-- Added min-w-0 for truncation -->
                <div class="flex-shrink-0 mr-2 w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-md"
                  [ngClass]="{
                    '': !loggedEx.supersetId,
                    'dark:bg-orange-300/30 border-orange-300 dark:border-orange-700': loggedEx.supersetId
                  }">
                  <img *ngIf="loggedEx.iconName" [src]="getIconPath(loggedEx.iconName)"
                    [alt]="loggedEx.exerciseName + ' icon'" class="w-6 h-6 sm:w-8 sm:h-8 object-contain"
                    [ngClass]="{'filter dark:invert': loggedEx.iconName !== 'default-exercise' && !loggedEx.supersetId, 'filter dark:brightness-200 dark:contrast-150': loggedEx.iconName !== 'default-exercise' && loggedEx.supersetId}">
                </div>
                <div *ngIf="loggedEx.baseExercise === undefined"
                  class="w-10 h-10 sm:w-12 sm:h-12 bg-gray-200 dark:bg-gray-700 animate-pulse rounded-md mr-3"></div>

                <div class="min-w-0"> <!-- Added min-w-0 for truncation -->
                  <div class="flex">
                    <h3 class="text-md sm:text-lg font-semibold truncate" [ngClass]="{
                      'text-primary dark:text-primary-light': !loggedEx.supersetId,
                      'text-orange-700 dark:text-orange-300': loggedEx.supersetId
                    }" [title]="loggedEx.exerciseName" (click)="openModal(loggedEx, $event)">
                      <span *ngIf="loggedEx.supersetId"
                        class="text-xs font-normal text-orange-600 dark:text-orange-400 block leading-tight">
                        <ng-container
                          *ngIf="loggedEx.supersetRounds && loggedEx.supersetRounds > 1 && loggedEx.supersetCurrentRound !== null">
                          Round {{ loggedEx.supersetCurrentRound }} of {{ loggedEx.supersetRounds }} |
                        </ng-container>
                        Superset exercise {{ (loggedEx.supersetOrder ?? 0) + 1 }} of {{ loggedEx.supersetSize }}
                      </span>
                      {{ loggedEx.exerciseName }}
                    </h3>
                    <app-icon name="info" class="h-4 w-4 text-gray-400 dark:text-gray-300 cursor-help" *ngIf="loggedEx"
                      (click)="openModal(loggedEx, $event)" [appTooltip]="exerciseInfoTooltipString"></app-icon>
                  </div>
                  <div *ngIf="!loggedEx.isExpanded" class="text-xs text-gray-500 dark:text-gray-400 truncate">
                    <p *ngIf="loggedEx.baseExercise?.category"
                      class="text-xs text-gray-500 dark:text-gray-400 truncate">
                      {{ loggedEx.baseExercise?.category | titlecase }}
                    </p>
                    <p *ngIf="loggedEx.sets && loggedEx.sets.length >= 1 && checkIfTimedExercise(loggedEx)"> Duration
                      (s): {{getSetDurationPerformed(loggedEx)}}</p>
                    <p *ngIf="loggedEx.sets && loggedEx.sets.length >= 1"> Sets: {{loggedEx.sets.length}} {{
                      getSetReps(loggedEx) != '0' ? '( Reps: ' + getSetReps(loggedEx) + ' )' : '' }}</p>
                    <p *ngIf="loggedEx.sets && loggedEx.sets.length > 1 && checkIfWeightedExercise(loggedEx)"> Weight
                      ({{unitService.getWeightUnitSuffix()}}): {{getSetWeightsUsed(loggedEx)}}</p>
                  </div>

                </div>
              </div>

              <div class="flex items-center min-w-0 text-xs text-gray-500 dark:text-gray-400 truncate">
                <app-icon name="collapse-card" class="w-5 h-5 transition-transform duration-200 flex-shrink-0 ml-2"
                  [ngClass]="{
                'text-gray-500 dark:text-gray-400': !loggedEx.supersetId,
                'text-orange-500 dark:text-orange-400': loggedEx.supersetId,
                'rotate-180': loggedEx.isExpanded
                }"></app-icon>
              </div>

            </button>

            <div *ngIf="loggedEx.isExpanded" [ngClass]="{
              'grid-cols-6': (loggedEx | isWeighted) && hasPerformedTimedSets(loggedEx),
              'grid-cols-5': ((loggedEx | isWeighted) && !hasPerformedTimedSets(loggedEx)) || (!(loggedEx | isWeighted) && hasPerformedTimedSets(loggedEx)),
              'grid-cols-4': !(loggedEx | isWeighted) && !hasPerformedTimedSets(loggedEx)
            }" class="grid gap-x-4 gap-y-2 p-4 bg-white rounded-b-md shadow-md dark:bg-gray-800">

              <!-- === GRID HEADER === -->
              <div class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400">Set</div>
              <div class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400">Reps</div>

              <div *ngIf="loggedEx | isWeighted" class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400">
                Weight
              </div>

              <div *ngIf="hasPerformedTimedSets(loggedEx)"
                class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400">Time</div>
              <div class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400">Rest</div>
              <div class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400">Notes</div>


              <!-- === GRID ROWS (LOOP) === -->
              <ng-container *ngFor="let set of loggedEx.sets; let i = index; let last = last">

                <!-- Set Number Column -->
                <div class="font-medium text-gray-900 dark:text-white flex items-center space-x-2">
                  <span [ngClass]="{'bg-blue-100 dark:bg-blue-400 p-1 rounded': set.type && set.type === 'warmup'}">{{ i
                    + 1 }}{{set.type === 'warmup' ? '*':''}}</span>
                  <div *ngIf="getPersonalBestTypesForSet(set, loggedEx.exerciseId).length > 0" class="flex-shrink-0"
                    [title]="'Personal Best!\n' + getPersonalBestTypesForSet(set, loggedEx.exerciseId).join('\n')">
                    <span
                      class="px-1.5 py-0.5 text-xs font-semibold rounded-full bg-primary-dark text-white dark:text-amber-100">
                      üèÜ PB
                    </span>
                  </div>
                </div>

                <!-- Reps Column -->
                <div class="">
                  <strong [ngClass]="checkTextClass(set, 'reps')" [class.cursor-pointer]="isTargetMissed(set, 'reps')"
                    [class.cursor-default]="!isTargetMissed(set, 'reps')"
                    [class.hover:underline]="isTargetMissed(set, 'reps')" (click)="showComparisonModal(set, 'reps')">
                    {{ set.repsAchieved || '-' }}
                  </strong>
                </div>

                <!-- Weight Column -->
                <div *ngIf="loggedEx | isWeighted">
                  <strong [ngClass]="checkTextClass(set, 'weight')"
                    [class.cursor-pointer]="isTargetMissed(set, 'weight')"
                    [class.cursor-default]="!isTargetMissed(set, 'weight')"
                    [class.hover:underline]="isTargetMissed(set, 'weight')"
                    (click)="showComparisonModal(set, 'weight')">
                    {{ set.weightUsed != null ? (set.weightUsed + ' ' + unitService.getWeightUnitSuffix()) : '-' }}
                  </strong>
                </div>

                <!-- Time Column -->
                <div *ngIf="hasPerformedTimedSets(loggedEx)">
                  <strong [ngClass]="checkTextClass(set, 'duration')"
                    [class.cursor-pointer]="isTargetMissed(set, 'duration')"
                    [class.cursor-default]="!isTargetMissed(set, 'duration')"
                    [class.hover:underline]="isTargetMissed(set, 'duration')"
                    (click)="showComparisonModal(set, 'duration')">
                    {{ set.durationPerformed || '-' }}
                  </strong>
                </div>

                <!-- Rest Column -->
                <div>
                  <strong [ngClass]="checkTextClass(set, 'rest')" [class.cursor-pointer]="isTargetMissed(set, 'rest')"
                    [class.hover:underline]="isTargetMissed(set, 'rest')" (click)="showComparisonModal(set, 'rest')"
                    [class.cursor-default]="!isTargetMissed(set, 'rest')">
                    {{ set.restAfterSetUsed || '-' }}
                  </strong>
                </div>

                <!-- Notes Column -->
                <div class="cursor-pointer dark:text-white">
                  <app-icon name="schedule" (click)="showNotesModal(set.notes)" *ngIf="set.notes"
                    class="h-7 w-7"></app-icon>
                  <span class="text-gray-500" *ngIf="!set.notes">-</span>
                </div>
                <div *ngIf="!last" class="col-span-full h-px bg-gray-200 dark:bg-gray-700"></div>

              </ng-container>
            </div>


          </div>
        </div>
        <ng-template #noLoggedExercises>
          <p class="text-gray-500 dark:text-gray-400">No specific exercises were logged for this workout</p>
        </ng-template>
      </div>
    </div>
  </ng-container>

  <ng-template #loadingOrNotFound>
    <div *ngIf="workoutLog() === undefined; else notFound" class="text-center py-20">
      <p class="text-xl text-gray-600 dark:text-gray-400">Loading workout details...</p>
    </div>
    <ng-template #notFound>
      <div class="text-center py-20">
        <h2 class="text-2xl font-semibold text-red-600 dark:text-red-400 mb-4">Workout Log Not Found</h2>
        <p class="text-gray-600 dark:text-gray-400">The workout log you are looking for does not exist</p>
        <button routerLink="/history/list"
          class="inline-flex items-center text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
          <app-icon name="back"></app-icon>
          Back to History
        </button>
      </div>
    </ng-template>
  </ng-template>
</div>

<app-modal *ngIf="exerciseDetailsId" [(isOpen)]="isSimpleModalOpen" [modalTitle]="exerciseDetailsName">
  <app-exercise-detail [id]="exerciseDetailsId" [isModal]="true"></app-exercise-detail>
</app-modal>

<!-- NOTES MODAL -->
<app-modal *ngIf="notesModalsData() as data" [isOpen]="!!data" (isOpenChange)="notesModalsData.set(null)"
  [modalTitle]="'Notes'">

  <div class="flex flex-col p-4 text-left text-gray-700 dark:text-gray-200">
    <textarea [disabled]="true" class="font-semibold pb-2 dark:border-gray-600 dark:bg-gray-800" name=""
      id="">{{data}}</textarea>
    <button appPress (shortPress)="notesModalsData.set(null)"
      class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary-light">
      CLOSE
    </button>
  </div>

</app-modal>

<!-- COMPARISON MODAL -->
<app-modal *ngIf="comparisonModalData() as data" [isOpen]="!!data" (isOpenChange)="comparisonModalData.set(null)"
  [modalTitle]="data.metric + ' Target Comparison'">

  <div class="p-4 text-center text-gray-700 dark:text-gray-200">
    <div class="grid grid-cols-2 gap-4 text-lg">
      <div class="font-semibold border-b pb-2 dark:border-gray-600">Target</div>
      <div class="font-semibold border-b pb-2 dark:border-gray-600">Performed</div>

      <div class="text-gray-500 dark:text-gray-400">{{ data.targetValue }}</div>
      <div class="text-red-500 dark:text-red-400 font-bold">{{ data.performedValue }}</div>
    </div>
    <button appPress (shortPress)="comparisonModalData.set(null)"
      class="mt-6 w-full px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary-light">
      CLOSE
    </button>
  </div>

</app-modal>

<div class="fixed bottom-20 right-6 z-40 flex flex-col items-center gap-4">

  <!-- 1. "Back to Top" Button -->
  <!-- It's now inside the container, so we remove its individual `fixed` positioning. -->
  <!-- It will appear only when the condition is met, stacked on top due to flex-col. -->
  <button *ngIf="showBackToTopButton()" appPress (shortPress)="scrollToTop()" type="button"
    class="bg-primary dark:bg-primary text-white rounded-full p-3 shadow-lg hover:bg-primary-dark dark:hover:bg-primary-light focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-focus dark:focus:ring-offset-gray-900 transition-opacity animate-fade-in">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"
      class="w-6 h-6">
      <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />
    </svg>
    <span class="sr-only">Back to Top</span>
  </button>
</div>
<!-- ========================================================== -->
<!-- END: Main Floating Button Container -->
<!-- ========================================================== -->
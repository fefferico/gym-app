<div class="compact-player-container bg-gray-100 dark:bg-gray-900 min-h-screen">
  <!-- Header -->
  <header
    class="sticky top-0 z-20 bg-white dark:bg-gray-800 shadow-md p-3 flex items-center justify-between rounded-b-md">
    <button (click)="router.navigate(['/workout'])" class="p-2">
      <app-icon name="cancel" class="h-6 w-6 text-gray-600 dark:text-gray-300"></app-icon>
    </button>
    <div class="text-center">
      <h1 class="text-lg font-bold text-gray-800 dark:text-gray-100 truncate max-w-xs">
        {{ routine()?.name || 'Workout' }}
      </h1>
      <div class="text-xl font-mono font-semibold text-primary dark:text-primary-light tracking-wider">
        {{ sessionTimerDisplay() }}
      </div>
    </div>
    <div class="w-10 relative">
      <!-- This div is a placeholder to balance the header -->
    </div>
  </header>

  <!-- Main Content: Exercises List -->
  <main class="p-2 pb-24">
    <div *ngIf="routine() as currentRoutine; else loading" class="space-y-3">
      <!-- FIX: Removed 'overflow-hidden' from this div -->
      <div *ngFor="let exercise of currentRoutine.exercises; let exIndex = index"
        class="bg-white dark:bg-gray-800 rounded-lg shadow-sm transition-all duration-300 relative">
        <!-- Exercise Header -->
        <div (click)="toggleExerciseExpansion(exIndex)"
          class="p-3 flex items-center justify-between cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50">
          <div class="flex items-center space-x-3 min-w-0">
            <span class="font-semibold text-gray-800 dark:text-gray-100">{{ exIndex + 1 }}</span>
            <h2 class="text-md font-semibold text-gray-800 dark:text-gray-100 truncate">
              {{ exercise.exerciseName }}
            </h2>
          </div>
          <div class="flex items-center">
            <button (click)="toggleActionMenu(exIndex, $event)"
              class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
              <!-- Refined Icon Name -->
              <app-icon name="menu_action" class="h-5 w-5 text-gray-500"></app-icon>
            </button>
            <!-- Refined Icon and Rotation Logic -->
            <app-icon name="chevron-down" class="h-5 w-5 text-gray-500 transition-transform duration-200 flex-shrink-0"
              [class.rotate-180]="expandedExerciseIndex() === exIndex"></app-icon>
          </div>
        </div>

        <!-- Action Menu (this will now be visible) -->
        <app-action-menu [isVisible]="activeActionMenuIndex() === exIndex"
          (itemClick)="handleActionMenuItemClick($event)" (closeMenu)="closeActionMenu()"
          [items]="getLogDropdownActionItems(exIndex,'dropdown')">
        </app-action-menu>


        <!-- Sets Container -->
        <div *ngIf="expandedExerciseIndex() === exIndex"
          class="bg-gray-50 dark:bg-gray-700/50 py-3 px-1 border-t border-gray-200 dark:border-gray-700">
          <!-- Set Headers -->
          <div class="grid grid-cols-12 gap-2 text-xs font-medium text-gray-500 dark:text-gray-400 mb-2 px-2">
            <div class="col-span-1 text-center">Set</div>
            <ng-container *ngIf="!isCardio(exercise)">
              <div class="col-span-4 text-center">Weight ({{ unitsService.getUnitLabel() }})</div>
              <div class="col-span-3 text-center">Reps</div>
            </ng-container>
            <ng-container *ngIf="isCardio(exercise)">
              <div class="col-span-4 text-center">Distance (km)</div>
              <div class="col-span-3 text-center">Time</div>
            </ng-container>
            <div class="col-span-4 text-center">Status</div>
          </div>

          <!-- Sets List -->
          <div class="space-y-2">
            <div *ngFor="let set of exercise.sets; let setIndex = index"
              class="grid grid-cols-12 gap-2 items-center bg-white dark:bg-gray-800 rounded-md p-2 shadow-sm">
              <div class="col-span-1 text-center font-semibold text-gray-700 dark:text-gray-200">{{ setIndex + 1 }}
              </div>

              <ng-container *ngIf="!isCardio(exercise)">
                <div class="col-span-4">
                  <input type="number" [ngModel]="getInitialInputValue(exIndex, setIndex, 'weight')"
                    (change)="updateSetData(exIndex, setIndex, 'weight', $event)"
                    class="w-full text-center bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-1 focus:ring-primary-dark focus:border-primary-dark dark:text-gray-200">
                </div>
                <div class="col-span-3">
                  <input type="number" [ngModel]="getInitialInputValue(exIndex, setIndex, 'reps')"
                    (change)="updateSetData(exIndex, setIndex, 'reps', $event)"
                    class="w-full text-center bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-1 focus:ring-primary-dark focus:border-primary-dark dark:text-gray-200">
                </div>
              </ng-container>

              <ng-container *ngIf="isCardio(exercise)">
                <div class="col-span-4">
                  <input type="number" step="0.1" placeholder="km"
                    [ngModel]="getInitialInputValue(exIndex, setIndex, 'distance')"
                    (change)="updateSetData(exIndex, setIndex, 'distance', $event)"
                    class="w-full text-center bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-1 focus:ring-primary-dark focus:border-primary-dark dark:text-gray-200">
                </div>
                <div class="col-span-3">
                  <input type="text" placeholder="mm:ss" [ngModel]="getInitialInputValue(exIndex, setIndex, 'time')"
                    (change)="updateSetData(exIndex, setIndex, 'time', $event)"
                    class="w-full text-center bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-1 focus:ring-primary-dark focus:border-primary-dark dark:text-gray-200">
                </div>
              </ng-container>

              <div class="col-span-4 flex justify-center">
                <button (click)="toggleSetCompletion(exercise, set, exIndex, setIndex)"
                  [disabled]="!isSetDataValid(exIndex, setIndex)"
                  class="h-10 w-10 rounded-full flex items-center justify-center transition-all duration-200 ease-in-out transform active:scale-90 disabled:opacity-50 disabled:cursor-not-allowed"
                  [ngClass]="isSetCompleted(exIndex, setIndex) ? 'bg-green-500 text-white shadow-lg' : 'bg-gray-200 dark:bg-gray-600 text-gray-500 dark:text-gray-300'">
                  <app-icon name="done" class="h-6 w-6"></app-icon>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <ng-template #loading>
      <div class="text-center py-10">
        <p class="text-gray-500">Loading workout...</p>
      </div>
    </ng-template>
  </main>

  <!-- Footer with Action Buttons -->
  <footer
    class="sticky bottom-0 left-0 right-0 z-20 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-3 flex items-center justify-around rounded-t-md">
    <button (click)="openExerciseSelectionModal()"
      class="flex items-center space-x-2 bg-blue-500 text-white font-semibold py-2 px-4 rounded-full shadow-lg hover:bg-blue-600 transition-colors">
      <app-icon name="plus-circle" class="h-6 w-6"></app-icon>
      <span>Add Exercise</span>
    </button>
    <button (click)="finishWorkout()"
      class="flex items-center space-x-2 bg-green-500 text-white font-semibold py-2 px-4 rounded-full shadow-lg hover:bg-green-600 transition-colors">
      <app-icon name="done" class="h-6 w-6"></app-icon>
      <span>Finish</span>
    </button>
  </footer>

  <app-exercise-selection-modal [isOpen]="isExerciseModalOpen()" [(searchTerm)]="modalSearchTerm" title="Add Exercise"
    [exercises]="availableExercises" (exerciseSelected)="addExerciseToRoutine($event)"
    (close)="closeExerciseSelectionModal()">
  </app-exercise-selection-modal>

  <!-- You would create and place modals for switch/insights here -->

</div>
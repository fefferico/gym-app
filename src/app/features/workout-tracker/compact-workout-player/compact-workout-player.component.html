<div class="compact-player-container bg-gray-200 dark:bg-gray-900 min-h-screen">
  <!-- Header -->
  <header #header
    class="sticky top-0 z-20 bg-white dark:bg-gray-800 shadow-md px-3 pt-3 pb-2 flex flex-col justify-between rounded-b-md">

    <!-- Top part of header -->
    <div class="flex items-center justify-between w-full">
      <button appBumpClick (click)="goBack()"
        class="p-2 text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light">
        <app-icon name="cancel" class="h-6 w-6"></app-icon>
      </button>
      <div class="text-center cursor-pointer" (click)="openSessionOverviewModal()">
        <h1 class="text-lg font-bold text-gray-800 dark:text-gray-100 truncate max-w-xs">
          {{ routine()?.name || ('compactPlayer.defaultWorkoutName' | translate) }}
        </h1>
        <div class="flex-col text-xl font-mono font-semibold text-primary dark:text-primary-light tracking-wider">
          {{ sessionTimerDisplay() }}
          <p>{{ sessionState() === 'paused' ? ('compactPlayer.paused' | translate):''}}</p>
        </div>
      </div>
      <!-- MODIFIED: Container for Pause/Resume and Notes buttons -->
      <div class="relative flex items-center">
        <button appBumpClick (click)="toggleMainSessionActionMenu($event)"
          class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-500 rounded-full focus:outline-none flex items-center">
          <app-icon name="menu-action" class="h-10 w-10"></app-icon>
        </button>
        <!-- The separate pause/resume button is now inside the action menu -->
        <button appBumpClick *ngIf="sessionState() === 'paused'" (click)="resumeSession()" class="p-2">
          <app-icon name="play" class="h-6 w-6 text-primary dark:text-primary-light animate-pulse"></app-icon>
        </button>
        <app-action-menu [isVisible]="mainSessionActionMenuOpened() === true && getMenuMode() !== 'compact'"
          class="action-menu-container" [modalTitle]="''" [displayMode]="getMenuMode()" [modalTitle]="''"
          [items]="mainSessionActionItems()" (itemClick)="handleMainSessionActionMenuItemClick($event)"
          (closeMenu)="toggleMainSessionActionMenu(null)">
        </app-action-menu>
      </div>
    </div>
    <app-action-menu [isVisible]="mainSessionActionMenuOpened() === true && getMenuMode() === 'compact'"
      class="action-menu-container" [modalTitle]="''" [displayMode]="getMenuMode()" [modalTitle]="''"
      [items]="mainSessionActionItems()" (itemClick)="handleMainSessionActionMenuItemClick($event)"
      (closeMenu)="toggleMainSessionActionMenu(null)">
    </app-action-menu>

    <!-- Workout Progress Bar -->
    <div class="w-full mt-2">
      <span class="flex justify-center text-primary-light font-mono">{{ 'compactPlayer.overallProgress' | translate
        }}</span>
      <div
        class="progress-bar-container w-full bg-gray-300 dark:bg-gray-700 rounded-full h-5 relative flex items-center">
        <div class="progress-bar bg-primary h-3 rounded-full my-1 mx-1" [style.width.%]="workoutProgress()"></div>
        <span class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-white">
          {{ workoutProgress() | number:'1.0-0' }}%
        </span>
      </div>
    </div>
  </header>



  <!-- Main Content: Exercises List -->
  <main class="pt-5 px-1 pb-36 bg-gray-200 dark:bg-gray-900">
    <div *ngIf="routine() as currentRoutine; else loading" cdkDropList [cdkDropListData]="currentRoutine.exercises"
      (cdkDropListDropped)="onExerciseDrop($event)" class="">
      <ng-container *ngFor="let exercise of currentRoutine.exercises; let exIndex = index;">
        <!-- Exercise Card -->
        <div #exerciseCard cdkDrag *ngIf="!exercise.supersetId || isSupersetStart(exIndex)"
          class="transition-all duration-300 relative" [ngClass]="getExerciseClasses(exercise, exIndex)"
          [style.zIndex]="areActionsVisible(exIndex) ? 50 : 'auto'" [attr.data-exercise-index]="exIndex">

          <!-- Ghost element for drop placeholder -->
          <div *cdkDragPlaceholder></div>

          <!-- Superset Indicator Ribbon -->
          <div *ngIf="isSupersetStart(exIndex)"
            class="absolute -left-[5px] top-2 text-white text-xs font-bold px-2 py-1 rounded-md shadow-lg z-10 transform translate-x-0 -translate-y-5"
            [ngClass]="{
            'bg-teal-500 dark:bg-teal-600': isEmom(exIndex),
            'bg-primary dark:bg-primary-dark': !isEmom(exIndex)
          }">
            {{ (isEmom(exIndex) ? 'compactPlayer.emom' : 'compactPlayer.superset') | translate}}
          </div>

          <!-- Exercise Header -->
          <div (click)="toggleExerciseExpansion(exIndex)"
            class="py-2 px-1 my-1 flex-col items-center justify-between cursor-pointer hover:bg-gray-100/50 dark:hover:bg-gray-700/50 hover:rounded-md">
            <div class="flex-col justify-start items-start space-x-3 min-w-0">
              <div class="flex items-start">
                <div cdkDragHandle class="cursor-move pr-2">
                  <app-icon name="reorder" class="h-6 w-6 text-gray-400"></app-icon>
                </div>
                <h2
                  class="max-w-[200px] sm:max-w-[250px] text-md font-semibold text-gray-800 dark:text-gray-100 text-wrap">
                  {{ getExerciseDisplayIndex(exIndex)}} -
                  <ng-container *ngIf="isSuperSet(exIndex)">{{ getSupersetDisplayName(exercise.supersetId!)
                    }}</ng-container>
                  <ng-container *ngIf="!isSuperSet(exIndex)">{{ exercise.exerciseName }}</ng-container>
                </h2>
              </div>
              <div class="px-5 flex items-center text-black dark:text-gray-400 text-sm"
                *ngIf="expandedExerciseIndex() !== exIndex">
                {{ (isSuperSet(exIndex) ? 'compactPlayer.rounds' : 'compactPlayer.sets') | translate }}: {{
                getExerciseTotalLoggedSets(exIndex) + '/' +
                getExerciseTotalSets(exIndex)}}
              </div>
            </div>
            <!-- Exercise Notes Textarea -->
            <div *ngIf="expandedExerciseNotes() === (exIndex)" class="flex py-2 w-full">
              <textarea [ngModel]="getInitialExerciseNoteInputValue(exIndex)"
                (change)="updateExerciseNotes(exIndex, $event)"
                [placeholder]="'compactPlayer.notesPlaceholder' | translate"
                class="w-full text-xs bg-inherit dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-md p-1.5 focus:ring-primary-dark focus:border-primary-dark dark:text-gray-200"></textarea>
            </div>

            <!-- Action Menu Container -->
            <div class="absolute top-2 right-2 z-60">
              <div class="relative">
                <div class="flex">
                  <button appBumpClick (click)="toggleExerciseNotes(exIndex, $event)"
                    [title]="'compactPlayer.toggleNotes' | translate"
                    class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-500 rounded-full focus:outline-none flex items-center p-2">
                    <app-icon name="clipboard-list" class="h-6 w-6"></app-icon>
                  </button>
                  <button appBumpClick (click)="toggleActionMenu(exIndex, $event)"
                    class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-500 rounded-full focus:outline-none flex items-center">
                    <app-icon name="menu-action" class="h-8 w-8"></app-icon>
                  </button>
                </div>
                <app-action-menu [isVisible]="activeActionMenuIndex() === exIndex && getMenuMode()  !== 'compact'"
                  [modalTitle]="''" class="action-menu-container" [displayMode]="getMenuMode()"
                  [items]="compactActionItemsMap().get(exIndex)!" (itemClick)="handleActionMenuItemClick($event)"
                  (closeMenu)="closeActionMenu()">
                </app-action-menu>
              </div>
            </div>
            <app-action-menu [isVisible]="activeActionMenuIndex() === exIndex && getMenuMode() === 'compact'"
              [modalTitle]="''" class="action-menu-container" [displayMode]="getMenuMode()"
              [items]="compactActionItemsMap().get(exIndex)!" (itemClick)="handleActionMenuItemClick($event)"
              (closeMenu)="closeActionMenu()">
            </app-action-menu>
          </div>

          <!-- Sets Container -->
          <div *ngIf="expandedExerciseIndex() === exIndex"
            class="bg-gray-100 dark:bg-gray-700/50 pt-2 pb-3 px-1 border-t border-gray-200 dark:border-gray-700 rounded-b-md">

            <!-- Sets List -->
            <div class="space-y-3">

              <!-- CASE 1: Standard Exercise (Not a Superset) -->
              <ng-container *ngIf="!isSuperSet(exIndex)">
                <ng-container *ngFor="let set of exercise.sets; let setIndex = index">


                  <!-- START: Set Card Layout -->
                  <div [attr.data-set-index]="setIndex" #setCard [ngClass]="getSetClasses(exIndex, setIndex, set)">
                    <!-- Set Header (Always visible, now clickable) -->

                    <div class="flex items-center gap-3 p-1 cursor-pointer"
                      (click)="toggleSetExpansion(exIndex, setIndex, $event)">
                      <!-- Set Number -->
                      <div class="flex-shrink-0 w-8 text-center">
                        <span class="font-bold text-lg text-gray-700 dark:text-gray-200">#{{ setIndex + 1 }}</span>
                      </div>

                      <!-- Summary for collapsed view -->
                      <div class="flex-1 text-sm text-gray-700 dark:text-gray-200 font-medium truncate"
                        *ngIf="!isSetExpanded(exIndex, setIndex)">
                        {{ getSetSummary(exIndex, setIndex) }}

                        <ng-container *ngIf="!isSetCompleted(exIndex, setIndex)">
                          <span *ngIf="setIndex === findFirstIncompleteSetIndex(exIndex)"
                            class="inline-flex items-center gap-1 rounded-full bg-yellow-100 dark:bg-yellow-900/70 px-2 py-1 text-xs font-medium text-yellow-800 dark:text-yellow-300 animate-pulse">
                            <app-icon name="target" class="h-4 w-4"></app-icon>
                            {{ 'compactPlayer.nextUp' | translate }}
                          </span>
                          <span *ngIf="setIndex !== findFirstIncompleteSetIndex(exIndex)"
                            class="inline-flex items-center gap-1 rounded-full bg-gray-200 dark:bg-gray-700 px-2 py-1 text-xs font-medium text-gray-600 dark:text-gray-400">
                            {{ 'compactPlayer.pending' | translate }}
                          </span>
                        </ng-container>
                        <p *ngIf="isSetWarmup(exIndex, setIndex)" class="font-bold">
                          {{ 'compactPlayer.warmupSet' | translate }}
                        </p>
                      </div>

                      <!-- Placeholder text for expanded view -->
                      <div class="flex-1 text-xs text-black dark:text-gray-300"
                        *ngIf="isSetExpanded(exIndex, setIndex)">
                        {{ (isSetCompleted(exIndex, setIndex)? 'compactPlayer.loggedPerformance' :
                        'compactPlayer.logPerformance' ) | translate}}:
                        <p *ngIf="isSetCompleted(exIndex, setIndex)" class="italic font-bold">{{
                          'compactPlayer.markAsUndone' | translate }}</p>
                        <p *ngIf="isSetWarmup(exIndex, setIndex)" class="font-bold">
                          {{ 'compactPlayer.warmupSet' | translate }}
                        </p>
                      </div>

                      <!-- Set actions - STANDARD SET -->
                      <div *ngIf="isSetExpanded(exIndex,setIndex)"
                        class="flex-shrink-0 flex flex-col items-center justify-center gap-1">
                        <div *ngIf="!isSetCompleted(exIndex, setIndex)" class="flex items-center">
                          <button appBumpClick (click)="toggleSetNotes(exIndex, setIndex, $event)"
                            class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center"><app-icon
                              name="clipboard-list"
                              class="h-6 w-6 text-gray-500 dark:text-gray-400"></app-icon></button>

                          <!-- START: ADD THIS NEW BUTTON -->
                          <button appBumpClick (click)="openRestModal(exIndex, setIndex, $event)"
                            [title]="'compactPlayer.rest' | translate"
                            class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center">
                            <app-icon name="rest" class="h-6 w-6 text-gray-500 dark:text-gray-400"></app-icon>
                          </button>
                          <!-- END: ADD THIS NEW BUTTON -->

                          <button appBumpClick (click)="removeSet(exIndex, setIndex)"
                            class="p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-600/50 flex items-center"><app-icon
                              name="trash" class="h-6 w-6 text-red-500" [strokeWidth]="2"></app-icon></button>
                        </div>
                      </div>

                      <!-- RIGHT Quick Complete Button -->
                      <button *ngIf="!isTimedSet(exIndex, setIndex) && !isSetExpanded(exIndex, setIndex)"
                        (click)="toggleSetCompletion(exercise, set, exIndex, setIndex, 0); $event.stopPropagation()"
                        [disabled]="!isSetDataValid(exIndex, setIndex)"
                        class="h-10 w-10 rounded-full flex items-center justify-center transition-all duration-200 ease-in-out transform active:scale-90 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none complete-set-button-animated"
                        [ngClass]="isSetCompleted(exIndex, setIndex, 0) ? 'bg-green-500 text-white shadow-lg' : 'bg-gray-200 dark:bg-gray-700 text-white'">
                        <app-icon name="done" class="h-6 w-6"></app-icon>
                      </button>

                      <div *ngIf="isTimedSet(exIndex, setIndex) && !isSetCompleted(exIndex, setIndex)"
                        class="flex items-center gap-2 text-white font-semibold">
                        <!-- Timer Display -->
                        <span class="text-lg font-mono text-gray-800 dark:text-gray-100 w-14 text-center">
                          {{ formatSecondsToTime(getSetTimerState(exIndex, setIndex).remainingTime) }}
                        </span>
                        <!-- Play/Pause Button -->
                        <button appBumpClick (click)="handleSetTimerAction(exIndex, setIndex, $event)"
                          class="h-10 w-10 rounded-full flex items-center justify-center transition-all duration-200 ease-in-out transform active:scale-90 focus:outline-none"
                          [ngClass]="getSetTimerButtonClass(exIndex, setIndex)">
                          <app-icon [name]="getSetTimerButtonIcon(exIndex, setIndex)" class="h-6 w-6"></app-icon>
                        </button>
                      </div>

                      <!-- Completed Indicator BUTTON (Shows for timed sets that are complete) -->
                      <button appBumpClick *ngIf="isTimedSet(exIndex, setIndex) && isSetCompleted(exIndex, setIndex)"
                        (click)="toggleSetCompletion(exercise, set, exIndex, setIndex, 0); $event.stopPropagation()"
                        class="h-10 w-10 rounded-full flex items-center justify-center bg-green-500 text-white shadow-lg transition-transform active:scale-90">
                        <app-icon name="done" class="h-6 w-6"></app-icon>
                      </button>
                    </div>

                    <div
                      *ngIf="isTimedSet(exIndex, setIndex) && getSetTimerState(exIndex, setIndex).status === 'running'"
                      class="relative flex items-center px-2 py-1 mt-2 transition-all">
                      <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4">
                        <div class="bg-teal-400 h-2 rounded-full my-1 mx-1"
                          [style.width.%]="(((performanceInputValues()[exIndex + '-' + setIndex]?.actualDuration ?? set.targetDuration) || 1) - getSetTimerState(exIndex, setIndex).remainingTime) / ((performanceInputValues()[exIndex + '-' + setIndex]?.actualDuration ?? set.targetDuration) || 1) * 100">
                        </div>
                      </div>

                      <app-icon name="duration" class="h-4 w-4 text-teal-500 ml-2" [strokeWidth]="2.5"></app-icon>
                      <button
                        (click)="toggleSetCompletion(exercise, set, exIndex, setIndex, 0); $event.stopPropagation()"
                        [disabled]="!isSetDataValid(exIndex, setIndex)"
                        class="ml-2 px-2 h-10 w-10 rounded-full flex items-center justify-center transition-all duration-200 ease-in-out transform active:scale-90 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none"
                        [ngClass]="isSetCompleted(exIndex, setIndex, 0) ? 'bg-green-500 text-white shadow-lg' : 'bg-gray-200 dark:bg-gray-700 text-white'">
                        <app-icon name="done" class="h-6 w-6"></app-icon>
                      </button>
                    </div>

                    <div *ngIf="isSetExpanded(exIndex, setIndex)">
                      <!-- <div *ngIf="isSetExpanded(exIndex, setIndex)" class="border-t border-white dark:border-gray-600/50"> -->

                      <!-- Set ADD/REMOVE METRICS - STANDARD SET -->
                      <div class="flex-shrink-0 flex flex-col items-center justify-center gap-1">
                        <div *ngIf="!isSetCompleted(exIndex, setIndex) && !getTrueGymMode()" class="flex items-center">
                          <div
                            class="flex w-fit items-center justify-center gap-1 bg-gray-300 dark:bg-gray-900/50 p-1 px-2 rounded-full mt-1">
                            <label
                              class="flex items-center justify-between text-s font-medium text-white dark:text-gray-400">{{
                              'workoutBuilder.set.metrics' | translate }}:</label>
                            <!-- Remove metric button -->
                            <button appBumpClick *ngIf="canRemoveAnyField(exIndex, setIndex)"
                              (click)="promptRemoveField(exIndex, setIndex); $event.stopPropagation()"
                              class="flex items-center gap-1 text-xs font-semibold text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 transition-colors">
                              <app-icon name="minus-circle" class="h-5 w-5"></app-icon>
                            </button>
                            <!-- ADD metric -->
                            <button appBumpClick *ngIf="getFieldsForSet(exIndex, setIndex).hidden.length > 0"
                              (click)="promptAddField(exIndex, setIndex); $event.stopPropagation()"
                              class="flex items-center gap-1 text-xs font-semibold text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 p-1 rounded-full hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors">
                              <app-icon name="plus-circle" class="h-5 w-5"></app-icon>
                            </button>
                          </div>
                        </div>
                        <div *ngIf="getSetType(exIndex, setIndex)" class="flex justify-start w-full">
                          <div class="w-full px-1">
                            <label [for]="'setType-exp-' + exIndex + '-' + setIndex"
                              class="block text-s font-medium text-gray-600 dark:text-gray-400">{{
                              'workoutBuilder.set.type' | translate }}</label>
                            <select [id]="'setType-exp-' + exIndex + '-' + setIndex"
                              [disabled]="isSetCompleted(exIndex, setIndex)" [ngModel]="getSetType(exIndex, setIndex)"
                              (ngModelChange)="updateSetType(exIndex, setIndex, $event)"
                              class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed"
                              [ngClass]="{'disabled-div-lower-opacity': isSetCompleted(exIndex, setIndex)}">
                              <option *ngFor="let typeOpt of availableSetTypes" [value]="typeOpt.value">{{ typeOpt.label
                                }}</option>
                            </select>
                          </div>
                        </div>
                      </div>

                      <!-- Inputs Grid -->
                      <div class="grid grid-cols-2 gap-x-4 gap-y-2 p-1"
                        [ngClass]="{'disabled-div-lower-opacity': isSetCompleted(exIndex, setIndex)}">
                        <ng-container *ngIf="getFieldsForSet(exIndex, setIndex).visible as visibleFields">
                          <!-- Loop through the visible fields in their defined order -->
                          <ng-container
                            *ngFor="let field of (workoutService.getSetFieldOrder(routine()!, exIndex, setIndex) || visibleFields)">
                            <ng-container [ngSwitch]="field">
                              <div *ngSwitchCase="'reps'">
                                <ng-container [ngTemplateOutlet]="repsInputTemplate"
                                  [ngTemplateOutletContext]="{ exIndex: exIndex, setIndex: setIndex, set: set }"></ng-container>
                              </div>
                              <div *ngSwitchCase="'weight'">
                                <ng-container [ngTemplateOutlet]="weightInputTemplate"
                                  [ngTemplateOutletContext]="{ exIndex: exIndex, setIndex: setIndex, set: set }"></ng-container>
                              </div>
                              <div *ngSwitchCase="'distance'">
                                <ng-container [ngTemplateOutlet]="distanceInputTemplate"
                                  [ngTemplateOutletContext]="{ exIndex: exIndex, setIndex: setIndex, set: set }"></ng-container>
                              </div>
                              <div *ngSwitchCase="'duration'">
                                <ng-container [ngTemplateOutlet]="durationInputTemplate"
                                  [ngTemplateOutletContext]="{ exIndex: exIndex, setIndex: setIndex, set: set }"></ng-container>
                              </div>
                              <div *ngSwitchCase="'tempo'">
                                <ng-container [ngTemplateOutlet]="tempoInputTemplate"
                                  [ngTemplateOutletContext]="{ exIndex: exIndex, setIndex: setIndex, set: set }"></ng-container>
                              </div>
                              <!-- <div *ngSwitchCase="'rest'">
                                <ng-container [ngTemplateOutlet]="restInputTemplate"
                                  [ngTemplateOutletContext]="{ exIndex: exIndex, setIndex: setIndex, set: set }"></ng-container>
                              </div> -->
                            </ng-container>
                          </ng-container>

                          <!-- "Add GHOST Field" Button - STANDARD SET -->
                          <div
                            *ngIf="isGhostFieldVisible(exIndex, setIndex)"
                            class="flex items-center justify-center h-full">
                            <button appBumpClick (click)="promptAddField(exIndex, setIndex); $event.stopPropagation()"
                              class="flex items-center justify-center w-full p-2 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-md text-gray-400 hover:bg-gray-200/50 dark:hover:bg-gray-700/50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                              <app-icon name="plus-circle" class="h-5 w-5"></app-icon>
                            </button>
                          </div>
                        </ng-container>
                      </div>
                      <!-- Set Notes Textarea (if visible) -->
                      <div *ngIf="expandedSetNotes() === (exIndex + '-' + setIndex)" class="px-2 pb-1">
                        <textarea [ngModel]="getInitialInputValue(exIndex, setIndex, 'notes')"
                          (change)="updateSetData(exIndex, setIndex, 0, 'notes', $event)"
                          [placeholder]="'compactPlayer.setNotesPlaceholder' | translate"
                          class="w-full text-xs bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-md p-1.5 focus:ring-primary-dark focus:border-primary-dark dark:text-gray-200"></textarea>
                      </div>

                      <!-- LOWER EXPANDED SET COMPLETE BUTTON -->
                      <div class="flex justify-center py-2">
                        <button *ngIf="!isTimedSet(exIndex, setIndex)"
                          (click)="toggleSetCompletion(exercise, set, exIndex, setIndex, 0); $event.stopPropagation()"
                          [disabled]="!isSetDataValid(exIndex, setIndex)"
                          class="py-2 px-4 rounded-full flex items-center font-semibold justify-center transition-all duration-200 ease-in-out transform active:scale-90 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none complete-set-button-animated"
                          [ngClass]="isSetCompleted(exIndex, setIndex, 0) ? 'bg-green-500 text-white shadow-lg' : 'bg-gray-200 dark:bg-gray-700 text-white border-2 border-gray-200 dark:border-gray-100'"><app-icon
                            name="done" class="h-6 w-6 mr-1"></app-icon>
                          <span>
                            {{(isSetCompleted(exIndex, setIndex, 0) ? 'compactPlayer.completedSet' : 'compactPlayer.completeSet') | translate}}
                          </span>
                        </button>
                      </div>

                    </div>
                    <!-- END: Set Card Layout -->

                  </div>

                </ng-container>
                <!-- Col 2: Set +/- Buttons STANDAR SET -->
                <div class="flex items-center justify-center">
                  <div
                    class="flex w-fit items-center justify-center gap-1 bg-gray-300 dark:bg-gray-900/50 p-1 px-2 rounded-full">
                    <label class="flex items-center justify-between text-s font-medium text-white dark:text-gray-400">{{
                      'compactPlayer.setLabel' | translate }}:</label>
                    <button appBumpClick type="button" (click)="removeSet(exIndex, -1)"
                      class="flex items-center gap-1 text-xs font-semibold text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 transition-colors"
                      [aria-label]="'compactPlayer.removeLastSet' | translate">
                      <app-icon name="minus-circle" class="h-5 w-5"></app-icon>
                    </button>
                    <button appBumpClick type="button" (click)="addSet(exIndex, 'standard'); $event.stopPropagation()"
                      class="flex items-center gap-1 text-xs font-semibold text-green-500 hover:text-green-700 dark:text-green-400 dark:hover:text-green-300 p-1 rounded-full hover:bg-green-100 dark:hover:bg-green-900/50 transition-colors"
                      [aria-label]="'compactPlayer.addSet' | translate">
                      <app-icon name="plus-circle" class="h-5 w-5"></app-icon>
                    </button>
                  </div>
                </div>

              </ng-container>

              <!-- CASE 2: Superset (uses a similar card logic for each exercise within the round) -->
              <ng-container *ngIf="isSupersetStart(exIndex)">
                <ng-container *ngFor="let roundSet of exercise.sets; let roundIndex = index">
                  <div #roundCard [attr.data-round-index]="roundIndex" [ngClass]="getRoundClasses(exIndex, roundIndex)">
                    <!-- Round Header -->
                    <div (click)="toggleRoundExpansion(exIndex, roundIndex, $event)"
                      class="flex items-center justify-between p-1 cursor-pointer">

                      <div class="flex items-start gap-2">
                        <!-- <app-icon name="chevron-down" class="h-5 w-5 transition-transform duration-200 flex-shrink-0"
                          [class.rotate-180]="isRoundExpanded(exIndex, roundIndex)"></app-icon> -->
                        <h4 class="text-sm font-bold text-gray-700 dark:text-gray-100">{{ 'compactPlayer.roundHeader' |
                          translate:{number: roundIndex + 1} }}</h4>
                        <div *ngIf="!isRoundExpanded(exIndex, roundIndex)">
                          <div (click)="$event.stopPropagation()">
                            <ng-container *ngIf="!isRoundCompleted(exIndex, roundIndex)">
                              <span *ngIf="roundIndex === findFirstIncompleteRoundIndex(exIndex)"
                                class="inline-flex items-center gap-1 rounded-full bg-yellow-100 dark:bg-yellow-900/70 px-2 py-1 text-xs font-medium text-yellow-800 dark:text-yellow-300 animate-pulse">
                                <app-icon name="target" class="h-4 w-4"></app-icon>
                                {{ 'compactPlayer.nextUp' | translate }}
                              </span>
                              <span *ngIf="roundIndex !== findFirstIncompleteRoundIndex(exIndex)"
                                class="inline-flex items-center gap-1 rounded-full bg-gray-200 dark:bg-gray-700 px-2 py-1 text-xs font-medium text-gray-600 dark:text-gray-400">
                                {{ 'compactPlayer.pending' | translate }}
                              </span>
                            </ng-container>
                          </div>
                        </div>
                      </div>


                      <div class="flex items-center">
                        <!-- +++ NEW BUTTON/STATUS ELEMENT +++ -->

                        <!-- ROUND NOTES BUTTON -->
                        <button appBumpClick (click)="toggleSetNotes(exIndex, roundIndex, $event)"
                          [title]="'compactPlayer.toggleNotes' | translate"
                          class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-500 rounded-full focus:outline-none flex items-center p-2">
                          <app-icon name="clipboard-list" class="h-6 w-6"></app-icon>
                        </button>

                        <!-- EMOM Controls (for EMOM supersets) -->
                        <div *ngIf="isEmom(exIndex)" class="flex items-center gap-2 text-white font-semibold">
                          <!-- Timer Display (for EMOM) -->
                          <span class="text-lg font-mono text-gray-800 dark:text-gray-100 w-14 text-center">
                            {{ formatSecondsToTime(getEmomState(exIndex, roundIndex).remainingTime) }}
                          </span>
                          <!-- Play/Pause Button (for EMOM) -->
                          <button appBumpClick (click)="handleEmomAction(exIndex, roundIndex); $event.stopPropagation()"
                            [disabled]="getEmomState(exIndex, roundIndex).status === 'completed'"
                            class="h-10 w-10 rounded-full flex items-center justify-center transition-all duration-200 ease-in-out transform active:scale-90 focus:outline-none disabled:opacity-50"
                            [ngClass]="getEmomButtonClass(exIndex, roundIndex)">
                            <app-icon [name]="getEmomButtonIcon(exIndex, roundIndex)" class="h-6 w-6"></app-icon>
                          </button>
                        </div>

                        <!-- Quick Complete Button (for STANDARD supersets) -->
                        <button appBumpClick *ngIf="!isEmom(exIndex)"
                          (click)="completeRoundOrSet(exercise, roundIndex, $event)"
                          class="h-10 w-10 rounded-full flex items-center justify-center transition-all duration-200 ease-in-out transform active:scale-90 focus:outline-none"
                          [ngClass]="isRoundCompleted(exIndex, roundIndex) ? 'bg-green-500 text-white shadow-lg' : 'bg-gray-200 dark:bg-gray-600 text-gray-500 dark:text-gray-300'">
                          <app-icon name="done" class="h-6 w-6"></app-icon>
                        </button>



                        <!-- +++ END NEW BUTTON/STATUS ELEMENT +++ -->
                      </div>
                    </div>
                    <!-- Set Notes Textarea (if visible) -->
                    <div *ngIf="expandedSetNotes() === (exIndex + '-' + roundIndex)" class="px-2 pb-1">
                      <textarea [ngModel]="getInitialInputValue(exIndex, roundIndex, 'notes')"
                        (change)="updateSetData(exIndex, roundIndex, 0,'notes', $event)"
                        [placeholder]="'compactPlayer.roundNotesPlaceholder' | translate"
                        class="w-full text-xs bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-md p-1.5 focus:ring-primary-dark focus:border-primary-dark dark:text-gray-200"></textarea>
                    </div>

                    <!-- Collapsible Round Body -->
                    <ng-container *ngIf="isRoundExpanded(exIndex, roundIndex)">
                      <div *ngIf="isRoundCompleted(exIndex, roundIndex)"
                        class="flex items-start text-xs text-white italic font-bold">{{ 'compactPlayer.markAsUndone' |
                        translate }}</div>



                      <div class="mt-2 space-y-3">
                        <ng-container *ngFor="let ssExercise of getSupersetExercises(exercise.supersetId!)">

                          <ng-container *ngLet="getOriginalExIndex(ssExercise.id) as ssOriginalIndex">
                            <div *ngIf="ssOriginalIndex > -1"
                              class="py-2 px-1 rounded bg-white dark:bg-gray-800 shadow-sm">
                              <div class="flex justify-between">
                                <!-- Exercise Name -->
                                <p class="text-sm font-semibold text-gray-800 dark:text-gray-100 mb-1">
                                  {{ getExerciseDisplayIndex(ssOriginalIndex) }} - {{ ssExercise.exerciseName }}
                                </p>

                                <!-- METRICS BUTTONS FOR SUPERSET -->
                                <!-- <div class="flex items-center justify-center gap-1 px-1">
                                  <button *ngIf="canRemoveAnyField(ssOriginalIndex, roundIndex)"
                                    (click)="promptRemoveField(ssOriginalIndex, roundIndex); $event.stopPropagation()"
                                    class="flex items-center gap-1 text-xs font-semibold text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 transition-colors">
                                    <app-icon name="minus-circle" class="h-5 w-5"></app-icon>
                                  </button>
                                  <button *ngIf="getFieldsForSet(ssOriginalIndex, roundIndex).hidden.length > 0"
                                    (click)="promptAddField(ssOriginalIndex, roundIndex); $event.stopPropagation()"
                                    class="flex items-center gap-1 text-xs font-semibold text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 p-1 rounded-full hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors">
                                    <app-icon name="plus-circle" class="h-5 w-5"></app-icon>
                                  </button>
                                </div> -->
                              </div>



                              <!-- Dynamic Inputs Grid -->
                              <div class="grid grid-cols-2 gap-x-4 gap-y-2"
                                [ngClass]="{'disabled-div-lower-opacity': isRoundCompleted(exIndex, roundIndex)}">

                                <ng-container
                                  *ngIf="getFieldsForSet(ssOriginalIndex, roundIndex).visible as visibleFields">
                                  <!-- Loop through the visible fields in their defined order -->
                                  <ng-container
                                    *ngFor="let field of (workoutService.getSetFieldOrder(routine()!, ssOriginalIndex, roundIndex) || visibleFields)">
                                    <ng-container [ngSwitch]="field">
                                      <div *ngSwitchCase="'reps'">
                                        <ng-container [ngTemplateOutlet]="repsInputTemplate"
                                          [ngTemplateOutletContext]="{ exIndex: ssOriginalIndex, setIndex: roundIndex, set: ssExercise.sets[roundIndex] }"></ng-container>
                                      </div>
                                      <div *ngSwitchCase="'weight'">
                                        <ng-container [ngTemplateOutlet]="weightInputTemplate"
                                          [ngTemplateOutletContext]="{ exIndex: ssOriginalIndex, setIndex: roundIndex, set: ssExercise.sets[roundIndex] }"></ng-container>
                                      </div>
                                      <div *ngSwitchCase="'duration'">
                                        <ng-container [ngTemplateOutlet]="durationInputTemplate"
                                          [ngTemplateOutletContext]="{ exIndex: ssOriginalIndex, setIndex: roundIndex, set: ssExercise.sets[roundIndex] }"></ng-container>
                                      </div>
                                      <div *ngSwitchCase="'tempo'">
                                        <ng-container [ngTemplateOutlet]="tempoInputTemplate"
                                          [ngTemplateOutletContext]="{ exIndex: ssOriginalIndex, setIndex: roundIndex, set: ssExercise.sets[roundIndex] }"></ng-container>
                                      </div>
                                      <!-- <div *ngSwitchCase="'rest'">
                                        <ng-container [ngTemplateOutlet]="restInputTemplate"
                                          [ngTemplateOutletContext]="{ exIndex: ssOriginalIndex, setIndex: roundIndex, set: ssExercise.sets[roundIndex] }"></ng-container>
                                      </div> -->
                                    </ng-container>
                                  </ng-container>

                                  <!-- "Add GHOST Field" Button for 1 or 3 fields - SUPERSET -->
                                  <!-- <div
        *ngIf="!isRoundCompleted(exIndex, roundIndex) && canAddField(ssOriginalIndex, roundIndex) && getFieldsForSet(ssOriginalIndex, roundIndex).visible.length%2===1"
        class="flex items-center justify-center h-full">
        <button (click)="promptAddField(ssOriginalIndex, roundIndex); $event.stopPropagation()"
          class="flex items-center justify-center w-full p-2 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-md text-gray-400 hover:bg-gray-200/50 dark:hover:bg-gray-700/50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
          <app-icon name="plus-circle" class="h-5 w-5"></app-icon>
        </button>
      </div> -->
                                </ng-container>



                              </div>
                            </div>
                          </ng-container>

                        </ng-container>
                      </div>
                    </ng-container>

                  </div>
                </ng-container>
                <!-- Col 2: Set +/- Buttons SUPER SET -->
                <div class="flex items-center justify-center gap-x-2">
                  <label class="text-black dark:text-gray-100">{{ 'compactPlayer.roundLabel' | translate }}</label>
                  <button appBumpClick type="button" (click)="removeSet(exIndex, -1)"
                    class="p-1.5 rounded-full bg-red-200 hover:bg-red-300 text-red-700 disabled:opacity-50 flex items-center"
                    [aria-label]="'compactPlayer.removeLastSet' | translate">
                    <app-icon name="minus-circle" class="h-5 w-5"></app-icon>
                  </button>
                  <button appBumpClick type="button" (click)="addSet(exIndex, 'standard'); $event.stopPropagation()"
                    class="p-1.5 rounded-full bg-green-200 hover:bg-green-300 text-green-700 flex items-center"
                    [aria-label]="'compactPlayer.addSet' | translate">
                    <app-icon name="plus-circle" class="h-5 w-5"></app-icon>
                  </button>
                </div>
              </ng-container>
            </div>
          </div>


        </div>
      </ng-container>

    </div>

    <ng-template #loading>
      <div class="text-center py-10">
        <p class="text-gray-500">{{ 'compactPlayer.loading' | translate }}</p>
      </div>
    </ng-template>
  </main>
  <div class="flex flex-col items-center"
    *ngIf="!routine() || (routine() !== null && routine() !== undefined && (!routine()?.exercises || routine()?.exercises?.length === 0))">
    <h2 class="text-2xl font-semibold text-gray-700 dark:text-gray-200">
      {{ sessionState() === 'error' ? ('compactPlayer.errorLoading' | translate) :
      (currentWorkoutLog().exercises?.length
      === 0 ?
      (routineId === '-1' ? ('compactPlayer.workoutStarted' | translate) : ('compactPlayer.workoutEnded' | translate)) :
      ('compactPlayer.workoutComplete' | translate)) }}
    </h2>
    <p class="text-gray-600 dark:text-gray-400 mt-2" *ngIf="sessionState() !== 'error'">
      {{ currentWorkoutLog().exercises?.length === 0 ? ('compactPlayer.noSetsLogged' | translate) :
      ('compactPlayer.allSetsDone' | translate) }}
    </p>
  </div>
  <!-- Footer with Action Buttons -->
  <div #footerBar class="flex justify-center fixed left-0 right-0 z-20 bottom-0">
    <div
      class="w-full max-w-sm grid grid-cols-2 gap-4 bg-white dark:bg-gray-800/80 dark:backdrop-blur-sm border-t border-x border-gray-200 dark:border-gray-700 p-3 rounded-t-md">

      <button appBumpClick (click)="openAddExerciseModal()"
        class="flex items-center justify-center space-x-2 bg-blue-500 text-white font-semibold py-2 px-4 rounded-full shadow-lg hover:bg-blue-600 transition-colors">
        <app-icon name="plus-circle" class="h-6 w-6"></app-icon>
        <span>{{ 'compactPlayer.addExercise' | translate }}</span>
      </button>

      <button appBumpClick (click)="finishWorkout()"
        [disabled]="!this.currentWorkoutLog() || !this.currentWorkoutLog().exercises || this.currentWorkoutLog().exercises?.length === 0"
        class="flex items-center justify-center space-x-2 bg-green-500 text-white font-semibold py-2 px-4 rounded-full shadow-lg hover:bg-green-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
        <app-icon name="done" class="h-6 w-6"></app-icon>
        <span>{{ 'compactPlayer.finish' | translate }}</span>
      </button>

    </div>
  </div>

  <app-exercise-selection-modal [isOpen]="isAddExerciseModalOpen()" [(searchTerm)]="modalSearchTerm"
    [title]="'compactPlayer.addExerciseTitle' | translate" [exercises]="availableExercises"
    [showCreateCustomLink]="true" itemIconName="plus-circle" itemIconClass="text-primary dark:text-primary-light"
    (exerciseSelected)="selectExerciseToAddFromModal($event)" (createCustomClicked)="handleTrulyCustomExerciseEntry()"
    (close)="closeAddExerciseModal()">
  </app-exercise-selection-modal>

  <app-exercise-selection-modal [isOpen]="isSwitchExerciseModalOpen()" [(searchTerm)]="modalSearchTerm"
    [title]="(isShowingSimilarInSwitchModal() ? 'compactPlayer.similarExercisesTitle' : 'compactPlayer.switchExerciseTitle') | translate"
    [exercises]="exercisesForSwitchModal()" [searchPlaceholder]="'compactPlayer.searchPlaceholder' | translate"
    [showSimilarButton]="true" [isShowingSimilarView]="isShowingSimilarInSwitchModal()" itemIconName="change"
    itemIconClass="text-green-500" (exerciseSelected)="handleExerciseSwitch($event)"
    (findSimilarClicked)="findAndShowSimilarExercises(exerciseToSwitchIndex())"
    (backToSearchClicked)="onBackToSearchFromSimilar()" (close)="closeSwitchExerciseModal()">
  </app-exercise-selection-modal>

  <app-full-screen-rest-timer [isVisible]="isRestTimerVisible()" [mode]="restTimerMode()"
    [mainTimer]="sessionTimerDisplay()" [durationSeconds]="restDuration()" [mainText]="restTimerMainText()"
    [nextUpText]="restTimerNextUpText()" (timerFinished)="handleRestTimerFinished()"
    (timerSkipped)="handleRestTimerSkipped($event)" (stopwatchStopped)="handleStopwatchStopped()"
    (modeChanged)="restTimerMode.set($event)">
  </app-full-screen-rest-timer>

  <!-- Performance Insights Modal -->
  <div *ngIf="isPerformanceInsightsModalOpen()" style="z-index: 100"
    class="fixed inset-0 bg-gray-900/70 dark:bg-black/80 backdrop-blur-md flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out">
    <div *ngIf="insightsData() as data"
      class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-xl max-h-[90vh] flex flex-col overflow-hidden transform transition-all duration-300 ease-in-out">
      <header class="p-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center flex-shrink-0">
        <div class="flex items-center gap-3">
          <app-icon name="chart" class="h-7 w-7 text-primary dark:text-primary-light"></app-icon>
          <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100">{{ 'compactPlayer.insights.title' |
            translate }}</h3>
        </div>
        <button appBumpClick (click)="closePerformanceInsightsModal()"
          class="p-1.5 rounded-full text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700/70 focus:outline-none transition-colors">
          <app-icon name="cancel" class="h-6 w-6"></app-icon>
        </button>
      </header>
      <div class="p-5 overflow-y-auto space-y-6 flex-grow">
        <div class="rounded-md border border-gray-200 dark:border-gray-700/80">
          <button appBumpClick (click)="toggleCompletedSetsForExerciseInfo()" class="w-full flex items-center justify-between p-2 text-left text-sm font-medium text-gray-700
          dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors rounded-t-lg">
            <span class="flex items-center gap-2">
              <app-icon name="clipboard-list" class="h-6 w-6"></app-icon>
              <span>{{ 'compactPlayer.insights.completedSets' | translate:{count:
                data.completedSetsInSession.length} }}</span>
            </span>
            <app-icon name="chevron-down" class="h-5 w-5 transform transition-transform duration-200"
              [ngClass]="{'rotate-180': showCompletedSetsForExerciseInfo()}"></app-icon>
          </button>
          <div *ngIf="showCompletedSetsForExerciseInfo()"
            class="bg-gray-50 dark:bg-gray-700/30 p-3 border-t border-gray-200 dark:border-gray-700/80 space-y-3 max-h-48 overflow-y-auto rounded-b-lg">
            <div *ngFor="let setLog of data.completedSetsInSession; let i = index"
              class="text-xs p-2 bg-white dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600">
              <p class="font-semibold text-gray-700 dark:text-gray-200 mb-1">
                {{ 'compactPlayer.setLabel' | translate }} #{{ i + 1 }}:
              </p>
              <div class="grid grid-cols-2 gap-x-2 gap-y-1 text-gray-600 dark:text-gray-300">
                <span *ngIf="setLog.repsLogged">{{ 'compactPlayer.repsLabel' | translate }}: <strong
                    class="dark:text-gray-100">{{ setLog.repsLogged
                    }}</strong></span>
                <span *ngIf="setLog.weightLogged != null">{{ 'compactPlayer.weightLabel' | translate:{unit: ''} }}:
                  <strong class="dark:text-gray-100">{{ setLog.weightLogged
                    |
                    weightUnit }}</strong></span>
                <span *ngIf="setLog.distanceLogged">{{ 'compactPlayer.distanceLabel' | translate }}: <strong
                    class="dark:text-gray-100">{{
                    setLog.distanceLogged }} km</strong></span>
                <span *ngIf="setLog.durationLogged">{{ 'compactPlayer.timeLabel' | translate }}: <strong
                    class="dark:text-gray-100">{{
                    formatSecondsToTime(setLog.durationLogged) }}</strong></span>
              </div>
            </div>
            <div *ngIf="data.completedSetsInSession.length === 0"
              class="p-3 text-xs text-center text-gray-500 dark:text-gray-400">
              {{ 'compactPlayer.insights.noSetsCompleted' | translate }}
            </div>
          </div>
        </div>
        <div class="rounded-md border border-gray-200 dark:border-gray-700/80">
          <div class="p-3 text-sm font-medium text-gray-700 dark:text-gray-300">
            <span class="flex items-center gap-2">
              <app-icon name="calendar-page" class="h-6 w-6"></app-icon>
              <span>{{ 'compactPlayer.insights.lastPerformance' | translate:{date:
                (data.lastPerformance?.lastPerformedDate
                | date:'shortDate')} }}</span>
            </span>
          </div>
          <div *ngIf="data.lastPerformance as lastPerf"
            class="bg-gray-50 dark:bg-gray-700/30 p-3 border-t border-gray-200 dark:border-gray-700/80 space-y-3 max-h-48 overflow-y-auto rounded-b-lg">
            <div *ngFor="let setLog of lastPerf.sets; let i = index"
              class="text-xs p-2 bg-white dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600">
              <p class="font-semibold text-gray-700 dark:text-gray-200 mb-1">{{ 'compactPlayer.setLabel' | translate }}
                #{{ i + 1 }}:</p>
              <div class="grid grid-cols-2 gap-x-2 gap-y-1 text-gray-600 dark:text-gray-300">
                <span *ngIf="setLog.repsLogged">{{ 'compactPlayer.repsLabel' | translate }}: <strong
                    class="dark:text-gray-100">{{ setLog.repsLogged
                    }}</strong></span>
                <span *ngIf="setLog.weightLogged != null">{{ 'compactPlayer.weightLabel' | translate:{unit: ''} }}:
                  <strong class="dark:text-gray-100">{{ setLog.weightLogged
                    |
                    weightUnit }}</strong></span>
                <span *ngIf="setLog.distanceLogged">{{ 'compactPlayer.distanceLabel' | translate }}: <strong
                    class="dark:text-gray-100">{{
                    setLog.distanceLogged }} km</strong></span>
                <span *ngIf="setLog.durationLogged">{{ 'compactPlayer.timeLabel' | translate }}: <strong
                    class="dark:text-gray-100">{{
                    formatSecondsToTime(setLog.durationLogged) }}</strong></span>
              </div>
            </div>
          </div>
          <div *ngIf="!data.lastPerformance"
            class="p-3 text-xs text-center text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700/80 rounded-b-lg">
            {{ 'compactPlayer.insights.noPreviousPerformance' | translate }}
          </div>
        </div>
        <div class="rounded-md border border-gray-200 dark:border-gray-700/80">
          <div class="p-3 text-sm font-medium text-gray-700 dark:text-gray-300">
            <span class="flex items-center gap-2">
              <app-icon name="pb" class="h-6 w-6 text-yellow-500"></app-icon>
              <span>{{ 'compactPlayer.insights.personalBests' | translate }}</span>
            </span>
          </div>
          <div *ngIf="data.personalBests.length > 0"
            class="bg-gray-50 dark:bg-gray-700/30 p-3 border-t border-gray-200 dark:border-gray-700/80 grid grid-cols-1 sm:grid-cols-2 gap-3 rounded-b-lg">
            <div *ngFor="let pb of data.personalBests"
              class="text-xs p-2 bg-white dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600">
              <p class="font-semibold text-gray-700 dark:text-gray-200">{{ pb.pbType }}</p>
              <p class="text-lg font-bold text-primary dark:text-primary-light">{{ formatPbValue(pb) }}</p>
              <p class="text-2xs text-gray-500 dark:text-gray-400">{{ 'compactPlayer.insights.onDate' |
                translate:{date: (pb.timestamp | date:'shortDate')} }}</p>
            </div>
          </div>
          <div *ngIf="data.personalBests.length === 0"
            class="p-3 text-xs text-center text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700/80 rounded-b-lg">
            {{ 'compactPlayer.insights.noPBs' | translate }}
          </div>
        </div>
      </div>
      <footer
        class="p-4 bg-gray-50 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 text-right flex-shrink-0">
        <button appBumpClick (click)="closePerformanceInsightsModal()"
          class="inline-flex items-center bg-primary hover:bg-primary-dark focus:ring-4 focus:ring-primary-focus text-white font-semibold py-2.5 px-6 rounded-md text-sm transition-colors shadow-md hover:shadow-lg">
          <app-icon name="done" class="h-7 w-7 mr-1"></app-icon>
          {{ 'compactPlayer.insights.done' | translate }}
        </button>
      </footer>
    </div>
  </div>
</div>

<!-- Rest Time Editor Modal -->
<div *ngIf="isRestModalVisible() && activeRestModalContext() as context" (click)="closeRestModal()"
  class="fixed inset-0 bg-gray-900/70 dark:bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50 transition-opacity duration-300 ease-in-out">
  <div (click)="$event.stopPropagation()"
    class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-xs p-4 flex flex-col transform transition-all duration-300 ease-in-out">
    <!-- Modal Header -->
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100">{{ 'compactPlayer.rest' | translate }}</h3>
      <button appBumpClick (click)="closeRestModal()"
        class="flex items-center p-2 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700">
        <app-icon name="cancel" class="h-6 w-6"></app-icon>
      </button>
    </div>

    <!-- Modal Body: Use the template here -->
    <div class="flex-grow">
      <ng-container [ngTemplateOutlet]="restInputTemplate"
        [ngTemplateOutletContext]="{ exIndex: context.exIndex, setIndex: context.setIndex, set: null }">
      </ng-container>
    </div>

    <!-- Modal Footer -->
    <div class="mt-6 text-right flex justify-center">
      <button appBumpClick (click)="closeRestModal()"
        class="w-fit inline-flex justify-center bg-primary hover:bg-primary-dark focus:ring-4 focus:ring-primary-focus text-white font-semibold py-2.5 px-6 rounded-md text-sm transition-colors shadow-md hover:shadow-lg">
        <app-icon name="done" class="h-5 w-5 mr-1"></app-icon>
        {{ 'compactPlayer.insights.done' | translate }}
      </button>
    </div>
  </div>
</div>


<div class="modal-overlay" *ngIf="isCalculatorModalVisible">
  <app-barbell-calculator-modal (close)="closeCalculatorModal()"></app-barbell-calculator-modal>
</div>

<app-session-overview-modal [isOpen]="isSessionOverviewVisible()" [routineSignal]="routine"
  [loggedExercisesSignal]="currentWorkoutLogExercises"
  [activeExerciseId]="routine()?.exercises?.[expandedExerciseIndex() ?? -1]?.id"
  [activeSetIndex]="findFirstIncompleteSetIndex(expandedExerciseIndex() ?? -1)"
  [activeBlockRound]="isSupersetStart(expandedExerciseIndex() ?? -1) ? findFirstIncompleteRoundIndex(expandedExerciseIndex() ?? -1) : -1"
  (close)="closeSessionOverviewModal()">
</app-session-overview-modal>


<!-- =================================================================== -->
<!-- NG-TEMPLATES for Reusable Set Inputs -->
<!-- =================================================================== -->


<!-- TEMPO INPUT TEMPLATE -->
<ng-template #tempoInputTemplate let-exIndex="exIndex" let-setIndex="setIndex" let-set="set">
  <div>
    <div class="flex items-center justify-center text-gray-500 dark:text-gray-300 ">
      <app-icon name="tempo" class="h-4 w-4 mr-1"></app-icon>
      <label class="text-xs font-medium py-1">
        {{ 'compactPlayer.tempoLabel' | translate }}
      </label>
    </div>
    <input type="text" [ngModel]="getInitialInputValue(exIndex, setIndex, metricEnum.tempo)"
      (change)="updateSetData(exIndex, setIndex, 0, metricEnum.tempo, $event)" placeholder="e.g. 4010"
      class="w-full p-1 text-center bg-gray-100 dark:bg-gray-700 rounded-md text-black dark:text-gray-200">
    <div *ngIf="getSetTargetDisplay(exIndex, setIndex, metricEnum.tempo) as target" class="target-class text-xs">
      <span class="flex items-center justify-center">
        <app-icon name="target" class="h-3 w-3 mr-0.5"></app-icon>{{ target }}
      </span>
    </div>
  </div>
</ng-template>

<!-- REUSABLE INCREMENTER INPUT TEMPLATE -->
<ng-template #incrementerInputTemplate let-exIndex="exIndex" let-setIndex="setIndex" let-field="field" let-label="label"
  let-target="target">
  <div>
    <!-- Label part (unchanged) -->
    <div class="flex items-center justify-center text-gray-500 dark:text-gray-300">
      <app-icon [name]="field" class="h-4 w-4 mr-1"></app-icon>
      <label class="text-xs font-medium py-1">{{ label }}</label>
    </div>

    <!-- Main input group container -->
    <div class="flex items-stretch w-full shadow-sm">

      <!-- Column 1: Decrement Button -->
      <button appBumpClick type="button" appPress (shortPress)="onShortPressDecrement(exIndex, setIndex, field)"
        (longPress)="onLongPressDecrement(exIndex, setIndex, field)" (pressRelease)="onPressRelease()"
        class="flex items-center px-3 py-2 bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-l-xl border-y border-l border-gray-300 dark:border-gray-700 transition-colors">
        <app-icon name="minus" class="h-5 w-5 pointer-events-none"></app-icon>
      </button>

      <!-- Column 2: The Input and its Target, stacked vertically -->
      <div class="relative flex flex-col flex-grow">
        <!-- Input Field -->
        <div class="flex items-center justify-center bg-gray-300 dark:bg-gray-700">
          <input [type]="(field === metricEnum.duration || field === metricEnum.rest) ? 'text' : 'number'"
            [ngModel]="getInitialInputValue(exIndex, setIndex, field)"
            (change)="updateSetData(exIndex, setIndex, 0, field, $event)"
            class="w-full p-1 mt-1 text-center text-lg font-bold bg-gray-50 dark:bg-gray-800 border-y border-gray-50 dark:border-gray-800 text-black dark:text-gray-200 focus:ring-2 focus:ring-primary dark:focus:ring-primary-light focus:outline-none focus:z-10 relative rounded-md">

        </div>

        <!-- Target Display (now correctly aligned under the input) -->
        <div *ngIf="target && target !== '' && target !== '-'"
          class="relative z-0 bottom-0 w-full bg-gray-300 dark:bg-gray-700 border-gray-300 dark:border-gray-700">
          <span
            class="flex items-center justify-center gap-1 py-0.5 text-white dark:text-gray-100 text-xs font-semibold">
            <app-icon name="target" class="h-3 w-3"></app-icon>
            <span>
              {{ (field === metricEnum.duration || field === metricEnum.rest) ? formatSecondsToTime(target) : target }}
            </span>
          </span>
        </div>
      </div>

      <!-- Column 3: Increment Button -->
      <button appBumpClick type="button" appPress (shortPress)="onShortPressIncrement(exIndex, setIndex, field)"
        (longPress)="onLongPressIncrement(exIndex, setIndex, field)" (pressRelease)="onPressRelease()"
        class="flex items-center px-3 py-2 bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-r-xl border-y border-r border-gray-300 dark:border-gray-700 transition-colors">
        <app-icon name="plus" class="h-5 w-5 pointer-events-none"></app-icon>
      </button>
    </div>
  </div>
</ng-template>

<!-- WEIGHT INPUT TEMPLATE -->
<ng-template #weightInputTemplate let-exIndex="exIndex" let-setIndex="setIndex" let-set="set">
  <ng-container [ngTemplateOutlet]="incrementerInputTemplate" [ngTemplateOutletContext]="{
      exIndex: exIndex,
      setIndex: setIndex,
      field: metricEnum.weight,
      label: ('compactPlayer.weightLabel' | translate:{unit: unitsService.getWeightUnitSuffix()}),
      target: getSetTargetDisplay(exIndex, setIndex, metricEnum.weight) + unitsService.getWeightUnitSuffix()
    }">
  </ng-container>
</ng-template>

<!-- REPS INPUT TEMPLATE  -->
<ng-template #repsInputTemplate let-exIndex="exIndex" let-setIndex="setIndex" let-set="set">
  <ng-container [ngTemplateOutlet]="incrementerInputTemplate" [ngTemplateOutletContext]="{
      exIndex: exIndex,
      setIndex: setIndex,
      field: metricEnum.reps,
      label: ('compactPlayer.repsLabel' | translate),
      target: 'x' + getSetTargetDisplay(exIndex, setIndex, metricEnum.reps)
    }">
  </ng-container>
</ng-template>

<!-- DISTANCE INPUT TEMPLATE -->
<ng-template #distanceInputTemplate let-exIndex="exIndex" let-setIndex="setIndex" let-set="set">
  <ng-container [ngTemplateOutlet]="incrementerInputTemplate" [ngTemplateOutletContext]="{
      exIndex: exIndex,
      setIndex: setIndex,
      field: metricEnum.distance,
      label: ('compactPlayer.distanceLabel' | translate),
      target: getSetTargetDisplay(exIndex, setIndex, metricEnum.distance) + unitsService.getDistanceMeasureUnitSuffix()
    }">
  </ng-container>
</ng-template>

<!-- DURATION INPUT TEMPLATE -->
<ng-template #durationInputTemplate let-exIndex="exIndex" let-setIndex="setIndex" let-set="set">
  <ng-container [ngTemplateOutlet]="incrementerInputTemplate" [ngTemplateOutletContext]="{
      exIndex: exIndex,
      setIndex: setIndex,
      field: metricEnum.duration,
      label: ('compactPlayer.timeLabel' | translate),
      target: getSetTargetDisplay(exIndex, setIndex, metricEnum.duration)
    }">
  </ng-container>
</ng-template>

<!-- REST INPUT TEMPLATE -->
<ng-template #restInputTemplate let-exIndex="exIndex" let-setIndex="setIndex" let-set="set">
  <ng-container [ngTemplateOutlet]="incrementerInputTemplate" [ngTemplateOutletContext]="{
      exIndex: exIndex,
      setIndex: setIndex,
      field: metricEnum.rest,
      label: ('compactPlayer.rest' | translate),
      target: getSetTargetDisplay(exIndex, setIndex, metricEnum.rest)
    }">
  </ng-container>
</ng-template>
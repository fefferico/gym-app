<div class="compact-player-container bg-gray-100 dark:bg-gray-900 min-h-screen">
  <!-- Header -->
  <header #header
    class="sticky top-0 z-20 bg-white dark:bg-gray-800 shadow-md px-3 pt-3 pb-2 flex flex-col justify-between rounded-b-md">

    <!-- Top part of header -->
    <div class="flex items-center justify-between w-full">
      <button (click)="goBack()"
        class="p-2 text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light">
        <app-icon name="cancel" class="h-6 w-6"></app-icon>
      </button>
      <div class="text-center">
        <h1 class="text-lg font-bold text-gray-800 dark:text-gray-100 truncate max-w-xs">
          {{ routine()?.name || ('compactPlayer.defaultWorkoutName' | translate) }}
        </h1>
        <div class="flex-col text-xl font-mono font-semibold text-primary dark:text-primary-light tracking-wider">
          {{ sessionTimerDisplay() }}
          <p>{{ sessionState() === 'paused' ? ('compactPlayer.paused' | translate):''}}</p>
        </div>
      </div>
      <!-- MODIFIED: Container for Pause/Resume and Notes buttons -->
      <div class="relative flex items-center">
        <button (click)="toggleMainSessionActionMenu($event)"
          class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-500 rounded-full focus:outline-none flex items-center">
          <app-icon name="menu-action" class="h-10 w-10"></app-icon>
        </button>
        <!-- The separate pause/resume button is now inside the action menu -->
        <button *ngIf="sessionState() === 'paused'" (click)="resumeSession()" class="p-2">
          <app-icon name="play" class="h-6 w-6 text-primary dark:text-primary-light animate-pulse"></app-icon>
        </button>
        <app-action-menu [isVisible]="mainSessionActionMenuOpened() === true && getMenuMode() !== 'compact'"
          class="action-menu-container" [modalTitle]="''" [displayMode]="getMenuMode()" [modalTitle]="''"
          [items]="mainSessionActionItems()" (itemClick)="handleMainSessionActionMenuItemClick($event)"
          (closeMenu)="toggleMainSessionActionMenu(null)">
        </app-action-menu>
      </div>
    </div>
    <app-action-menu [isVisible]="mainSessionActionMenuOpened() === true && getMenuMode() === 'compact'"
      class="action-menu-container" [modalTitle]="''" [displayMode]="getMenuMode()" [modalTitle]="''"
      [items]="mainSessionActionItems()" (itemClick)="handleMainSessionActionMenuItemClick($event)"
      (closeMenu)="toggleMainSessionActionMenu(null)">
    </app-action-menu>

    <!-- Workout Progress Bar -->
    <div class="w-full mt-2">
      <span class="flex justify-center text-primary-light font-mono">{{ 'compactPlayer.overallProgress' | translate
        }}</span>
      <div class="progress-bar-container w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 relative">
        <div class="progress-bar bg-primary h-3 rounded-full" [style.width.%]="workoutProgress()"></div>
        <span class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-white">
          {{ workoutProgress() | number:'1.0-0' }}%
        </span>
      </div>
    </div>
  </header>



  <!-- Main Content: Exercises List -->
  <main class="pt-5 px-1 pb-36">
    <div *ngIf="routine() as currentRoutine; else loading" cdkDropList [cdkDropListData]="currentRoutine.exercises"
      (cdkDropListDropped)="onExerciseDrop($event)" class="">
      <ng-container *ngFor="let exercise of currentRoutine.exercises; let exIndex = index;">
        <!-- Exercise Card -->
        <div #exerciseCard cdkDrag *ngIf="!exercise.supersetId || isSupersetStart(exIndex)"
          class="transition-all duration-300 relative" [ngClass]="getExerciseClasses(exercise, exIndex)"
          [style.zIndex]="areActionsVisible(exIndex) ? 50 : 'auto'" [attr.data-exercise-index]="exIndex">

          <!-- Ghost element for drop placeholder -->
          <div *cdkDragPlaceholder></div>

          <!-- Superset Indicator Ribbon -->
          <div *ngIf="isSupersetStart(exIndex)"
            class="absolute -left-[5px] top-2 text-white text-xs font-bold px-2 py-1 rounded-md shadow-lg z-10 transform translate-x-0 -translate-y-5"
            [ngClass]="{
            'bg-teal-500 dark:bg-teal-600': isEmom(exIndex),
            'bg-primary dark:bg-primary-dark': !isEmom(exIndex)
          }">
            {{ (isEmom(exIndex) ? 'compactPlayer.emom' : 'compactPlayer.superset') | translate}}
          </div>

          <!-- Exercise Header -->
          <div (click)="toggleExerciseExpansion(exIndex)"
            class="py-2 px-1 my-1 flex-col items-center justify-between cursor-pointer hover:bg-gray-100/50 dark:hover:bg-gray-700/50 hover:rounded-md">
            <div class="flex-col justify-start items-start space-x-3 min-w-0">
              <div class="flex items-start">
                <div cdkDragHandle class="cursor-move pr-2">
                  <app-icon name="reorder" class="h-6 w-6 text-gray-400"></app-icon>
                </div>
                <h2
                  class="max-w-[200px] sm:max-w-[250px] text-md font-semibold text-gray-800 dark:text-gray-100 text-wrap">
                  {{ getExerciseDisplayIndex(exIndex)}} -
                  <ng-container *ngIf="isSuperSet(exIndex)">{{ getSupersetDisplayName(exercise.supersetId!)
                    }}</ng-container>
                  <ng-container *ngIf="!isSuperSet(exIndex)">{{ exercise.exerciseName }}</ng-container>
                </h2>
              </div>
              <div class="px-5 flex items-center text-black dark:text-gray-400 text-sm"
                *ngIf="expandedExerciseIndex() !== exIndex">
                {{ (isSuperSet(exIndex) ? 'compactPlayer.rounds' : 'compactPlayer.sets') | translate }}: {{
                getExerciseTotalLoggedSets(exIndex) + '/' +
                getExerciseTotalSets(exIndex)}}
              </div>
            </div>
            <!-- Exercise Notes Textarea -->
            <div *ngIf="expandedExerciseNotes() === (exIndex)" class="flex py-2 w-full">
              <textarea [ngModel]="getInitialExerciseNoteInputValue(exIndex)"
                (change)="updateExerciseNotes(exIndex, $event)"
                [placeholder]="'compactPlayer.notesPlaceholder' | translate"
                class="w-full text-xs bg-inherit dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-md p-1.5 focus:ring-primary-dark focus:border-primary-dark dark:text-gray-200"></textarea>
            </div>

            <!-- Action Menu Container -->
            <div class="absolute top-2 right-2 z-60">
              <div class="relative">
                <div class="flex">
                  <button (click)="toggleExerciseNotes(exIndex, $event)"
                    [title]="'compactPlayer.toggleNotes' | translate"
                    class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-500 rounded-full focus:outline-none flex items-center p-2">
                    <app-icon name="clipboard-list" class="h-6 w-6"></app-icon>
                  </button>
                  <button (click)="toggleActionMenu(exIndex, $event)"
                    class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-500 rounded-full focus:outline-none flex items-center">
                    <app-icon name="menu-action" class="h-10 w-10"></app-icon>
                  </button>
                </div>
                <app-action-menu [isVisible]="activeActionMenuIndex() === exIndex && getMenuMode()  !== 'compact'"
                  [modalTitle]="''" class="action-menu-container" [displayMode]="getMenuMode()"
                  [items]="compactActionItemsMap().get(exIndex)!" (itemClick)="handleActionMenuItemClick($event)"
                  (closeMenu)="closeActionMenu()">
                </app-action-menu>
              </div>
            </div>
            <app-action-menu [isVisible]="activeActionMenuIndex() === exIndex && getMenuMode() === 'compact'"
              [modalTitle]="''" class="action-menu-container" [displayMode]="getMenuMode()"
              [items]="compactActionItemsMap().get(exIndex)!" (itemClick)="handleActionMenuItemClick($event)"
              (closeMenu)="closeActionMenu()">
            </app-action-menu>
          </div>

          <!-- Sets Container -->
          <!-- Sets Container -->
          <div *ngIf="expandedExerciseIndex() === exIndex"
            class="bg-gray-200 dark:bg-gray-700/50 pt-2 pb-3 px-1 border-t border-gray-200 dark:border-gray-700 rounded-b-md">

            <!-- Sets List -->
            <div class="space-y-3">

              <!-- CASE 1: Standard Exercise (Not a Superset) -->
              <ng-container *ngIf="!isSuperSet(exIndex)">
                <ng-container *ngFor="let set of exercise.sets; let setIndex = index">
                  <!-- START: Set Card Layout -->
                  <div [attr.data-set-index]="setIndex" #setCard [ngClass]="getSetClasses(exIndex, setIndex, set)">
                    <!-- Set Header (Always visible, now clickable) -->
                    <div class="flex items-center gap-3 p-1 cursor-pointer"
                      (click)="toggleSetExpansion(exIndex, setIndex, $event)">

                      <!-- Set Number -->
                      <div class="flex-shrink-0 w-8 text-center">
                        <span class="font-bold text-lg text-gray-700 dark:text-gray-200">#{{ setIndex + 1 }}</span>
                      </div>

                      <!-- Summary for collapsed view -->
                      <div class="flex-1 text-sm text-gray-700 dark:text-gray-200 font-medium truncate"
                        *ngIf="!isSetExpanded(exIndex, setIndex)">
                        {{ getSetSummary(exIndex, setIndex) }}

                        <ng-container *ngIf="!isSetCompleted(exIndex, setIndex)">
                              <span *ngIf="setIndex === findFirstIncompleteSetIndex(exIndex)"
                                class="inline-flex items-center gap-1 rounded-full bg-yellow-100 dark:bg-yellow-900/70 px-2 py-1 text-xs font-medium text-yellow-800 dark:text-yellow-300 animate-pulse">
                                <app-icon name="target" class="h-4 w-4"></app-icon>
                                {{ 'compactPlayer.nextUp' | translate }}
                              </span>
                              <span *ngIf="setIndex !== findFirstIncompleteSetIndex(exIndex)"
                                class="inline-flex items-center gap-1 rounded-full bg-gray-200 dark:bg-gray-700 px-2 py-1 text-xs font-medium text-gray-600 dark:text-gray-400">
                                {{ 'compactPlayer.pending' | translate }}
                              </span>
                            </ng-container>

                      </div>

                      <!-- Placeholder text for expanded view -->
                      <div class="flex-1 text-xs text-black dark:text-gray-300"
                        *ngIf="isSetExpanded(exIndex, setIndex)">
                        {{ 'compactPlayer.logPerformance' | translate }}{{ isSetCompleted(exIndex, setIndex)?'ged':''}}:
                        <p *ngIf="isSetCompleted(exIndex, setIndex)" class="italic font-bold">{{
                          'compactPlayer.markAsUndone' | translate }}</p>
                      </div>

                      <!-- Actions -->
                      <div *ngIf="isSetExpanded(exIndex,setIndex)"
                        class="flex-shrink-0 flex flex-col items-center justify-center gap-1">
                        <div *ngIf="!isSetCompleted(exIndex, setIndex)" class="flex items-center"
                          >
                        <!-- <div *ngIf="!isSetCompleted(exIndex, setIndex)" class="flex items-center"
                          [ngClass]="{'disabled-div': isTimedSet(exIndex, setIndex) && getSetTimerState(exIndex, setIndex).status === 'running'}"
                          > -->
                          <div class="flex items-center justify-center gap-1">
                            <!-- Remove metric button -->
                            <button *ngIf="canRemoveAnyField(exIndex, setIndex)"
                              (click)="promptRemoveField(exIndex, setIndex); $event.stopPropagation()"
                              class="flex items-center gap-1 text-xs font-semibold text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 transition-colors">
                              <app-icon name="minus-circle" class="h-5 w-5"></app-icon>
                            </button>
                            <!-- ADD metric -->
                            <button *ngIf="getFieldsForSet(exIndex, setIndex).hidden.length > 0"
                              (click)="promptAddField(exIndex, setIndex); $event.stopPropagation()"
                              class="flex items-center gap-1 text-xs font-semibold text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 p-1 rounded-full hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors">
                              <app-icon name="plus-circle" class="h-5 w-5"></app-icon>
                            </button>
                          </div>
                          <button (click)="toggleSetNotes(exIndex, setIndex, $event)"
                            class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center"><app-icon
                              name="clipboard-list"
                              class="h-6 w-6 text-gray-500 dark:text-gray-400"></app-icon></button>
                          <button (click)="removeSet(exIndex, setIndex)"
                            class="p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-600/50 flex items-center"><app-icon
                              name="trash" class="h-6 w-6 text-red-500" [strokeWidth]="2"></app-icon></button>
                        </div>
                      </div>

                      <!-- Quick Complete Button (visible when collapsed) -->
                      <button *ngIf="!isTimedSet(exIndex, setIndex)"
                        (click)="toggleSetCompletion(exercise, set, exIndex, setIndex, 0); $event.stopPropagation()"
                        [disabled]="!isSetDataValid(exIndex, setIndex)"
                        class="h-10 w-10 rounded-full flex items-center justify-center transition-all duration-200 ease-in-out transform active:scale-90 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none"
                        [ngClass]="isSetCompleted(exIndex, setIndex, 0) ? 'bg-green-500 text-white shadow-lg' : 'bg-gray-200 dark:bg-gray-600 text-gray-500 dark:text-gray-300'"><app-icon
                          name="done" class="h-6 w-6"></app-icon>
                      </button>

                      <div *ngIf="isTimedSet(exIndex, setIndex) && !isSetCompleted(exIndex, setIndex)"
                        class="flex items-center gap-2 text-white font-semibold">
                        <!-- Timer Display -->
                        <span class="text-lg font-mono text-gray-800 dark:text-gray-100 w-14 text-center">
                          {{ formatSecondsToTime(getSetTimerState(exIndex, setIndex).remainingTime) }}
                        </span>
                        <!-- Play/Pause Button -->
                        <button (click)="handleSetTimerAction(exIndex, setIndex, $event)"
                          class="h-10 w-10 rounded-full flex items-center justify-center transition-all duration-200 ease-in-out transform active:scale-90 focus:outline-none"
                          [ngClass]="getSetTimerButtonClass(exIndex, setIndex)">
                          <app-icon [name]="getSetTimerButtonIcon(exIndex, setIndex)" class="h-6 w-6"></app-icon>
                        </button>
                      </div>

                      <!-- Completed Indicator BUTTON (Shows for timed sets that are complete) -->
                      <button *ngIf="isTimedSet(exIndex, setIndex) && isSetCompleted(exIndex, setIndex)"
                        (click)="toggleSetCompletion(exercise, set, exIndex, setIndex, 0); $event.stopPropagation()"
                        class="h-10 w-10 rounded-full flex items-center justify-center bg-green-500 text-white shadow-lg transition-transform active:scale-90">
                        <app-icon name="done" class="h-6 w-6"></app-icon>
                      </button>
                    </div>

                    <div
                      *ngIf="isTimedSet(exIndex, setIndex) && getSetTimerState(exIndex, setIndex).status === 'running'"
                      class="relative flex items-center px-2 py-1 mt-2 transition-all">
                      <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                        <div class="bg-teal-400 h-2 rounded-full"
                          [style.width.%]="(((performanceInputValues()[exIndex + '-' + setIndex]?.actualDuration ?? set.targetDuration) || 1) - getSetTimerState(exIndex, setIndex).remainingTime) / ((performanceInputValues()[exIndex + '-' + setIndex]?.actualDuration ?? set.targetDuration) || 1) * 100">
                        </div>
                      </div>
                      
                      <app-icon name="hourglass" class="h-4 w-4 text-teal-500 ml-2" [strokeWidth]="2.5"></app-icon>
                      <button 
                        (click)="toggleSetCompletion(exercise, set, exIndex, setIndex, 0); $event.stopPropagation()"
                        [disabled]="!isSetDataValid(exIndex, setIndex)"
                        class="ml-2 px-2 h-10 w-10 rounded-full flex items-center justify-center transition-all duration-200 ease-in-out transform active:scale-90 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none"
                        [ngClass]="isSetCompleted(exIndex, setIndex, 0) ? 'bg-green-500 text-white shadow-lg' : 'bg-gray-200 dark:bg-gray-600 text-gray-500 dark:text-gray-300'"><app-icon
                          name="done" class="h-6 w-6"></app-icon>
                      </button>
                    </div>

                    <div *ngIf="isSetExpanded(exIndex, setIndex)" class="border-t border-white dark:border-gray-600/50">

                      <!-- Inputs Grid -->
                      <div class="flex-1 grid grid-cols-2 gap-x-4 gap-y-2 px-1 py-1">
                      <!-- <div class="flex-1 grid grid-cols-2 gap-x-4 gap-y-2 px-1 py-1" [ngClass]="{'disabled-div-lower-opacity': isSetCompleted(exIndex, setIndex),
                          'disabled-div': isTimedSet(exIndex, setIndex) && getSetTimerState(exIndex, setIndex).status === 'running'
                        }"> -->

                        <!-- Case for ZERO visible fields -->
                        <ng-container *ngIf="getFieldsForSet(exIndex, setIndex).visible.length === 0">
                          <div class="col-span-2">
                            <button *ngIf="!isSetCompleted(exIndex, setIndex)"
                              (click)="promptAddField(exIndex, setIndex); $event.stopPropagation()"
                              class="flex items-center justify-center w-full h-full p-3 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-md text-gray-400 hover:bg-gray-200/50 dark:hover:bg-gray-700/50 transition-colors">
                              <app-icon name="plus-circle" class="h-5 w-5 mr-2"></app-icon>
                              <span class="text-sm font-semibold">{{ 'compactPlayer.addMetric' | translate }}</span>
                            </button>
                          </div>
                        </ng-container>

                        <ng-container *ngIf="getFieldsForSet(exIndex, setIndex).visible.length > 0">
                          <ng-container *ngIf="getFieldsForSet(exIndex, setIndex).visible as visibleFields">
                            <!-- Weight Input -->
                            <div *ngIf="visibleFields.includes('weight')">
                              <label
                                class="flex items-center justify-center text-xs font-medium text-gray-500 dark:text-gray-300 pb-1">
                                {{ 'compactPlayer.weightLabel' | translate:{unit:
                                unitsService.getWeightUnitSuffix()} }}
                              </label>
                              <input type="number" [ngModel]="getInitialInputValue(exIndex, setIndex, 'weight')"
                                (change)="updateSetData(exIndex, setIndex, 0, 'weight', $event)"
                                class="w-full p-1 text-center bg-gray-100 dark:bg-gray-700 rounded-md text-black dark:text-gray-200">
                              <div *ngIf="getSetTargetDisplay(set, exIndex, setIndex, 'weight') as target"
                                class="target-class text-xs"><span class="flex items-center justify-center"><app-icon
                                    name="target" class="h-3 w-3 mr-0.5"></app-icon>{{ target
                                  }}{{unitsService.getWeightUnitSuffix()}}</span></div>
                            </div>
                            <!-- Reps Input -->
                            <div *ngIf="visibleFields.includes('reps')">
                              <label
                                class="flex items-center justify-center text-xs font-medium text-gray-500 dark:text-gray-300 pb-1">
                                {{ 'compactPlayer.repsLabel' | translate }}
                              </label>
                              <input type="number" [ngModel]="getInitialInputValue(exIndex, setIndex, 'reps')"
                                (change)="updateSetData(exIndex, setIndex, 0, 'reps', $event)"
                                class="w-full p-1 text-center bg-gray-100 dark:bg-gray-700 rounded-md text-black dark:text-gray-200">
                              <div *ngIf="getSetTargetDisplay(set, exIndex, setIndex, 'reps') as target"
                                class="target-class text-xs"><span class="flex items-center justify-center"><app-icon
                                    name="target" class="h-3 w-3 mr-0.5"></app-icon>x{{ target }}</span></div>
                            </div>
                            <!-- Distance Input -->
                            <div *ngIf="visibleFields.includes('distance')">
                              <label
                                class="flex items-center justify-center text-xs font-medium text-gray-500 dark:text-gray-300 pb-1">
                                {{ 'compactPlayer.distanceLabel' | translate }}
                              </label>
                              <input type="number" [ngModel]="getInitialInputValue(exIndex, setIndex, 'distance')"
                                (change)="updateSetData(exIndex, setIndex, 0, 'distance', $event)"
                                class="w-full p-1 text-center bg-gray-100 dark:bg-gray-700 rounded-md text-black dark:text-gray-200">
                              <div *ngIf="getSetTargetDisplay(set, exIndex, setIndex, 'distance') as target"
                                class="target-class text-xs"><span class="flex items-center justify-center"><app-icon
                                    name="target" class="h-3 w-3 mr-0.5"></app-icon>{{ target }} km</span></div>
                            </div>
                            <!-- Duration Input -->
                            <div *ngIf="visibleFields.includes('duration')">
                              <label
                                class="flex items-center justify-center text-xs font-medium text-gray-500 dark:text-gray-300 pb-1">
                                {{ 'compactPlayer.timeLabel' | translate }}
                              </label>
                              <input type="text" [ngModel]="getInitialInputValue(exIndex, setIndex, 'duration')"
                                (change)="updateSetData(exIndex, setIndex, 0, 'duration', $event)"
                                class="w-full p-1 text-center bg-gray-100 dark:bg-gray-700 rounded-md text-black dark:text-gray-200"
                                [placeholder]="'compactPlayer.timePlaceholder' | translate">
                              <div *ngIf="getSetTargetDisplay(set, exIndex, setIndex, 'duration') as target"
                                class="target-class text-xs"><span class="flex items-center justify-center"><app-icon
                                    name="target" class="h-3 w-3 mr-0.5"></app-icon>{{ formatSecondsToTime(target)
                                  }}</span></div>
                            </div>
                          </ng-container>
                        </ng-container>

                        <!-- "Add GHOST Field" Button for 1 or 3 fields -->
                        <div *ngIf="canAddField(exIndex, setIndex)" class="flex items-center justify-center h-full">
                          <button [disabled]="isSetCompleted(exIndex, setIndex)"
                            (click)="promptAddField(exIndex, setIndex); $event.stopPropagation()"
                            class="flex items-center justify-center w-full p-2 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-md text-gray-400 hover:bg-gray-200/50 dark:hover:bg-gray-700/50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <app-icon name="plus-circle" class="h-5 w-5"></app-icon>
                          </button>
                        </div>
                      </div>
                      <!-- Set Notes Textarea (if visible) -->
                      <div *ngIf="expandedSetNotes() === (exIndex + '-' + setIndex)" class="px-2 pb-1">
                        <textarea [ngModel]="getInitialInputValue(exIndex, setIndex, 'notes')"
                          (change)="updateSetData(exIndex, setIndex, 0, 'notes', $event)"
                          [placeholder]="'compactPlayer.setNotesPlaceholder' | translate"
                          class="w-full text-xs bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-md p-1.5 focus:ring-primary-dark focus:border-primary-dark dark:text-gray-200"></textarea>
                      </div>
                    </div>
                    <!-- END: Set Card Layout -->

                  </div>

                </ng-container>
                <!-- Col 2: Set +/- Buttons STANDAR SET -->
                <div class="flex items-center justify-center gap-x-2">
                  <label class="text-black dark:text-gray-100">{{ 'compactPlayer.setLabel' | translate }}</label>
                  <button type="button" (click)="removeSet(exIndex, -1)"
                    class="p-1.5 rounded-full bg-red-200 hover:bg-red-300 text-red-700 disabled:opacity-50 flex items-center"
                    [aria-label]="'compactPlayer.removeLastSet' | translate">
                    <app-icon name="minus-circle" class="h-6 w-6"></app-icon>
                  </button>
                  <button type="button" (click)="addSet(exIndex, 'standard'); $event.stopPropagation()"
                    class="p-1.5 rounded-full bg-green-200 hover:bg-green-300 text-green-700 flex items-center"
                    [aria-label]="'compactPlayer.addSet' | translate">
                    <app-icon name="plus-circle" class="h-6 w-6"></app-icon>
                  </button>
                </div>
              </ng-container>

              <!-- CASE 2: Superset (uses a similar card logic for each exercise within the round) -->
              <ng-container *ngIf="isSupersetStart(exIndex)">
                <ng-container *ngFor="let roundSet of exercise.sets; let roundIndex = index">
                  <div #roundCard [attr.data-round-index]="roundIndex" [ngClass]="getRoundClasses(exIndex, roundIndex)">
                    <!-- Round Header -->
                    <div (click)="toggleRoundExpansion(exIndex, roundIndex, $event)"
                      class="flex items-center justify-between p-1 cursor-pointer">

                      <div class="flex items-start gap-2">
                        <!-- <app-icon name="chevron-down" class="h-5 w-5 transition-transform duration-200 flex-shrink-0"
                          [class.rotate-180]="isRoundExpanded(exIndex, roundIndex)"></app-icon> -->
                        <h4 class="text-sm font-bold text-gray-700 dark:text-gray-100">{{ 'compactPlayer.roundHeader' |
                          translate:{number: roundIndex + 1} }}</h4>
                        <div *ngIf="!isRoundExpanded(exIndex, roundIndex)">
                          <div (click)="$event.stopPropagation()">
                            <ng-container *ngIf="!isRoundCompleted(exIndex, roundIndex)">
                              <span *ngIf="roundIndex === findFirstIncompleteRoundIndex(exIndex)"
                                class="inline-flex items-center gap-1 rounded-full bg-yellow-100 dark:bg-yellow-900/70 px-2 py-1 text-xs font-medium text-yellow-800 dark:text-yellow-300 animate-pulse">
                                <app-icon name="target" class="h-4 w-4"></app-icon>
                                {{ 'compactPlayer.nextUp' | translate }}
                              </span>
                              <span *ngIf="roundIndex !== findFirstIncompleteRoundIndex(exIndex)"
                                class="inline-flex items-center gap-1 rounded-full bg-gray-200 dark:bg-gray-700 px-2 py-1 text-xs font-medium text-gray-600 dark:text-gray-400">
                                {{ 'compactPlayer.pending' | translate }}
                              </span>
                            </ng-container>
                          </div>
                        </div>
                      </div>


                      <div class="flex items-center">
                        <!-- +++ NEW BUTTON/STATUS ELEMENT +++ -->

                        <!-- ROUND NOTES BUTTON -->
                        <button (click)="toggleSetNotes(exIndex, roundIndex, $event)"
                          [title]="'compactPlayer.toggleNotes' | translate"
                          class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-500 rounded-full focus:outline-none flex items-center p-2">
                          <app-icon name="clipboard-list" class="h-6 w-6"></app-icon>
                        </button>

                        <!-- EMOM Controls (for EMOM supersets) -->
                        <div *ngIf="isEmom(exIndex)" class="flex items-center gap-2 text-white font-semibold">
                          <!-- Timer Display (for EMOM) -->
                          <span class="text-lg font-mono text-gray-800 dark:text-gray-100 w-14 text-center">
                            {{ formatSecondsToTime(getEmomState(exIndex, roundIndex).remainingTime) }}
                          </span>
                          <!-- Play/Pause Button (for EMOM) -->
                          <button (click)="handleEmomAction(exIndex, roundIndex); $event.stopPropagation()"
                            [disabled]="getEmomState(exIndex, roundIndex).status === 'completed'"
                            class="h-10 w-10 rounded-full flex items-center justify-center transition-all duration-200 ease-in-out transform active:scale-90 focus:outline-none disabled:opacity-50"
                            [ngClass]="getEmomButtonClass(exIndex, roundIndex)">
                            <app-icon [name]="getEmomButtonIcon(exIndex, roundIndex)" class="h-6 w-6"></app-icon>
                          </button>
                        </div>

                        <!-- Quick Complete Button (for STANDARD supersets) -->
                        <button *ngIf="!isEmom(exIndex)" (click)="completeRoundOrSet(exercise, roundIndex, $event)"
                          class="h-10 w-10 rounded-full flex items-center justify-center transition-all duration-200 ease-in-out transform active:scale-90 focus:outline-none"
                          [ngClass]="isRoundCompleted(exIndex, roundIndex) ? 'bg-green-500 text-white shadow-lg' : 'bg-gray-200 dark:bg-gray-600 text-gray-500 dark:text-gray-300'">
                          <app-icon name="done" class="h-6 w-6"></app-icon>
                        </button>



                        <!-- +++ END NEW BUTTON/STATUS ELEMENT +++ -->
                      </div>
                    </div>
                    <!-- Set Notes Textarea (if visible) -->
                    <div *ngIf="expandedSetNotes() === (exIndex + '-' + roundIndex)" class="px-2 pb-1">
                      <textarea [ngModel]="getInitialInputValue(exIndex, roundIndex, 'notes')"
                        (change)="updateSetData(exIndex, roundIndex, 0, 'notes', $event)"
                        [placeholder]="'compactPlayer.roundNotesPlaceholder' | translate"
                        class="w-full text-xs bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-md p-1.5 focus:ring-primary-dark focus:border-primary-dark dark:text-gray-200"></textarea>
                    </div>

                    <!-- Collapsible Round Body -->
                    <ng-container *ngIf="isRoundExpanded(exIndex, roundIndex)">
                      <div *ngIf="isRoundCompleted(exIndex, roundIndex)"
                        class="flex items-start text-xs text-white italic font-bold">{{ 'compactPlayer.markAsUndone' |
                        translate }}</div>



                      <div class="mt-2 space-y-3">
                        <ng-container *ngFor="let ssExercise of getSupersetExercises(exercise.supersetId!)">

                          <ng-container *ngLet="getOriginalExIndex(ssExercise.id) as ssOriginalIndex">
                            <div *ngIf="ssOriginalIndex > -1"
                              class="py-2 px-1 rounded bg-white dark:bg-gray-800 shadow-sm">
                              <div class="flex justify-between">
                                <!-- Exercise Name -->
                                <p class="text-sm font-semibold text-gray-800 dark:text-gray-100 mb-1">
                                  {{ getExerciseDisplayIndex(ssOriginalIndex) }} - {{ ssExercise.exerciseName }}
                                </p>

                                <!-- METRICS BUTTONS FOR SUPERSET -->
                                <div class="flex items-center justify-center gap-1 px-1">
                                  <!-- Remove metric button -->
                                  <button *ngIf="canRemoveAnyField(ssOriginalIndex, roundIndex)"
                                    (click)="promptRemoveField(ssOriginalIndex, roundIndex); $event.stopPropagation()"
                                    class="flex items-center gap-1 text-xs font-semibold text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 transition-colors">
                                    <app-icon name="minus-circle" class="h-5 w-5"></app-icon>
                                  </button>
                                  <!-- ADD metric -->
                                  <button *ngIf="getFieldsForSet(ssOriginalIndex, roundIndex).hidden.length > 0"
                                    (click)="promptAddField(ssOriginalIndex, roundIndex); $event.stopPropagation()"
                                    class="flex items-center gap-1 text-xs font-semibold text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 p-1 rounded-full hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors">
                                    <app-icon name="plus-circle" class="h-5 w-5"></app-icon>
                                  </button>
                                </div>
                              </div>



                              <!-- Dynamic Inputs Grid -->
                              <div class="grid grid-cols-2 gap-x-4 gap-y-2"
                                [ngClass]="{'disabled-div-lower-opacity': isRoundCompleted(exIndex, roundIndex)}">

                                <ng-container *ngIf="getVisibleSetColumns(ssOriginalIndex, roundIndex) as cols">
                                  <!-- All the input fields (Weight, Reps, etc.) remain exactly the same -->
                                  <!-- Weight Input -->
                                  <div *ngIf="cols['weight']">
                                    <label
                                      class="block text-xs font-medium text-gray-500 dark:text-gray-400 text-center pb-1">{{
                                      'compactPlayer.weightLabel' | translate }}</label>
                                    <input type="number"
                                      [ngModel]="getInitialInputValue(ssOriginalIndex, roundIndex, 'weight')"
                                      [disabled]="isRoundCompleted(exIndex, roundIndex)"
                                      (change)="updateSetData(ssOriginalIndex, roundIndex, roundIndex, 'weight', $event)"
                                      class="w-full text-md text-center bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-1 text-gray-700 dark:text-white">
                                    <div
                                      *ngIf="workoutService.getWeightDisplay(ssExercise.sets[roundIndex], ssExercise) as target"
                                      class="target-class text-xs"><span
                                        class="flex items-center justify-center"><app-icon name="target"
                                          class="h-3 w-3 mr-0.5"></app-icon>{{ target
                                        }}</span></div>
                                  </div>
                                  <!-- Reps Input -->
                                  <div *ngIf="cols['reps']">
                                    <label
                                      class="block text-xs font-medium text-gray-500 dark:text-gray-400 text-center pb-1">{{
                                      'compactPlayer.repsLabel' | translate }}</label>
                                    <input type="number"
                                      [ngModel]="getInitialInputValue(ssOriginalIndex, roundIndex, 'reps')"
                                      [disabled]="isRoundCompleted(exIndex, roundIndex)"
                                      (change)="updateSetData(ssOriginalIndex, roundIndex, roundIndex, 'reps', $event)"
                                      class="w-full text-md text-center bg-gray-100 dark:bg-gray-700 border-gray-300 rounded-md p-1 text-gray-700 dark:text-white">
                                    <div
                                      *ngIf="getSetTargetDisplay(ssExercise.sets[roundIndex], ssOriginalIndex, roundIndex, 'reps') as target"
                                      class="target-class text-xs"><span
                                        class="flex items-center justify-center"><app-icon name="target"
                                          class="h-3 w-3 mr-0.5"></app-icon>{{ target
                                        }}</span></div>
                                  </div>
                                  <!-- Distance Input -->
                                  <div *ngIf="cols['distance']">
                                    <label
                                      class="block text-xs font-medium text-gray-500 dark:text-gray-400 text-center pb-1">{{
                                      'compactPlayer.distanceLabel' | translate }}</label>
                                    <input type="number"
                                      [ngModel]="getInitialInputValue(ssOriginalIndex, roundIndex, 'distance')"
                                      [disabled]="isRoundCompleted(exIndex, roundIndex)"
                                      (change)="updateSetData(ssOriginalIndex, roundIndex, roundIndex, 'distance', $event)"
                                      class="w-full text-md text-center bg-gray-100 dark:bg-gray-700 border-gray-300 rounded-md p-1 text-gray-700 dark:text-white">
                                    <div
                                      *ngIf="getSetTargetDisplay(ssExercise.sets[roundIndex], ssOriginalIndex, roundIndex, 'distance') as target"
                                      class="target-class text-xs"><span
                                        class="flex items-center justify-center"><app-icon name="target"
                                          class="h-3 w-3 mr-0.5"></app-icon>{{ target
                                        }}</span></div>
                                  </div>
                                  <!-- Duration Input -->
                                  <div *ngIf="cols['duration']">
                                    <label
                                      class="block text-xs font-medium text-gray-500 dark:text-gray-400 text-center pb-1">{{
                                      'compactPlayer.timeLabel' | translate }}</label>
                                    <input type="text"
                                      [ngModel]="getInitialInputValue(ssOriginalIndex, roundIndex, 'duration')"
                                      [disabled]="isRoundCompleted(exIndex, roundIndex)"
                                      (change)="updateSetData(ssOriginalIndex, roundIndex, roundIndex, 'duration', $event)"
                                      class="w-full text-md text-center bg-gray-100 dark:bg-gray-700 border-gray-300 rounded-md p-1 text-gray-700 dark:text-white"
                                      [placeholder]="'compactPlayer.timePlaceholder' | translate">
                                    <div
                                      *ngIf="getSetTargetDisplay(ssExercise.sets[roundIndex], ssOriginalIndex, roundIndex, 'duration') as target"
                                      class="target-class text-xs"><span
                                        class="flex items-center justify-center"><app-icon name="target"
                                          class="h-3 w-3 mr-0.5"></app-icon>{{ target
                                        }}</span></div>
                                  </div>

                                  <!-- "Add GHOST Field" Button for 1 or 3 fields - SUPERSET -->
                                  <div *ngIf="canAddField(ssOriginalIndex, roundIndex)"
                                    class="flex items-center justify-center h-full">
                                    <button [disabled]="isSetCompleted(exIndex, roundIndex)"
                                      (click)="promptAddField(ssOriginalIndex, roundIndex); $event.stopPropagation()"
                                      class="flex items-center justify-center w-full p-2 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-md text-gray-400 hover:bg-gray-200/50 dark:hover:bg-gray-700/50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                      <app-icon name="plus-circle" class="h-5 w-5"></app-icon>
                                    </button>
                                  </div>

                                </ng-container>



                              </div>
                            </div>
                          </ng-container>

                        </ng-container>
                      </div>
                    </ng-container>

                  </div>
                </ng-container>
                <!-- Col 2: Set +/- Buttons SUPER SET -->
                <div class="flex items-center justify-center gap-x-2">
                  <label class="text-black dark:text-gray-100">{{ 'compactPlayer.roundLabel' | translate }}</label>
                  <button type="button" (click)="removeSet(exIndex, -1)"
                    class="p-1.5 rounded-full bg-red-200 hover:bg-red-300 text-red-700 disabled:opacity-50 flex items-center"
                    [aria-label]="'compactPlayer.removeLastSet' | translate">
                    <app-icon name="minus-circle" class="h-6 w-6"></app-icon>
                  </button>
                  <button type="button" (click)="addSet(exIndex, 'standard'); $event.stopPropagation()"
                    class="p-1.5 rounded-full bg-green-200 hover:bg-green-300 text-green-700 flex items-center"
                    [aria-label]="'compactPlayer.addSet' | translate">
                    <app-icon name="plus-circle" class="h-6 w-6"></app-icon>
                  </button>
                </div>
              </ng-container>
            </div>
          </div>


        </div>
      </ng-container>

    </div>

    <ng-template #loading>
      <div class="text-center py-10">
        <p class="text-gray-500">{{ 'compactPlayer.loading' | translate }}</p>
      </div>
    </ng-template>
  </main>
  <div class="flex flex-col items-center"
    *ngIf="!routine() || (routine() !== null && routine() !== undefined && (!routine()?.exercises || routine()?.exercises?.length === 0))">
    <h2 class="text-2xl font-semibold text-gray-700 dark:text-gray-200">
      {{ sessionState() === 'error' ? ('compactPlayer.errorLoading' | translate) : (currentWorkoutLog().exercises?.length
      === 0 ?
      (routineId === '-1' ? ('compactPlayer.workoutStarted' | translate) : ('compactPlayer.workoutEnded' | translate)) :
      ('compactPlayer.workoutComplete' | translate)) }}
    </h2>
    <p class="text-gray-600 dark:text-gray-400 mt-2" *ngIf="sessionState() !== 'error'">
      {{ currentWorkoutLog().exercises?.length === 0 ? ('compactPlayer.noSetsLogged' | translate) :
      ('compactPlayer.allSetsDone' | translate) }}
    </p>
  </div>
  <!-- Footer with Action Buttons -->
  <div class="flex justify-center fixed left-0 right-0 z-20 bottom-0">
    <div
      class="w-full max-w-sm grid grid-cols-2 gap-4 bg-white dark:bg-gray-800/80 dark:backdrop-blur-sm border-t border-x border-gray-200 dark:border-gray-700 p-3 rounded-t-md">

      <button (click)="openAddExerciseModal()"
        class="flex items-center justify-center space-x-2 bg-blue-500 text-white font-semibold py-2 px-4 rounded-full shadow-lg hover:bg-blue-600 transition-colors">
        <app-icon name="plus-circle" class="h-6 w-6"></app-icon>
        <span>{{ 'compactPlayer.addExercise' | translate }}</span>
      </button>

      <button (click)="finishWorkout()"
        [disabled]="!this.currentWorkoutLog() || !this.currentWorkoutLog().exercises || this.currentWorkoutLog().exercises?.length === 0"
        class="flex items-center justify-center space-x-2 bg-green-500 text-white font-semibold py-2 px-4 rounded-full shadow-lg hover:bg-green-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
        <app-icon name="done" class="h-6 w-6"></app-icon>
        <span>{{ 'compactPlayer.finish' | translate }}</span>
      </button>

    </div>
  </div>

  <app-exercise-selection-modal [isOpen]="isAddExerciseModalOpen()" [(searchTerm)]="modalSearchTerm"
    [title]="'compactPlayer.addExerciseTitle' | translate" [exercises]="availableExercises"
    [showCreateCustomLink]="true" itemIconName="plus-circle" itemIconClass="text-primary dark:text-primary-light"
    (exerciseSelected)="selectExerciseToAddFromModal($event)" (createCustomClicked)="handleTrulyCustomExerciseEntry()"
    (close)="closeAddExerciseModal()">
  </app-exercise-selection-modal>

  <app-exercise-selection-modal [isOpen]="isSwitchExerciseModalOpen()" [(searchTerm)]="modalSearchTerm"
    [title]="(isShowingSimilarInSwitchModal() ? 'compactPlayer.similarExercisesTitle' : 'compactPlayer.switchExerciseTitle') | translate"
    [exercises]="exercisesForSwitchModal()" [searchPlaceholder]="'compactPlayer.searchPlaceholder' | translate"
    [showSimilarButton]="true" [isShowingSimilarView]="isShowingSimilarInSwitchModal()" itemIconName="change"
    itemIconClass="text-green-500" (exerciseSelected)="handleExerciseSwitch($event)"
    (findSimilarClicked)="findAndShowSimilarExercises(exerciseToSwitchIndex())"
    (backToSearchClicked)="onBackToSearchFromSimilar()" (close)="closeSwitchExerciseModal()">
  </app-exercise-selection-modal>

  <app-full-screen-rest-timer [isVisible]="isRestTimerVisible()" [mainTimer]="sessionTimerDisplay"
    [durationSeconds]="restDuration()" [mainText]="restTimerMainText()" [nextUpText]="restTimerNextUpText()"
    (timerFinished)="handleRestTimerFinished()" (timerSkipped)="handleRestTimerSkipped($event)">
  </app-full-screen-rest-timer>

  <!-- Performance Insights Modal -->
  <div *ngIf="isPerformanceInsightsModalOpen()" style="z-index: 100"
    class="fixed inset-0 bg-gray-900/70 dark:bg-black/80 backdrop-blur-md flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out">
    <div *ngIf="insightsData() as data"
      class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-xl max-h-[90vh] flex flex-col overflow-hidden transform transition-all duration-300 ease-in-out">
      <header class="p-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center flex-shrink-0">
        <div class="flex items-center gap-3">
          <app-icon name="chart" class="h-7 w-7 text-primary dark:text-primary-light"></app-icon>
          <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100">{{ 'compactPlayer.insights.title' |
            translate }}</h3>
        </div>
        <button (click)="closePerformanceInsightsModal()"
          class="p-1.5 rounded-full text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700/70 focus:outline-none transition-colors">
          <app-icon name="cancel" class="h-6 w-6"></app-icon>
        </button>
      </header>
      <div class="p-5 overflow-y-auto space-y-6 flex-grow">
        <div class="rounded-md border border-gray-200 dark:border-gray-700/80">
          <button (click)="toggleCompletedSetsForExerciseInfo()" class="w-full flex items-center justify-between p-2 text-left text-sm font-medium text-gray-700
          dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors rounded-t-lg">
            <span class="flex items-center gap-2">
              <app-icon name="clipboard-list" class="h-6 w-6"></app-icon>
              <span>{{ 'compactPlayer.insights.completedSets' | translate:{count:
                data.completedSetsInSession.length} }}</span>
            </span>
            <app-icon name="chevron-down" class="h-5 w-5 transform transition-transform duration-200"
              [ngClass]="{'rotate-180': showCompletedSetsForExerciseInfo()}"></app-icon>
          </button>
          <div *ngIf="showCompletedSetsForExerciseInfo()"
            class="bg-gray-50 dark:bg-gray-700/30 p-3 border-t border-gray-200 dark:border-gray-700/80 space-y-3 max-h-48 overflow-y-auto rounded-b-lg">
            <div *ngFor="let setLog of data.completedSetsInSession; let i = index"
              class="text-xs p-2 bg-white dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600">
              <p class="font-semibold text-gray-700 dark:text-gray-200 mb-1">
                {{ 'compactPlayer.setLabel' | translate }} #{{ i + 1 }}:
              </p>
              <div class="grid grid-cols-2 gap-x-2 gap-y-1 text-gray-600 dark:text-gray-300">
                <span *ngIf="setLog.repsAchieved">{{ 'compactPlayer.repsLabel' | translate }}: <strong
                    class="dark:text-gray-100">{{ setLog.repsAchieved
                    }}</strong></span>
                <span *ngIf="setLog.weightUsed != null">{{ 'compactPlayer.weightLabel' | translate:{unit: ''} }}: <strong
                    class="dark:text-gray-100">{{ setLog.weightUsed
                    |
                    weightUnit }}</strong></span>
                <span *ngIf="setLog.distanceAchieved">{{ 'compactPlayer.distanceLabel' | translate }}: <strong
                    class="dark:text-gray-100">{{
                    setLog.distanceAchieved }} km</strong></span>
                <span *ngIf="setLog.durationPerformed">{{ 'compactPlayer.timeLabel' | translate }}: <strong
                    class="dark:text-gray-100">{{
                    formatSecondsToTime(setLog.durationPerformed) }}</strong></span>
              </div>
            </div>
            <div *ngIf="data.completedSetsInSession.length === 0"
              class="p-3 text-xs text-center text-gray-500 dark:text-gray-400">
              {{ 'compactPlayer.insights.noSetsCompleted' | translate }}
            </div>
          </div>
        </div>
        <div class="rounded-md border border-gray-200 dark:border-gray-700/80">
          <div class="p-3 text-sm font-medium text-gray-700 dark:text-gray-300">
            <span class="flex items-center gap-2">
              <app-icon name="calendar-page" class="h-6 w-6"></app-icon>
              <span>{{ 'compactPlayer.insights.lastPerformance' | translate:{date: (data.lastPerformance?.lastPerformedDate
                | date:'shortDate')} }}</span>
            </span>
          </div>
          <div *ngIf="data.lastPerformance as lastPerf"
            class="bg-gray-50 dark:bg-gray-700/30 p-3 border-t border-gray-200 dark:border-gray-700/80 space-y-3 max-h-48 overflow-y-auto rounded-b-lg">
            <div *ngFor="let setLog of lastPerf.sets; let i = index"
              class="text-xs p-2 bg-white dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600">
              <p class="font-semibold text-gray-700 dark:text-gray-200 mb-1">{{ 'compactPlayer.setLabel' | translate }}
                #{{ i + 1 }}:</p>
              <div class="grid grid-cols-2 gap-x-2 gap-y-1 text-gray-600 dark:text-gray-300">
                <span *ngIf="setLog.repsAchieved">{{ 'compactPlayer.repsLabel' | translate }}: <strong
                    class="dark:text-gray-100">{{ setLog.repsAchieved
                    }}</strong></span>
                <span *ngIf="setLog.weightUsed != null">{{ 'compactPlayer.weightLabel' | translate:{unit: ''} }}: <strong
                    class="dark:text-gray-100">{{ setLog.weightUsed
                    |
                    weightUnit }}</strong></span>
                <span *ngIf="setLog.distanceAchieved">{{ 'compactPlayer.distanceLabel' | translate }}: <strong
                    class="dark:text-gray-100">{{
                    setLog.distanceAchieved }} km</strong></span>
                <span *ngIf="setLog.durationPerformed">{{ 'compactPlayer.timeLabel' | translate }}: <strong
                    class="dark:text-gray-100">{{
                    formatSecondsToTime(setLog.durationPerformed) }}</strong></span>
              </div>
            </div>
          </div>
          <div *ngIf="!data.lastPerformance"
            class="p-3 text-xs text-center text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700/80 rounded-b-lg">
            {{ 'compactPlayer.insights.noPreviousPerformance' | translate }}
          </div>
        </div>
        <div class="rounded-md border border-gray-200 dark:border-gray-700/80">
          <div class="p-3 text-sm font-medium text-gray-700 dark:text-gray-300">
            <span class="flex items-center gap-2">
              <app-icon name="pb" class="h-6 w-6 text-yellow-500"></app-icon>
              <span>{{ 'compactPlayer.insights.personalBests' | translate }}</span>
            </span>
          </div>
          <div *ngIf="data.personalBests.length > 0"
            class="bg-gray-50 dark:bg-gray-700/30 p-3 border-t border-gray-200 dark:border-gray-700/80 grid grid-cols-1 sm:grid-cols-2 gap-3 rounded-b-lg">
            <div *ngFor="let pb of data.personalBests"
              class="text-xs p-2 bg-white dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600">
              <p class="font-semibold text-gray-700 dark:text-gray-200">{{ pb.pbType }}</p>
              <p class="text-lg font-bold text-primary dark:text-primary-light">{{ formatPbValue(pb) }}</p>
              <p class="text-2xs text-gray-500 dark:text-gray-400">{{ 'compactPlayer.insights.onDate' |
                translate:{date: (pb.timestamp | date:'shortDate')} }}</p>
            </div>
          </div>
          <div *ngIf="data.personalBests.length === 0"
            class="p-3 text-xs text-center text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700/80 rounded-b-lg">
            {{ 'compactPlayer.insights.noPBs' | translate }}
          </div>
        </div>
      </div>
      <footer
        class="p-4 bg-gray-50 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 text-right flex-shrink-0">
        <button (click)="closePerformanceInsightsModal()"
          class="inline-flex items-center bg-primary hover:bg-primary-dark focus:ring-4 focus:ring-primary-focus text-white font-semibold py-2.5 px-6 rounded-md text-sm transition-colors shadow-md hover:shadow-lg">
          <app-icon name="done" class="h-7 w-7 mr-1"></app-icon>
          {{ 'compactPlayer.insights.done' | translate }}
        </button>
      </footer>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="isCalculatorModalVisible">
  <app-barbell-calculator-modal (close)="closeCalculatorModal()"></app-barbell-calculator-modal>
</div>
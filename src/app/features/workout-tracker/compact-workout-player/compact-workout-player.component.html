<!-- compact-workout-player.component.html -->

<div class="compact-player-container bg-gray-100 dark:bg-gray-900 min-h-screen">
  <!-- Header -->
  <header
    class="sticky top-0 z-20 bg-white dark:bg-gray-800 shadow-md px-3 pt-3 pb-2 flex flex-col justify-between rounded-b-md">

    <!-- Top part of header -->
    <div class="flex items-center justify-between w-full">
      <button (click)="goBack()" class="p-2">
        <app-icon name="cancel" class="h-6 w-6 text-gray-600 dark:text-gray-300"></app-icon>
      </button>
      <div class="text-center">
        <h1 class="text-lg font-bold text-gray-800 dark:text-gray-100 truncate max-w-xs">
          {{ routine()?.name || 'Workout' }}
        </h1>
        <div class="text-xl font-mono font-semibold text-primary dark:text-primary-light tracking-wider">
          {{ sessionTimerDisplay() }}
        </div>
      </div>
      <!-- MODIFIED: Container for Pause/Resume and Notes buttons -->
      <div class="relative flex items-center">
        <!-- +++ NEW: Session Notes Button +++ -->
        <button (click)="editSessionNotes()" class="p-2">
          <app-icon name="clipboard-list" class="h-6 w-6 text-gray-600 dark:text-gray-300"></app-icon>
        </button>
        <button *ngIf="sessionState() === 'playing'" (click)="pauseSession()" class="p-2">
          <app-icon name="pause" class="h-6 w-6 text-gray-600 dark:text-gray-300"></app-icon>
        </button>
        <button *ngIf="sessionState() === 'paused'" (click)="resumeSession()" class="p-2">
          <app-icon name="play" class="h-6 w-6 text-primary dark:text-primary-light animate-pulse"></app-icon>
        </button>
      </div>
    </div>

    <!-- Workout Progress Bar -->
    <div class="w-full mt-2">
      <span class="flex justify-center text-white dark:text-primary-light font-mono">Overall progress</span>
      <div class="progress-bar-container w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 relative">
        <div class="progress-bar bg-primary h-2.5 rounded-full" [style.width.%]="workoutProgress()"></div>
        <span *ngIf="workoutProgress() > 5"
          class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-white">
          {{ workoutProgress() | number:'1.0-0' }}%
        </span>
      </div>
    </div>
  </header>



  <!-- Main Content: Exercises List -->
<main class="pt-4 px-2 pb-36">
  <div *ngIf="routine() as currentRoutine; else loading" class="space-y-1">
    <!-- MODIFIED: Changed space-y-1 to space-y-3 for better superset group separation -->
    <div *ngFor="let exercise of currentRoutine.exercises; let exIndex = index"
      class="bg-white dark:bg-gray-800 rounded-lg shadow-sm transition-all duration-300 relative"
      [class.superset-group]="exercise.supersetId"
      [class.superset-start]="isSupersetStart(exIndex)"
      [class.superset-middle]="isSupersetMiddle(exIndex)"
      [class.superset-end]="isSupersetEnd(exIndex)"
      [style.zIndex]="areActionsVisible(exIndex) ? 50 : 'auto'">

      <!-- +++ NEW: Superset Indicator Ribbon +++ -->
      <div *ngIf="exercise.supersetId && isSupersetStart(exIndex)"
           class="absolute -left-2 top-2 bg-primary dark:bg-primary-dark text-white text-xs font-bold px-2 py-1 rounded-md shadow-lg z-10 transform translate-x-0 -translate-y-5">
        SUPERSET
      </div>

      <!-- Exercise Header -->
      <div (click)="toggleExerciseExpansion(exIndex)"
        class="p-3 flex items-center justify-between cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50"
        [class.rounded-t-lg]="!isSupersetMiddle(exIndex) && !isSupersetEnd(exIndex)"
        [class.rounded-b-lg]="expandedExerciseIndex() !== exIndex && !isSupersetStart(exIndex) && !isSupersetMiddle(exIndex)">
        <div class="flex items-center space-x-3 min-w-0">
          <!-- MODIFIED: Display superset letter -->
          <span class="font-semibold text-gray-800 dark:text-gray-100">
            {{ getExerciseDisplayIndex(exIndex) }}
          </span>
          <h2 class="max-w-[250px] text-md font-semibold text-gray-800 dark:text-gray-100 text-wrap">
            {{ exercise.exerciseName }}
          </h2>
        </div>

        <!-- Action Menu Container -->
        <div class="absolute top-2 right-2 z-60">
          <div class="flex">
            <app-icon name="chevron-down"
              class="h-7 w-7 text-gray-500 transition-transform duration-200 flex-shrink-0"
              [class.rotate-180]="expandedExerciseIndex() === exIndex"></app-icon>
            <button (click)="toggleExerciseNotes(exIndex, $event)"
              class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-500 rounded-full focus:outline-none flex items-center p-1">
              <app-icon name="clipboard-list" class="h-6 w-6"></app-icon>
            </button>
            <button (click)="toggleActionMenu(exIndex, $event)"
              class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-500 rounded-full focus:outline-none flex items-center">
              <app-icon name="menu-action" class="h-7 w-7"></app-icon>
            </button>
            <app-action-menu [isVisible]="activeActionMenuIndex() === exIndex && menuModeDropdown"
              class="action-menu-container" displayMode="dropdown" [items]="getLogDropdownActionItems(exIndex, 'dropdown')"
              (itemClick)="handleActionMenuItemClick($event)" (closeMenu)="closeActionMenu()">
            </app-action-menu>
            <app-action-menu [isVisible]="activeActionMenuIndex() === exIndex && menuModeModal"
              class="action-menu-container" displayMode="modal" [items]="getLogDropdownActionItems(exIndex, 'modal')"
              (itemClick)="handleActionMenuItemClick($event)" (closeMenu)="closeActionMenu()"
              [customButtonDivCssClass]="' '">
            </app-action-menu>
          </div>
        </div>
      </div>

        <!-- Sets Container -->
        <div *ngIf="expandedExerciseIndex() === exIndex"
          class="bg-gray-50 dark:bg-gray-700/50 py-2 px-1 border-t border-gray-200 dark:border-gray-700 rounded-t-md rounded-b-md">
          <!-- Set Headers -->
          <div class="grid grid-cols-12 gap-2 text-xs font-medium text-gray-500 dark:text-gray-400 mb-2 px-2">
            <div class="col-span-1 text-center">Set</div>
            <ng-container *ngIf="!isCardio(exercise)">
              <div class="col-span-3 text-center">Weight ({{ unitsService.getUnitLabel() }})</div>
              <div class="col-span-3 text-center">Reps</div>
            </ng-container>
            <ng-container *ngIf="isCardio(exercise)">
              <div class="col-span-3 text-center">Distance</div>
              <div class="col-span-3 text-center">Time</div>
            </ng-container>
            <div class="col-span-2 text-center">Status</div>
            <div class="col-span-3 text-center">Actions</div> <!-- Actions Header -->
          </div>

          <!-- Sets List -->
          <div class="space-y-2">
            <!-- MODIFIED: *ngFor container to include notes section -->
            <ng-container *ngFor="let set of exercise.sets; let setIndex = index">
              <div class="grid grid-cols-12 gap-2 items-center rounded-md p-2 shadow-sm"
                [ngClass]="{'bg-blue-100 dark:bg-blue-700/70': set.type === 'warmup', 'bg-white dark:bg-gray-800': set.type !== 'warmup'}">
                <div class="col-span-1 text-center font-semibold text-gray-700 dark:text-gray-200">{{ setIndex + 1 }}
                </div>

                <!-- Input fields remain the same -->
                <ng-container *ngIf="!isCardio(exercise)">
                  <div class="col-span-3">
                    <input type="number" [ngModel]="getInitialInputValue(exIndex, setIndex, 'weight')"
                      (change)="updateSetData(exIndex, setIndex, 'weight', $event)"
                      class="w-full text-center bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-1 focus:ring-primary-dark focus:border-primary-dark dark:text-gray-200">
                  </div>
                  <div class="col-span-3">
                    <input type="number" [ngModel]="getInitialInputValue(exIndex, setIndex, 'reps')"
                      (change)="updateSetData(exIndex, setIndex, 'reps', $event)"
                      class="w-full text-center bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-1 focus:ring-primary-dark focus:border-primary-dark dark:text-gray-200">
                  </div>
                </ng-container>
                <ng-container *ngIf="isCardio(exercise)">
                  <div class="col-span-3">
                    <input type="number" step="0.1" placeholder="km"
                      [ngModel]="getInitialInputValue(exIndex, setIndex, 'distance')"
                      (change)="updateSetData(exIndex, setIndex, 'distance', $event)"
                      class="w-full text-center bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-1 focus:ring-primary-dark focus:border-primary-dark dark:text-gray-200">
                  </div>
                  <div class="col-span-3">
                    <input type="text" placeholder="mm:ss" [ngModel]="getInitialInputValue(exIndex, setIndex, 'time')"
                      (change)="updateSetData(exIndex, setIndex, 'time', $event)"
                      class="w-full text-center bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-1 focus:ring-primary-dark focus:border-primary-dark dark:text-gray-200">
                  </div>
                </ng-container>

                <div class="col-span-2 flex justify-center">
                  <button (click)="toggleSetCompletion(exercise, set, exIndex, setIndex)"
                    [disabled]="!isSetDataValid(exIndex, setIndex)"
                    class="h-10 w-10 rounded-full flex items-center justify-center transition-all duration-200 ease-in-out transform active:scale-90 disabled:opacity-50 disabled:cursor-not-allowed"
                    [ngClass]="isSetCompleted(exIndex, setIndex) ? 'bg-green-500 text-white shadow-lg' : 'bg-gray-200 dark:bg-gray-600 text-gray-500 dark:text-gray-300'">
                    <app-icon name="done" class="h-6 w-6"></app-icon>
                  </button>
                </div>

                <!-- MODIFIED: Set actions now include a notes button -->
                <div class="col-span-3 flex justify-center items-center">
                  <!-- +++ NEW: Set Notes Button +++ -->
                  <button (click)="toggleSetNotes(exIndex, setIndex, $event)"
                    class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">
                    <app-icon name="clipboard-list" class="h-5 w-5 text-gray-500 dark:text-gray-400"></app-icon>
                  </button>
                  <button (click)="removeSet(exIndex, setIndex)"
                    class="p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-700/50">
                    <app-icon name="trash" class="h-5 w-5 text-red-500 dark:text-red-400"></app-icon>
                  </button>
                </div>
              </div>
              <!-- +++ NEW: Set Notes Textarea +++ -->
              <div *ngIf="expandedSetNotes() === (exIndex + '-' + setIndex)" class="px-2 pb-2">
                <textarea [ngModel]="getInitialInputValue(exIndex, setIndex, 'notes')"
                  (change)="updateSetData(exIndex, setIndex, 'notes', $event)" placeholder="Notes for this set..."
                  class="w-full text-xs bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-md p-1.5 focus:ring-primary-dark focus:border-primary-dark dark:text-gray-200"></textarea>
              </div>
            </ng-container>
          </div>
        </div>
      </div>
    </div>

    <ng-template #loading>
      <div class="text-center py-10">
        <p class="text-gray-500">Loading workout...</p>
      </div>
    </ng-template>
  </main>

  <!-- Footer with Action Buttons -->
  <footer class="flex justify-center fixed left-0 right-0 z-20" [style.bottom]="'var(--main-nav-height)'">
    <div
      class="w-full max-w-sm grid grid-cols-2 gap-4 bg-white dark:bg-gray-800/80 dark:backdrop-blur-sm border-t border-x border-gray-200 dark:border-gray-700 p-3 rounded-t-md">

      <!-- Button 1 -->
      <button (click)="openAddExerciseModal()"
        class="flex items-center justify-center space-x-2 bg-blue-500 text-white font-semibold py-2 px-4 rounded-full shadow-lg hover:bg-blue-600 transition-colors">
        <app-icon name="plus-circle" class="h-6 w-6"></app-icon>
        <span>ADD EXERCISE</span>
      </button>

      <!-- Button 2 -->
      <button (click)="finishWorkout()"
        [disabled]="!this.currentWorkoutLog() || !this.currentWorkoutLog().exercises || this.currentWorkoutLog().exercises?.length === 0"
        class="flex items-center justify-center space-x-2 bg-green-500 text-white font-semibold py-2 px-4 rounded-full shadow-lg hover:bg-green-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
        <app-icon name="done" class="h-6 w-6"></app-icon>
        <span>FINISH</span>
      </button>

    </div>
  </footer>

  <app-exercise-selection-modal [isOpen]="isAddExerciseModalOpen()" [(searchTerm)]="modalSearchTerm"
    title="ADD EXERCISE" [exercises]="availableExercises" (exerciseSelected)="addExerciseToRoutine($event)"
    (close)="closeAddExerciseModal()">
  </app-exercise-selection-modal>

  <app-exercise-selection-modal [isOpen]="isSwitchExerciseModalOpen()" [(searchTerm)]="modalSearchTerm"
    [title]="isShowingSimilarInSwitchModal() ? 'SIMILAR EXERCISES' : 'SWITCH EXERCISE'"
    [exercises]="filteredExercisesForSwitchModal()" searchPlaceholder="Search for a replacement..."
    [showSimilarButton]="true" [isShowingSimilarView]="isShowingSimilarInSwitchModal()" itemIconName="change"
    itemIconClass="text-green-500" (exerciseSelected)="handleExerciseSwitch($event)"
    (findSimilarClicked)="findAndShowSimilarExercises(exerciseToSwitchIndex())"
    (backToSearchClicked)="isShowingSimilarInSwitchModal.set(false)" (close)="closeSwitchExerciseModal()">
  </app-exercise-selection-modal>

  <!-- MODIFIED: Pass next set details to the rest timer component -->
  <app-full-screen-rest-timer [isVisible]="isRestTimerVisible()" [mainTimer]="sessionTimerDisplay"
    [durationSeconds]="restDuration()" [mainText]="restTimerMainText()" [nextUpText]="restTimerNextUpText()"
    (timerFinished)="handleRestTimerFinished()"
    (timerSkipped)="handleRestTimerSkipped($event)">
  </app-full-screen-rest-timer>

  <!-- Performance Insights Modal -->
  <div *ngIf="isPerformanceInsightsModalOpen()" style="z-index: 100"
    class="fixed inset-0 bg-gray-900/70 dark:bg-black/80 backdrop-blur-md flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out">
    <div *ngIf="insightsData() as data"
      class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-xl max-h-[90vh] flex flex-col overflow-hidden transform transition-all duration-300 ease-in-out">
      <header class="p-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center flex-shrink-0">
        <div class="flex items-center gap-3">
          <app-icon name="chart" class="h-7 w-7 text-primary dark:text-primary-light"></app-icon>
          <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100">Performance Insights</h3>
        </div>
        <button (click)="closePerformanceInsightsModal()"
          class="p-1.5 rounded-full text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700/70 focus:outline-none transition-colors">
          <app-icon name="cancel" class="h-6 w-6"></app-icon>
        </button>
      </header>
      <div class="p-5 overflow-y-auto space-y-6 flex-grow">
        <div class="rounded-md border border-gray-200 dark:border-gray-700/80">
          <button (click)="toggleCompletedSetsForExerciseInfo()" class="w-full flex items-center justify-between p-3 text-left text-sm font-medium text-gray-700
          dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors rounded-t-lg">
            <span class="flex items-center gap-2">
              <app-icon name="clipboard-list" class="h-6 w-6"></app-icon>
              <span>Completed Sets in this Session ({{ data.completedSetsInSession.length }})</span>
            </span>
            <app-icon name="chevron-down" class="h-5 w-5 transform transition-transform duration-200"
              [ngClass]="{'rotate-180': showCompletedSetsForExerciseInfo()}"></app-icon>
          </button>
          <div *ngIf="showCompletedSetsForExerciseInfo()"
            class="bg-gray-50 dark:bg-gray-700/30 p-3 border-t border-gray-200 dark:border-gray-700/80 space-y-3 max-h-48 overflow-y-auto rounded-b-lg">
            <div *ngFor="let setLog of data.completedSetsInSession; let i = index"
              class="text-xs p-2 bg-white dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600">
              <p class="font-semibold text-gray-700 dark:text-gray-200 mb-1">
                Set #{{ i + 1 }}:
              </p>
              <div class="grid grid-cols-2 gap-x-2 gap-y-1 text-gray-600 dark:text-gray-300">
                <span *ngIf="setLog.repsAchieved">Reps: <strong class="dark:text-gray-100">{{ setLog.repsAchieved
                    }}</strong></span>
                <span *ngIf="setLog.weightUsed != null">Weight: <strong class="dark:text-gray-100">{{ setLog.weightUsed
                    |
                    weightUnit }}</strong></span>
                <span *ngIf="setLog.distanceAchieved">Distance: <strong class="dark:text-gray-100">{{
                    setLog.distanceAchieved }} km</strong></span>
                <span *ngIf="setLog.durationPerformed">Time: <strong class="dark:text-gray-100">{{
                    formatSecondsToTime(setLog.durationPerformed) }}</strong></span>
              </div>
            </div>
            <div *ngIf="data.completedSetsInSession.length === 0"
              class="p-3 text-xs text-center text-gray-500 dark:text-gray-400">
              No sets completed yet for this exercise in this workout.
            </div>
          </div>
        </div>
        <div class="rounded-md border border-gray-200 dark:border-gray-700/80">
          <div class="p-3 text-sm font-medium text-gray-700 dark:text-gray-300">
            <span class="flex items-center gap-2">
              <app-icon name="calendar-page" class="h-6 w-6"></app-icon>
              <span>Last Performance ({{ data.lastPerformance?.lastPerformedDate | date:'shortDate' }})</span>
            </span>
          </div>
          <div *ngIf="data.lastPerformance as lastPerf"
            class="bg-gray-50 dark:bg-gray-700/30 p-3 border-t border-gray-200 dark:border-gray-700/80 space-y-3 max-h-48 overflow-y-auto rounded-b-lg">
            <div *ngFor="let setLog of lastPerf.sets; let i = index"
              class="text-xs p-2 bg-white dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600">
              <p class="font-semibold text-gray-700 dark:text-gray-200 mb-1">Set #{{ i + 1 }}:</p>
              <div class="grid grid-cols-2 gap-x-2 gap-y-1 text-gray-600 dark:text-gray-300">
                <span *ngIf="setLog.repsAchieved">Reps: <strong class="dark:text-gray-100">{{ setLog.repsAchieved
                    }}</strong></span>
                <span *ngIf="setLog.weightUsed != null">Weight: <strong class="dark:text-gray-100">{{ setLog.weightUsed
                    |
                    weightUnit }}</strong></span>
                <span *ngIf="setLog.distanceAchieved">Distance: <strong class="dark:text-gray-100">{{
                    setLog.distanceAchieved }} km</strong></span>
                <span *ngIf="setLog.durationPerformed">Time: <strong class="dark:text-gray-100">{{
                    formatSecondsToTime(setLog.durationPerformed) }}</strong></span>
              </div>
            </div>
          </div>
          <div *ngIf="!data.lastPerformance"
            class="p-3 text-xs text-center text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700/80 rounded-b-lg">
            No previous performance recorded for this exercise.
          </div>
        </div>
        <div class="rounded-md border border-gray-200 dark:border-gray-700/80">
          <div class="p-3 text-sm font-medium text-gray-700 dark:text-gray-300">
            <span class="flex items-center gap-2">
              <app-icon name="pb" class="h-6 w-6 text-yellow-500"></app-icon>
              <span>Personal Bests</span>
            </span>
          </div>
          <div *ngIf="data.personalBests.length > 0"
            class="bg-gray-50 dark:bg-gray-700/30 p-3 border-t border-gray-200 dark:border-gray-700/80 grid grid-cols-1 sm:grid-cols-2 gap-3 rounded-b-lg">
            <div *ngFor="let pb of data.personalBests"
              class="text-xs p-2 bg-white dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600">
              <p class="font-semibold text-gray-700 dark:text-gray-200">{{ pb.pbType }}</p>
              <p class="text-lg font-bold text-primary dark:text-primary-light">{{ formatPbValue(pb) }}</p>
              <p class="text-2xs text-gray-500 dark:text-gray-400">on {{ pb.timestamp | date:'shortDate' }}</p>
            </div>
          </div>
          <div *ngIf="data.personalBests.length === 0"
            class="p-3 text-xs text-center text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700/80 rounded-b-lg">
            No personal bests recorded for this exercise yet.
          </div>
        </div>
      </div>
      <footer
        class="p-4 bg-gray-50 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 text-right flex-shrink-0">
        <button (click)="closePerformanceInsightsModal()"
          class="inline-flex items-center bg-primary hover:bg-primary-dark focus:ring-4 focus:ring-primary-focus text-white font-semibold py-2.5 px-6 rounded-md text-sm transition-colors shadow-md hover:shadow-lg">
          <app-icon name="done" class="h-7 w-7 mr-1"></app-icon>
          DONE
        </button>
      </footer>
    </div>
  </div>
</div>

<!-- <app-exercise-selection-modal
  [isOpen]="isAddToSupersetModalOpen()"
  [(searchTerm)]="modalSearchTerm"
  title="ADD TO SUPERSET"
  [exercises]="availableExercises"
  (exerciseSelected)="addExerciseToSuperset($event)"
  (close)="closeAddToSupersetModal()">
</app-exercise-selection-modal> -->
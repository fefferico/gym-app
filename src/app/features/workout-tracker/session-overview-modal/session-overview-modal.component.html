<div *ngIf="isOpen"
    class="fixed inset-0 backdrop-blur-md flex items-center justify-center p-4 z-[100]"
    (click)="close.emit()">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl h-[90vh] flex flex-col overflow-hidden"
        (click)="$event.stopPropagation()">

        <!-- Header -->
        <header
            class="p-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center flex-shrink-0">
            <div class="flex items-center gap-3">
                <app-icon name="clipboard-list" class="h-7 w-7 text-primary dark:text-primary-light"></app-icon>
                <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100">{{ 'sessionOverview.title' | translate }}</h3>
            </div>
            <button (click)="close.emit()"
                class="p-1.5 rounded-full text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700/70 focus:outline-none transition-colors">
                <app-icon name="cancel" class="h-6 w-6"></app-icon>
            </button>
        </header>

        <!-- Main Content (Scrollable with Themed Scrollbar) -->
        <div class="p-4 sm:p-6 overflow-y-auto space-y-4 flex-grow bg-gray-100 dark:bg-gray-900 
                    scrollbar-thin scrollbar-thumb-primary dark:scrollbar-thumb-primary-dark 
                    scrollbar-track-gray-200 dark:scrollbar-track-gray-700 
                    hover:scrollbar-thumb-primary-dark dark:hover:scrollbar-thumb-primary">
            <ng-container *ngFor="let group of groupedExercises(); trackBy: trackByGroup">
                <!-- Superset Group Card -->
                <div *ngIf="group.type === 'superset'"
                    class="bg-gray-50 dark:bg-gray-900/50 border border-primary/50 rounded-lg shadow-sm">
                    <h4 class="text-lg font-bold text-primary dark:text-primary-light p-3 border-b border-primary/20">
                        Superset</h4>
                    <div class="space-y-4 p-3">
                        <ng-container *ngFor="let exercise of group.exercises; let i = index">
                            <div [ngClass]="{'pt-4 border-t border-gray-200 dark:border-gray-700': i > 0}">
                                <!-- Pass the unwrapped signal value -->
                                <app-exercise-overview-item 
                                    [exercise]="exercise" 
                                    [loggedExercises]="loggedExercisesSignal()" 
                                    [activeExerciseId]="activeExerciseId"
                                    [activeSetIndex]="activeSetIndex"
                                    [activeBlockRound]="activeBlockRound">
                                </app-exercise-overview-item>
                            </div>
                        </ng-container>
                    </div>
                </div>

                <!-- Standard Exercise Card -->
                <div *ngIf="group.type === 'standard'"
                    class="bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg p-4 shadow-sm">
                    <!-- Pass the unwrapped signal value -->
                    <app-exercise-overview-item 
                        [exercise]="group.exercise" 
                        [loggedExercises]="loggedExercisesSignal()"
                        [activeExerciseId]="activeExerciseId"
                        [activeSetIndex]="activeSetIndex"
                        [activeBlockRound]="activeBlockRound">
                    </app-exercise-overview-item>
                </div>
            </ng-container>
        </div>

        <!-- Footer -->
        <footer
            class="p-4 bg-gray-50 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 text-right flex-shrink-0">
            <button (click)="close.emit()"
                class="inline-flex items-center bg-primary hover:bg-primary-dark focus:ring-4 focus:ring-primary-focus text-white font-semibold py-2.5 px-6 rounded-md text-sm transition-colors shadow-md hover:shadow-lg">
                <app-icon name="done" class="h-7 w-7 mr-1"></app-icon>
                {{ 'sessionOverview.doneButton' | translate }}
            </button>
        </footer>
    </div>
</div>
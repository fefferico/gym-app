<div *ngIf="isOpen"
    class="fixed inset-0 bg-gray-900/70 dark:bg-black/80 backdrop-blur-md flex items-center justify-center p-4 z-[100]"
    (click)="close.emit()">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl h-[90vh] flex flex-col overflow-hidden"
        (click)="$event.stopPropagation()">

        <!-- Header -->
        <header
            class="p-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center flex-shrink-0">
            <div class="flex items-center gap-3">
                <app-icon name="clipboard-check" class="h-7 w-7"></app-icon>
                <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100">Generated Workout Summary</h3>
                <!-- +++ NEW: Dynamic Total Duration Display +++ -->
                <p *ngIf="totalEstimatedDuration() > 0" class="text-sm text-gray-500 dark:text-gray-400">
                    Estimated Duration: ~{{ totalEstimatedDuration() }} min
                </p>
            </div>
            <button (click)="close.emit()"
                class="p-1.5 rounded-full text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700/70 focus:outline-none transition-colors">
                <app-icon name="cancel" class="h-6 w-6"></app-icon>
            </button>
        </header>

        <!-- Main Content (Scrollable) -->
        <div class="p-4 sm:p-6 overflow-y-auto space-y-4 flex-grow bg-gray-100 dark:bg-gray-900 
                    scrollbar-thin scrollbar-thumb-primary dark:scrollbar-thumb-primary-dark 
                    scrollbar-track-gray-200 dark:scrollbar-track-gray-700">

            <!-- <div *ngIf="generatedRoutineSignal() as routine"
                class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/30 border-l-4 border-blue-400 rounded-r-md">
                <h4 class="font-bold text-lg text-blue-800 dark:text-blue-200">{{ routine.name }}</h4>
                <p class="text-sm text-gray-600 dark:text-gray-400">{{ routine.description }}</p>
            </div> -->

            <ng-container *ngFor="let group of groupedExercises(); let i = index; trackBy: trackByGroup">
                <!-- Superset Group Card -->
                <div *ngIf="group.type === 'superset'"
                    class="bg-gray-50 dark:bg-gray-900/50 border border-primary/50 rounded-lg shadow-sm">
                    <div class="flex justify-between items-center p-3 border-b border-primary/20">
                        <h4 class="text-lg font-bold text-primary dark:text-primary-light">Superset</h4>
                        <button (click)="onSupersetRemove(group.supersetId)" title="Remove Entire Superset"
                            class="p-1.5 rounded-full hover:bg-red-100 dark:hover:bg-red-700/50">
                            <app-icon name="trash" class="h-5 w-5 text-red-500 dark:text-red-400"></app-icon>
                        </button>
                    </div>
                    <div class="space-y-4 p-3">
                        <!-- +++ START OF FIX +++ -->
                        <!-- We need another inner *ngFor to handle the array of exercises within the group -->
                        <ng-container *ngFor="let exercise of group.exercises; let j = index">
                            <div [ngClass]="{'pt-4 border-t border-gray-200 dark:border-gray-700': j > 0}">
                                <!-- The computed signal provides a slice of the main signal -->
                                <app-generated-exercise-item [exercise]="getExerciseSignal(exercise.id)"
                                    (exerciseUpdated)="onExerciseUpdate($event)"
                                    (exerciseRemoved)="onExerciseRemove($event)">
                                </app-generated-exercise-item>
                            </div>
                        </ng-container>
                        <!-- +++ END OF FIX +++ -->
                    </div>
                </div>

                <!-- Standard Exercise Card -->
                <div *ngIf="group.type === 'standard'"
                    class="bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg p-4 shadow-sm">
                    <!-- +++ START OF FIX +++ -->
                    <!-- The computed signal provides a slice of the main signal -->
                    <app-generated-exercise-item [exercise]="getExerciseSignal(group.exercise.id)"
                        (exerciseUpdated)="onExerciseUpdate($event)" (exerciseRemoved)="onExerciseRemove($event)">
                    </app-generated-exercise-item>
                    <!-- +++ END OF FIX +++ -->
                </div>
            </ng-container>
        </div>

        <!-- Footer -->
        <footer
            class="p-4 bg-gray-50 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 flex justify-between items-center flex-shrink-0">
            <button (click)="close.emit()"
                class="px-6 py-2.5 text-sm font-semibold text-gray-700 dark:text-gray-300 bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 rounded-md transition-colors">
                BACK
            </button>
            <button (click)="start.emit(generatedRoutineSignal()!)"
                class="inline-flex items-center bg-green-500 hover:bg-green-600 focus:ring-4 focus:ring-green-300 text-white font-bold py-2.5 px-8 rounded-md text-sm transition-colors shadow-md hover:shadow-lg">
                <app-icon name="play" class="h-6 w-6 mr-2"></app-icon>
                START WORKOUT
            </button>
        </footer>
    </div>
</div>
<!-- Main container with background color -->
<div class="workout-player-container bg-gray-50 dark:bg-gray-950 min-h-screen flex flex-col"
  *ngIf="routine() !== undefined; else loadingOrError">

  <!-- PAUSED OVERLAY -->
  <div *ngIf="sessionState() === 'paused'"
    class="fixed inset-0 z-[60] bg-black/70 backdrop-blur-sm flex flex-col items-center justify-center space-y-6 p-4">
    <h2 class="text-4xl font-bold text-white">Session Paused</h2>
    <p class="text-lg text-gray-200">Elapsed Time: {{ sessionTimerDisplay() }}</p>
    <button (click)="resumeSession()"
      class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg w-full max-w-xs">
      Resume Workout
    </button>
    <button (click)="quitWorkout()"
      class="text-sm text-red-300 hover:text-red-100 font-medium py-2 px-4 rounded-md border border-red-300 hover:bg-red-700/30 w-full max-w-xs mt-2">
      Quit Workout (No Save)
    </button>
  </div>

  <ng-container *ngIf="routine() as currentRoutine; else routineNotFound">
    <!-- Top Bar -->
    <header
      class="fixed top-0 left-0 right-0 z-30 bg-gray-50 dark:bg-gray-950 border-b border-gray-200 dark:border-gray-800 p-2 flex items-center justify-between h-14">
      <button (click)="goBack()"
        class="text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light p-2 -ml-1">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      </button>
      <div class="text-center">
        <h1 class="text-sm font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider truncate max-w-[calc(100vw-120px)]" [title]="currentRoutine.name">
          {{ currentRoutine.name || 'Workout' }}
        </h1>
        <div class="text-xs text-gray-500 dark:text-gray-400">{{ sessionTimerDisplay() }}</div>
      </div>
      <button (click)="toggleWorkoutMenu()" [disabled]="sessionState() === 'loading' || sessionState() === 'error' || sessionState() === 'paused'"
        class="text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light p-2 -mr-1 disabled:opacity-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"
          stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
        </svg>
      </button>
    </header>

    <main class="flex-grow overflow-y-auto pt-10" [class.pb-20]="isRestTimerVisible()"
      [class.pb-4]="!isRestTimerVisible()">
      <div class="p-4 max-w-md mx-auto" *ngIf="activeSetInfo() as activeSet; else workoutCompleteOrError">

        <div class="flex text-center justify-center items-center mb-1">
            <div *ngIf="currentBaseExercise() as baseEx" class="mr-2 h-8 w-8 flex-shrink-0">
                <img *ngIf="baseEx.iconName" [src]="getIconPath(baseEx.iconName)" [alt]="baseEx.name + ' icon'"
                    class="w-full h-full object-contain"
                    [ngClass]="{'filter dark:invert': baseEx.iconName !== 'default-exercise' && baseEx.iconName !== '' && baseEx.iconName !== null }">
            </div>
            <ng-template #loadingBaseExIcon>
                <div class="w-8 h-8 bg-gray-200 dark:bg-gray-700 rounded-md animate-pulse mr-2 flex-shrink-0"></div>
            </ng-template>
             <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 truncate" [title]="activeSet.exerciseData.exerciseName">
                {{ activeSet.exerciseData.exerciseName || 'Loading Exercise...' }}
            </h2>
        </div>

        <div class="text-center mb-4">
          <p class="text-sm text-gray-500 dark:text-gray-400">
            <span *ngIf="activeSet.isWarmup" class="text-blue-500 dark:text-blue-400">
              Warm-up Set {{ getCurrentWarmupSetNumber() }}
              <span *ngIf="getTotalWarmupSetsForCurrentExercise() > 0">/{{ getTotalWarmupSetsForCurrentExercise() }}</span>
            </span>
            <span *ngIf="!activeSet.isWarmup">
              Set {{ getCurrentWorkingSetNumber() }}/{{ getWorkingSetCountForCurrentExercise() }}
            </span>
            <span *ngIf="totalBlockRounds() > 1 && currentBlockRound() > 0" class="ml-2">
              (Round {{currentBlockRound()}}/{{totalBlockRounds()}})
            </span>
             <span *ngIf="activeSet.exerciseData.supersetId" class="ml-2 text-purple-500 dark:text-purple-400 italic">
                (Superset {{ (activeSet.exerciseData.supersetOrder ?? 0) + 1 }}/{{activeSet.exerciseData.supersetSize ?? '?'}})
            </span>
          </p>
        </div>

        <form [formGroup]="currentSetForm" class="space-y-6 mb-8">
          <div *ngIf="csf['actualWeight']">
            <label
              class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider text-center mb-2">Weight</label>
            <div class="flex items-center justify-center space-x-3">
              <button type="button" (click)="decrementWeight(0.5)" [disabled]="getDisabled()"
                class="p-3 bg-gray-200 dark:bg-gray-700 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                </svg>
              </button>
              <input type="number" formControlName="actualWeight" readonly
                class="w-28 text-center text-3xl font-bold bg-transparent border-none p-0 focus:ring-0 text-gray-800 dark:text-gray-100"
                placeholder="0">
              <span class="text-lg text-gray-700 dark:text-gray-200 -ml-2">{{weightUnitDisplaySymbol}}</span>
              <button type="button" (click)="incrementWeight(0.5)" [disabled]="getDisabled()"
                class="p-3 bg-gray-200 dark:bg-gray-700 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
              </button>
            </div>
          </div>

          <div *ngIf="csf['actualReps'] && activeSet.setData.reps !== undefined">
            <label
              class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider text-center mb-2">Reps</label>
            <div class="flex items-center justify-center space-x-3">
              <button type="button" (click)="decrementReps(1)" [disabled]="getDisabled()"
                class="p-3 bg-gray-200 dark:bg-gray-700 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                </svg>
              </button>
              <input type="number" formControlName="actualReps" readonly
                class="w-28 text-center text-3xl font-bold bg-transparent border-none p-0 focus:ring-0 text-gray-800 dark:text-gray-100"
                placeholder="0">
              <button type="button" (click)="incrementReps(1)" [disabled]="getDisabled()"
                class="p-3 bg-gray-200 dark:bg-gray-700 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
              </button>
            </div>
          </div>
          
          <!-- Actual Duration (for timed sets or manually entered duration) -->
            <div *ngIf="activeSet.setData.duration !== undefined"> <!-- Show if duration is a relevant metric for this set -->
                <label for="timedSetDisplay" class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider text-center mb-2">
                    Time (seconds) <span *ngIf="activeSet.setData.duration > 0">(Target: {{activeSet.setData.duration}}s)</span>
                </label>
                
                <!-- Display for countdown/countup -->
                <div id="timedSetDisplay"
                     class="mt-1 block w-full p-3 border-none text-3xl font-bold text-center bg-transparent focus:ring-0"
                     [ngClass]="{
                        'text-red-500': isTimedSetOvertime(),
                        'animate-pulse': isTimedSetOvertime() && timedSetTimerState() === 'running',
                        'text-green-500 dark:text-green-400': !isTimedSetOvertime() && timedSetTimerState() === 'running' && (activeSetInfo()?.setData?.duration ?? 0) > 0 && timedSetElapsedSeconds() > 0,
                        'text-gray-800 dark:text-gray-100': timedSetTimerState() === 'idle' || timedSetTimerState() === 'paused' || !((activeSetInfo()?.setData?.duration ?? 0) > 0 && timedSetElapsedSeconds() > 0 && !isTimedSetOvertime())
                     }">
                  {{ timedSetDisplay() }}
                </div>
                 <!-- Hidden input to store the actual LOGGED duration (total elapsed) -->
                <input type="number" formControlName="actualDuration" class="hidden">

                <div class="flex space-x-2 mt-2 justify-center">
                    <button type="button" (click)="toggleTimedSetTimer()" [disabled]="getDisabled()" 
                            [ngClass]="{
                              'bg-green-500 hover:bg-green-600': timedSetTimerState() === 'idle' || timedSetTimerState() === 'paused',
                              'bg-yellow-500 hover:bg-yellow-600 text-black': timedSetTimerState() === 'running'
                            }" 
                            class="flex-grow max-w-[150px] text-white font-medium py-2 px-3 rounded-md transition-colors text-sm disabled:opacity-50">
                      <span *ngIf="timedSetTimerState() === 'idle'">Start Timer</span>
                      <span *ngIf="timedSetTimerState() === 'running'">Pause Timer</span>
                      <span *ngIf="timedSetTimerState() === 'paused'">Resume Timer</span>
                    </button>
                    <button type="button" (click)="resetTimedSet()" *ngIf="timedSetTimerState() !== 'idle'" [disabled]="getDisabled()"
                            class="flex-grow max-w-[150px] bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-medium py-2 px-3 rounded-md transition-colors text-sm disabled:opacity-50">
                      Reset
                    </button>
                </div>
            </div>


          <div *ngIf="false" class="pt-4">
            <button type="button" (click)="toggleRpeInput()"
              class="w-full text-center text-sm text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary-light mb-2">
              Tap to track RPE (optional)
              <svg xmlns="http://www.w3.org/2000/svg" class="inline h-4 w-4 ml-1 text-gray-400 dark:text-gray-500"
                fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </button>
            <div *ngIf="showRpeSlider()" class="mt-2 px-2">
              <input type="range" min="1" max="10" step="1" [ngModel]="rpeValue()" (ngModelChange)="updateRpe($event)"
                formControlName="rpe"
                class="w-full h-2 bg-gray-300 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:bg-red-500 [&::-moz-range-thumb]:bg-red-500">
              <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 px-1 mt-1">
                <span>Easy</span>
                <span class="font-semibold text-red-500">{{ rpeValue() || '-' }}</span>
                <span>Max Effort</span>
              </div>
            </div>
          </div>
        </form>

        <button (click)="completeSetAndProceed()" [disabled]="sessionState() === 'paused'"
          class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-4 rounded-2xl shadow-md text-lg transition-colors focus:outline-none focus:ring-2 focus:ring-red-400 disabled:opacity-50">
          {{ nextActionButtonLabel() }}
        </button>

      </div>
      <ng-template #workoutCompleteOrError>
        <div class="text-center py-10 pt-16"> <!-- Added pt-16 for header -->
          <h2 class="text-2xl font-semibold text-gray-700 dark:text-gray-200">
            {{ sessionState() === 'error' ? 'Error Loading Workout' : 'Workout Complete!' }}
          </h2>
          <p class="text-gray-600 dark:text-gray-400 mt-2" *ngIf="sessionState() !== 'error'">
            All sets are done. Well done!
          </p>
          <button *ngIf="sessionState() !== 'error'" (click)="finishWorkout()"
            class="mt-6 bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md text-lg transition-colors">
            Confirm & Finish Workout
          </button>
          <a *ngIf="sessionState() === 'error'" routerLink="/workout"
            class="mt-6 inline-block text-primary dark:text-primary-light hover:underline">
            ← Back to Routines
          </a>
        </div>
      </ng-template>
    </main>

    <footer *ngIf="isRestTimerVisible()"
      class="fixed bottom-0 left-0 right-0 z-30 bg-gray-50 dark:bg-gray-950 border-t border-gray-200 dark:border-gray-800 p-3 text-center h-auto min-h-[70px] flex flex-col justify-center">
      <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">UP NEXT</div>
      <div class="text-lg font-medium text-gray-800 dark:text-gray-100 truncate px-4" [title]="restTimerNextUpText()">
        {{ restTimerNextUpText() || 'Next Exercise' }}
      </div>
      <div class="text-sm text-gray-600 dark:text-gray-300">
        Rest: {{ restTimerDisplay() || (restDuration() | number:'1.0-0') + 's' }}
        <button (click)="skipRest()"
          class="ml-2 text-xs text-primary dark:text-primary-light hover:underline">(Skip)</button>
      </div>
    </footer>

  </ng-container>

  <ng-template #routineNotFound>
    <div
      class="fixed top-0 left-0 right-0 z-30 bg-gray-50 dark:bg-gray-950 border-b border-gray-200 dark:border-gray-800 p-4 flex items-center justify-between h-16">
      <button (click)="goBack()"
        class="text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light p-2 -ml-2">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      </button>
      <div class="text-center">
        <h1 class="text-sm font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Error</h1>
      </div>
      <div class="w-6"></div>
    </div>
    <div class="text-center py-20 pt-24">
      <h2 class="text-2xl font-semibold text-red-600 dark:text-red-400 mb-4">Routine Not Found</h2>
      <p class="text-gray-600 dark:text-gray-400">The selected routine could not be loaded.</p>
      <a routerLink="/workout" class="mt-6 inline-block text-primary dark:text-primary-light hover:underline">
        ← Back to Routines
      </a>
    </div>
  </ng-template>
</div>

<app-full-screen-rest-timer [isVisible]="isRestTimerVisible()" [durationSeconds]="restDuration()"
  [mainText]="restTimerMainText()" [nextUpText]="restTimerNextUpText()" (timerFinished)="handleRestTimerFinished()"
  (timerSkipped)="handleRestTimerSkipped()">
</app-full-screen-rest-timer>

<div *ngIf="isWorkoutMenuVisible()"
  class="fixed inset-0 z-50 bg-black/70 backdrop-blur-md flex flex-col items-center justify-center p-4 space-y-3 sm:space-y-4">

  <h2 class="text-2xl sm:text-3xl font-bold text-white mb-2 sm:mb-4">Workout Menu</h2>

  <button (click)="pauseSession()" [disabled]="sessionState() !== 'playing'"
    class="w-full max-w-xs sm:max-w-sm bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg text-lg sm:text-xl shadow-lg disabled:opacity-60 disabled:cursor-not-allowed">
    Pause Workout
  </button>

  <button (click)="openPerformanceInsightsFromMenu()" [disabled]="sessionState() === 'paused'"
    class="w-full max-w-xs sm:max-w-sm bg-cyan-500 hover:bg-cyan-600 text-white font-semibold py-2.5 sm:py-3 px-6 rounded-lg text-md sm:text-lg shadow-md disabled:opacity-60 disabled:cursor-not-allowed">
    View Performance Insights
  </button>

  <button (click)="addWarmupSet()" [disabled]="!canAddWarmupSet() || sessionState() === 'paused'"
    class="w-full max-w-xs sm:max-w-sm bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2.5 sm:py-3 px-6 rounded-lg text-md sm:text-lg shadow-md disabled:opacity-60 disabled:cursor-not-allowed">
    + Add Warm-up Set
  </button>

  <button (click)="skipCurrentSet()" [disabled]="!activeSetInfo() || sessionState() === 'paused'"
    class="w-full max-w-xs sm:max-w-sm bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2.5 sm:py-3 px-6 rounded-lg text-md sm:text-lg shadow-md disabled:opacity-60 disabled:cursor-not-allowed">
    Skip Current Set
  </button>

  <button (click)="skipCurrentExercise()" [disabled]="!activeSetInfo() || sessionState() === 'paused'"
    class="w-full max-w-xs sm:max-w-sm bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2.5 sm:py-3 px-6 rounded-lg text-md sm:text-lg shadow-md disabled:opacity-60 disabled:cursor-not-allowed">
    Skip Current Exercise
  </button>

  <button (click)="finishWorkoutEarly()" [disabled]="sessionState() === 'paused'"
    class="w-full max-w-xs sm:max-w-sm bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2.5 sm:py-3 px-6 rounded-lg text-md sm:text-lg shadow-md disabled:opacity-60 disabled:cursor-not-allowed">
    Finish Workout Early
  </button>

  <button (click)="quitWorkout()"
    class="w-full max-w-xs sm:max-w-sm text-red-300 hover:text-red-100 font-medium py-2.5 sm:py-3 px-6 rounded-lg border border-red-400 hover:bg-red-700/50 text-md sm:text-lg">
    Quit Workout
  </button>

  <button (click)="closeWorkoutMenu()"
    class="mt-4 sm:mt-6 text-gray-300 hover:text-white font-medium py-2 px-4 rounded-md text-sm">
    Close Menu
  </button>
</div>

<div *ngIf="isPerformanceInsightsVisible()" style="z-index: 100"
  class="fixed inset-0 bg-gray-800/80 dark:bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col">
    <header class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
      <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100">Performance Insights & Targets</h3>
      <button (click)="closePerformanceInsights()"
        class="p-1 rounded-full text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"
          stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </header>
    <div class="p-4 pt-1 overflow-y-auto" *ngIf="activeSetInfo() as activeSet">
      <div class="mb-3">
        <button (click)="toggleCompletedSetsInfo()"
          class="text-xs text-primary dark:text-primary-light hover:underline">
          {{ showCompletedSetsInfo() ? 'Hide' : 'Show' }} Completed Sets ({{allPreviousLoggedSetsForCurrentExercise().length}})
        </button>
      </div>
      <div *ngIf="allPreviousLoggedSetsForCurrentExercise().length > 0 && showCompletedSetsInfo()"
        class="mb-4 mt-1 space-y-2 max-h-32 overflow-y-auto p-2 border dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-750">
        <div *ngFor="let prevSetLog of allPreviousLoggedSetsForCurrentExercise(); let prevSetDisplayIndex = index"
          class="p-1.5 border-b border-gray-200 dark:border-gray-600 last:border-b-0 text-xs">
          <p class="font-medium text-gray-600 dark:text-gray-200 mb-0.5">
            <span *ngIf="prevSetLog.isWarmup" class="text-blue-500 dark:text-blue-400">(Warm-up) </span> Set {{
            prevSetDisplayIndex + 1 }}:
          </p>
          <span *ngIf="prevSetLog.repsAchieved !== undefined" class="mr-3">Reps: <strong
              class="text-gray-700 dark:text-gray-300">{{ prevSetLog.repsAchieved }}</strong></span>
          <span *ngIf="prevSetLog.weightUsed !== undefined && prevSetLog.weightUsed !== null" class="mr-3">Weight:
            <strong class="text-gray-700 dark:text-gray-300">{{ prevSetLog.weightUsed | weightUnit }}</strong></span>
          <span *ngIf="prevSetLog.durationPerformed !== undefined">Time: <strong
              class="text-gray-700 dark:text-gray-300">{{ prevSetLog.durationPerformed }}s</strong></span>
          <p *ngIf="prevSetLog.notes" class="mt-1 text-gray-500 dark:text-gray-400 italic">Notes: {{ prevSetLog.notes
            }}</p>
        </div>
      </div>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
        <div
          *ngIf="trackingService.findPreviousSetPerformance(lastPerformanceForCurrentExercise, activeSet.setData, activeSet.setIndex) as prevPerfSet"
          class="col-span-full pt-2 text-xs">
          <p class="font-medium text-gray-500 dark:text-gray-400">Last time ({{
            lastPerformanceForCurrentExercise?.lastPerformedDate | date:'dd/MM/yyyy HH:mm' }}):</p>
          <ul class="list-disc list-inside ml-2 text-gray-500 dark:text-gray-400">
            <li *ngIf="prevPerfSet.repsAchieved !== undefined">Reps: {{ prevPerfSet.repsAchieved }}</li>
            <li *ngIf="prevPerfSet.weightUsed !== undefined && prevPerfSet.weightUsed !== null">Weight: {{
              prevPerfSet.weightUsed | weightUnit }}</li>
            <li *ngIf="prevPerfSet.durationPerformed !== undefined">Time: {{ prevPerfSet.durationPerformed }}s</li>
          </ul>
        </div>
        <div *ngIf="!lastPerformanceForCurrentExercise && activeSetInfo()" class="col-span-full pt-2 text-xs">
          <p class="text-gray-500 dark:text-gray-400 italic">No previous performance recorded for this exercise yet.</p>
        </div>
        <div *ngIf="exercisePBs().length > 0"
          class="col-span-full mt-2 pt-2 border-t border-dashed border-gray-300 dark:border-gray-600 text-xs">
          <p class="font-medium text-gray-500 dark:text-gray-400 mb-1">Personal Bests for {{ currentBaseExercise()?.name
            || 'this exercise' }}:</p>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1">
            <div *ngFor="let pb of exercisePBs()">
              <span class="text-gray-500 dark:text-gray-400">{{ pb.pbType }}: </span>
              <strong class="text-gray-700 dark:text-gray-300">{{ formatPbValue(pb) }}</strong>
              <em class="text-gray-400 dark:text-gray-500 text-2xs ml-1"> ({{ pb.timestamp | date:'shortDate' }})</em>
            </div>
          </div>
        </div>
        <div *ngIf="currentBaseExercise() && exercisePBs().length === 0"
          class="col-span-full mt-2 pt-2 border-t border-dashed border-gray-300 dark:border-gray-600 text-xs">
          <p class="text-gray-500 dark:text-gray-400 italic">No personal bests recorded yet for {{
            currentBaseExercise()?.name }}.</p>
        </div>
        <div *ngIf="activeSet.setData.reps !== undefined"
          class="col-span-2 md:col-span-2 mt-2 pt-2 border-t border-dashed border-gray-300 dark:border-gray-600">
          <span class="block text-sm text-gray-500 dark:text-gray-400 mb-1">Target Reps</span>
          <div *ngIf="editingTarget !== 'reps'" (click)="startEditTarget('reps')"
            class="text-2xl font-bold text-gray-800 dark:text-gray-100 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 p-1 rounded">
            {{ activeSet.setData.reps }}
          </div>
          <div *ngIf="editingTarget === 'reps'" class="flex items-center space-x-1">
            <input type="number" [(ngModel)]="editingTargetValue" (keyup.enter)="confirmEditTarget()"
              (keyup.escape)="cancelEditTarget()"
              class="w-20 p-1 text-xl border-gray-300 dark:border-gray-600 rounded-md focus:ring-primary focus:border-primary dark:bg-gray-600"
              autofocus>
            <button (click)="confirmEditTarget()" class="p-1 text-green-500 hover:text-green-700">✓</button>
            <button (click)="cancelEditTarget()" class="p-1 text-red-500 hover:text-red-700">✕</button>
          </div>
        </div>
        <div *ngIf="activeSet.setData.weight !== undefined && activeSet.setData.weight !== null"
          class="col-span-2 md:col-span-2 mt-2 pt-2 border-t border-dashed border-gray-300 dark:border-gray-600">
          <span class="block text-sm text-gray-500 dark:text-gray-400 mb-1">Target Weight</span>
          <div *ngIf="editingTarget !== 'weight'" (click)="startEditTarget('weight')"
            class="text-2xl font-bold text-gray-800 dark:text-gray-100 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 p-1 rounded">
            {{ activeSet.setData.weight | weightUnit }}
          </div>
          <div *ngIf="editingTarget === 'weight'" class="flex items-center space-x-1">
            <input type="number" [(ngModel)]="editingTargetValue" (keyup.enter)="confirmEditTarget()"
              (keyup.escape)="cancelEditTarget()"
              class="w-20 p-1 text-xl border-gray-300 dark:border-gray-600 rounded-md focus:ring-primary focus:border-primary dark:bg-gray-600"
              autofocus>
            <button (click)="confirmEditTarget()" class="p-1 text-green-500 hover:text-green-700">✓</button>
            <button (click)="cancelEditTarget()" class="p-1 text-red-500 hover:text-red-700">✕</button>
          </div>
        </div>
        
        <div *ngIf="activeSet.setData.duration !== undefined"
            class="col-span-2 md:col-span-2 mt-2 pt-2 border-t border-dashed border-gray-300 dark:border-gray-600">
            <span class="block text-sm text-gray-500 dark:text-gray-400 mb-1">Target Time</span>
            <div *ngIf="editingTarget !== 'duration'" (click)="startEditTarget('duration')"
                class="text-2xl font-bold text-gray-800 dark:text-gray-100 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 p-1 rounded">
                {{ activeSet.setData.duration }}<span class="text-lg">s</span>
            </div>
            <div *ngIf="editingTarget === 'duration'" class="flex items-center space-x-1">
                <input type="number" [(ngModel)]="editingTargetValue" (keyup.enter)="confirmEditTarget()"
                (keyup.escape)="cancelEditTarget()"
                class="w-20 p-1 text-xl border-gray-300 dark:border-gray-600 rounded-md focus:ring-primary focus:border-primary dark:bg-gray-600"
                autofocus>
                <button (click)="confirmEditTarget()" class="p-1 text-green-500 hover:text-green-700">✓</button>
                <button (click)="cancelEditTarget()" class="p-1 text-red-500 hover:text-red-700">✕</button>
            </div>
        </div>

        <div *ngIf="activeSet.setData.tempo"
            class="col-span-2 md:col-span-2 mt-2 pt-2 border-t border-dashed border-gray-300 dark:border-gray-600">
            <span class="block text-sm text-gray-500 dark:text-gray-400 mb-1">Target Tempo</span>
            <span class="text-lg font-semibold text-gray-800 dark:text-gray-100 p-1">{{ activeSet.setData.tempo }}</span>
        </div>
      </div>
    </div>
    <footer class="p-4 border-t border-gray-200 dark:border-gray-700 text-right">
      <button (click)="closePerformanceInsights()"
        class="bg-primary hover:bg-primary-dark text-white font-semibold py-2 px-6 rounded-md text-sm">
        Done
      </button>
    </footer>
  </div>
</div>

<ng-template #loadingOrError>
  <div class="text-center py-20">
    <p class="text-xl text-gray-600 dark:text-gray-400">Loading workout player...</p>
  </div>
</ng-template>
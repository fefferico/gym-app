<!-- Main container with background color -->
<ng-container *ngIf="routine() as currentRoutine; else loadingOrError" style="height: 60px; position: fixed; top: 0; left: 0; right: 0; z-index: 50;">
  <!-- NEW: Tabata Player UI -->
  <!-- In workout-player.html -->

  <!-- NEW: Tabata Player UI -->
  <div *ngIf="isTabataMode(); else standardPlayer" class="tabata-player">
    <ng-container *ngIf="currentTabataInterval() as interval">

      <!-- Background: Add a gradient and a smooth transition -->
      <div class="fixed inset-0 transition-all duration-700 ease-in-out" [ngClass]="{
           'tabata-work-bg': interval.type === 'work',
       'tabata-rest-bg': interval.type === 'rest',
       'tabata-prepare-bg': interval.type === 'prepare'
         }"></div>

      <!-- Main Content Container -->
      <div class="relative z-10 flex flex-col h-screen text-white p-4 font-sans">

        <!-- Tabata Header -->
    <header class="flex justify-between items-center w-full p-4 flex-shrink-0">
      <div class="text-sm font-medium bg-black/20 px-3 py-1 rounded-full">
            Total: {{ sessionTimerDisplay() }}
          </div>
          <div class="flex items-center space-x-2">
            <!-- The "Lock" icon from the original design -->
            <button class="p-2 bg-black/20 rounded-full hover:bg-black/40 transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
            </button>
            <button (click)="toggleTabataPause()" class="p-2 bg-black/20 rounded-full hover:bg-black/40 transition">
              <svg *ngIf="sessionState() === 'playing'" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6" />
              </svg>
              <svg *ngIf="sessionState() === 'paused'" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </button>
          </div>
        </header>

        <!-- Main Timer & Interval Name -->
        <main class="flex flex-col items-center justify-center text-center">
          <!-- Add a subtle pulse animation for the last few seconds -->
          <h1 class="text-[250px] md:text-[450px] font-bold tabular-nums leading-none tracking-tighter text-shadow-lg"
            [class.animate-pulse]="tabataTimeRemaining() <= 3 && tabataTimeRemaining() > 0">
            {{ tabataTimeRemaining() >= 0 ? (tabataTimeRemaining() | number: '2.0-0') : '00' }}
          </h1>
          <p class="text-2xl md:text-3xl font-semibold capitalize mt-2 text-shadow">
            {{ interval.exerciseName || interval.type }}
          </p>
        </main>

        <!-- Interval List -->
        <div class="flex-shrink-0 max-h-48 overflow-y-auto mb-2 scrollbar-hide px-2">
          <ul class="space-y-1">
            <li #intervalListItem 
              *ngFor="let item of tabataIntervals(); let i = index" 
              class="text-lg p-2 transition-all duration-300 ease-in-out">
            <!-- 
              The styling div. This now uses a different "pop" effect
              that is guaranteed to not interfere with the border radius.
            -->
            <div class="rounded-md flex items-center p-2 transition-all duration-200 ease-in-out"
                 [ngClass]="{
                   'bg-white/90 text-black font-bold shadow-2xl -translate-y-px': i === currentTabataIntervalIndex(),
                   'text-white/60 opacity-80': i !== currentTabataIntervalIndex()
                 }">
              <span class="font-mono w-8 text-right mr-2">{{ item.currentIntervalNumber }}.</span> 
              <span class="capitalize font-medium">{{ item.type }}: {{ item.duration }}s</span>
              <span *ngIf="item.type === 'work'" class="ml-2 font-light truncate"> â€¢ {{ item.exerciseName }}</span>
            </div>
          </li>
          </ul>
        </div>

        <!-- Footer Controls -->
        <footer class="flex-shrink-0 flex justify-between items-center w-full">
          <button (click)="previousTabataInterval()" [disabled]="currentTabataIntervalIndex() === 0"
            class="p-2 disabled:opacity-30 hover:scale-110 active:scale-95 transition-transform">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
            </svg>
          </button>
          <div class="text-2xl font-semibold bg-black/20 px-4 py-2 rounded-full tabular-nums">
            {{ interval.currentIntervalNumber }} / {{ interval.totalIntervals }}
          </div>
          <button (click)="nextTabataInterval()"
            [disabled]="currentTabataIntervalIndex() === tabataIntervals().length - 1"
            class="p-2 disabled:opacity-30 hover:scale-110 active:scale-95 transition-transform">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
            </svg>
          </button>
        </footer>
      </div>
    </ng-container>
  </div>

  <!-- NEW: The original player is now the 'else' part of the *ngIf -->
  <ng-template #standardPlayer>
    <div class="workout-player-container bg-gray-50 dark:bg-gray-950 min-h-screen flex flex-col"
      *ngIf="routine() !== undefined; else loadingOrError">

      <!-- PAUSED OVERLAY -->
      <div *ngIf="sessionState() === 'paused'"
        class="fixed inset-0 z-[60] bg-black/70 backdrop-blur-sm flex flex-col items-center justify-center space-y-6 p-4">
        <h2 class="text-4xl font-bold text-white">Session Paused</h2>
        <p class="text-lg text-gray-200">Elapsed Time: {{ sessionTimerDisplay() }}</p>
        <button (click)="resumeSession()"
          class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg w-full max-w-xs">
          Resume Workout
        </button>
        <button (click)="quitWorkout()"
          class="text-m text-red-300 hover:text-red-100 font-medium py-2 px-4 rounded-md border border-red-300 hover:bg-red-700/30 w-full max-w-xs mt-2">
          Quit Workout (No Save)
        </button>
      </div>

      <!-- Top Bar -->
      <header
        class="fixed top-0 left-0 right-0 z-30 bg-gray-50 dark:bg-gray-950 border-b border-gray-200 dark:border-gray-800 p-2 flex items-center justify-between h-14">
        <button (click)="goBack()"
          class="text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light p-2 -ml-1">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
        <div class="text-center">
          <h1
            class="text-m font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider truncate max-w-[calc(100vw-120px)]"
            [title]="currentRoutine.name">
            {{ currentRoutine.name || 'Workout' }}
          </h1>
          <div class="text-xs text-gray-500 dark:text-gray-400">{{ sessionTimerDisplay() }}</div>
        </div>
        <button (click)="toggleWorkoutMenu()"
          [disabled]="sessionState() === 'loading' || sessionState() === 'error' || (sessionState() === 'paused' && !isWorkoutMenuVisible())"
          class="text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light p-2 -mr-1 disabled:opacity-50">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"
            stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
          </svg>
        </button>
      </header>

      <main class="flex-grow overflow-y-auto pt-10" [class.pb-24]="true">
        <!-- Increased pb for main action button area -->
        <div class="p-4 max-w-md mx-auto" *ngIf="activeSetInfo() as activeSet; else workoutCompleteOrError">

          <div class="flex text-center justify-center items-center mb-1">
            <div *ngIf="currentBaseExercise() as baseEx; else loadingBaseExIcon" class="mr-2 h-8 w-8 flex-shrink-0">
              <img *ngIf="baseEx.iconName" [src]="getIconPath(baseEx.iconName)" [alt]="baseEx.name + ' icon'"
                class="w-full h-full object-contain"
                [ngClass]="{'filter dark:invert': baseEx.iconName !== 'default-exercise' && baseEx.iconName !== '' && baseEx.iconName !== null }">
            </div>
            <ng-template #loadingBaseExIcon>
              <div class="w-8 h-8 bg-gray-200 dark:bg-gray-700 rounded-md animate-pulse mr-2 flex-shrink-0"></div>
            </ng-template>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 truncate"
              [title]="activeSet.exerciseData.exerciseName">
              {{ activeSet.exerciseData.exerciseName || 'Loading Exercise...' }}
            </h2>
            <svg class="ml-2 cursor-pointer dark:text-white" title="Exercise details" *ngIf="activeSet.exerciseData.id"
              width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"
              (click)="openModal(activeSet.exerciseData)">
              <!-- Outer circle -->
              <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="2" fill="none" />
              <!-- Dot of the 'i' -->
              <circle cx="10" cy="6" r="1.5" fill="currentColor" />
              <!-- Stem of the 'i' -->
              <rect x="9" y="9" width="2" height="7" fill="currentColor" />
            </svg>
          </div>

          <div class="text-center mb-2">
            <p class="text-m text-gray-500 dark:text-gray-400">
              <span *ngIf="activeSet.type === 'warmup'" class="text-blue-500 dark:text-blue-400">
                Warm-up Set {{ getCurrentWarmupSetNumber() }}
                <span *ngIf="getTotalWarmupSetsForCurrentExercise() > 0">/{{
                  getTotalWarmupSetsForCurrentExercise()}}</span>
              </span>
              <span *ngIf="activeSet.type !== 'warmup'">
                Set {{ getCurrentWorkingSetNumber() }}/{{ getWorkingSetCountForCurrentExercise() }}
              </span>
              <span *ngIf="totalBlockRounds() >= 1 && currentBlockRound() > 0" class="ml-2">
                (Round {{currentBlockRound()}}/{{totalBlockRounds()}})
              </span>
              <span *ngIf="activeSet.exerciseData.supersetId" class="ml-2 text-purple-500 dark:text-purple-400 italic">
                (Superset {{ (activeSet.exerciseData.supersetOrder ?? 0) + 1 }}/{{activeSet.exerciseData.supersetSize ??
                '?'}})
              </span>
            </p>
          </div>
          <!-- Display sessionStatus if not pending -->
          <div *ngIf="activeSet.exerciseData.sessionStatus && activeSet.exerciseData.sessionStatus !== 'pending'"
            class="text-center mb-3">
            <span *ngIf="activeSet.exerciseData.sessionStatus === 'skipped'"
              class="px-2 py-0.5 text-xs font-semibold text-red-700 bg-red-100 dark:bg-red-900 dark:text-red-200 rounded-full">Marked
              as Skipped</span>
            <span *ngIf="activeSet.exerciseData.sessionStatus === 'do_later'"
              class="px-2 py-0.5 text-xs font-semibold text-yellow-700 bg-yellow-100 dark:bg-yellow-800 dark:text-yellow-200 rounded-full">Marked
              for Later</span>
          </div>


          <!-- Pre-Set Countdown Display -->
          <div *ngIf="playerSubState() === PlayerSubState.PresetCountdown" class="text-center mb-6 animate-fadeIn">
            <!-- ... (existing preset countdown HTML) ... -->
            <h3 class="text-xl font-semibold text-blue-600 dark:text-blue-400">Get Ready!</h3>
            <p class="text-4xl sm:text-5xl font-bold text-blue-500 dark:text-blue-300 my-3">{{
              presetTimerCountdownDisplay() }}s</p>
            <p class="text-m text-gray-600 dark:text-gray-400">
              Upcoming: {{ activeSet.setData.reps ? (activeSet.setData.reps + ' reps') : '' }}
              {{ activeSet.setData.reps && activeSet.setData.weight ? ' at ' : '' }}
              {{ activeSet.setData.weight ? (activeSet.setData.weight | weightUnit) : '' }}
              {{ activeSet.setData.duration ? (activeSet.setData.duration + 's') : '' }}
            </p>
            <button (click)="skipPresetTimer()"
              class="mt-4 text-xs text-primary dark:text-primary-light hover:underline">
              Skip Countdown & Start Set
            </button>
          </div>

          <div *ngIf="playerSubState() === PlayerSubState.PerformingSet">
            <form [formGroup]="currentSetForm" class="space-y-4 mb-2">
              <!-- Weight Input -->
              <div *ngIf="csf['actualWeight']">
                <label
                  class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider text-center mb-1">Weight</label>
                <div class="flex items-center justify-center space-x-2">
                  <button type="button" (mousedown)="onWeightDecrementPointerDown($event)" [disabled]="getDisabled()"
                    appLongPress (longPress)="onWeightDecrementPointerDown($event)"
                    class="p-3 bg-gray-200 dark:bg-gray-700 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                    </svg>
                  </button>
                  <div (click)="editWeightWithPrompt()"
                    class="w-28 text-center text-3xl font-bold bg-transparent p-0 text-gray-800 dark:text-gray-100 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 rounded-md py-1">
                    {{ (csf['actualWeight'].value | number:'1.0-2') ?? '0' }}
                  </div>
                  <input type="number" formControlName="actualWeight" class="hidden">
                  <span class="text-lg text-gray-700 dark:text-gray-200 -ml-1">{{weightUnitDisplaySymbol}}</span>
                  <button type="button" (mousedown)="onWeightIncrementPointerDown($event)" [disabled]="getDisabled()"
                    appLongPress (longPress)="onWeightIncrementPointerDown($event)"
                    class="p-3 bg-gray-200 dark:bg-gray-700 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                  </button>
                </div>
              </div>

              <!-- Reps Input -->
              <div *ngIf="csf['actualReps'] && activeSet.setData.reps !== undefined">
                <label
                  class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider text-center mb-1">Reps</label>
                <div class="flex items-center justify-center space-x-2">
                  <button type="button" (click)="decrementReps(1)" [disabled]="getDisabled()"
                    class="p-3 bg-gray-200 dark:bg-gray-700 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                    </svg>
                  </button>
                  <input type="number" formControlName="actualReps" readonly
                    class="w-28 text-center text-3xl font-bold bg-transparent border-none p-0 focus:ring-0 text-gray-800 dark:text-gray-100"
                    placeholder="0">
                  <button type="button" (click)="incrementReps(1)" [disabled]="getDisabled()"
                    class="p-3 bg-gray-200 dark:bg-gray-700 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                  </button>
                </div>
              </div>

              <!-- Timed Set Duration -->
              <div *ngIf="activeSet.setData.duration !== undefined">
                <!-- ... (existing timed set HTML) ... -->
                <label for="timedSetDisplay"
                  class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider text-center mb-2">
                  Time (seconds) <span *ngIf="activeSet.setData.duration > 0">(Target:
                    {{ (activeSet.setData.duration * 1000) | date:'mm:ss':'UTC' }})</span>
                </label>
                <div id="timedSetDisplay"
                  class="mt-1 block w-full p-3 border-none text-3xl font-bold text-center bg-transparent focus:ring-0"
                  [ngClass]="{
                        'text-red-500': isTimedSetOvertime(),
                        'animate-pulse': isTimedSetOvertime() && timedSetTimerState() === 'running',
                        'text-green-500 dark:text-green-400': !isTimedSetOvertime() && timedSetTimerState() === 'running' && (activeSetInfo()?.setData?.duration ?? 0) > 0 && timedSetElapsedSeconds() > 0,
                        'text-gray-800 dark:text-gray-100': timedSetTimerState() === 'idle' || timedSetTimerState() === 'paused' || !((activeSetInfo()?.setData?.duration ?? 0) > 0 && timedSetElapsedSeconds() > 0 && !isTimedSetOvertime())
                     }">
                  {{ (timedSetDisplay() * 1000) | date:'mm:ss':'UTC' }}
                </div>
                <input type="number" formControlName="actualDuration" class="hidden">
                <div class="flex space-x-2 mt-2 justify-center">
                  <button type="button" (click)="toggleTimedSetTimer()" [disabled]="getDisabled()" [ngClass]="{
                              'bg-green-500 hover:bg-green-600': timedSetTimerState() === 'idle' || timedSetTimerState() === 'paused',
                              'bg-yellow-500 hover:bg-yellow-600 text-black': timedSetTimerState() === 'running'
                            }"
                    class="flex-grow max-w-[150px] text-white font-medium py-2 px-3 rounded-full transition-colors text-m disabled:opacity-50">
                    <span *ngIf="timedSetTimerState() === 'idle'">Start Timer</span>
                    <span *ngIf="timedSetTimerState() === 'running'">Pause Timer</span>
                    <span *ngIf="timedSetTimerState() === 'paused'">Resume Timer</span>
                  </button>
                  <button type="button" (click)="resetTimedSet()" *ngIf="timedSetTimerState() !== 'idle'"
                    [disabled]="getDisabled()"
                    class="flex-grow max-w-[150px] bg-gray-300 hover:bg-gray-400 dark:bg-gray-700 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-medium py-2 px-3 rounded-md transition-colors text-m disabled:opacity-50">
                    Reset
                  </button>
                </div>
              </div>

              <!-- Set Notes Input -->
              <div class="mt-3">
                <label for="setNotes"
                  class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider text-center mb-1">Set
                  Notes (Optional)</label>
                <textarea id="setNotes" formControlName="setNotes" rows="2" [disabled]="getDisabled()"
                  class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-800 dark:text-gray-200 text-m disabled:opacity-60"
                  placeholder="e.g., felt good, struggled on last rep..."></textarea>
              </div>

              <!-- RPE Slider -->
              <!-- <div *ngIf="appSettingsService.enableRpeTracking()" class="pt-2">
              <button type="button" (click)="toggleRpeInput()"
                class="w-full text-center text-m text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary-light mb-1">
                Tap to track RPE
                <svg xmlns="http://www.w3.org/2000/svg" class="inline h-4 w-4 ml-1 text-gray-400 dark:text-gray-500"
                  fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </button>
              <div *ngIf="showRpeSlider()" class="mt-1 px-2">
                <input type="range" min="1" max="10" step="1" [ngModel]="rpeValue()" (ngModelChange)="updateRpe($event)"
                  formControlName="rpe" [disabled]="getDisabled()"
                  class="w-full h-2 bg-gray-300 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:bg-red-500 [&::-moz-range-thumb]:bg-red-500 disabled:opacity-60">
                <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 px-1 mt-1">
                  <span>Easy</span>
                  <span class="font-semibold text-red-500">{{ rpeValue() || '-' }}</span>
                  <span>Max Effort</span>
                </div>
              </div>
            </div> -->
            </form>
          </div>
          <div class="left-0 right-0 z-20 p-3" *ngIf="routine() && sessionState() === 'playing' && activeSetInfo()">
            <div class="max-w-md mx-auto">
              <button (click)="handleMainAction()"
                [disabled]="sessionState() === 'paused' || (playerSubState() === PlayerSubState.PresetCountdown && presetTimerCountdownDisplay() !== '0' && presetTimerCountdownDisplay() !== null) || (playerSubState() === PlayerSubState.Resting && isRestTimerVisible())"
                class="w-full font-bold py-3.5 px-4 rounded-full shadow-md text-lg transition-colors focus:outline-none focus:ring-2 disabled:opacity-70 text-white"
                [ngClass]="{
                'bg-red-500 hover:bg-red-600 focus:ring-red-400': playerSubState() === PlayerSubState.PerformingSet && !checkIfLatestSetOfWorkoutConsideringPending(),
                'bg-green-500 hover:bg-green-600 focus:ring-green-400': playerSubState() === PlayerSubState.PerformingSet && checkIfLatestSetOfWorkoutConsideringPending(),
                'bg-blue-500 hover:bg-blue-600 focus:ring-blue-400': playerSubState() === PlayerSubState.PresetCountdown,
                'bg-gray-400 dark:bg-gray-600 text-gray-800 dark:text-gray-200 cursor-not-allowed': playerSubState() === PlayerSubState.Resting && isRestTimerVisible()
            }">
                {{ mainActionButtonLabel() }}
              </button>
            </div>
          </div>
          <div *ngIf="getNextUpText(activeSetInfo(), routine() ?? null)"
            class="text-wrap text-sm text-center text-gray-800 dark:text-gray-100 px-2 text-s"
            [title]="getNextUpText(activeSetInfo(), routine() ?? null) || 'Next Exercise'">
            <span class="font-medium">Next up: </span><span>{{ getNextUpText(activeSetInfo(), routine() ?? null) ||
              'Next Exercise' }}</span>
          </div>
        </div>
        <ng-template #workoutCompleteOrError>
          <div class="text-center py-10 pt-16">
            <h2 class="text-2xl font-semibold text-gray-700 dark:text-gray-200">
              {{ sessionState() === 'error' ? 'Error Loading Workout' : (currentWorkoutLogExercises().length === 0 ?
              'Workout Ended' : 'Workout Complete!') }}
            </h2>
            <p class="text-gray-600 dark:text-gray-400 mt-2" *ngIf="sessionState() !== 'error'">
              {{ currentWorkoutLogExercises().length === 0 ? 'No sets were logged.' : 'All planned sets are done. Well
              done!' }}
            </p>
            <button *ngIf="sessionState() !== 'error' && currentWorkoutLogExercises().length > 0"
              (click)="finishWorkoutAndReportStatus()"
              class="mt-6 bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md text-lg transition-colors">
              Confirm & Save Workout
            </button>
            <button *ngIf="sessionState() !== 'error' && currentWorkoutLogExercises().length === 0"
              routerLink="/workout"
              class="mt-6 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-md text-lg transition-colors">
              Back to Workouts
            </button>
            <button *ngIf="sessionState() === 'error'" routerLink="/workout"
              class="mt-6 text-primary dark:text-primary-light hover:underline p-2">
              Go Back
            </button>
          </div>
        </ng-template>
      </main>

      <!-- Fixed Footer for Main Action Button -->


      <!-- Footer for Rest/Preset Info (appears above main action button footer if active) -->
      <footer
        *ngIf="routine() && sessionState() === 'playing' && activeSetInfo() && ((playerSubState() === PlayerSubState.Resting && !isRestTimerVisible()) || playerSubState() === PlayerSubState.PresetCountdown)"
        class="fixed bottom-[76px] left-0 right-0 z-10 bg-gray-100 dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 p-2 text-center h-auto min-h-[60px] flex flex-col justify-center shadow-[0_-1px_3px_rgba(0,0,0,0.07)]">
        <div class="max-w-md mx-auto w-full">
          <div *ngIf="playerSubState() === PlayerSubState.Resting && !isRestTimerVisible()">
            <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">UP NEXT</div>
            <div class="text-base font-medium text-gray-800 dark:text-gray-100 truncate px-4"
              [title]="restTimerNextUpText()">
              {{ restTimerNextUpText() || 'Next Exercise' }}
            </div>
            <div class="text-m text-gray-600 dark:text-gray-300">
              Rest: {{ restTimerDisplay() || (restDuration() | number:'1.0-0') + 's' }}
              <button (click)="skipRest()"
                class="ml-2 text-xs text-primary dark:text-primary-light hover:underline">(Skip)</button>
            </div>
          </div>
          <div *ngIf="playerSubState() === PlayerSubState.PresetCountdown">
            <div class="text-base font-medium text-gray-800 dark:text-gray-100 truncate px-4"
              [title]="restTimerMainText()">
              {{ restTimerMainText() }}
            </div>
            <div class="text-xl font-bold text-blue-600 dark:text-blue-300">
              {{ presetTimerCountdownDisplay() }}s
            </div>
            <button (click)="skipPresetTimer()"
              class="mt-0.5 text-xs text-primary dark:text-primary-light hover:underline">(Skip Countdown)</button>
          </div>
        </div>
      </footer>


      <ng-template #routineNotFound>
        <div
          class="fixed top-0 left-0 right-0 z-30 bg-gray-50 dark:bg-gray-950 border-b border-gray-200 dark:border-gray-800 p-4 flex items-center justify-between h-16">
          <button (click)="goBack()"
            class="text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light p-2 -ml-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
          </button>
          <div class="text-center">
            <h1 class="text-m font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Error</h1>
          </div>
          <div class="w-6"></div>
        </div>
        <div class="text-center py-20 pt-24">
          <h2 class="text-2xl font-semibold text-red-600 dark:text-red-400 mb-4">Routine Not Found</h2>
          <p class="text-gray-600 dark:text-gray-400">The selected routine could not be loaded.</p>
          <button routerLink="/workout"
            class="text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light p-2 -ml-1"><svg
              fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg></button>
        </div>
      </ng-template>
    </div>
  </ng-template>

</ng-container>



<app-full-screen-rest-timer [isVisible]="playerSubState() === PlayerSubState.Resting && isRestTimerVisible()"
  [durationSeconds]="restDuration()" [mainText]="restTimerMainText()" [nextUpText]="restTimerNextUpText()"
  (timerFinished)="handleRestTimerFinished()" (timerSkipped)="handleRestTimerSkipped()">
</app-full-screen-rest-timer>

<div *ngIf="isWorkoutMenuVisible()"
  class="fixed inset-0 z-50 bg-black/70 backdrop-blur-md flex flex-col items-center justify-center p-4 space-y-2 sm:space-y-3"
  style="padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom);">

  <div class="flex columns-3">
    <div></div>
    <button (click)="closeWorkoutMenu()"
      class="p-1.5 rounded-full text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700/70 focus:outline-none transition-colors"><svg
        _ngcontent-ng-c2442506092="" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
        stroke="currentColor" stroke-width="2.5" class="h-6 w-6">
        <path _ngcontent-ng-c2442506092="" stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12">
        </path>
      </svg></button>

    <div></div>
  </div>

  <h2 class="text-2xl sm:text-3xl font-bold text-white mb-2">Workout Menu</h2>


  <button (click)="pauseSession()" [disabled]="sessionState() !== 'playing'"
    class="flex justify-center items-center w-full max-w-xs bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2.5 px-6 rounded-lg text-lg shadow-lg disabled:opacity-60 disabled:cursor-not-allowed">
    <svg class="h-5 w-5 text-white" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <!-- Outer Circle -->
      <circle cx="10" cy="10" r="8" fill="none" stroke="currentColor" stroke-width="2" />
      <!-- Pause Bars -->
      <!-- Left Bar -->
      <rect x="7" y="7" width="2" height="7" rx="4" ry="4" fill="currentColor" />
      <!-- Right Bar -->
      <rect x="11" y="7" width="2" height="7" rx="4" ry="4" fill="currentColor" />
    </svg>
    Pause Workout
  </button>

  <button (click)="jumpToExercise()" [disabled]="sessionState() === 'paused' || !routine()?.exercises?.length"
    class="flex justify-center items-center w-full max-w-xs bg-fuchsia-500 hover:bg-fuchsia-600 text-white font-semibold py-2 px-6 rounded-lg text-md shadow-md disabled:opacity-60 disabled:cursor-not-allowed">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 500" width="55" height="20" fill="white">
      <!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
      <path
        d="M96 64c0-17.7 14.3-32 32-32l32 0c17.7 0 32 14.3 32 32l0 160 0 64 0 160c0 17.7-14.3 32-32 32l-32 0c-17.7 0-32-14.3-32-32l0-64-32 0c-17.7 0-32-14.3-32-32l0-64c-17.7 0-32-14.3-32-32s14.3-32 32-32l0-64c0-17.7 14.3-32 32-32l32 0 0-64zm448 0l0 64 32 0c17.7 0 32 14.3 32 32l0 64c17.7 0 32 14.3 32 32s-14.3 32-32 32l0 64c0 17.7-14.3 32-32 32l-32 0 0 64c0 17.7-14.3 32-32 32l-32 0c-17.7 0-32-14.3-32-32l0-160 0-64 0-160c0-17.7 14.3-32 32-32l32 0c17.7 0 32 14.3 32 32zM416 224l0 64-192 0 0-64 192 0z" />
    </svg>
    Jump to Exercise
  </button>

  <button (click)="openPerformanceInsightsFromMenu()" [disabled]="sessionState() === 'paused' || !activeSetInfo()"
    class="flex justify-center align-center w-full max-w-xs bg-cyan-500 hover:bg-cyan-600 text-white font-semibold py-2 px-6 rounded-lg text-md shadow-md disabled:opacity-60 disabled:cursor-not-allowed">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 dark:text-gray-400" fill="none"
      viewBox="0 0 24 24" stroke="white" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
    </svg>
    Performance Insights
  </button>

  <button (click)="addWarmupSet()" [disabled]="!canAddWarmupSet() || sessionState() === 'paused' || !activeSetInfo()"
    class="w-full max-w-xs bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-6 rounded-lg text-md shadow-md disabled:opacity-60 disabled:cursor-not-allowed">
    <p>+ Add Warm-up Set</p>
    <span *ngIf="!canAddWarmupSet()" class="text-xs text-white ml-2">(already started main sets)</span>
  </button>

  <button (click)="addExerciseDuringSession()" [disabled]="sessionState() === 'paused'"
    class="w-full max-w-xs bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-6 rounded-lg text-md shadow-md disabled:opacity-60 disabled:cursor-not-allowed">
    + Add Exercise to Session
  </button>

  <button (click)="skipCurrentSet()" [disabled]="!activeSetInfo() || sessionState() === 'paused'"
    class="w-full max-w-xs bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg text-md shadow-md disabled:opacity-60 disabled:cursor-not-allowed">
    Skip Current Set
  </button>

  <button (click)="skipCurrentExercise()" [disabled]="!activeSetInfo() || sessionState() === 'paused'"
    class="w-full max-w-xs bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg text-md shadow-md disabled:opacity-60 disabled:cursor-not-allowed">
    Mark Exercise as Skipped
  </button>

  <button (click)="markCurrentExerciseDoLater()" [disabled]="!activeSetInfo() || sessionState() === 'paused'"
    class="w-full max-w-xs bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-6 rounded-lg text-md shadow-md disabled:opacity-60 disabled:cursor-not-allowed">
    Mark Exercise for Later
  </button>

  <button (click)="finishWorkoutEarly()" [disabled]="sessionState() === 'paused'"
    class="w-full max-w-xs bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-6 rounded-lg text-md shadow-md disabled:opacity-60 disabled:cursor-not-allowed">
    Finish Workout Early
  </button>

  <button (click)="quitWorkout()"
    class="w-full max-w-xs text-red-300 hover:text-red-100 font-medium py-2 px-6 rounded-lg border border-red-400 hover:bg-red-700/50 text-md">
    Quit Workout (No Save)
  </button>
</div>

<!-- Performance Insights Modal -->
<div *ngIf="isPerformanceInsightsVisible()" style="z-index: 100"
  class="fixed inset-0 bg-gray-900/70 dark:bg-black/80 backdrop-blur-md flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out">

  <div
    class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-xl max-h-[90vh] flex flex-col overflow-hidden transform transition-all duration-300 ease-in-out scale-95 opacity-0 animate-modal-appear">

    <header class="p-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-primary dark:text-primary-light" fill="none"
          viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100">Performance Insights & Targets</h3>
      </div>
      <button (click)="closePerformanceInsights()"
        class="p-1.5 rounded-full text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700/70 focus:outline-none transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"
          stroke-width="2.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </header>

    <div class="p-5 overflow-y-auto space-y-6 flex-grow custom-scrollbar" *ngIf="activeSetInfo() as activeSet">
      <!-- Added custom-scrollbar to the main content area -->

      <!-- Completed Sets This Workout (for current exercise) -->
      <div class="rounded-lg border border-gray-200 dark:border-gray-700/80">
        <button (click)="toggleCompletedSetsForExerciseInfo()" class="w-full flex items-center justify-between p-3 text-left text-sm font-medium text-gray-700
          dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors rounded-t-lg">
          <span class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 dark:text-gray-400" fill="none"
              viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
            </svg>
            This Exercise ({{ currentBaseExercise()?.name || 'Current' }}) - Completed Sets
            ({{allPreviousLoggedSetsForCurrentExercise().length}})
          </span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform transition-transform duration-200"
            [ngClass]="{'rotate-180': showCompletedSetsForExerciseInfo()}" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="2">
            <!-- Signal name changed -->
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <div *ngIf="allPreviousLoggedSetsForCurrentExercise().length > 0 && showCompletedSetsForExerciseInfo()"
          class="bg-gray-50 dark:bg-gray-700/30 p-3 border-t border-gray-200 dark:border-gray-700/80 space-y-3 max-h-40 overflow-y-auto custom-scrollbar rounded-b-lg">
          <div *ngFor="let prevSetLog of allPreviousLoggedSetsForCurrentExercise(); let prevSetDisplayIndex = index"
            class="text-xs p-2 bg-white dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600">
            <p class="font-semibold text-gray-700 dark:text-gray-200 mb-1">
              <span *ngIf="prevSetLog.type === 'warmup'" class="text-blue-600 dark:text-blue-400 font-normal">(Warm-up)
              </span>
              Set #{{ prevSetDisplayIndex + 1 }}:
            </p>
            <div class="grid grid-cols-2 gap-x-2 gap-y-1 text-gray-600 dark:text-gray-300">
              <span *ngIf="prevSetLog.repsAchieved !== undefined">Reps: <strong class="dark:text-gray-100">{{
                  prevSetLog.repsAchieved }}</strong></span>
              <span *ngIf="prevSetLog.weightUsed !== undefined && prevSetLog.weightUsed !== null">Weight: <strong
                  class="dark:text-gray-100">{{ prevSetLog.weightUsed | weightUnit }}</strong></span>
              <span *ngIf="prevSetLog.durationPerformed !== undefined" class="col-span-2">Time: <strong
                  class="dark:text-gray-100">{{ prevSetLog.durationPerformed }}s</strong></span>
            </div>
            <p *ngIf="prevSetLog.notes"
              class="mt-1.5 text-gray-500 dark:text-gray-400 italic text-2xs border-t border-gray-100 dark:border-gray-600 pt-1.5">
              {{ prevSetLog.notes }}
            </p>
          </div>
        </div>
        <div *ngIf="allPreviousLoggedSetsForCurrentExercise().length === 0 && showCompletedSetsForExerciseInfo()"
          class="p-3 text-xs text-center text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700/80 rounded-b-lg">
          No sets completed yet for this exercise in this workout.
        </div>
      </div>

      <!-- Completed Sets Today (All Exercises) -->
      <div class="rounded-lg border border-gray-200 dark:border-gray-700/80">
        <button (click)="toggleCompletedSetsForDayInfo()" class="w-full flex items-center justify-between p-3 text-left text-sm font-medium text-gray-700
          dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors rounded-t-lg">
          <span class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 dark:text-gray-400" fill="none"
              viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            Today's Logged Sets (All Exercises) ({{allPreviousLoggedSetsForCurrentSession().length}})
            <!-- Assuming this is the correct data source -->
          </span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform transition-transform duration-200"
            [ngClass]="{'rotate-180': showCompletedSetsForDayInfo()}" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="2"> <!-- New signal name -->
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <div *ngIf="allPreviousLoggedSetsForCurrentSession().length > 0 && showCompletedSetsForDayInfo()"
          class="bg-gray-50 dark:bg-gray-700/30 p-3 border-t border-gray-200 dark:border-gray-700/80 space-y-3 max-h-48 overflow-y-auto custom-scrollbar rounded-b-lg">
          <!-- Slightly increased max-h -->
          <div *ngFor="let daySetLog of allPreviousLoggedSetsForCurrentSession(); let daySetDisplayIndex = index"
            class="text-xs p-2 bg-white dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600">
            <p class="font-semibold text-gray-700 dark:text-gray-200 mb-1">
              <!-- You'll need the exercise name for these sets -->
              <span class="text-sm text-primary dark:text-primary-light">{{ daySetLog.exerciseName || 'Exercise'
                }}:</span>
              <span *ngIf="daySetLog.type === 'warmup'" class="text-blue-600 dark:text-blue-400 font-normal">
                (Warm-up)</span>
              Set #{{ (daySetDisplayIndex + 1) }}:
              <!-- Use actual set number if available -->
            </p>
            <div class="grid grid-cols-2 gap-x-2 gap-y-1 text-gray-600 dark:text-gray-300">
              <span *ngIf="daySetLog.repsAchieved !== undefined">Reps: <strong class="dark:text-gray-100">{{
                  daySetLog.repsAchieved }}</strong></span>
              <span *ngIf="daySetLog.weightUsed !== undefined && daySetLog.weightUsed !== null">Weight: <strong
                  class="dark:text-gray-100">{{ daySetLog.weightUsed | weightUnit }}</strong></span>
              <span *ngIf="daySetLog.durationPerformed !== undefined" class="col-span-2">Time: <strong
                  class="dark:text-gray-100">{{ daySetLog.durationPerformed }}s</strong></span>
            </div>
            <p *ngIf="daySetLog.notes"
              class="mt-1.5 text-gray-500 dark:text-gray-400 italic text-2xs border-t border-gray-100 dark:border-gray-600 pt-1.5">
              {{ daySetLog.notes }}
            </p>
          </div>
        </div>
        <div *ngIf="allPreviousLoggedSetsForCurrentSession().length === 0 && showCompletedSetsForDayInfo()"
          class="p-3 text-xs text-center text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700/80 rounded-b-lg">
          No sets logged today for any exercise yet.
        </div>
      </div>

      <!-- Last Performance (for current exercise) -->
      <div
        *ngIf="trackingService.findPreviousSetPerformance(lastPerformanceForCurrentExercise, activeSet.setData, activeSet.setIndex) as prevPerfSet"
        class="p-3 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-lg text-xs">
        <p class="font-medium text-blue-700 dark:text-blue-300 mb-1">
          <span class="flex items-center gap-1.5">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
              stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Last time ({{lastPerformanceForCurrentExercise?.lastPerformedDate | date:'dd/MM/yy HH:mm' }}):
          </span>
        </p>
        <ul class="list-none space-y-0.5 ml-1 text-blue-600 dark:text-blue-400">
          <li *ngIf="prevPerfSet.repsAchieved !== undefined" class="flex items-center"><span class="w-16">Reps:</span>
            <strong class="dark:text-blue-200">{{ prevPerfSet.repsAchieved }}</strong>
          </li>
          <li *ngIf="prevPerfSet.weightUsed !== undefined && prevPerfSet.weightUsed !== null" class="flex items-center">
            <span class="w-16">Weight:</span> <strong class="dark:text-blue-200">{{ prevPerfSet.weightUsed | weightUnit
              }}</strong>
          </li>
          <li *ngIf="prevPerfSet.durationPerformed !== undefined" class="flex items-center"><span
              class="w-16">Time:</span> <strong class="dark:text-blue-200">{{ prevPerfSet.durationPerformed }}s</strong>
          </li>
          <li *ngIf="prevPerfSet.notes" class="mt-1 italic border-t border-blue-200 dark:border-blue-600 pt-1">Notes: {{
            prevPerfSet.notes }}</li>
        </ul>
      </div>
      <div
        *ngIf="!lastPerformanceForCurrentExercise && activeSetInfo() && !activeSetInfo()?.exerciseData?.exerciseId?.startsWith('custom-')"
        class="p-3 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-lg text-xs text-center text-gray-500 dark:text-gray-400 italic">
        No previous performance recorded for this exercise yet.
      </div>

      <!-- Personal Bests (for current exercise) -->
      <div
        *ngIf="exercisePBs().length > 0 || (currentBaseExercise() && !currentBaseExercise()?.id?.startsWith('custom-'))"
        class="p-3 bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-700 rounded-lg text-xs">
        <p class="font-medium text-yellow-700 dark:text-yellow-300 mb-2">
          <span class="flex items-center gap-1.5">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
              stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-12v4m-2-2h4m5 10v4m-2-2h4M5 3a2 2 0 00-2 2v1c0 1.1.9 2 2 2h4a2 2 0 002-2V6a2 2 0 00-2-2H5zm14 0a2 2 0 00-2 2v1c0 1.1.9 2 2 2h4a2 2 0 002-2V6a2 2 0 00-2-2h-4zM5 17a2 2 0 00-2 2v1c0 1.1.9 2 2 2h4a2 2 0 002-2v-1a2 2 0 00-2-2H5zm14 0a2 2 0 00-2 2v1c0 1.1.9 2 2 2h4a2 2 0 002-2v-1a2 2 0 00-2-2h-4z" />
            </svg>
            Personal Bests for {{ currentBaseExercise()?.name || 'this exercise' }}:
          </span>
        </p>
        <div *ngIf="exercisePBs().length > 0"
          class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1 text-yellow-600 dark:text-yellow-400">
          <div *ngFor="let pb of exercisePBs()">
            <span>{{ pb.pbType }}: </span>
            <strong class="dark:text-yellow-200">{{ formatPbValue(pb) }}</strong>
            <em class="text-yellow-500 dark:text-yellow-500 text-2xs ml-1"> ({{ pb.timestamp | date:'shortDate' }})</em>
          </div>
        </div>
        <div
          *ngIf="currentBaseExercise() && exercisePBs().length === 0 && !currentBaseExercise()?.id?.startsWith('custom-')"
          class="italic text-yellow-600 dark:text-yellow-400">
          No personal bests recorded yet for {{ currentBaseExercise()?.name }}.
        </div>
      </div>

      <!-- Target Editing Sections (Remains the same as previous) -->
      <div class="space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700">
        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-200">Set Targets:</h4>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <!-- Target Reps -->
          <div *ngIf="activeSet.setData.reps !== undefined"
            class="p-3 bg-gray-50 dark:bg-gray-700/80 rounded-lg shadow">
            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Target Reps</label>
            <div *ngIf="editingTarget !== 'reps'" (click)="startEditTarget('reps')"
              class="text-3xl font-bold text-primary dark:text-primary-light cursor-pointer hover:opacity-80 p-1.5 rounded-md min-h-[48px] flex items-center">
              {{ activeSet.setData.reps }}
            </div>
            <div *ngIf="editingTarget === 'reps'" class="flex items-center space-x-2">
              <input type="number" [(ngModel)]="editingTargetValue" (keyup.enter)="confirmEditTarget()"
                (keyup.escape)="cancelEditTarget()"
                class="w-24 p-2 text-2xl border-gray-300 dark:border-gray-600 rounded-md focus:ring-primary-focus focus:border-primary-focus dark:bg-gray-600 dark:text-gray-100 shadow-sm"
                autofocus>
              <button (click)="confirmEditTarget()"
                class="p-2 text-green-600 hover:text-green-500 dark:text-green-400 dark:hover:text-green-300 rounded-full hover:bg-green-100 dark:hover:bg-green-700/50"><svg
                  class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"></path>
                </svg></button>
              <button (click)="cancelEditTarget()"
                class="p-2 text-red-600 hover:text-red-500 dark:text-red-400 dark:hover:text-red-300 rounded-full hover:bg-red-100 dark:hover:bg-red-700/50"><svg
                  class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd"
                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                    clip-rule="evenodd"></path>
                </svg></button>
            </div>
          </div>

          <!-- Target Weight -->
          <div *ngIf="activeSet.setData.weight !== undefined && activeSet.setData.weight !== null"
            class="p-3 bg-gray-50 dark:bg-gray-700/80 rounded-lg shadow">
            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Target Weight</label>
            <div *ngIf="editingTarget !== 'weight'" (click)="startEditTarget('weight')"
              class="text-3xl font-bold text-primary dark:text-primary-light cursor-pointer hover:opacity-80 p-1.5 rounded-md min-h-[48px] flex items-center">
              {{ activeSet.setData.weight | weightUnit }}
            </div>
            <div *ngIf="editingTarget === 'weight'" class="flex items-center space-x-2">
              <input type="number" [(ngModel)]="editingTargetValue" (keyup.enter)="confirmEditTarget()"
                (keyup.escape)="cancelEditTarget()"
                class="w-24 p-2 text-2xl border-gray-300 dark:border-gray-600 rounded-md focus:ring-primary-focus focus:border-primary-focus dark:bg-gray-600 dark:text-gray-100 shadow-sm"
                autofocus>
              <button (click)="confirmEditTarget()"
                class="p-2 text-green-600 hover:text-green-500 dark:text-green-400 dark:hover:text-green-300 rounded-full hover:bg-green-100 dark:hover:bg-green-700/50"><svg
                  class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"></path>
                </svg></button>
              <button (click)="cancelEditTarget()"
                class="p-2 text-red-600 hover:text-red-500 dark:text-red-400 dark:hover:text-red-300 rounded-full hover:bg-red-100 dark:hover:bg-red-700/50"><svg
                  class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd"
                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                    clip-rule="evenodd"></path>
                </svg></button>
            </div>
          </div>

          <!-- Target Time -->
          <div *ngIf="activeSet.setData.duration !== undefined"
            class="p-3 bg-gray-50 dark:bg-gray-700/80 rounded-lg shadow">
            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Target Time</label>
            <div *ngIf="editingTarget !== 'duration'" (click)="startEditTarget('duration')"
              class="text-3xl font-bold text-primary dark:text-primary-light cursor-pointer hover:opacity-80 p-1.5 rounded-md min-h-[48px] flex items-center">
              {{ activeSet.setData.duration }}<span class="text-xl ml-0.5">s</span>
            </div>
            <div *ngIf="editingTarget === 'duration'" class="flex items-center space-x-2">
              <input type="number" [(ngModel)]="editingTargetValue" (keyup.enter)="confirmEditTarget()"
                (keyup.escape)="cancelEditTarget()"
                class="w-24 p-2 text-2xl border-gray-300 dark:border-gray-600 rounded-md focus:ring-primary-focus focus:border-primary-focus dark:bg-gray-600 dark:text-gray-100 shadow-sm"
                autofocus>
              <button (click)="confirmEditTarget()"
                class="p-2 text-green-600 hover:text-green-500 dark:text-green-400 dark:hover:text-green-300 rounded-full hover:bg-green-100 dark:hover:bg-green-700/50"><svg
                  class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"></path>
                </svg></button>
              <button (click)="cancelEditTarget()"
                class="p-2 text-red-600 hover:text-red-500 dark:text-red-400 dark:hover:text-red-300 rounded-full hover:bg-red-100 dark:hover:bg-red-700/50"><svg
                  class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd"
                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                    clip-rule="evenodd"></path>
                </svg></button>
            </div>
          </div>

          <!-- Target Tempo (Read-only example) -->
          <div *ngIf="activeSet.setData.tempo" class="p-3 bg-gray-50 dark:bg-gray-700/80 rounded-lg shadow">
            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Target Tempo</label>
            <span
              class="text-xl font-semibold text-gray-700 dark:text-gray-100 p-1.5 block min-h-[48px] flex items-center">{{
              activeSet.setData.tempo }}</span>
          </div>
        </div>
      </div>

      <!-- Planned Notes -->
      <div *ngIf="activeSet.setData.notes" class="mt-4 p-3 bg-gray-100 dark:bg-gray-700/60 rounded-lg text-xs">
        <p class="font-medium text-gray-600 dark:text-gray-300 mb-1">
          <span class="flex items-center gap-1.5">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
              stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
            </svg>
            Planned Notes for this Set:
          </span>
        </p>
        <p class="text-gray-700 dark:text-gray-200 italic">{{ activeSet.setData.notes }}</p>
      </div>

    </div>

    <footer class="p-4 bg-gray-50 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 text-right">
      <button (click)="closePerformanceInsights()"
        class="bg-primary hover:bg-primary-dark focus:ring-4 focus:ring-primary-focus text-white font-semibold py-2.5 px-6 rounded-lg text-sm transition-colors shadow-md hover:shadow-lg">
        Done
      </button>
    </footer>
  </div>
</div>


<!-- Exercise Selection Modal (similar to WorkoutBuilderComponent) -->
<div *ngIf="isExerciseModalOpen()"
  class="fixed inset-0 bg-gray-700 bg-opacity-75 transition-opacity overflow-y-auto h-full w-full z-[70] flex items-center justify-center p-4"
  (click)="closeExerciseSelectionModal()">
  <div
    class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-700 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg"
    (click)="$event.stopPropagation()">
    <div class="bg-white dark:bg-gray-700 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
      <div class="flex justify-between items-center pb-3">
        <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Add Exercise to Session</h3>
        <button type="button" (click)="closeExerciseSelectionModal()"
          class="p-1 rounded-full text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 focus:outline-none">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
            stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="my-4">
        <input type="text" placeholder="Search exercises..." [ngModel]="modalSearchTerm()"
          (ngModelChange)="modalSearchTerm.set($event)"
          class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-gray-200" />
      </div>
      <div class="mt-2 max-h-60 sm:max-h-80 overflow-y-auto pr-2">
        <ul class="space-y-1">
          <li *ngFor="let ex of filteredAvailableExercises()" (click)="selectExerciseToAddFromModal(ex)"
            class="p-3 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-md cursor-pointer transition-all duration-150 ease-in-out flex justify-between items-center">
            <div>
              <span class="font-medium text-gray-800 dark:text-gray-200">{{ ex.name }}</span>
              <span class="block text-xs text-gray-500 dark:text-gray-400">{{ ex.category | titlecase }} - {{
                ex.primaryMuscleGroup | titlecase }}</span>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
              class="w-5 h-5 text-primary dark:text-primary-light">
              <path fill-rule="evenodd"
                d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5V4.75Z"
                clip-rule="evenodd" />
            </svg>
          </li>
          <li *ngIf="filteredAvailableExercises().length === 0 && availableExercises.length > 0"
            class="text-gray-500 dark:text-gray-400 text-center p-4">No exercises match your search.</li>
          <li *ngIf="availableExercises.length === 0" class="text-gray-500 dark:text-gray-400 text-center p-4">Exercise
            library is empty or still loading.</li>
        </ul>
      </div>
      <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-600 text-center">
        <button type="button" (click)="handleTrulyCustomExerciseEntry()"
          class="text-sm text-primary dark:text-primary-light hover:underline">
          Or, create a new custom exercise entry...
        </button>
      </div>
    </div>
    <div class="bg-gray-50 dark:bg-gray-800 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
      <button type="button" (click)="closeExerciseSelectionModal()"
        class="mt-3 inline-flex w-full justify-center rounded-md bg-white dark:bg-gray-600 px-3 py-2 text-sm font-semibold text-gray-900 dark:text-gray-200 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-500 hover:bg-gray-50 dark:hover:bg-gray-500 sm:mt-0 sm:w-auto">
        Cancel
      </button>
    </div>
  </div>
</div>


<ng-template #loadingOrError>
  <div class="text-center py-20">
    <p class="text-xl text-gray-600 dark:text-gray-400">Loading workout player...</p>
  </div>
</ng-template>

<app-modal *ngIf="exerciseDetailsId" [(isOpen)]="isSimpleModalOpen" [modalTitle]="exerciseDetailsName">
  <app-exercise-detail [id]="exerciseDetailsId" [isModal]="true"></app-exercise-detail>
</app-modal>
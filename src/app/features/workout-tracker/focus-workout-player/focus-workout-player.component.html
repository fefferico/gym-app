<ng-container *ngIf="routine() as currentRoutine; else loadingOrError"
  style="height: 60px; position: fixed; top: 0; left: 0; right: 0; z-index: 50;">
  <div class="workout-player-container bg-gray-50 dark:bg-gray-950 flex flex-col justify-center"
    *ngIf="routine() !== undefined; else loadingOrError">

    <!-- PAUSED OVERLAY -->
    <div *ngIf="sessionState() === 'paused'"
      class="fixed inset-0 z-[60] bg-black/70 backdrop-blur-sm flex flex-col items-center justify-center space-y-6 p-4">
      <h2 class="text-4xl font-bold text-white">Session Paused</h2>
      <p class="text-lg text-gray-200">Elapsed Time: {{ sessionTimerDisplay() }}</p>
      <button appPress (shortPress)="resumeSession()"
        class="flex items-center justify-center bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-md text-xl shadow-lg w-full max-w-xs">
        <app-icon name="play" class="w-7 h-7 mr-1"></app-icon>
        RESUME WORKOUT
      </button>
      <button appPress (shortPress)="quitWorkout()"
        class="flex items-center justify-center text-m text-red-300 hover:text-red-100 font-medium py-2 px-4 rounded-md border border-red-300 hover:bg-red-700/30 w-full max-w-xs mt-2">
        <app-icon name="exit-door" class="w-7 h-7 mr-1"></app-icon>
        QUIT WORKOUT (NO SAVE)
      </button>
    </div>

    <!-- Top Bar -->
    <header
      class="sticky top-0 left-0 right-0 z-30 bg-white dark:bg-gray-800 shadow-md px-3 pt-3 pb-2 flex items-center flex-col h-15 rounded-b-md">
      <div class="flex w-full justify-between">
        <button appPress (shortPress)="goBack()"
        class="text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light">
        <app-icon name="back" class="h-7 w-7"></app-icon>
      </button>
      <div class="flex flex-col items-center cursor-pointer" appPress (shortPress)="jumpToExercise('Session overview')"
        [title]="'Click for session overview'">
        <h1 class="text-lg font-bold text-gray-800 dark:text-gray-100 truncate max-w-xs">
          {{ currentRoutine.name || 'Workout' }}
        </h1>
        <div class="text-xl font-mono font-semibold text-primary dark:text-primary-light tracking-wider">{{
          sessionTimerDisplay()
          }}</div>
      </div>
      <button appPress (shortPress)="toggleWorkoutMenu()"
        [disabled]="sessionState() === 'loading' || sessionState() === 'error' || (sessionState() === 'paused' && !isWorkoutMenuVisible())"
        class="text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light disabled:opacity-50">
            <app-icon name="menu-action" class="h-7 w-7"></app-icon>
      </button>
      </div>
      <!-- Workout Progress Bar -->
      <div class="w-full mt-2">
        <span class="flex justify-center text-white dark:text-primary-light font-mono">Overall progress</span>
        <div class="progress-bar-container w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 relative">
          <div class="progress-bar bg-primary h-2.5 rounded-full" [style.width.%]="workoutProgress()"></div>
          <span 
            class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-white">
            {{ workoutProgress() | number:'1.0-0' }}%
          </span>
        </div>
      </div>
    </header>

    <main class="pt-4 px-2 pb-36 bg-gray-100 dark:bg-gray-900">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm transition-all duration-300 relative py-2" *ngIf="activeSetInfo() as activeSet; else workoutCompleteOrError">
        <div class="flex text-center justify-center items-center mb-1 hover:cursor-pointer" appPress
          (shortPress)="openModal(activeSet.exerciseData)" [title]="'Click/tap for more info about the exercise'">
          <div *ngIf="currentBaseExercise() as baseEx; else loadingBaseExIcon" class="mr-2 h-8 w-8 flex-shrink-0">
            <img *ngIf="baseEx.iconName" [src]="getIconPath(baseEx.iconName)" [alt]="baseEx.name + ' icon'"
              class="w-full h-full object-contain"
              [ngClass]="{'filter dark:invert': baseEx.iconName !== 'default-exercise' && baseEx.iconName !== '' && baseEx.iconName !== null }">
          </div>
          <ng-template #loadingBaseExIcon>
            <div class="w-8 h-8 bg-gray-200 dark:bg-gray-700 rounded-md animate-pulse mr-2 flex-shrink-0"></div>
          </ng-template>
          <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 truncate"
            [title]="activeSet.exerciseData.exerciseName">
            {{ activeSet.exerciseData.exerciseName || 'Loading Exercise...' }}
          </h2>
        </div>

        <div class="text-center mb-2">
          <p *ngIf="false" class="flex flex-col">
            <span class="text-xs text-gray-500 dark:text-gray-400">{{activeSet.exerciseData.id}}</span>
            <span class="text-xs text-gray-500 dark:text-gray-400">{{activeSet.exerciseData.exerciseId}}</span>
            <span class="text-xs text-gray-500 dark:text-gray-400">{{activeSet.exerciseData.exerciseName}}</span>
          </p>

          <p class="text-m text-gray-500 dark:text-gray-400">
            <span *ngIf="activeSet.type === 'warmup'" class="text-blue-500 dark:text-blue-400">
              Warm-up Set {{ getCurrentWarmupSetNumber() }}
              <span *ngIf="getTotalWarmupSetsForCurrentExercise() > 0">/{{
                getTotalWarmupSetsForCurrentExercise()}}</span>
            </span>
            <span *ngIf="activeSet.type !== 'warmup'">
              Set {{ getCurrentWorkingSetNumber() }}/{{ getWorkingSetCountForCurrentExercise() }}
            </span>
            <span *ngIf="totalBlockRounds() > 1 && currentBlockRound() > 0" class="ml-2">
              (Round {{currentBlockRound()}}/{{totalBlockRounds()}})
            </span>
            <span *ngIf="activeSet.exerciseData.supersetId" class="ml-2 text-purple-500 dark:text-purple-400 italic">
              (Superset {{ (activeSet.exerciseData.supersetOrder ?? 0) + 1 }}/{{activeSet.exerciseData.supersetSize ??
              '?'}})
            </span>
          </p>
        </div>
        <div *ngIf="activeSet.exerciseData.sessionStatus && activeSet.exerciseData.sessionStatus !== 'pending'"
          class="text-center mb-3">
          <span *ngIf="activeSet.exerciseData.sessionStatus === 'skipped'"
            class="px-2 py-0.5 text-xs font-semibold text-red-700 bg-red-100 dark:bg-red-900 dark:text-red-200 rounded-full">Marked
            as Skipped</span>
          <span *ngIf="activeSet.exerciseData.sessionStatus === 'do_later'"
            class="px-2 py-0.5 text-xs font-semibold text-yellow-700 bg-yellow-100 dark:bg-yellow-800 dark:text-yellow-200 rounded-full">Marked
            for Later</span>
        </div>

        <div *ngIf="playerSubState() === PlayerSubState.PresetCountdown" class="text-center mb-6 animate-fadeIn">
          <h3 class="text-xl font-semibold text-blue-600 dark:text-blue-400">Get Ready!</h3>
          <p class="text-4xl sm:text-5xl font-bold text-blue-500 dark:text-blue-300 my-3">{{
            presetTimerCountdownDisplay() }}s</p>
          <p class="text-m text-gray-600 dark:text-gray-400">
            Prepare for: {{getCurrentUpText()}}
          </p>
          <button appPress (shortPress)="skipPresetTimer()"
            class="mt-4 text-xs text-primary dark:text-primary-light hover:underline">
            Skip Countdown & Start Set
          </button>
        </div>

        <div *ngIf="playerSubState() === PlayerSubState.PerformingSet">
          <form [formGroup]="currentSetForm" class="space-y-2 mb-2">
            <div *ngIf="csf['actualWeight']">
              <label
                class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider text-center mb-1">Weight
                ({{weightUnitDisplaySymbol}})</label>
              <div class="flex items-center justify-center space-x-2">
                <button type="button" [disabled]="getDisabled()" appPress (shortPress)="onShortPressWeightDecrement()"
                  (longPress)="onLongPressWeightDecrement()" (pressRelease)="onPressRelease()"
                  class="p-4 bg-gray-400 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50 rounded-r-sm rounded-l-2xl">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                  </svg>
                </button>
                <div appPress (shortPress)="editWeightWithPrompt()"
                  class="w-20 text-center text-3xl font-bold bg-transparent p-0 text-gray-800 dark:text-gray-100 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 py-1">
                  {{ (csf['actualWeight'].value | number:'1.0-2') ?? '0' }}
                </div>
                <input type="number" formControlName="actualWeight" class="hidden">
                <button type="button" [disabled]="getDisabled()" appPress (shortPress)="onShortPressWeightIncrement()"
                  (longPress)="onLongPressWeightIncrement()" (pressRelease)="onPressRelease()"
                  class="p-4 bg-gray-400 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50 rounded-l-sm rounded-r-2xl">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                  </svg>
                </button>
              </div>
            </div>

            <div
              *ngIf="csf['actualReps'] && activeSet.setData.reps !== undefined && activeSetInfo()?.baseExerciseInfo?.category !== 'cardio'">
              <label
                class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider text-center mb-1">Reps</label>
              <div class="flex items-center justify-center space-x-2">
                <button type="button" [disabled]="getDisabled()" appPress (shortPress)="onShortPressRepsDecrement()"
                  (longPress)="onLongPressRepsDecrement()" (pressRelease)="onPressRelease()"
                  class="p-4 bg-gray-400 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50 rounded-r-sm rounded-l-2xl">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                  </svg>
                </button>
                <input appPress (shortPress)="editRepsWithPrompt()" type="number" formControlName="actualReps" readonly
                  class="w-20 text-center text-3xl font-bold bg-transparent p-0 text-gray-800 dark:text-gray-100 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 py-1"
                  placeholder="0">
                <button type="button" [disabled]="getDisabled()" appPress (shortPress)="onShortPressRepsIncrement()"
                  (longPress)="onLongPressRepsIncrement()" (pressRelease)="onPressRelease()"
                  class="p-4 bg-gray-400 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50 rounded-l-sm rounded-r-2xl">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                  </svg>
                </button>
              </div>
            </div>

            <div *ngIf="activeSet.setData.duration">
              <label for="timedSetDisplay"
                class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider text-center">
                Time <span *ngIf="activeSet.setData.duration > 0">(Target:
                  {{ (activeSet.setData.duration * 1000) | date:'mm:ss':'UTC' }})</span>
              </label>
              <div id="timedSetDisplay"
                class="block w-full px-3 py-1 border-none text-6xl font-bold text-center bg-transparent focus:ring-0 hover:cursor-default unselectable"
                [ngClass]="{
                        'text-red-500': isTimedSetOvertime(),
                        'animate-pulse': isTimedSetOvertime() && timedSetTimerState() === 'running',
                        'text-green-500 dark:text-green-400': !isTimedSetOvertime() && timedSetTimerState() === 'running' && (activeSetInfo()?.setData?.duration ?? 0) > 0 && timedSetElapsedSeconds() > 0,
                        'text-gray-800 dark:text-gray-100': timedSetTimerState() === 'idle' || timedSetTimerState() === 'paused'
                     }">
                {{ timedSetDisplay() | formatSeconds }}
              </div>
              <input type="number" formControlName="actualDuration" class="hidden">
              <div class="flex space-x-2 mt-2 justify-center">
                <button type="button" (click)="toggleTimedSetTimer()" [ngClass]="{
                              'bg-green-500 hover:bg-green-600': timedSetTimerState() === 'idle' || timedSetTimerState() === 'paused',
                              'bg-yellow-500 hover:bg-yellow-600 text-white': timedSetTimerState() === 'running'
                            }"
                  class="flex items-center justify-center flex-grow min-w-[150px] max-w-[150px] font-medium py-2 px-3 rounded-full transition-colors text-m disabled:opacity-50">
                  <app-icon *ngIf="timedSetTimerState() === 'idle' || timedSetTimerState() === 'paused'" name="play"
                    class="h-8 w-8 text-white"></app-icon>
                  <app-icon *ngIf="timedSetTimerState() === 'running'" name="pause"
                    class="h-8 w-8 text-white"></app-icon>
                  <span *ngIf="timedSetTimerState() === 'idle'" class="text-white">START TIMER</span>
                  <span *ngIf="timedSetTimerState() === 'running'" class="text-white">PAUSE TIMER</span>
                  <span *ngIf="timedSetTimerState() === 'paused'" class="text-white">RESUME TIMER</span>
                </button>
                <button type="button" appPress (shortPress)="resetTimedSet()" *ngIf="timedSetTimerState() !== 'idle'"
                  class="flex items-center justify-center min-w-[150px] max-w-[150px] gap-x-2 bg-gray-300 hover:bg-gray-400 dark:bg-gray-700 dark:hover:bg-gray-500 text-white font-medium py-2 px-3 rounded-full transition-colors text-m disabled:opacity-50">
                  <app-icon name="change" class="w-5 h-5"></app-icon>
                  RESET
                </button>
              </div>
            </div>

            <div class="mt-5" *ngIf="showNotes()">
              <label for="setNotes" appPress (shortPress)="showNotes.set(!showNotes())"
                class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider text-center mb-1">Set
                Notes (Optional)</label>
              <textarea id="setNotes" formControlName="setNotes" rows="1" [disabled]="getDisabled()"
                class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-800 dark:text-gray-200 text-m disabled:opacity-60"
                placeholder="e.g., felt good, struggled on last rep..."></textarea>
            </div>
            <div class="flex justify-center cursor-pointer pt-5" *ngIf="!showNotes()" appPress
              (shortPress)="showNotes.set(!showNotes())">
              <div class="inline-flex items-center space-x-2 bg-blue-400 text-white rounded-full px-4 py-1">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                  stroke="currentColor" class="w-6 h-6 transition-all mr-2">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    [attr.d]="'M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25'" />
                </svg>
                Notes
              </div>
            </div>
          </form>
        </div>
        <div class="left-0 right-0 z-20 p-3 mt-5" *ngIf="routine() && sessionState() === 'playing' && activeSetInfo()">
          <div class="max-w-md mx-auto">
            <button appPress (shortPress)="handleMainAction()" appPress
              [disabled]="sessionState() === 'paused' || (playerSubState() === PlayerSubState.PresetCountdown && presetTimerCountdownDisplay() !== '0' && presetTimerCountdownDisplay() !== null) || (playerSubState() === PlayerSubState.Resting && isRestTimerVisible())"
              class="w-full font-bold py-3.5 px-4 rounded-full shadow-md text-lg transition-colors focus:outline-none focus:ring-2 disabled:opacity-70 text-white  transition-colors duration-150"
              [ngClass]="{
                'bg-primary hover:bg-primary-dark active:bg-primary-dark focus:outline-none focus:ring-0': playerSubState() === PlayerSubState.PerformingSet && !checkIfLatestOfEverything(),
                'bg-green-500 hover:bg-green-600 focus:ring-green-400': playerSubState() === PlayerSubState.PerformingSet && checkIfLatestOfEverything(),
                'bg-blue-500 hover:bg-blue-600 focus:ring-blue-400': playerSubState() === PlayerSubState.PresetCountdown,
                'bg-gray-400 dark:bg-gray-600 text-gray-800 dark:text-gray-200 cursor-not-allowed': playerSubState() === PlayerSubState.Resting && isRestTimerVisible()
            }">
              {{ mainActionButtonLabel() }}
            </button>
          </div>
        </div>
        <div *ngIf="getNextUpText(activeSetInfo(), routine() ?? null) && playerSubState() !== 'preset_countdown'"
          class="text-wrap text-sm text-center text-gray-800 dark:text-gray-100 px-2 text-s"
          [title]="getNextUpText(activeSetInfo(), routine() ?? null) || 'Next Exercise'">
          <span class="font-medium">Next up: </span><span>{{ getNextUpText(activeSetInfo(), routine() ?? null) ||
            'Next Exercise' }}</span>
        </div>
      </div>
      <ng-template #workoutCompleteOrError>
        <div class="text-center py-10 pt-16">
          <h2 class="text-2xl font-semibold text-gray-700 dark:text-gray-200">
            {{ sessionState() === 'error' ? 'Error Loading Workout' : (currentWorkoutLogExercises().length === 0 ?
            (routineId === '-1' ? 'Workout to be started' : 'Workout Ended') : 'Workout Complete!') }}
          </h2>
          <p class="text-gray-600 dark:text-gray-400 mt-2" *ngIf="sessionState() !== 'error'">
            {{ currentWorkoutLogExercises().length === 0 ? 'No sets logged yet' : 'All planned sets are done. Well
            done!' }}
          </p>
          <button *ngIf="sessionState() !== 'error' && currentWorkoutLogExercises().length > 0" appPress
            (shortPress)="finishWorkoutAndReportStatus()"
            class="mt-6 bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-md shadow-md text-lg transition-colors">
            Confirm & Save Workout
          </button>
          <div class="flex justify-center items-center gap-3 flex-col">
            <button appPress (shortPress)="backToRoutines()"
              *ngIf="sessionState() !== 'error' && currentWorkoutLogExercises().length === 0"
              class="flex justify-center items-center mt-1 w-full max-w-xs bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-md text-md shadow-md disabled:opacity-60 disabled:cursor-not-allowed">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                stroke-width="1.5" class="h-6 w-6 mr-1">
                <path _ngcontent-ng-c2442506092="" stroke-linecap="round" stroke-linejoin="round"
                  d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 0 1 0 3.75H5.625a1.875 1.875 0 0 1 0-3.75Z">
                </path>
              </svg>
              BACK TO WORKOUTS
            </button>
            <button appPress (shortPress)="addExerciseDuringSession()" [disabled]="sessionState() === 'paused'"
              class="w-full max-w-xs bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-6 rounded-md text-md shadow-md disabled:opacity-60 disabled:cursor-not-allowed mt-1">
              + ADD EXERCISE TO SESSION
            </button>
          </div>
        </div>
      </ng-template>
    </main>

    <footer
      *ngIf="routine() && sessionState() === 'playing' && activeSetInfo() && ((playerSubState() === PlayerSubState.Resting && !isRestTimerVisible()) || playerSubState() === PlayerSubState.PresetCountdown)"
      class="fixed bottom-[76px] left-0 right-0 z-10 bg-gray-100 dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 p-2 text-center h-auto min-h-[60px] flex flex-col justify-center shadow-[0_-1px_3px_rgba(0,0,0,0.07)]">
      <div class="max-w-md mx-auto w-full">
        <div *ngIf="playerSubState() === PlayerSubState.Resting && !isRestTimerVisible()">
          <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">UP NEXT</div>
          <div class="text-base font-medium text-gray-800 dark:text-gray-100 truncate px-4"
            [title]="restTimerNextUpText()">
            {{ restTimerNextUpText() || 'Next Exercise' }}
          </div>
          <div class="text-m text-gray-600 dark:text-gray-300">
            Rest: {{ restTimerDisplay() || (restDuration() | number:'1.0-0') + 's' }}
            <button appPress (shortPress)="skipRest()"
              class="ml-2 text-xs text-primary dark:text-primary-light hover:underline">(Skip)</button>
          </div>
        </div>
        <div *ngIf="playerSubState() === PlayerSubState.PresetCountdown">
          <div class="text-base font-medium text-gray-800 dark:text-gray-100 truncate px-4"
            [title]="restTimerMainText()">
            {{ restTimerMainText() }}
          </div>
          <div class="text-xl font-bold text-blue-600 dark:text-blue-300">
            {{ presetTimerCountdownDisplay() }}s
          </div>
          <button appPress (shortPress)="skipPresetTimer()"
            class="mt-0.5 text-xs text-primary dark:text-primary-light hover:underline">(Skip Countdown)</button>
        </div>
      </div>
    </footer>
  </div>
</ng-container>

<app-full-screen-rest-timer [isVisible]="playerSubState() === PlayerSubState.Resting && isRestTimerVisible()"
  [mainTimer]="sessionTimerDisplay" [durationSeconds]="restDuration()" [mainText]="restTimerMainText()"
  [nextUpText]="restTimerNextUpText()" (timerFinished)="handleRestTimerFinished()"
  (timerSkipped)="handleRestTimerSkipped($event)">
</app-full-screen-rest-timer>

<div *ngIf="isWorkoutMenuVisible()"
  class="fixed inset-0 z-50 bg-black/70 backdrop-blur-md flex flex-col justify-center items-center"
  style="padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom);">

  <div class="flex grid-cols-3 justify-center">
    <div></div>
    <h2 class="text-2xl sm:text-3xl font-bold text-white mb-2 justify-end">Workout Menu</h2>
    <button appPress (shortPress)="closeWorkoutMenu()"
      class="p-1.5 rounded-full text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700/70 focus:outline-none transition-colors ml-2">
      <app-icon name="cancel" class="h-6 w-6 text-white mr-1"></app-icon>
    </button>
  </div>

  <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 items-stretch p-4 max-w-[800px]">
    <button appPress (shortPress)="pauseSession()" [disabled]="sessionState() !== 'playing'"
      class="flex justify-center items-center w-full max-w-xs bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2.5 px-6 rounded-md text-lg shadow-lg disabled:opacity-60 disabled:cursor-not-allowed">
      <app-icon name="pause" class="h-6 w-6 text-white mr-1"></app-icon>
      PAUSE WORKOUT
    </button>

    <button *ngIf="!checkIfSuperSetIsStarted()" appPress (shortPress)="jumpToExercise()"
      [disabled]="sessionState() === 'paused' || !routine()?.exercises?.length"
      class="flex justify-center items-center w-full max-w-xs bg-fuchsia-500 hover:bg-fuchsia-600 text-white font-semibold py-2 px-6 rounded-md text-md shadow-md disabled:opacity-60 disabled:cursor-not-allowed">
      <app-icon name="dumbbell" class="h-6 w-6 text-white mr-1"></app-icon>
      JUMP TO EXERCISE
    </button>

    <button *ngIf="canSwitchExercise()" appPress (shortPress)="openSwitchExerciseModal()"
      class="w-full max-w-xs bg-cyan-500 hover:bg-cyan-600 text-white font-semibold py-2 px-6 rounded-md text-md shadow-md disabled:opacity-60 disabled:cursor-not-allowed flex items-center justify-center">
      <app-icon name="change" class="h-6 w-6 text-white mr-1"></app-icon>
      SWITCH EXERCISE
    </button>

    <button appPress (shortPress)="openPerformanceInsightsFromMenu()"
      [disabled]="sessionState() === 'paused' || !activeSetInfo()"
      class="flex items-center justify-center align-center w-full max-w-xs bg-cyan-500 hover:bg-cyan-600 text-white font-semibold py-2 px-6 rounded-md text-md shadow-md disabled:opacity-60 disabled:cursor-not-allowed">
      <app-icon name="schedule" class="h-8 w-8 text-white mr-1"></app-icon>
      PERFORMANCE INSIGHTS
    </button>

    <button *ngIf="!checkIfSuperSetIsStarted()" appPress (shortPress)="addWarmupSet()"
      [disabled]="!canAddWarmupSet() || sessionState() === 'paused' || !activeSetInfo()"
      class="w-full flex items-center justify-center max-w-xs bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-6 rounded-md text-md shadow-md disabled:opacity-60 disabled:cursor-not-allowed">
      <app-icon name="plus-circle" class="h-6 w-6 text-white mr-1"></app-icon>
      <p>ADD WARM-UP SET</p>
      <span *ngIf="!canAddWarmupSet()" class="text-xs text-white ml-2">(already started main sets)</span>
    </button>

    <button appPress (shortPress)="addExerciseDuringSession()" [disabled]="sessionState() === 'paused'"
      class="flex items-center justify-center align-center w-full max-w-xs bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-6 rounded-md text-md shadow-md disabled:opacity-60 disabled:cursor-not-allowed">
      <app-icon name="muscle" class="h-8 w-8 text-white mr-1"></app-icon>
      ADD EXERCISE TO SESSION
    </button>

    <button *ngIf="!checkIfSetIsPartOfRounds()" appPress (shortPress)="skipCurrentSet()"
      [disabled]="!activeSetInfo() || sessionState() === 'paused'"
      class="w-full flex items-center justify-center max-w-xs bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded-md text-md shadow-md disabled:opacity-60 disabled:cursor-not-allowed">
      <app-icon name="skip" class="h-6 w-6 text-white mr-1"></app-icon>
      SKIP CURRENT SET
    </button>

    <button *ngIf="!checkIfSetIsPartOfRounds()" appPress (shortPress)="skipCurrentExercise()"
      [disabled]="!activeSetInfo() || sessionState() === 'paused'"
      class="w-full flex items-center justify-center max-w-xs bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-6 rounded-md text-md shadow-md disabled:opacity-60 disabled:cursor-not-allowed">
      <app-icon name="skip" class="h-6 w-6 text-white mr-1"></app-icon>
      MARK EXERCISE AS SKIPPED
    </button>

    <button *ngIf="!checkIfSetIsPartOfRounds()" appPress (shortPress)="markCurrentExerciseDoLater()"
      [disabled]="!activeSetInfo() || sessionState() === 'paused'"
      class="w-full flex items-center justify-center max-w-xs bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-6 rounded-md text-md shadow-md disabled:opacity-60 disabled:cursor-not-allowed">
      <app-icon name="clock" class="h-6 w-6 text-white mr-1"></app-icon>
      MARK EXERCISE FOR LATER
    </button>

    <button *ngIf="currentWorkoutLogExercises().length > 0" appPress (shortPress)="finishWorkoutEarly()"
      [disabled]="sessionState() === 'paused' || currentWorkoutLogExercises().length === 0"
      class="w-full flex items-center justify-center max-w-xs bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-6 rounded-md text-md shadow-md disabled:opacity-60 disabled:cursor-not-allowed">
      <app-icon name="done" class="h-6 w-6 text-white mr-1"></app-icon>
      FINISH WORKOUT EARLY
    </button>

    <button appPress (shortPress)="quitWorkout()"
      class="w-full flex items-center justify-center max-w-xs text-red-300 hover:text-red-100 font-medium py-2 px-6 rounded-md border border-red-400 hover:bg-red-700/50 text-md">
      <app-icon name="exit-door" class="h-6 w-6 text-white mr-1"></app-icon>

      QUIT WORKOUT (NO SAVE)
    </button>
  </div>
</div>

<!-- Performance Insights Modal -->
<div *ngIf="isPerformanceInsightsVisible()" style="z-index: 100"
  class="fixed inset-0 bg-gray-900/70 dark:bg-black/80 backdrop-blur-md flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out">

  <div
    class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-xl max-h-[90vh] flex flex-col overflow-hidden transform transition-all duration-300 ease-in-out scale-95 opacity-0 animate-modal-appear">

    <header class="p-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-primary dark:text-primary-light" fill="none"
          viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100">Performance Insights & Targets</h3>
      </div>
      <button appPress (shortPress)="closePerformanceInsights()"
        class="p-1.5 rounded-full text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700/70 focus:outline-none transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"
          stroke-width="2.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </header>

    <div class="p-5 overflow-y-auto space-y-6 flex-grow custom-scrollbar" *ngIf="activeSetInfo() as activeSet">

      <!-- Completed Sets This Workout (for current exercise) -->
      <div class="rounded-md border border-gray-200 dark:border-gray-700/80">
        <button appPress (shortPress)="toggleCompletedSetsForExerciseInfo()" class="w-full flex items-center justify-between p-3 text-left text-sm font-medium text-gray-700
          dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors rounded-t-lg">
          <span class="flex items-center gap-2">
            <app-icon name="clipboard-list" class="h-6 w-6"></app-icon>
            This Exercise ({{ currentBaseExercise()?.name || 'Current' }}) - Completed Sets
            ({{allPreviousLoggedSetsForCurrentExercise().length}})
          </span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform transition-transform duration-200"
            [ngClass]="{'rotate-180': showCompletedSetsForExerciseInfo()}" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <div *ngIf="allPreviousLoggedSetsForCurrentExercise().length > 0 && showCompletedSetsForExerciseInfo()"
          class="bg-gray-50 dark:bg-gray-700/30 p-3 border-t border-gray-200 dark:border-gray-700/80 space-y-3 max-h-40 overflow-y-auto custom-scrollbar rounded-b-lg">
          <div *ngFor="let prevSetLog of allPreviousLoggedSetsForCurrentExercise(); let prevSetDisplayIndex = index"
            class="text-xs p-2 bg-white dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600">
            <p class="font-semibold text-gray-700 dark:text-gray-200 mb-1">
              <span *ngIf="prevSetLog.type === 'warmup'" class="text-blue-600 dark:text-blue-400 font-normal">(Warm-up)
              </span>
              Set #{{ prevSetDisplayIndex + 1 }}:
            </p>
            <div class="grid grid-cols-2 gap-x-2 gap-y-1 text-gray-600 dark:text-gray-300">
              <span *ngIf="prevSetLog.repsAchieved !== undefined">Reps: <strong class="dark:text-gray-100">{{
                  prevSetLog.repsAchieved }}</strong></span>
              <span *ngIf="prevSetLog.weightUsed !== undefined && prevSetLog.weightUsed !== null">Weight: <strong
                  class="dark:text-gray-100">{{ prevSetLog.weightUsed | weightUnit }}</strong></span>
              <span *ngIf="prevSetLog.durationPerformed !== undefined" class="col-span-2">Time: <strong
                  class="dark:text-gray-100">{{ prevSetLog.durationPerformed }}s</strong></span>
            </div>
            <p *ngIf="prevSetLog.notes"
              class="mt-1.5 text-gray-500 dark:text-gray-400 italic text-2xs border-t border-gray-100 dark:border-gray-600 pt-1.5">
              {{ prevSetLog.notes }}
            </p>
          </div>
        </div>
        <div *ngIf="allPreviousLoggedSetsForCurrentExercise().length === 0 && showCompletedSetsForExerciseInfo()"
          class="p-3 text-xs text-center text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700/80 rounded-b-lg">
          No sets completed yet for this exercise in this workout.
        </div>
      </div>

      <!-- Completed Sets Today (All Exercises) -->
      <div class="rounded-md border border-gray-200 dark:border-gray-700/80">
        <button appPress (shortPress)="toggleCompletedSetsForDayInfo()" class="w-full flex items-center justify-between p-3 text-left text-sm font-medium text-gray-700
          dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors rounded-t-lg">
          <span class="flex items-center gap-2">
            <app-icon name="calendar-page" class="h-6 w-6"></app-icon>
            Today's Logged Sets (All Exercises) ({{allPreviousLoggedSetsForCurrentSession().length}})
            <!-- Assuming this is the correct data source -->
          </span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform transition-transform duration-200"
            [ngClass]="{'rotate-180': showCompletedSetsForDayInfo()}" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="2"> <!-- New signal name -->
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <div *ngIf="allPreviousLoggedSetsForCurrentSession().length > 0 && showCompletedSetsForDayInfo()"
          class="bg-gray-50 dark:bg-gray-700/30 p-3 border-t border-gray-200 dark:border-gray-700/80 space-y-3 max-h-48 overflow-y-auto custom-scrollbar rounded-b-lg">
          <!-- Slightly increased max-h -->
          <div *ngFor="let daySetLog of allPreviousLoggedSetsForCurrentSession(); let daySetDisplayIndex = index"
            class="text-xs p-2 bg-white dark:bg-gray-700 rounded-md shadow-sm border border-gray-200 dark:border-gray-600">
            <p class="font-semibold text-gray-700 dark:text-gray-200 mb-1">
              <!-- You'll need the exercise name for these sets -->
              <span class="text-sm text-primary dark:text-primary-light">{{ daySetLog.exerciseName || 'Exercise'
                }}:</span>
              <span *ngIf="daySetLog.type === 'warmup'" class="text-blue-600 dark:text-blue-400 font-normal">
                (Warm-up)</span>
              Set #{{ (daySetLog.plannedSetId) }}:
              <!-- Use actual set number if available -->
            </p>
            <div class="grid grid-cols-2 gap-x-2 gap-y-1 text-gray-600 dark:text-gray-300">
              <span *ngIf="daySetLog.repsAchieved !== undefined">Reps: <strong class="dark:text-gray-100">{{
                  daySetLog.repsAchieved }}</strong></span>
              <span *ngIf="daySetLog.weightUsed !== undefined && daySetLog.weightUsed !== null">Weight: <strong
                  class="dark:text-gray-100">{{ daySetLog.weightUsed | weightUnit }}</strong></span>
              <span *ngIf="daySetLog.durationPerformed !== undefined" class="col-span-2">Time: <strong
                  class="dark:text-gray-100">{{ daySetLog.durationPerformed }}s</strong></span>
            </div>
            <p *ngIf="daySetLog.notes"
              class="mt-1.5 text-gray-500 dark:text-gray-400 italic text-2xs border-t border-gray-100 dark:border-gray-600 pt-1.5">
              {{ daySetLog.notes }}
            </p>
          </div>
        </div>
        <div *ngIf="allPreviousLoggedSetsForCurrentSession().length === 0 && showCompletedSetsForDayInfo()"
          class="p-3 text-xs text-center text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700/80 rounded-b-lg">
          No sets logged today for any exercise yet.
        </div>
      </div>

      <!-- Last Performance (for current exercise) -->
      <div
        *ngIf="trackingService.findPreviousSetPerformance(lastPerformanceForCurrentExercise, activeSet.setData, activeSet.setIndex) as prevPerfSet"
        class="p-3 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-md text-xs">
        <p class="font-medium text-blue-700 dark:text-blue-300 mb-1">
          <span class="flex items-center gap-1.5">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
              stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Last time ({{lastPerformanceForCurrentExercise?.lastPerformedDate | date:'dd/MM/yy' }}):
          </span>
        </p>
        <ul class="list-none space-y-0.5 ml-1 text-blue-600 dark:text-blue-400">
          <li *ngIf="prevPerfSet.repsAchieved !== undefined" class="flex items-center"><span class="w-16">Reps:</span>
            <strong class="dark:text-blue-200">{{ prevPerfSet.repsAchieved }}</strong>
          </li>
          <li *ngIf="prevPerfSet.weightUsed !== undefined && prevPerfSet.weightUsed !== null" class="flex items-center">
            <span class="w-16">Weight:</span> <strong class="dark:text-blue-200">{{ prevPerfSet.weightUsed | weightUnit
              }}</strong>
          </li>
          <li *ngIf="prevPerfSet.durationPerformed !== undefined" class="flex items-center"><span
              class="w-16">Time:</span> <strong class="dark:text-blue-200">{{ prevPerfSet.durationPerformed }}s</strong>
          </li>
          <li *ngIf="prevPerfSet.notes" class="mt-1 italic border-t border-blue-200 dark:border-blue-600 pt-1">Notes: {{
            prevPerfSet.notes }}</li>
        </ul>
      </div>
      <div
        *ngIf="!lastPerformanceForCurrentExercise && activeSetInfo() && !activeSetInfo()?.exerciseData?.exerciseId?.startsWith('custom-')"
        class="p-3 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-md text-xs text-center text-gray-500 dark:text-gray-400 italic">
        No previous performance recorded for this exercise yet.
      </div>

      <!-- Personal Bests (for current exercise) -->
      <div
        *ngIf="exercisePBs().length > 0 || (currentBaseExercise() && !currentBaseExercise()?.id?.startsWith('custom-'))"
        class="p-3 bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-700 rounded-md text-xs">
        <p class="font-medium text-yellow-700 dark:text-yellow-300 mb-2">
          <span class="flex items-center gap-1.5">
            <app-icon name="pb" class="h-6 w-6"></app-icon>
            Personal Bests for {{ currentBaseExercise()?.name || 'this exercise' }}:
          </span>
        </p>
        <div *ngIf="exercisePBs().length > 0"
          class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1 text-yellow-600 dark:text-yellow-400">
          <div *ngFor="let pb of exercisePBs()">
            <span>{{ pb.pbType }}: </span>
            <strong class="dark:text-yellow-200">{{ formatPbValue(pb) }}</strong>
            <em class="text-yellow-500 dark:text-yellow-500 text-2xs ml-1"> ({{ pb.timestamp | date:'shortDate' }})</em>
          </div>
        </div>
        <div
          *ngIf="currentBaseExercise() && exercisePBs().length === 0 && !currentBaseExercise()?.id?.startsWith('custom-')"
          class="italic text-yellow-600 dark:text-yellow-400">
          No personal bests recorded yet for {{ currentBaseExercise()?.name }}.
        </div>
      </div>

      <!-- Target Editing Sections (Remains the same as previous) -->
      <div class="space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700">
        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-200">Set Targets:</h4>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <!-- Target Reps -->
          <div *ngIf="activeSet.setData.reps !== undefined"
            class="p-3 bg-gray-50 dark:bg-gray-700/80 rounded-md shadow">
            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Target Reps</label>
            <div *ngIf="editingTarget !== 'reps'" appPress (shortPress)="startEditTarget('reps')"
              class="text-3xl font-bold text-primary dark:text-primary-light cursor-pointer hover:opacity-80 p-1.5 rounded-md min-h-[48px] flex items-center">
              {{ activeSet.setData.reps }}
            </div>
            <div *ngIf="editingTarget === 'reps'" class="flex items-center space-x-2">
              <input type="number" [(ngModel)]="editingTargetValue" (keyup.enter)="confirmEditTarget()"
                (keyup.escape)="cancelEditTarget()"
                class="w-24 p-2 text-2xl border-gray-300 dark:border-gray-600 rounded-md focus:ring-primary-focus focus:border-primary-focus dark:bg-gray-600 dark:text-gray-100 shadow-sm"
                autofocus>
              <button appPress (shortPress)="confirmEditTarget()"
                class="p-2 text-green-600 hover:text-green-500 dark:text-green-400 dark:hover:text-green-300 rounded-full hover:bg-green-100 dark:hover:bg-green-700/50"><svg
                  class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"></path>
                </svg></button>
              <button appPress (shortPress)="cancelEditTarget()"
                class="p-2 text-red-600 hover:text-red-500 dark:text-red-400 dark:hover:text-red-300 rounded-full hover:bg-red-100 dark:hover:bg-red-700/50"><svg
                  class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd"
                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                    clip-rule="evenodd"></path>
                </svg></button>
            </div>
          </div>

          <!-- Target Weight -->
          <div *ngIf="activeSet.setData.weight !== undefined && activeSet.setData.weight !== null"
            class="p-3 bg-gray-50 dark:bg-gray-700/80 rounded-md shadow">
            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Target Weight</label>
            <div *ngIf="editingTarget !== 'weight'" appPress (shortPress)="startEditTarget('weight')"
              class="text-3xl font-bold text-primary dark:text-primary-light cursor-pointer hover:opacity-80 p-1.5 rounded-md min-h-[48px] flex items-center">
              {{ activeSet.setData.weight | weightUnit }}
            </div>
            <div *ngIf="editingTarget === 'weight'" class="flex items-center space-x-2">
              <input type="number" [(ngModel)]="editingTargetValue" (keyup.enter)="confirmEditTarget()"
                (keyup.escape)="cancelEditTarget()"
                class="w-24 p-2 text-2xl border-gray-300 dark:border-gray-600 rounded-md focus:ring-primary-focus focus:border-primary-focus dark:bg-gray-600 dark:text-gray-100 shadow-sm"
                autofocus>
              <button appPress (shortPress)="confirmEditTarget()"
                class="p-2 text-green-600 hover:text-green-500 dark:text-green-400 dark:hover:text-green-300 rounded-full hover:bg-green-100 dark:hover:bg-green-700/50"><svg
                  class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"></path>
                </svg></button>
              <button appPress (shortPress)="cancelEditTarget()"
                class="p-2 text-red-600 hover:text-red-500 dark:text-red-400 dark:hover:text-red-300 rounded-full hover:bg-red-100 dark:hover:bg-red-700/50"><svg
                  class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd"
                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                    clip-rule="evenodd"></path>
                </svg></button>
            </div>
          </div>

          <!-- Target Time -->
          <div *ngIf="activeSet.setData.duration !== undefined"
            class="p-3 bg-gray-50 dark:bg-gray-700/80 rounded-md shadow">
            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Target Time</label>
            <div *ngIf="editingTarget !== 'duration'" appPress (shortPress)="startEditTarget('duration')"
              class="text-3xl font-bold text-primary dark:text-primary-light cursor-pointer hover:opacity-80 p-1.5 rounded-md min-h-[48px] flex items-center">
              {{ activeSet.setData.duration }}<span class="text-xl ml-0.5">s</span>
            </div>
            <div *ngIf="editingTarget === 'duration'" class="flex items-center space-x-2">
              <input type="number" [(ngModel)]="editingTargetValue" (keyup.enter)="confirmEditTarget()"
                (keyup.escape)="cancelEditTarget()"
                class="w-24 p-2 text-2xl border-gray-300 dark:border-gray-600 rounded-md focus:ring-primary-focus focus:border-primary-focus dark:bg-gray-600 dark:text-gray-100 shadow-sm"
                autofocus>
              <button appPress (shortPress)="confirmEditTarget()"
                class="p-2 text-green-600 hover:text-green-500 dark:text-green-400 dark:hover:text-green-300 rounded-full hover:bg-green-100 dark:hover:bg-green-700/50"><svg
                  class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"></path>
                </svg></button>
              <button appPress (shortPress)="cancelEditTarget()"
                class="p-2 text-red-600 hover:text-red-500 dark:text-red-400 dark:hover:text-red-300 rounded-full hover:bg-red-100 dark:hover:bg-red-700/50"><svg
                  class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd"
                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                    clip-rule="evenodd"></path>
                </svg></button>
            </div>
          </div>

          <!-- Target Tempo (Read-only example) -->
          <div *ngIf="activeSet.setData.tempo" class="p-3 bg-gray-50 dark:bg-gray-700/80 rounded-md shadow">
            <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Target Tempo</label>
            <span
              class="text-xl font-semibold text-gray-700 dark:text-gray-100 p-1.5 block min-h-[48px] flex items-center">{{
              activeSet.setData.tempo }}</span>
          </div>
        </div>
      </div>

      <!-- Planned Notes -->
      <div *ngIf="activeSet.setData.notes" class="mt-4 p-3 bg-gray-100 dark:bg-gray-700/60 rounded-md text-xs">
        <p class="font-medium text-gray-600 dark:text-gray-300 mb-1">
          <span class="flex items-center gap-1.5">
            <app-icon name="message" class="h-6 w-6"></app-icon>
            Planned Notes for this Set:
          </span>
        </p>
        <p class="text-gray-700 dark:text-gray-200 italic">{{ activeSet.setData.notes }}</p>
      </div>

    </div>

    <footer class="p-4 bg-gray-50 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 text-right">
      <button appPress (shortPress)="closePerformanceInsights()"
        class="flex items-center bg-primary hover:bg-primary-dark focus:ring-4 focus:ring-primary-focus text-white font-semibold py-2.5 px-6 rounded-md text-sm transition-colors shadow-md hover:shadow-lg">
        <app-icon name="done" class="h-7 w-7 mr-1"></app-icon>
        DONE
      </button>
    </footer>
  </div>
</div>


<app-exercise-selection-modal [isOpen]="isExerciseAddModalOpen()" [(searchTerm)]="modalSearchTerm"
  title="ADD EXERCISE TO SESSION" [exercises]="availableExercises" [showCreateCustomLink]="true"
  itemIconName="plus-circle" itemIconClass="text-primary dark:text-primary-light"
  (exerciseSelected)="selectExerciseToAddFromModal($event)" (createCustomClicked)="handleTrulyCustomExerciseEntry()"
  (close)="closeExerciseSelectionModal()">
</app-exercise-selection-modal>


<app-exercise-selection-modal [isOpen]="isExerciseSwitchModalOpen()" [(searchTerm)]="switchModalSearchTerm"
  [title]="isShowingSimilarInSwitchModal() ? 'SIMILAR EXERCISES' : 'SWITCH EXERCISE'"
  [exercises]="filteredExercisesForSwitchModal()" searchPlaceholder="Search for a replacement..."
  [showSimilarButton]="true" [isShowingSimilarView]="isShowingSimilarInSwitchModal()" itemIconName="change"
  itemIconClass="text-green-500" (exerciseSelected)="selectExerciseToSwitch($event)"
  (findSimilarClicked)="findAndShowSimilarExercises()" (backToSearchClicked)="isShowingSimilarInSwitchModal.set(false)"
  (close)="closeSwitchExerciseModal()">
</app-exercise-selection-modal>


<ng-template #loadingOrError>
  <div class="text-center py-20">
    <p class="text-xl text-gray-600 dark:text-gray-400">Loading workout player...</p>
  </div>
</ng-template>

<app-modal *ngIf="exerciseDetailsId" [(isOpen)]="isSimpleModalOpen" [modalTitle]="exerciseDetailsName">
  <app-exercise-detail [id]="exerciseDetailsId" [isModal]="true"></app-exercise-detail>
</app-modal>
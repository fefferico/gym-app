<div *ngIf="errorMessage()"
    class="my-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-md dark:bg-red-900/30 dark:border-red-600 dark:text-red-300">
    {{ errorMessage() }}
</div>

<div class="container mx-auto p-2 sm:p-4">
    <header class="flex items-center justify-between p-2">
        <div class="flex justify-between items-center">
            <button [routerLink]="mode === 'routineBuilder' ? '/workout' : '/history/list'"
                class="text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light p-2 -ml-1"><svg
                    fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
                    class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg></button>
            <div class="w-10 h-10"></div> <!-- Spacer -->
        </div>
        <!-- Action Buttons Group -->
        <div class="flex items-center space-x-2 flex-shrink-0">
            <!-- Wrapper for "More Actions" button and its dropdown -->
            <div *ngIf="routine as log" class="">
                <div class="relative">
                    <button (click)="toggleActions(log.id, $event)"
                        class="p-1.5 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                        </svg>
                    </button>
                    <app-action-menu *ngIf="areActionsVisible(log.id)" displayMode="dropdown"
                        [items]="getRoutineDropdownActionItems(log.id, 'dropdown')"
                        [isVisible]="areActionsVisible(log.id)" (itemClick)="handleActionMenuItemClick($event)"
                        (closeMenu)="onCloseActionMenu()">
                    </app-action-menu>
                </div>
            </div>
        </div>

    </header>

    <form [formGroup]="builderForm" (ngSubmit)="onSubmit()"
        class="space-y-6 mb-6 p-1 bg-white dark:bg-gray-700 rounded-md shadow-xl overflow-hidden">
        <section class="space-y-4 p-2 rounded-md shadow-sm dark:shadow-none">
            <!-- ROUTINE BUILDER FIELDS -->
            <ng-container *ngIf="mode === 'routineBuilder'">
                <!-- ROUTINE NAME -->
                <div *ngIf="isViewMode">
                    <label
                        class="block text-xl font-black text-gray-700 dark:text-gray-300">{{builderForm.get('name')?.value}}</label>
                </div>
                <div *ngIf="isEditableMode()">
                    <label for="routineName" class="block text-m font-medium text-gray-700 dark:text-gray-300">Routine
                        Name</label>
                    <input type="text" id="routineName" formControlName="name" placeholder="Routine name"
                        class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200"
                        [ngClass]="{'border-red-500 dark:border-red-400': builderForm.get('name')?.invalid && builderForm.get('name')?.touched, 'border-gray-300 dark:border-gray-500': !(builderForm.get('name')?.invalid && builderForm.get('name')?.touched) }">
                    <div *ngIf="builderForm.get('name')?.invalid && (builderForm.get('name')?.dirty || builderForm.get('name')?.touched)"
                        class="text-red-500 dark:text-red-400 text-xs mt-1">
                        <span *ngIf="builderForm.get('name')?.errors?.['required']">Routine name is required.</span>
                    </div>
                </div>
                <!-- DESCRIPTION -->
                <div *ngIf="isViewMode">
                    <p class="mt-1 block w-full shadow-sm dark:shadow-none dark:text-gray-200"
                        [innerHTML]="sanitizedDescription">
                    </p>
                </div>
                <div *ngIf="isEditableMode()">
                    <label for="description"
                        class="block text-m font-medium text-gray-700 dark:text-gray-300">Description (Optional)</label>
                    <textarea id="description" formControlName="description" rows="3"
                        placeholder="Description (optional)"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200"></textarea>
                </div>
                <!-- GOAL -->
                <div *ngIf="isViewMode">
                    <label class="block text-m text-gray-700 dark:text-gray-300">
                        <span class="font-medium">Goal: </span>
                        {{ builderForm.get('goal')?.value?.toUpperCase() || ''}}</label>
                </div>
                <div *ngIf="isEditableMode()">
                    <!-- <label for="goal" class="block text-m font-medium text-gray-700 dark:text-gray-300">Primary
                        Goal</label> -->
                    <select id="goal" formControlName="goal"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200">
                        <option value="">-- Set routine goal --</option>
                        <option *ngFor="let goalOpt of routineGoals" [value]="goalOpt.value">{{ goalOpt.label }}
                        </option>
                    </select>
                </div>
                <!-- TIME TO COMPLETE -->
                <div>
                    <div *ngIf="routine && getRoutineDuration() > 0" class="text-m text-gray-500 dark:text-gray-300">
                        <span class="font-medium">Est:</span> ~{{ getRoutineDuration()}} min
                    </div>
                </div>

            </ng-container>

            <!-- MANUAL LOG ENTRY FIELDS -->
            <ng-container *ngIf="mode === 'manualLogEntry'">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="workoutDate"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300">Workout Date</label>
                        <input type="date" id="workoutDate" formControlName="workoutDate"
                            class="mt-1 block w-full p-2 border rounded-md shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200"
                            [ngClass]="{'border-red-500 dark:border-red-400': builderForm.get('workoutDate')?.invalid && builderForm.get('workoutDate')?.touched, 'border-gray-300 dark:border-gray-500': !(builderForm.get('workoutDate')?.invalid && builderForm.get('workoutDate')?.touched) }">
                        <div *ngIf="builderForm.get('workoutDate')?.invalid && (builderForm.get('workoutDate')?.dirty || builderForm.get('workoutDate')?.touched)"
                            class="text-red-500 dark:text-red-400 text-xs mt-1">
                            <span *ngIf="builderForm.get('workoutDate')?.errors?.['required']">Date is required.</span>
                        </div>
                    </div>
                    <div>
                        <label for="startTime" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Start
                            Time</label>
                        <input type="time" id="startTime" formControlName="startTime"
                            class="mt-1 block w-full p-2 border rounded-md shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200"
                            [ngClass]="{'border-red-500 dark:border-red-400': builderForm.get('startTime')?.invalid && builderForm.get('startTime')?.touched, 'border-gray-300 dark:border-gray-500': !(builderForm.get('startTime')?.invalid && builderForm.get('startTime')?.touched) }">
                        <div *ngIf="builderForm.get('startTime')?.invalid && (builderForm.get('startTime')?.dirty || builderForm.get('startTime')?.touched)"
                            class="text-red-500 dark:text-red-400 text-xs mt-1">
                            <span *ngIf="builderForm.get('startTime')?.errors?.['required']">Start time is
                                required.</span>
                        </div>
                    </div>
                    <div>
                        <label for="durationMinutes"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300">Duration (min)</label>
                        <input type="number" id="durationMinutes" formControlName="durationMinutes"
                            class="mt-1 block w-full p-2 border rounded-md shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200"
                            [ngClass]="{'border-red-500 dark:border-red-400': builderForm.get('durationMinutes')?.invalid && builderForm.get('durationMinutes')?.touched, 'border-gray-300 dark:border-gray-500': !(builderForm.get('durationMinutes')?.invalid && builderForm.get('durationMinutes')?.touched) }">
                        <div *ngIf="builderForm.get('durationMinutes')?.invalid && (builderForm.get('durationMinutes')?.dirty || builderForm.get('durationMinutes')?.touched)"
                            class="text-red-500 dark:text-red-400 text-xs mt-1">
                            <span *ngIf="builderForm.get('durationMinutes')?.errors?.['min']">Min duration is 1.</span>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="logWorkoutName"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">Workout Title
                        (Optional)</label>
                    <input type="text" id="logWorkoutName" formControlName="name"
                        placeholder="e.g., Morning Chest Session"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200">
                </div>
                <div>
                    <label for="routineIdForLog"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">Based on Routine
                        (Optional)</label>
                    <select id="routineIdForLog" formControlName="routineIdForLog"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200">
                        <option value="">-- Log Ad-hoc Routine --</option>
                        <option *ngFor="let r of availableRoutines" [value]="r.id">{{ r.name }}</option>
                    </select>
                </div>
                <div>
                    <label for="programIdForLog"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">Based on Program
                        (Optional)</label>
                    <select id="programIdForLog" formControlName="programIdForLog"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200">
                        <option value="">-- Log Ad-hoc Program --</option>
                        <option *ngFor="let program of availablePrograms" [value]="program.id">{{ program.name }}</option>
                    </select>
                </div>
                <div>
                    <label for="overallNotesLog"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">Overall Notes
                        (Optional)</label>
                    <textarea id="overallNotesLog" formControlName="overallNotesLog" rows="2"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200"></textarea>
                </div>
            </ng-container>
        </section>

        <section class="pt-4 px-2" *ngIf="mode === 'manualLogEntry' || builderForm.get('goal')?.value !== 'rest'">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-300">{{ mode === 'routineBuilder' ?
                    'Exercises' : 'Logged Exercises' }}</h2>
                <button *ngIf="!isViewMode && (!exercisesFormArray.controls || exercisesFormArray.controls.length > 0)"
                    type="button" (click)="openExerciseSelectionModal()"
                    class="bg-green-500 hover:enabled:bg-green-600 text-white text-m font-medium py-2 px-3 rounded-md transition-all duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                    + ADD EXERCISE
                </button>
            </div>

            <div *ngIf="exercisesFormArray.length>0" cdkDropList [cdkDropListData]="exercisesFormArray.controls"
                (cdkDropListDropped)="onExerciseDrop($event)"
                [cdkDropListDisabled]="!isEditableMode" formArrayName="exercises"
                class="exercise-list-container space-y-4">
                <ng-container *ngFor="let exerciseControl of exercisesFormArray.controls; let exIndex = index;"
                    >
                    <div class="relative group exercise-card-wrapper" (click)="toggleSetExpansion(exIndex,0, $event)"
                        appClickOutside (clickOutside)="collapseExpandedSet(false,$event)" [title]="isEditableMode() ? 'Drag to reorder' : ''"
                        [ngClass]="{
                                        'superset-spacing': isSupersetSpacing(exIndex)
                                        }">
                        <div *ngIf="mode === 'routineBuilder' && (isEditableMode()) && selectedExerciseIndicesForSuperset().length >= 2 && exIndex === firstSelectedExerciseIndexForSuperset"
                            class="absolute left-1/2 -translate-x-1/2 z-20" style="top: -1.25rem;">
                            <button *ngIf="!canUngroupSelectedExercises()" type="button"
                                (click)="groupSelectedAsSuperset()" [disabled]="isViewMode"
                                class="bg-orange-600 hover:bg-orange-700 text-white text-xs font-semibold py-1.5 px-3 rounded-full shadow-lg">
                                Group Superset ({{ selectedExerciseIndicesForSuperset().length }})
                            </button>
                            <button *ngIf="canUngroupSelectedExercises()" type="button"
                                (click)="ungroupSuperset(exIndex)" [disabled]="isViewMode"
                                class="bg-violet-600 hover:bg-violet-700 text-white text-xs font-semibold py-1.5 px-3 rounded-full shadow-lg">
                                Ungroup Superset ({{ selectedExerciseIndicesForSuperset().length }})
                            </button>
                        </div>

                        <div cdkDrag
                            [cdkDragDisabled]="!isEditableMode() || isSetExpanded(exIndex, 0)"
                            appLongPressDrag [longPressEnabled]="isEditableMode() && !isSetExpanded(exIndex, 0)"
                            [longPressDelay]="150" longPressClass="is-long-pressing" [cdkDragData]="exerciseControl"
                            [formGroupName]="exIndex" [cdkDragStartDelay]="110"
                            class="exercise-item relative transition-all"
                            [ngClass]="getExerciseCardClasses(exerciseControl, exIndex)">
                            <!-- COMPACT VIEW / HEADER AREA -->
                            <div class="flex items-center space-x-1">
                                <!-- DRAG HANDLE ICON (Now just a visual cue) -->
                                <div *ngIf="isEditableMode()"
                                    class="p-1 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 flex-shrink-0"
                                    title="Drag to reorder">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-5 h-5">
                                        <path d="M 7 17 L 7 3 M 4 6 L 7 3 L 10 6 M 17 7 L 17 21 M 14 18 L 17 21 L 20 18"
                                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" />
                                    </svg>
                                </div>
                                <!-- CHECKBOX (if applicable) -->
                                <input
                                    *ngIf="mode === 'routineBuilder' && (isEditableMode() || isNewMode) && !isViewMode"
                                    type="checkbox" title="Select the exercise for the Superset"
                                    [id]="'superset-select-' + exIndex"
                                    (change)="toggleExerciseSelectionForSuperset(exIndex, $event)"
                                    [checked]="selectedExerciseIndicesForSuperset().includes(exIndex)"
                                    class="h-4 w-4 text-orange-600 border-gray-300 dark:border-gray-600 rounded focus:ring-orange-500 flex-shrink-0 disabled:opacity-50"
                                    [disabled]="isViewMode">
                                <!-- EXERCISE NAME & SUPERSET INFO / SETS SUMMARY FOR COMPACT -->
                                <div *ngIf="!shouldShowExpandedExercise(exIndex)" class="flex-grow min-w-0 py-2 px-0">
                                    <!-- COMPACT: Show SETS SUMMARY if in compact view -->
                                    <div *ngIf="exerciseControl.get('supersetId')?.value && getSetsFormArray(exerciseControl).controls.length > 0 
                                        && exerciseControl.get('supersetOrder')?.value === 0"
                                        class="text-xs text-orange-600 dark:text-orange-400 mt-0.5">
                                        {{ exerciseControl.get('rounds')?.value || 1 }}
                                        {{ (exerciseControl.get('rounds')?.value || 1) === 1 ? 'round' : 'rounds' }}
                                    </div>
                                    <div *ngIf="!shouldShowExpandedExercise(exIndex) && getSetsFormArray(exerciseControl).controls.length > 0"
                                        class="flex items-center text-s text-gray-500 dark:text-gray-400 mt-0.5 gap-4 pl-2">
                                        <img [src]="getIconPath(exerciseControl.get('exerciseId')?.value) | async"
                                            alt="Exercise Icon" class="w-6 h-6 sm:w-8 sm:h-8 object-contain">
                                        <div class="min-w-0"> <!-- Added min-w-0 for truncation -->
                                            <div class="flex">
                                                <h3 class="font-semibold text-gray-800 dark:text-gray-100 truncate"
                                                    [title]="exerciseControl.get('exerciseName')?.value">
                                                    {{ exerciseControl.get('exerciseName')?.value }}
                                                </h3>
                                                <svg class="ml-2 cursor-pointer dark:text-white"
                                                    title="Exercise details"
                                                    *ngIf="exerciseControl.get('exerciseId')?.value" width="20"
                                                    height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"
                                                    appPress (shortPress)="openModal(exerciseControl.value)">
                                                    <!-- Outer circle -->
                                                    <title>Exercise details and progression</title>
                                                    <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="2"
                                                        fill="none" />
                                                    <!-- Dot of the 'i' -->
                                                    <circle cx="10" cy="6" r="1.5" fill="currentColor" />
                                                    <!-- Stem of the 'i' -->
                                                    <rect x="9" y="9" width="2" height="7" fill="currentColor" />
                                                </svg>
                                            </div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400 truncate">
                                                <p
                                                    *ngIf="exerciseControl?.get('sets')?.value && exerciseControl?.get('sets')?.value.length >= 1 && checkIfTimedExercise(exerciseControl)">
                                                    Duration
                                                    (s):
                                                    {{getSetDurationPerformed(exerciseControl)}}
                                                </p>
                                                <p
                                                    *ngIf="exerciseControl?.get('sets')?.value && exerciseControl?.get('sets')?.value.length >= 1">
                                                    Sets: {{exerciseControl?.get('sets')?.value.length}} {{
                                                    getSetReps(exerciseControl) != '0' ? '( Reps: ' +
                                                    getSetReps(exerciseControl) + ' )' : '' }}
                                                </p>
                                                <p
                                                    *ngIf="exerciseControl?.get('sets')?.value && exerciseControl?.get('sets')?.value.length > 1 && checkIfWeightedExercise(exerciseControl)">
                                                    Weight
                                                    ({{unitService.getUnitLabel()}}):
                                                    {{getSetWeightsUsed(exerciseControl)}}
                                                </p>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                                <!-- COMPACT: Minimal actions for compact view (e.g., small remove icon) -->
                                <div *ngIf="!shouldShowExpandedExercise(exIndex) && !isViewMode"
                                    class="flex-shrink-0 ml-auto">
                                    <!-- ml-auto to push to the right -->
                                    <button type="button" (click)="removeExercise(exIndex); $event.stopPropagation()"
                                        title="Remove Exercise"
                                        class="p-1 text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 rounded-full hover:bg-red-100 dark:hover:bg-red-900/30 disabled:opacity-50">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" class="w-4 h-4">
                                            <!-- Rounded square background in red -->
                                            <rect width="16" height="16" rx="3" ry="3" fill="red" />
                                            <!-- White "X" shape centered -->
                                            <path fill="#ffffff" fill-rule="evenodd" clip-rule="evenodd"
                                                d="M4.22 4.22a.75.75 0 0 1 1.06 0L8 7.94l2.72-2.72a.75.75 0 1 1 1.06 1.06L9.06 9l2.72 2.72a.75.75 0 1 1-1.06 1.06L8 10.06 5.28 12.78a.75.75 0 0 1-1.06-1.06L6.94 9 4.22 6.28a.75.75 0 0 1 0-1.06z" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <!-- EXPANDED CONTENT AREA -->
                            <div *ngIf="shouldShowExpandedExercise(exIndex)" class="p-2">
                                <div
                                    class="flex flex-col sm:flex-row justify-between items-start sm:items-center pb-2 pt-1 sm:pt-0">
                                    <div class="flex-grow">
                                        <!-- Superset info remains on its own line if visible, which is correct -->
                                        <span
                                            *ngIf="mode === 'routineBuilder' && exerciseControl.get('supersetId')?.value"
                                            class="text-xs text-orange-600 dark:text-orange-400 font-normal block mb-1">
                                            Superset exercise ({{ (exerciseControl.get('supersetOrder')?.value ?? 0) + 1 }} of {{
                                            exerciseControl.get('supersetSize')?.value }})
                                        </span>

                                        <!-- NEW: Flex container to align the icon and the title horizontally -->
                                        <div class="flex items-center">
                                            <!-- The Image: Added margin-right for spacing and flex-shrink-0 -->
                                            <img [src]="getIconPath(exerciseControl.get('exerciseId')?.value) | async"
                                                alt="Exercise Icon"
                                                class="w-6 h-6 sm:w-8 sm:h-8 object-contain mr-3 flex-shrink-0">

                                            <!-- The Title Text: Now wrapped in its own h3 tag -->
                                            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100">
                                                {{ exerciseControl.get('exerciseName')?.value || 'Select Exercise' }}
                                            </h3>
                                            <svg class="ml-2 cursor-pointer dark:text-white" title="Exercise details"
                                                *ngIf="exerciseControl.get('exerciseId')?.value" width="20" height="20"
                                                viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"
                                                appPress (shortPress)="openModal(exerciseControl.value)">
                                                <!-- Outer circle -->
                                                <title>Exercise details and progression</title>
                                                <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="2"
                                                    fill="none" />
                                                <!-- Dot of the 'i' -->
                                                <circle cx="10" cy="6" r="1.5" fill="currentColor" />
                                                <!-- Stem of the 'i' -->
                                                <rect x="9" y="9" width="2" height="7" fill="currentColor" />
                                            </svg>
                                        </div>
                                    </div>

                                    <div
                                        class="flex flex-col items-start sm:items-end space-y-1 flex-shrink-0 w-full sm:w-auto mt-2 sm:mt-0">
                                        <div *ngIf="mode === 'routineBuilder' && exerciseControl.get('supersetId')?.value && exerciseControl.get('supersetOrder')?.value === 0"
                                            class="flex items-center space-x-1">
                                            <label [for]="'rounds-' + exIndex"
                                                class="text-xs font-medium text-gray-600 dark:text-gray-400 whitespace-nowrap">Rounds:</label>
                                            <input type="number" [id]="'rounds-' + exIndex" formControlName="rounds"
                                                min="1"
                                                class="w-16 p-1 text-m border-gray-300 dark:border-gray-500 border-2 rounded-md focus:ring-primary focus:border-primary dark:bg-gray-600 dark:text-gray-200 disabled:opacity-50 disabled:bg-gray-300 dark:disabled:bg-gray-500"
                                                [readonly]="(exerciseControl.get('supersetId')?.value && (exerciseControl.get('supersetOrder')?.value ?? 0) > 0) || isViewMode"
                                                (change)="syncSupersetRounds(exerciseControl.get('supersetId')?.value, exerciseControl.get('rounds')?.value, exIndex)">
                                        </div>
                                        <button *ngIf="!isViewMode" type="button" (click)="removeExercise(exIndex)"
                                            class="flex items-center text-xs text-red-600 bg-red-200 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 font-medium py-1 px-2 rounded-md hover:enabled:bg-red-100 dark:enabled:hover:bg-red-900/50 disabled:opacity-50">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"
                                                class="w-4 h-4 mr-2">
                                                <!-- Rounded square background in red -->
                                                <rect width="16" height="16" rx="3" ry="3" fill="red" />
                                                <!-- White "X" shape centered -->
                                                <path fill="#ffffff" fill-rule="evenodd" clip-rule="evenodd"
                                                    d="M4.22 4.22a.75.75 0 0 1 1.06 0L8 7.94l2.72-2.72a.75.75 0 1 1 1.06 1.06L9.06 9l2.72 2.72a.75.75 0 1 1-1.06 1.06L8 10.06 5.28 12.78a.75.75 0 0 1-1.06-1.06L6.94 9 4.22 6.28a.75.75 0 0 1 0-1.06z" />
                                            </svg>
                                            Remove
                                        </button>
                                        <button
                                            *ngIf="mode === 'routineBuilder' && isEditableMode() && exerciseControl.get('supersetId')?.value"
                                            type="button" (click)="ungroupSuperset(exIndex)" [disabled]="isViewMode"
                                            class="flex bg-violet-200 items-center text-xs text-violet-600 hover:text-violet-700 dark:text-violet-400 dark:hover:text-violet-300 font-medium py-1 px-2 rounded-md hover:bg-violet-100 dark:hover:bg-violet-900/50 disabled:opacity-50">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                                stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1">
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                    d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75v4.5m0-4.5h-4.5m4.5 0L15 9m5.25 11.25v-4.5m0 4.5h-4.5m4.5 0L15 15" />
                                            </svg>
                                            Ungroup
                                        </button>
                                    </div>
                                </div>

                                <!-- Exercise Notes -->
                                <div *ngIf="builderForm.get('notes')?.value || isEditableMode()">
                                    <label [for]="'exerciseNotes-' + exIndex"
                                        class="block text-s font-medium text-gray-600 dark:text-gray-400 mb-0.5">
                                        {{ mode === 'routineBuilder' ? 'Exercise Notes (Optional)' : 'Notes for this
                                        Logged Exercise (Optional)'}}
                                    </label>
                                    <textarea [id]="'exerciseNotes-' + exIndex" formControlName="notes" rows="1"
                                        appAutoGrow
                                        class="mt-0.5 block w-full p-1.5 text-sm border-gray-300 dark:border-gray-500 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200"
                                        [readonly]="isViewMode"></textarea>
                                </div>

                                <!-- Sets Section (Headers, Collapsed Sets, Expanded Set Form) -->
                                <!-- EXPANDED Only VIEW MODE - START -->
                                <div *ngIf="!isCompactView && isViewMode" [ngClass]="{
                                        'grid-cols-6': exerciseControl.getRawValue() | isWeighted,
                                        'grid-cols-5': !(exerciseControl.getRawValue() | isWeighted)
                                    }"
                                    class="grid gap-x-4 gap-y-2 px-2 py-2 bg-white rounded-md dark:bg-gray-800 text-gray-900 dark:text-white">

                                    <!-- === GRID HEADER === -->
                                    <div class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400">Set</div>
                                    <div class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400">Reps</div>

                                    <!-- The pipe is used here for the *ngIf condition -->
                                    <div *ngIf="exerciseControl.getRawValue() | isWeighted"
                                        class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400">
                                        Weight
                                    </div>

                                    <div class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400">Time</div>
                                    <div class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400">Rest</div>
                                    <div class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400">Notes
                                    </div>


                                    <!-- === GRID ROWS (LOOP) === -->
                                    <ng-container
                                        *ngFor="let set of exerciseControl.get('sets')?.value; let i = index; let last = last">

                                        <!-- Row data aligns perfectly -->
                                        <div class="font-medium">{{ i + 1 }}</div>
                                        <div>
                                            <strong>
                                                {{ set.reps || '—' }}
                                            </strong>
                                        </div>

                                        <!-- The pipe is used a final time for the data cell -->
                                        <div *ngIf="exerciseControl.getRawValue() | isWeighted">
                                            <strong>
                                                {{ set.weight != null ? (set.weight + ' ' +
                                                unitService.getUnitLabel()) : '—' }}
                                            </strong>

                                        </div>

                                        <div>
                                            <strong>
                                                {{ set.duration || '—' }}
                                            </strong>
                                        </div>
                                        <div>
                                            <strong>
                                                {{ set.restAfterSet || '—' }}
                                            </strong>
                                        </div>
                                        <div class="cursor-pointer">
                                            <svg (click)="showNotesModal(set.notes)" *ngIf="set.notes"
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-8 w-8 text-gray-500 dark:text-white" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                                            </svg>
                                            <span class="text-gray-500 dark:text-white" *ngIf="!set.notes">-</span>
                                        </div>
                                        <div *ngIf="!last" class="col-span-full h-px bg-gray-200 dark:bg-gray-700">
                                        </div>

                                    </ng-container>

                                </div>
                                <!-- EXPANDED Only VIEW MODE - END -->

                                <!-- EXPANDED Only EDIT MODE - START -->
                                <div *ngIf="!isCompactView && isEditableMode()" class="space-y-1">
                                    <div class="flex justify-between items-center py-1">
                                        <h4 class="text-m font-semibold text-gray-700 dark:text-gray-300">Sets:</h4>
                                        <button *ngIf="!isViewMode" type="button"
                                            (click)="addSet(exerciseControl, exIndex); $event.stopPropagation()"
                                            class="text-xs bg-blue-200 text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 font-medium py-0.5 px-1.5 rounded-md hover:enabled:bg-blue-100 dark:hover:bg-blue-900/50">
                                            + Add Set
                                        </button>
                                    </div>

                                    <div formArrayName="sets" class="space-y-1.5">
                                        <!-- Set Headers -->
                                        <div *ngIf="getSetsFormArray(exerciseControl).controls.length > 0 && (expandedSetPath()?.exerciseIndex !== exIndex)"
                                            class="grid grid-cols-12 gap-x-1 py-1 px-1.5 text-xs font-medium text-gray-500 dark:text-gray-400 border-b dark:border-gray-600">
                                            <div class="col-span-1 text-center">#</div>
                                            <div class="col-span-2 text-center truncate">Type</div>
                                            <div class="col-span-2 text-center">{{ mode === 'manualLogEntry' ? 'Reps
                                                Ach.' : 'Reps' }}</div>
                                            <div class="col-span-2 text-center truncate">{{ mode === 'manualLogEntry' ?
                                                'Wt Used' : 'Weight' }} ({{unitService.getUnitLabel()}})</div>
                                            <div class="col-span-1 text-center">{{ mode === 'manualLogEntry' ? 'Time
                                                Perf.' : 'Time' }}</div>
                                            <div class="col-span-2 text-center">{{ mode === 'routineBuilder' ? 'Rest' :
                                                'Notes'}}</div>
                                            <div class="col-span-1 text-center">{{ mode === 'routineBuilder' ? 'Tempo' :
                                                ''}}</div>
                                            <div class="col-span-1"></div> <!-- Action column -->
                                        </div>

                                        <!-- Loop through sets for collapsed or expanded display -->
                                        <div *ngFor="let setControl of getSetsFormArray(exerciseControl).controls; let setIndex = index"
                                            [formGroupName]="setIndex">
                                            <!-- Collapsed Set View -->
                                            <div *ngIf="!isSetExpanded(exIndex, setIndex)"
                                                (click)="toggleSetExpansion(exIndex, setIndex, $event)"
                                                class="grid grid-cols-12 gap-x-1 items-center py-1.5 px-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800/60 cursor-pointer border dark:border-gray-700 dark:text-white"
                                                [ngClass]="{
                                                        'bg-gray-50 dark:bg-gray-700/50 text-gray-800 dark:text-gray-200': !['warmup', 'dropset', 'failure', 'amrap', 'myorep', 'restpause'].includes(setControl.get('type')?.value ?? '') && !isViewMode,
                                                        'cursor-default': isViewMode
                                                    } ">
                                                <!-- ... content of collapsed set row (as before) ... -->
                                                <div class="col-span-1 text-s text-center font-medium">{{ setIndex + 1
                                                    }}</div>
                                                <div class="col-span-2 text-xs text-center truncate"
                                                    [title]="setControl.get('type')?.value | titlecase">{{
                                                    (setControl.get('type')?.value | titlecase) || 'Standard' }}</div>
                                                <div class="col-span-2 text-s text-center">{{ (setControl.get(mode ===
                                                    'manualLogEntry' ? 'repsAchieved' : 'reps')?.value) ?? '-' }}</div>
                                                <div class="col-span-2 text-s text-center">{{ (setControl.get(mode ===
                                                    'manualLogEntry' ? 'weightUsed' : 'weight')?.value) |
                                                    weightUnit:'1.0-2' }}</div>
                                                <div class="col-span-1 text-s text-center">{{ (setControl.get(mode ===
                                                    'manualLogEntry' ? 'durationPerformed' : 'duration')?.value) ?
                                                    ((setControl.get(mode === 'manualLogEntry' ? 'durationPerformed' :
                                                    'duration')?.value) + 's') : '-' }}</div>
                                                <div class="col-span-2 text-s text-center truncate"
                                                    [title]="mode === 'routineBuilder' ? (setControl.get('restAfterSet')?.value + 's') : setControl.get('notes')?.value">
                                                    <ng-container *ngIf="mode === 'routineBuilder'">{{
                                                        setControl.get('restAfterSet')?.value }}s</ng-container>
                                                    <ng-container *ngIf="mode === 'manualLogEntry'">{{
                                                        setControl.get('notes')?.value || '-' }}</ng-container>
                                                </div>
                                                <div class="col-span-1 text-s text-center truncate"
                                                    [title]="setControl.get('tempo')?.value">
                                                    <ng-container *ngIf="mode === 'routineBuilder'">{{
                                                        setControl.get('tempo')?.value || '-' }}</ng-container>
                                                </div>
                                                <div *ngIf="!isViewMode"
                                                    class="col-span-1 flex items-center justify-end">
                                                    <button type="button"
                                                        (click)="removeSet(exerciseControl, exIndex, setIndex); $event.stopPropagation()"
                                                        title="Remove Set"
                                                        class="flex items-center text-red-500 hover:text-red-600 dark:text-red-400 dark:hover:text-red-300 p-0.5 rounded-full hover:bg-red-100 dark:hover:bg-red-900/30 disabled:opacity-50">
                                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"
                                                            class="w-4 h-4">
                                                            <!-- Rounded square background in red -->
                                                            <rect width="16" height="16" rx="3" ry="3" fill="red" />
                                                            <!-- White "X" shape centered -->
                                                            <path fill="#ffffff" fill-rule="evenodd" clip-rule="evenodd"
                                                                d="M4.22 4.22a.75.75 0 0 1 1.06 0L8 7.94l2.72-2.72a.75.75 0 1 1 1.06 1.06L9.06 9l2.72 2.72a.75.75 0 1 1-1.06 1.06L8 10.06 5.28 12.78a.75.75 0 0 1-1.06-1.06L6.94 9 4.22 6.28a.75.75 0 0 1 0-1.06z" />
                                                        </svg>
                                                    </button>
                                                </div>
                                                <div *ngIf="isViewMode" class="col-span-1"></div>
                                            </div>

                                            <!-- Expanded Set Form -->
                                            <div #expandedSetElement *ngIf="isSetExpanded(exIndex, setIndex)"
                                                class="p-1 rounded-md shadow-inner space-y-2" [ngClass]="{
                                                        'bg-gray-100 dark:bg-gray-800/50': !['warmup', 'dropset', 'failure', 'amrap', 'myorep', 'restpause'].includes(setControl.get('type')?.value ?? '')
                                                    }">
                                                <!-- ... content of expanded set form (as before) ... -->
                                                <div class="grid grid-cols-2 sm:grid-cols-3 gap-x-3 gap-y-2 items-end">
                                                    <div class="col-span-full sm:col-span-1">
                                                        <label [for]="'setType-exp-' + exIndex + '-' + setIndex"
                                                            class="block text-s font-medium text-gray-600 dark:text-gray-400">Set
                                                            Type</label>
                                                        <select [id]="'setType-exp-' + exIndex + '-' + setIndex"
                                                            formControlName="type" [disabled]="isViewMode"
                                                            class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                            <option *ngFor="let typeOpt of availableSetTypes"
                                                                [value]="typeOpt.value">{{ typeOpt.label }}</option>
                                                        </select>
                                                    </div>
                                                    <!-- Other inputs for reps, weight, duration, tempo, rest, notes -->
                                                    <div>
                                                        <label [for]="'reps-exp-' + exIndex + '-' + setIndex"
                                                            class="block text-s font-medium text-gray-600 dark:text-gray-400">Reps
                                                            {{ mode === 'manualLogEntry' ? '(Achieved)' : ''}}</label>
                                                        <input type="number"
                                                            [id]="'reps-exp-' + exIndex + '-' + setIndex"
                                                            [formControlName]="mode === 'manualLogEntry' ? 'repsAchieved' : 'reps'"
                                                            placeholder="Reps" [readonly]="isViewMode"
                                                            class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                    </div>
                                                    <div>
                                                        <label [for]="'weight-exp-' + exIndex + '-' + setIndex"
                                                            class="block text-s font-medium text-gray-600 dark:text-gray-400">Weight
                                                            ({{ unitService.getUnitLabel() }}) {{ mode ===
                                                            'manualLogEntry' ? '(Used)' : ''}}</label>
                                                        <input type="number"
                                                            [id]="'weight-exp-' + exIndex + '-' + setIndex"
                                                            [formControlName]="mode === 'manualLogEntry' ? 'weightUsed' : 'weight'"
                                                            placeholder="Weight" [readonly]="isViewMode"
                                                            class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                    </div>
                                                    <div>
                                                        <label [for]="'duration-exp-' + exIndex + '-' + setIndex"
                                                            class="block text-s font-medium text-gray-600 dark:text-gray-400">Time
                                                            (s) {{ mode === 'manualLogEntry' ? '(Performed)' :
                                                            ''}}</label>
                                                        <input type="number"
                                                            [id]="'duration-exp-' + exIndex + '-' + setIndex"
                                                            [formControlName]="mode === 'manualLogEntry' ? 'durationPerformed' : 'duration'"
                                                            placeholder="Secs" [readonly]="isViewMode"
                                                            class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                    </div>
                                                    <div
                                                        *ngIf="mode === 'routineBuilder' && (setControl.get('tempo')?.value || isEditableMode())">
                                                        <label [for]="'tempo-exp-' + exIndex + '-' + setIndex"
                                                            class="block text-s font-medium text-gray-600 dark:text-gray-400">Tempo</label>
                                                        <input type="text"
                                                            [id]="'tempo-exp-' + exIndex + '-' + setIndex"
                                                            formControlName="tempo" placeholder="e.g. 2010"
                                                            [readonly]="isViewMode"
                                                            class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                    </div>
                                                    <div *ngIf="mode === 'routineBuilder'">
                                                        <label [for]="'rest-exp-' + exIndex + '-' + setIndex"
                                                            class="block text-s font-medium text-gray-600 dark:text-gray-400">Rest
                                                            (s)</label>
                                                        <input type="number"
                                                            [id]="'rest-exp-' + exIndex + '-' + setIndex"
                                                            formControlName="restAfterSet" placeholder="Rest"
                                                            [readonly]="isViewMode"
                                                            class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                    </div>
                                                    <div class="col-span-full"
                                                        *ngIf="(setControl.get('notes')?.value || isEditableMode())">
                                                        <label [for]="'setNotes-exp-' + exIndex + '-' + setIndex"
                                                            class="block text-s font-medium text-gray-600 dark:text-gray-400">Set
                                                            Notes</label>
                                                        <input type="text"
                                                            [id]="'setNotes-exp-' + exIndex + '-' + setIndex"
                                                            formControlName="notes" placeholder="e.g. Good form"
                                                            [readonly]="isViewMode"
                                                            class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                    </div>
                                                </div>
                                                <div class="mt-2 text-right">
                                                    <button type="button" (click)="collapseExpandedSet(false,$event)"
                                                        title="Collapse set"
                                                        class="bg-blue-200 text-xs text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 font-medium py-1 px-2 rounded-md">
                                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                                            width="24" height="24">
                                                            <path
                                                                d="M 12 5 L 12 10 M 9 7 L 12 10 L 15 7 M 12 19 L 12 14 M 9 17 L 12 14 L 15 17"
                                                                fill="none" stroke="currentColor" stroke-width="1.5"
                                                                stroke-linecap="round" stroke-linejoin="round" />
                                                        </svg></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- EXPANDED Only EDIT MODE - END -->
                            </div> <!-- End of *ngIf="!isCompactView" -->
                            <!--<button *ngIf="!isCompactView && expandedSetPath()?.exerciseIndex === exIndex" type="button"
                                (click)="collapseExpandedSet(true, $event)" title="Collapse exercise"
                                class="bg-blue-200 mt-1 p-1 text-blue-600 hover:text-gray-500 dark:text-gray-400 dark:hover:text-gray-200 flex-shrink-0  rounded-md">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                                    <path d="M 12 5 L 12 10 M 9 7 L 12 10 L 15 7 M 12 19 L 12 14 M 9 17 L 12 14 L 15 17"
                                        fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg>
                            </button> 
                                                -->
                        </div>
                    </div>
                </ng-container>
            </div>

            <div *ngIf="!isViewMode && exercisesFormArray.length === 0 && (mode === 'routineBuilder' && builderForm.get('goal')?.value !== 'rest')"
                class="text-center py-6 text-gray-500 dark:text-gray-400 border border-dashed dark:border-gray-700 rounded-md mt-4">
                <p class="mb-2">No exercises added yet.</p>
                <button type="button" (click)="openExerciseSelectionModal()"
                    class="bg-green-500 hover:bg-green-600 text-white text-m font-medium py-2 px-3 rounded-md">
                    + ADD FIRST EXERCISE
                </button>
            </div>
            <div *ngIf="mode === 'manualLogEntry' && exercisesFormArray.length === 0 && !builderForm.get('routineIdForLog')?.value"
                class="text-center py-6 text-gray-500 dark:text-gray-400 border border-dashed dark:border-gray-700 rounded-md mt-4">
                <p class="mb-2">Select a routine or ADD EXERCISEs manually to log.</p>
                <button type="button" (click)="openExerciseSelectionModal()"
                    class="bg-green-500 hover:bg-green-600 text-white text-m font-medium py-2 px-3 rounded-md">
                    + ADD FIRST EXERCISE TO LOG
                </button>
            </div>
            <div *ngIf="mode === 'manualLogEntry' && exercisesFormArray.length === 0 && builderForm.get('routineIdForLog')?.value"
                class="text-center py-4 text-gray-500 dark:text-gray-400">
                The selected routine has no exercises. Add them manually or edit the routine template.
            </div>


            <div *ngIf="!isViewMode && exercisesFormArray.length > 0" class="mt-6 text-center">
                <button type="button" (click)="openExerciseSelectionModal()"
                    class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-md shadow-md hover:shadow-lg transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                        class="w-5 h-5 mr-2 inline-block">
                        <path
                            d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" />
                    </svg>
                    ADD ANOTHER EXERCISE
                </button>
            </div>
        </section>

        <section *ngIf="mode === 'routineBuilder' && builderForm.get('goal')?.value === 'rest'"
            class="p-4 bg-blue-50 dark:bg-blue-900/30 rounded-md text-center">
            <p class="text-m text-blue-700 dark:text-blue-300">This is a rest day routine. No exercises are needed.</p>
        </section>

        <div *ngIf="!isViewMode" class="py-2 px-1 flex justify-end space-x-3">
            <button type="button" [routerLink]="mode === 'routineBuilder' ? '/workout' : '/history/list'"
                class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-m font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-500">
                CANCEL
            </button>
            <button type="submit"
                [disabled]="builderForm.invalid || (exercisesFormArray.length === 0 && !(mode === 'routineBuilder' && builderForm.get('goal')?.value === 'rest'))"
                class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-dark disabled:opacity-50">
                {{ mode === 'routineBuilder' ? (isNewMode ? 'CREATE ROUTINE' : 'SAVE CHANGES') : (isNewMode ? 'LOG
                WORKOUT' : 'SAVE LOG CHANGES') }}
            </button>
        </div>
    </form>

    <!-- Exercise Selection Modal -->
    <div *ngIf="isExerciseModalOpen"
        class="fixed inset-0 bg-gray-700 bg-opacity-75 transition-opacity overflow-y-auto h-full w-full z-[70] flex items-center justify-center p-4"
        (click)="closeExerciseSelectionModal()">
        <div class="relative transform overflow-hidden rounded-md bg-white dark:bg-gray-700 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg"
            (click)="$event.stopPropagation()">
            <div class="bg-white dark:bg-gray-700 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="flex justify-between items-center pb-3">
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">ADD EXERCISE</h3>
                    <button type="button" (click)="closeExerciseSelectionModal()"
                        class="p-1 rounded-full text-gray-400 hover:text-gray-600"><svg
                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                        </svg></button>
                </div>
                <div class="my-4">
                    <input type="text" placeholder="Search exercises..." [ngModel]="modalSearchTerm()"
                        (ngModelChange)="modalSearchTerm.set($event)"
                        class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-gray-200" />
                </div>
                <div class="mt-2 max-h-80 overflow-y-auto">
                    <ul class="space-y-1">
                        <li *ngFor="let ex of filteredAvailableExercises()"
                            (click)="mode === 'routineBuilder' ? selectExercise(ex) : selectExerciseForLog(ex)"
                            class="p-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md cursor-pointer flex justify-between items-center">
                            <div>
                                <span class="font-medium text-gray-800 dark:text-gray-200">{{ ex.name }}</span>
                                <span class="block text-xs text-gray-500 dark:text-gray-400">{{ ex.category | titlecase
                                    }} - {{ ex.primaryMuscleGroup | titlecase }}</span>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                class="w-5 h-5 text-primary dark:text-primary-light">
                                <path fill-rule="evenodd"
                                    d="M8.22 5.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L11.94 10 8.22 6.28a.75.75 0 0 1 0-1.06Z"
                                    clip-rule="evenodd" />
                            </svg>
                        </li>
                        <li *ngIf="filteredAvailableExercises().length === 0"
                            class="text-gray-500 dark:text-gray-400 text-center p-4">No exercises match your search or
                            library is empty.</li>
                    </ul>
                </div>

                <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-600 text-center">
                    <button type="button" (click)="handleTrulyCustomExerciseEntry()"
                        class="text-sm text-primary dark:text-primary-light hover:underline">
                        Or, create a new custom exercise entry...
                    </button>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                <button type="button" (click)="closeExerciseSelectionModal()"
                    class="mt-3 inline-flex w-full justify-center rounded-md bg-white dark:bg-gray-700 px-3 py-2 text-sm font-semibold text-gray-900 dark:text-gray-200 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-500 hover:bg-gray-50 dark:hover:bg-gray-500 sm:mt-0 sm:w-auto">CANCEL</button>
            </div>
        </div>
    </div>
</div>

<!-- NOTES MODAL -->
<app-modal *ngIf="notesModalsData() as data" [isOpen]="!!data" (isOpenChange)="notesModalsData.set(null)"
    [modalTitle]="'Notes'">

    <div class="flex flex-col p-4 text-left text-gray-700 dark:text-gray-200">
        <textarea [disabled]="true" class="font-semibold pb-2 dark:border-gray-600 dark:bg-gray-800" name=""
            id="">{{data}}</textarea>
        <button (click)="notesModalsData.set(null)"
            class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary-light">
            CLOSE
        </button>
    </div>

</app-modal>

<app-modal *ngIf="exerciseDetailsId" [(isOpen)]="isSimpleModalOpen" [modalTitle]="exerciseDetailsName">
    <app-exercise-detail [id]="exerciseDetailsId" [isModal]="true"></app-exercise-detail>
</app-modal>
<div *ngIf="errorMessage()"
    class="my-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-md dark:bg-red-900/30 dark:border-red-600 dark:text-red-300">
    {{ errorMessage() }}
</div>

<div class="container mx-auto p-1 sm:p-4">
    <header class="mb-6 pb-4 border-b border-gray-200 dark:border-gray-700">
        <div class="flex justify-between items-center">
            <button [routerLink]="mode === 'routineBuilder' ? '/workout' : '/history/list'"
                class="text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light p-2 -ml-1"><svg
                    fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
                    class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg></button>
            <h1
                class="text-xl sm:text-2xl md:text-2xl font-bold text-gray-800 dark:text-gray-200 text-center flex-grow truncate px-2">
                {{ mode === 'routineBuilder' ?
                (isNewMode ? 'New Routine' : (isViewMode ? (builderForm.get('name')?.value || 'View Routine') : ('Edit:
                ' + (builderForm.get('name')?.value || 'Routine')))) :
                (isNewMode ? 'Log Past Workout' : ('Edit Log: ' + (builderForm.get('name')?.value || 'Workout')))
                }}
            </h1>
            <div class="w-10 h-10"></div> <!-- Spacer -->
        </div>

        <div *ngIf="mode === 'routineBuilder' && !isNewMode && currentRoutineId"
            class="mt-4 flex flex-wrap gap-2 justify-center sm:justify-start">
            <button type="button" (click)="startCurrentWorkout()"
                class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-3 rounded-md shadow-sm text-xs sm:text-m flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="size-4 sm:size-5 mr-1">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z" />
                </svg>
                Start
            </button>
            <button *ngIf="isViewMode" type="button" (click)="enableEditMode()"
                class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-3 rounded-md shadow-sm text-xs sm:text-m flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="size-4 sm:size-5 mr-1">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                </svg>
                Edit
            </button>
            <button type="button" (click)="deleteCurrentRoutine()"
                class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-3 rounded-md shadow-sm text-xs sm:text-m flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="size-4 sm:size-5 mr-1">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                </svg>
                Delete
            </button>
        </div>
    </header>

    <form [formGroup]="builderForm" (ngSubmit)="onSubmit()" class="space-y-6 mb-6">
        <section class="space-y-4 p-4 bg-white dark:bg-gray-800 rounded-lg shadow-sm">
            <!-- ROUTINE BUILDER FIELDS -->
            <ng-container *ngIf="mode === 'routineBuilder'">
                <div>
                    <label for="routineName" class="block text-m font-medium text-gray-700 dark:text-gray-300">Routine
                        Name</label>
                    <input type="text" id="routineName" formControlName="name"
                        class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200"
                        [ngClass]="{'border-red-500 dark:border-red-400': builderForm.get('name')?.invalid && builderForm.get('name')?.touched, 'border-gray-300 dark:border-gray-500': !(builderForm.get('name')?.invalid && builderForm.get('name')?.touched) }">
                    <div *ngIf="builderForm.get('name')?.invalid && (builderForm.get('name')?.dirty || builderForm.get('name')?.touched)"
                        class="text-red-500 dark:text-red-400 text-xs mt-1">
                        <span *ngIf="builderForm.get('name')?.errors?.['required']">Routine name is required.</span>
                    </div>
                </div>
                <div>
                    <label for="description"
                        class="block text-m font-medium text-gray-700 dark:text-gray-300">Description (Optional)</label>
                    <textarea id="description" formControlName="description" rows="3"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200"></textarea>
                </div>
                <div>
                    <label for="goal" class="block text-m font-medium text-gray-700 dark:text-gray-300">Primary
                        Goal</label>
                    <select id="goal" formControlName="goal"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200">
                        <option *ngFor="let goalOpt of routineGoals" [value]="goalOpt.value">{{ goalOpt.label }}
                        </option>
                    </select>
                </div>
            </ng-container>

            <!-- MANUAL LOG ENTRY FIELDS -->
            <ng-container *ngIf="mode === 'manualLogEntry'">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="workoutDate"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300">Workout Date</label>
                        <input type="date" id="workoutDate" formControlName="workoutDate"
                            class="mt-1 block w-full p-2 border rounded-md shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200"
                            [ngClass]="{'border-red-500 dark:border-red-400': builderForm.get('workoutDate')?.invalid && builderForm.get('workoutDate')?.touched, 'border-gray-300 dark:border-gray-500': !(builderForm.get('workoutDate')?.invalid && builderForm.get('workoutDate')?.touched) }">
                        <div *ngIf="builderForm.get('workoutDate')?.invalid && (builderForm.get('workoutDate')?.dirty || builderForm.get('workoutDate')?.touched)"
                            class="text-red-500 dark:text-red-400 text-xs mt-1">
                            <span *ngIf="builderForm.get('workoutDate')?.errors?.['required']">Date is required.</span>
                        </div>
                    </div>
                    <div>
                        <label for="startTime" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Start
                            Time</label>
                        <input type="time" id="startTime" formControlName="startTime"
                            class="mt-1 block w-full p-2 border rounded-md shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200"
                            [ngClass]="{'border-red-500 dark:border-red-400': builderForm.get('startTime')?.invalid && builderForm.get('startTime')?.touched, 'border-gray-300 dark:border-gray-500': !(builderForm.get('startTime')?.invalid && builderForm.get('startTime')?.touched) }">
                        <div *ngIf="builderForm.get('startTime')?.invalid && (builderForm.get('startTime')?.dirty || builderForm.get('startTime')?.touched)"
                            class="text-red-500 dark:text-red-400 text-xs mt-1">
                            <span *ngIf="builderForm.get('startTime')?.errors?.['required']">Start time is
                                required.</span>
                        </div>
                    </div>
                    <div>
                        <label for="durationMinutes"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300">Duration (min)</label>
                        <input type="number" id="durationMinutes" formControlName="durationMinutes"
                            class="mt-1 block w-full p-2 border rounded-md shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200"
                            [ngClass]="{'border-red-500 dark:border-red-400': builderForm.get('durationMinutes')?.invalid && builderForm.get('durationMinutes')?.touched, 'border-gray-300 dark:border-gray-500': !(builderForm.get('durationMinutes')?.invalid && builderForm.get('durationMinutes')?.touched) }">
                        <div *ngIf="builderForm.get('durationMinutes')?.invalid && (builderForm.get('durationMinutes')?.dirty || builderForm.get('durationMinutes')?.touched)"
                            class="text-red-500 dark:text-red-400 text-xs mt-1">
                            <span *ngIf="builderForm.get('durationMinutes')?.errors?.['min']">Min duration is 1.</span>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="logWorkoutName"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">Workout Title
                        (Optional)</label>
                    <input type="text" id="logWorkoutName" formControlName="name"
                        placeholder="e.g., Morning Chest Session"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200">
                </div>
                <div>
                    <label for="routineIdForLog"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">Based on Routine
                        (Optional)</label>
                    <select id="routineIdForLog" formControlName="routineIdForLog"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200">
                        <option value="">-- Log Ad-hoc Exercises --</option>
                        <option *ngFor="let r of availableRoutines" [value]="r.id">{{ r.name }}</option>
                    </select>
                </div>
                <div>
                    <label for="overallNotesLog"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">Overall Notes
                        (Optional)</label>
                    <textarea id="overallNotesLog" formControlName="overallNotesLog" rows="2"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200"></textarea>
                </div>
            </ng-container>
        </section>

        <section class="pt-4" *ngIf="mode === 'manualLogEntry' || builderForm.get('goal')?.value !== 'rest'">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-300">{{ mode === 'routineBuilder' ?
                    'Exercises' : 'Logged Exercises' }}</h2>
                <button *ngIf="!isViewMode && (!exercisesFormArray.controls || exercisesFormArray.controls.length > 0)"
                    type="button" (click)="openExerciseSelectionModal()"
                    class="bg-green-500 hover:enabled:bg-green-600 text-white text-m font-medium py-2 px-3 rounded-md transition-all duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                    + Add Exercise
                </button>
            </div>

            <div *ngIf="exercisesFormArray.length>0" cdkDropList [cdkDropListData]="exercisesFormArray.controls"
                (cdkDropListDropped)="onExerciseDrop($event)"
                [cdkDropListDisabled]="mode !== 'routineBuilder' || isViewMode" formArrayName="exercises"
                class="exercise-list-container space-y-4">
                <ng-container *ngFor="let exerciseControl of exercisesFormArray.controls; let exIndex = index;">
                    <div class="relative group exercise-card-wrapper" (click)="toggleSetExpansion(exIndex,0, $event)" [ngClass]="{
                                        'superset-spacing': isSupersetSpacing(exIndex)
                                        }">
                        <div *ngIf="mode === 'routineBuilder' && isEditMode && selectedExerciseIndicesForSuperset().length >= 2 && exIndex === firstSelectedExerciseIndexForSuperset"
                            class="absolute left-1/2 -translate-x-1/2 z-20" style="top: -1.25rem;">
                            <button type="button" (click)="groupSelectedAsSuperset()"
                                [disabled]="!canGroupSelectedExercises() || isViewMode"
                                class="bg-orange-600 hover:bg-orange-700 text-white text-xs font-semibold py-1.5 px-3 rounded-full shadow-lg">
                                Group Superset ({{ selectedExerciseIndicesForSuperset().length }})
                            </button>
                        </div>

                        <div cdkDrag [cdkDragDisabled]="mode !== 'routineBuilder' || isViewMode || !isEditMode"
                            [cdkDragData]="exerciseControl" [formGroupName]="exIndex"
                            class="exercise-item relative transition-all"
                            [ngClass]="getExerciseCardClasses(exerciseControl, exIndex)">
                            <!-- COMPACT VIEW / HEADER AREA -->
                            <div class="flex items-center space-x-2">
                                <!-- DRAG HANDLE -->
                                <div *ngIf="mode === 'routineBuilder' && isEditMode && !isViewMode" cdkDragHandle
                                    class="cdk-drag-handle cursor-grab p-1 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 flex-shrink-0 top-1 right-1 sm:static"
                                    [ngClass]="{
                                        'absolute top-1 right-1 sm:static': isCompactView,
                                        'absolute top-2 right-2': !isCompactView && (mode !== 'routineBuilder' || !isEditMode || isViewMode)
                                    }" title="Drag to reorder">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-5 h-5">
                                        <path d="M 7 17 L 7 3 M 4 6 L 7 3 L 10 6 M 17 7 L 17 21 M 14 18 L 17 21 L 20 18"
                                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" />
                                    </svg>
                                </div>
                                <!-- CHECKBOX (if applicable) -->
                                <input *ngIf="mode === 'routineBuilder' && isEditMode && !isViewMode" type="checkbox"
                                    title="Select the exercise for the Superset"
                                    [id]="'superset-select-' + exIndex"
                                    (change)="toggleExerciseSelectionForSuperset(exIndex, $event)"
                                    [checked]="selectedExerciseIndicesForSuperset().includes(exIndex)"
                                    class="h-4 w-4 text-orange-600 border-gray-300 dark:border-gray-600 rounded focus:ring-orange-500 flex-shrink-0 disabled:opacity-50"
                                    [disabled]="isViewMode">
                                <!-- EXERCISE NAME & SUPERSET INFO / SETS SUMMARY FOR COMPACT -->
                                <div *ngIf="isCompactView || (!isCompactView && expandedSetPath()?.exerciseIndex !== exIndex)" class="flex-grow min-w-0">
                                    <h3 class="font-semibold text-gray-800 dark:text-gray-100 truncate" [ngClass]="{
                                            'text-sm': isCompactView && expandedSetPath()?.exerciseIndex !== exIndex,
                                            'text-lg': !isCompactView && expandedSetPath()?.exerciseIndex === exIndex
                                        }">
                                        <span
                                            *ngIf="mode === 'routineBuilder' && exerciseControl.get('supersetId')?.value"
                                            class="text-xs text-orange-600 dark:text-orange-400 font-normal block"
                                            [ngClass]="{
                                                'sm:inline sm:mr-1': !isCompactView && expandedSetPath()?.exerciseIndex === exIndex,
                                                'block text-xs leading-tight': isCompactView && expandedSetPath()?.exerciseIndex !== exIndex 
                                            }">
                                            Superset ({{ (exerciseControl.get('supersetOrder')?.value ?? 0) + 1 }} of {{
                                            exerciseControl.get('supersetSize')?.value }})
                                        </span>
                                        {{ exerciseControl.get('exerciseName')?.value || 'Select Exercise' }}
                                    </h3>
                                    <!-- COMPACT: Show SETS SUMMARY if in compact view -->
                                    <div *ngIf="(isCompactView  || (!isCompactView && expandedSetPath()?.exerciseIndex !== exIndex)) && getSetsFormArray(exerciseControl).controls.length > 0"
                                        class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                                        {{ getSetsFormArray(exerciseControl).controls.length }}
                                        {{ getSetsFormArray(exerciseControl).controls.length === 1 ? 'set' : 'sets' }}
                                    </div>
                                </div>
                                <!-- COMPACT: Minimal actions for compact view (e.g., small remove icon) -->
                                <div *ngIf="(isCompactView  || (!isCompactView && expandedSetPath()?.exerciseIndex !== exIndex)) && !isViewMode" class="flex-shrink-0 ml-auto">
                                    <!-- ml-auto to push to the right -->
                                    <button type="button" (click)="removeExercise(exIndex); $event.stopPropagation()"
                                        title="Remove Exercise"
                                        class="p-1 text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 rounded-full hover:bg-red-100 dark:hover:bg-red-900/30 disabled:opacity-50">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke-width="2" stroke="currentColor" class="w-4 h-4">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <!-- EXPANDED CONTENT AREA -->
                            <div *ngIf="expandedSetPath()?.exerciseIndex === exIndex" class="space-y-3">
                                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center pb-2 pt-1 sm:pt-0"
                                    [ngClass]="{
                                    'border-b border-orange-300 dark:border-orange-600': mode==='routineBuilder' &&
                                    exerciseControl.get('supersetId')?.value &&
                                    (exerciseControl.get('supersetOrder')?.value ?? -1) <
                                        ((exerciseControl.get('supersetSize')?.value ?? 0)
                                        -1), 'border-b border-gray-200 dark:border-gray-600' : !(mode==='routineBuilder'
                                        && exerciseControl.get('supersetId')?.value) || (mode==='routineBuilder' &&
                                        (exerciseControl.get('supersetOrder')?.value ??
                                        -1)===((exerciseControl.get('supersetSize')?.value ?? 0) -1)) }">
                                    <div class="flex-grow">
                                        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100">
                                            <span
                                                *ngIf="mode === 'routineBuilder' && exerciseControl.get('supersetId')?.value"
                                                class="text-xs text-orange-600 dark:text-orange-400 font-normal block">
                                                Superset ({{ (exerciseControl.get('supersetOrder')?.value ?? 0) + 1 }}
                                                of {{ exerciseControl.get('supersetSize')?.value }})
                                            </span>
                                            {{ exerciseControl.get('exerciseName')?.value || 'Select Exercise' }}
                                        </h3>
                                    </div>

                                    <div
                                        class="flex flex-col items-start sm:items-end space-y-1 flex-shrink-0 w-full sm:w-auto mt-2 sm:mt-0">
                                        <div *ngIf="mode === 'routineBuilder' && exerciseControl.get('supersetId')?.value"
                                            class="flex items-center space-x-1">
                                            <label [for]="'rounds-' + exIndex"
                                                class="text-xs font-medium text-gray-600 dark:text-gray-400 whitespace-nowrap">Rounds:</label>
                                            <input type="number" [id]="'rounds-' + exIndex" formControlName="rounds"
                                                min="1"
                                                class="w-16 p-1 text-m border-gray-300 dark:border-gray-500 border-2 rounded-md focus:ring-primary focus:border-primary dark:bg-gray-600 dark:text-gray-200 disabled:opacity-50 disabled:bg-gray-300 dark:disabled:bg-gray-500"
                                                [readonly]="(exerciseControl.get('supersetId')?.value && (exerciseControl.get('supersetOrder')?.value ?? 0) > 0) || isViewMode"
                                                (change)="syncSupersetRounds(exerciseControl.get('supersetId')?.value, exerciseControl.get('rounds')?.value, exIndex)">
                                        </div>
                                        <button *ngIf="!isViewMode" type="button" (click)="removeExercise(exIndex)"
                                            class="flex items-center text-xs text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 font-medium py-1 px-2 rounded-md hover:enabled:bg-red-100 dark:enabled:hover:bg-red-900/50 disabled:opacity-50">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                                stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1">
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                    d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.56 0c.342.052.682.107 1.022.166m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                                            </svg>
                                            Remove
                                        </button>
                                        <button
                                            *ngIf="mode === 'routineBuilder' && isEditMode && exerciseControl.get('supersetId')?.value"
                                            type="button" (click)="ungroupSuperset(exIndex)" [disabled]="isViewMode"
                                            class="flex items-center text-xs text-violet-600 hover:text-violet-700 dark:text-violet-400 dark:hover:text-violet-300 font-medium py-1 px-2 rounded-md hover:bg-violet-100 dark:hover:bg-violet-900/50 disabled:opacity-50">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                                stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1">
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                    d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75v4.5m0-4.5h-4.5m4.5 0L15 9m5.25 11.25v-4.5m0 4.5h-4.5m4.5 0L15 15" />
                                            </svg>
                                            Ungroup
                                        </button>
                                    </div>
                                </div>

                                <!-- Exercise Notes -->
                                <div>
                                    <label [for]="'exerciseNotes-' + exIndex"
                                        class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-0.5">
                                        {{ mode === 'routineBuilder' ? 'Exercise Notes (Optional)' : 'Notes for this
                                        Logged Exercise (Optional)'}}
                                    </label>
                                    <textarea [id]="'exerciseNotes-' + exIndex" formControlName="notes" rows="1"
                                        class="mt-0.5 block w-full p-1.5 text-sm border-gray-300 dark:border-gray-500 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200"
                                        [readonly]="isViewMode"></textarea>
                                </div>

                                <!-- Sets Section (Headers, Collapsed Sets, Expanded Set Form) -->
                                <div *ngIf="!isCompactView" class="space-y-1">
                                    <div class="flex justify-between items-center mb-1">
                                        <h4 class="text-m font-semibold text-gray-700 dark:text-gray-300">Sets:</h4>
                                        <button *ngIf="!isViewMode" type="button"
                                            (click)="addSet(exerciseControl, exIndex); $event.stopPropagation()"
                                            class="text-xs text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 font-medium py-0.5 px-1.5 rounded-md hover:enabled:bg-blue-100 dark:hover:bg-blue-900/50">
                                            + Add Set
                                        </button>
                                    </div>

                                    <div formArrayName="sets" class="space-y-1.5">
                                        <!-- Set Headers -->
                                        <div *ngIf="getSetsFormArray(exerciseControl).controls.length > 0 && (expandedSetPath()?.exerciseIndex !== exIndex)"
                                            class="grid grid-cols-12 gap-x-1 py-1 px-1.5 text-xs font-medium text-gray-500 dark:text-gray-400 border-b dark:border-gray-600">
                                            <div class="col-span-1 text-center">#</div>
                                            <div class="col-span-2 text-center truncate">Type</div>
                                            <div class="col-span-2 text-center">{{ mode === 'manualLogEntry' ? 'Reps
                                                Ach.' : 'Reps' }}</div>
                                            <div class="col-span-2 text-center truncate">{{ mode === 'manualLogEntry' ?
                                                'Wt Used' : 'Weight' }} ({{unitsService.getUnitLabel()}})</div>
                                            <div class="col-span-1 text-center">{{ mode === 'manualLogEntry' ? 'Time
                                                Perf.' : 'Time' }}</div>
                                            <div class="col-span-2 text-center">{{ mode === 'routineBuilder' ? 'Rest' :
                                                'Notes'}}</div>
                                            <div class="col-span-1 text-center">{{ mode === 'routineBuilder' ? 'Tempo' :
                                                ''}}</div>
                                            <div class="col-span-1"></div> <!-- Action column -->
                                        </div>

                                        <!-- Loop through sets for collapsed or expanded display -->
                                        <div *ngFor="let setControl of getSetsFormArray(exerciseControl).controls; let setIndex = index"
                                            [formGroupName]="setIndex">
                                            <!-- Collapsed Set View -->
                                            <div *ngIf="!isSetExpanded(exIndex, setIndex)"
                                                (click)="toggleSetExpansion(exIndex, setIndex, $event)"
                                                class="grid grid-cols-12 gap-x-1 items-center py-1.5 px-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800/60 cursor-pointer border dark:border-gray-700 dark:text-white"
                                                [ngClass]="{
                                                        'bg-gray-50 dark:bg-gray-700/50 text-gray-800 dark:text-gray-200': !['warmup', 'dropset', 'failure', 'amrap', 'myorep', 'restpause'].includes(setControl.get('type')?.value ?? '') && !isViewMode,
                                                        'cursor-default': isViewMode
                                                    } ">
                                                <!-- ... content of collapsed set row (as before) ... -->
                                                <div class="col-span-1 text-xs text-center font-medium">{{ setIndex + 1
                                                    }}</div>
                                                <div class="col-span-2 text-xs text-center truncate"
                                                    [title]="setControl.get('type')?.value | titlecase">{{
                                                    (setControl.get('type')?.value | titlecase) || 'Standard' }}</div>
                                                <div class="col-span-2 text-xs text-center">{{ (setControl.get(mode ===
                                                    'manualLogEntry' ? 'repsAchieved' : 'reps')?.value) ?? '-' }}</div>
                                                <div class="col-span-2 text-xs text-center">{{ (setControl.get(mode ===
                                                    'manualLogEntry' ? 'weightUsed' : 'weight')?.value) |
                                                    weightUnit:'1.0-2' }}</div>
                                                <div class="col-span-1 text-xs text-center">{{ (setControl.get(mode ===
                                                    'manualLogEntry' ? 'durationPerformed' : 'duration')?.value) ?
                                                    ((setControl.get(mode === 'manualLogEntry' ? 'durationPerformed' :
                                                    'duration')?.value) + 's') : '-' }}</div>
                                                <div class="col-span-2 text-xs text-center truncate"
                                                    [title]="mode === 'routineBuilder' ? (setControl.get('restAfterSet')?.value + 's') : setControl.get('notes')?.value">
                                                    <ng-container *ngIf="mode === 'routineBuilder'">{{
                                                        setControl.get('restAfterSet')?.value }}s</ng-container>
                                                    <ng-container *ngIf="mode === 'manualLogEntry'">{{
                                                        setControl.get('notes')?.value || '-' }}</ng-container>
                                                </div>
                                                <div class="col-span-1 text-xs text-center truncate"
                                                    [title]="setControl.get('tempo')?.value">
                                                    <ng-container *ngIf="mode === 'routineBuilder'">{{
                                                        setControl.get('tempo')?.value || '-' }}</ng-container>
                                                </div>
                                                <div *ngIf="!isViewMode"
                                                    class="col-span-1 flex items-center justify-end">
                                                    <button type="button"
                                                        (click)="removeSet(exerciseControl, exIndex, setIndex); $event.stopPropagation()"
                                                        title="Remove Set"
                                                        class="text-red-500 hover:text-red-600 dark:text-red-400 dark:hover:text-red-300 p-0.5 rounded-full hover:bg-red-100 dark:hover:bg-red-900/30 disabled:opacity-50"><svg
                                                            xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"
                                                            fill="currentColor" class="w-3.5 h-3.5">
                                                            <path fill-rule="evenodd"
                                                                d="M5 3.25A2.25 2.25 0 0 0 2.75 5.5v5A2.25 2.25 0 0 0 5 12.75h6a2.25 2.25 0 0 0 2.25-2.25v-5A2.25 2.25 0 0 0 11 3.25H5Zm.97 3.97a.75.75 0 0 1 1.06 0L8 8.28l.97-.97a.75.75 0 1 1 1.06 1.06L9.06 9.25l.97.97a.75.75 0 1 1-1.06 1.06L8 10.43l-.97.97a.75.75 0 0 1-1.06-1.06L6.94 9.25l-.97-.97a.75.75 0 0 1 0-1.06Z"
                                                                clip-rule="evenodd" />
                                                        </svg></button>
                                                </div>
                                                <div *ngIf="isViewMode" class="col-span-1"></div>
                                            </div>

                                            <!-- Expanded Set Form -->
                                            <div #expandedSetElement *ngIf="isSetExpanded(exIndex, setIndex)"
                                                class="mt-1 p-3 rounded-md border border-gray-300 dark:border-gray-500 shadow-inner space-y-2"
                                                [ngClass]="{
                                                        'bg-gray-100 dark:bg-gray-800/50': !['warmup', 'dropset', 'failure', 'amrap', 'myorep', 'restpause'].includes(setControl.get('type')?.value ?? '')
                                                    }">
                                                <!-- ... content of expanded set form (as before) ... -->
                                                <div class="grid grid-cols-2 sm:grid-cols-3 gap-x-3 gap-y-2 items-end">
                                                    <div class="col-span-full sm:col-span-1">
                                                        <label [for]="'setType-exp-' + exIndex + '-' + setIndex"
                                                            class="block text-xs font-medium text-gray-600 dark:text-gray-400">Set
                                                            Type</label>
                                                        <select [id]="'setType-exp-' + exIndex + '-' + setIndex"
                                                            formControlName="type" [disabled]="isViewMode"
                                                            class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                            <option *ngFor="let typeOpt of availableSetTypes"
                                                                [value]="typeOpt.value">{{ typeOpt.label }}</option>
                                                        </select>
                                                    </div>
                                                    <!-- Other inputs for reps, weight, duration, tempo, rest, notes -->
                                                    <div>
                                                        <label [for]="'reps-exp-' + exIndex + '-' + setIndex"
                                                            class="block text-xs font-medium text-gray-600 dark:text-gray-400">Reps
                                                            {{ mode === 'manualLogEntry' ? '(Achieved)' : ''}}</label>
                                                        <input type="number"
                                                            [id]="'reps-exp-' + exIndex + '-' + setIndex"
                                                            [formControlName]="mode === 'manualLogEntry' ? 'repsAchieved' : 'reps'"
                                                            placeholder="Reps" [readonly]="isViewMode"
                                                            class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                    </div>
                                                    <div>
                                                        <label [for]="'weight-exp-' + exIndex + '-' + setIndex"
                                                            class="block text-xs font-medium text-gray-600 dark:text-gray-400">Weight
                                                            ({{ unitsService.getUnitLabel() }}) {{ mode ===
                                                            'manualLogEntry' ? '(Used)' : ''}}</label>
                                                        <input type="number"
                                                            [id]="'weight-exp-' + exIndex + '-' + setIndex"
                                                            [formControlName]="mode === 'manualLogEntry' ? 'weightUsed' : 'weight'"
                                                            placeholder="Weight" [readonly]="isViewMode"
                                                            class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                    </div>
                                                    <div>
                                                        <label [for]="'duration-exp-' + exIndex + '-' + setIndex"
                                                            class="block text-xs font-medium text-gray-600 dark:text-gray-400">Time
                                                            (s) {{ mode === 'manualLogEntry' ? '(Performed)' :
                                                            ''}}</label>
                                                        <input type="number"
                                                            [id]="'duration-exp-' + exIndex + '-' + setIndex"
                                                            [formControlName]="mode === 'manualLogEntry' ? 'durationPerformed' : 'duration'"
                                                            placeholder="Secs" [readonly]="isViewMode"
                                                            class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                    </div>
                                                    <div *ngIf="mode === 'routineBuilder'">
                                                        <label [for]="'tempo-exp-' + exIndex + '-' + setIndex"
                                                            class="block text-xs font-medium text-gray-600 dark:text-gray-400">Tempo</label>
                                                        <input type="text"
                                                            [id]="'tempo-exp-' + exIndex + '-' + setIndex"
                                                            formControlName="tempo" placeholder="e.g. 2010"
                                                            [readonly]="isViewMode"
                                                            class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                    </div>
                                                    <div *ngIf="mode === 'routineBuilder'">
                                                        <label [for]="'rest-exp-' + exIndex + '-' + setIndex"
                                                            class="block text-xs font-medium text-gray-600 dark:text-gray-400">Rest
                                                            (s)</label>
                                                        <input type="number"
                                                            [id]="'rest-exp-' + exIndex + '-' + setIndex"
                                                            formControlName="restAfterSet" placeholder="Rest"
                                                            [readonly]="isViewMode"
                                                            class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                    </div>
                                                    <div class="col-span-full">
                                                        <label [for]="'setNotes-exp-' + exIndex + '-' + setIndex"
                                                            class="block text-xs font-medium text-gray-600 dark:text-gray-400">Set
                                                            Notes</label>
                                                        <input type="text"
                                                            [id]="'setNotes-exp-' + exIndex + '-' + setIndex"
                                                            formControlName="notes" placeholder="e.g. Good form"
                                                            [readonly]="isViewMode"
                                                            class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                    </div>
                                                </div>
                                                <div class="mt-2 text-right">
                                                    <button type="button" (click)="collapseExpandedSet(false,$event)" title="Collapse set"
                                                        class="text-xs text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 font-medium py-1 px-2 rounded-md">Done</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div> <!-- End of *ngIf="!isCompactView" -->
                            <button *ngIf="!isCompactView && expandedSetPath()?.exerciseIndex === exIndex" type="button" (click)="collapseExpandedSet(true, $event)" title="Collapse exercise"
                                class=" p-1 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 flex-shrink-0 ">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                                    <path d="M 12 5 L 12 10 M 9 7 L 12 10 L 15 7 M 12 19 L 12 14 M 9 17 L 12 14 L 15 17" fill="none"
                                        stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </button>
                            </div>
                    </div>
                </ng-container>
            </div>

            <div *ngIf="!isViewMode && exercisesFormArray.length === 0 && (mode === 'routineBuilder' && builderForm.get('goal')?.value !== 'rest')"
                class="text-center py-6 text-gray-500 dark:text-gray-400 border border-dashed dark:border-gray-700 rounded-md mt-4">
                <p class="mb-2">No exercises added yet.</p>
                <button type="button" (click)="openExerciseSelectionModal()"
                    class="bg-green-500 hover:bg-green-600 text-white text-m font-medium py-2 px-3 rounded-md">
                    + Add First Exercise
                </button>
            </div>
            <div *ngIf="mode === 'manualLogEntry' && exercisesFormArray.length === 0 && !builderForm.get('routineIdForLog')?.value"
                class="text-center py-6 text-gray-500 dark:text-gray-400 border border-dashed dark:border-gray-700 rounded-md mt-4">
                <p class="mb-2">Select a routine or add exercises manually to log.</p>
                <button type="button" (click)="openExerciseSelectionModal()"
                    class="bg-green-500 hover:bg-green-600 text-white text-m font-medium py-2 px-3 rounded-md">
                    + Add First Exercise to Log
                </button>
            </div>
            <div *ngIf="mode === 'manualLogEntry' && exercisesFormArray.length === 0 && builderForm.get('routineIdForLog')?.value"
                class="text-center py-4 text-gray-500 dark:text-gray-400">
                The selected routine has no exercises. Add them manually or edit the routine template.
            </div>


            <div *ngIf="!isViewMode && exercisesFormArray.length > 0" class="mt-6 text-center">
                <button type="button" (click)="openExerciseSelectionModal()"
                    class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-md shadow-md hover:shadow-lg transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                        class="w-5 h-5 mr-2 inline-block">
                        <path
                            d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" />
                    </svg>
                    Add Another Exercise
                </button>
            </div>
        </section>

        <section *ngIf="mode === 'routineBuilder' && builderForm.get('goal')?.value === 'rest'"
            class="p-4 bg-blue-50 dark:bg-blue-900/30 rounded-lg text-center">
            <p class="text-m text-blue-700 dark:text-blue-300">This is a rest day routine. No exercises are needed.</p>
        </section>

        <div *ngIf="!isViewMode" class="pt-6 flex justify-end space-x-3">
            <button type="button" [routerLink]="mode === 'routineBuilder' ? '/workout' : '/history/list'"
                class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-m font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700">
                Cancel
            </button>
            <button type="submit"
                [disabled]="builderForm.invalid || (exercisesFormArray.length === 0 && !(mode === 'routineBuilder' && builderForm.get('goal')?.value === 'rest'))"
                class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-dark disabled:opacity-50">
                {{ mode === 'routineBuilder' ? (isNewMode ? 'CREATE ROUTINE' : 'SAVE CHANGES') : (isNewMode ? 'Log
                Workout' : 'Save Log Changes') }}
            </button>
        </div>
    </form>

    <!-- Exercise Selection Modal -->
    <div *ngIf="isExerciseModalOpen"
        class="fixed inset-0 bg-gray-700 bg-opacity-75 transition-opacity overflow-y-auto h-full w-full z-[70] flex items-center justify-center p-4"
        (click)="closeExerciseSelectionModal()">
        <div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-700 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg"
            (click)="$event.stopPropagation()">
            <div class="bg-white dark:bg-gray-700 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="flex justify-between items-center pb-3">
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Add Exercise</h3>
                    <button type="button" (click)="closeExerciseSelectionModal()"
                        class="p-1 rounded-full text-gray-400 hover:text-gray-600"><svg
                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                        </svg></button>
                </div>
                <div class="my-4">
                    <input type="text" placeholder="Search exercises..." [ngModel]="modalSearchTerm()"
                        (ngModelChange)="modalSearchTerm.set($event)"
                        class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-gray-200" />
                </div>
                <div class="mt-2 max-h-80 overflow-y-auto">
                    <ul class="space-y-1">
                        <li *ngFor="let ex of filteredAvailableExercises()"
                            (click)="mode === 'routineBuilder' ? selectExercise(ex) : selectExerciseForLog(ex)"
                            class="p-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md cursor-pointer flex justify-between items-center">
                            <div>
                                <span class="font-medium text-gray-800 dark:text-gray-200">{{ ex.name }}</span>
                                <span class="block text-xs text-gray-500 dark:text-gray-400">{{ ex.category | titlecase
                                    }} - {{ ex.primaryMuscleGroup | titlecase }}</span>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                class="w-5 h-5 text-primary dark:text-primary-light">
                                <path fill-rule="evenodd"
                                    d="M8.22 5.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L11.94 10 8.22 6.28a.75.75 0 0 1 0-1.06Z"
                                    clip-rule="evenodd" />
                            </svg>
                        </li>
                        <li *ngIf="filteredAvailableExercises().length === 0"
                            class="text-gray-500 dark:text-gray-400 text-center p-4">No exercises match your search or
                            library is empty.</li>
                    </ul>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                <button type="button" (click)="closeExerciseSelectionModal()"
                    class="mt-3 inline-flex w-full justify-center rounded-md bg-white dark:bg-gray-700 px-3 py-2 text-sm font-semibold text-gray-900 dark:text-gray-200 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-500 hover:bg-gray-50 dark:hover:bg-gray-500 sm:mt-0 sm:w-auto">Cancel</button>
            </div>
        </div>
    </div>
</div>
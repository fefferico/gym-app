<div *ngIf="errorMessage()"
    class="my-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-md dark:bg-red-900/30 dark:border-red-600 dark:text-red-300">
    {{ errorMessage() }}
</div>

<div class="container mx-auto">
    <header class="flex items-center justify-between p-2">
        <div class="flex justify-between items-center">
            <button [routerLink]="mode === 'routineBuilder' ? '/workout' : '/history/list'"
                class="text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                <app-icon name="back"></app-icon>
            </button>
            <div class="w-10 h-10"></div> <!-- Spacer -->
        </div>
        <!-- Action Buttons Group -->
        <div class="flex items-center space-x-2 flex-shrink-0">
            <!-- Wrapper for "More Actions" button and its dropdown -->
            <div *ngIf="routine() as routine" class="">
                <div *ngIf="routine.id && !isNewMode" class="relative">
                    <button (click)="toggleActions(routine.id, $event)"
                        class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-500 rounded-full focus:outline-none flex items-center">
                        <app-icon name="menu-action" class="h-10 w-10"></app-icon>
                    </button>
                    <app-action-menu *ngIf="areActionsVisible(routine.id)" displayMode="dropdown"
                        [items]="getRoutineDropdownActionItems(routine.id, 'dropdown')"
                        [isVisible]="areActionsVisible(routine.id)" (itemClick)="handleActionMenuItemClick($event)"
                        (closeMenu)="onCloseActionMenu()">
                    </app-action-menu>
                </div>
            </div>
        </div>

    </header>

    <form [formGroup]="builderForm" (ngSubmit)="onSubmit()"
        class="space-y-6 mb-6 p-1 rounded-md shadow-xl overflow-hidden min-h-screen">
        <section class="space-y-2 p-2 rounded-md shadow-sm dark:shadow-none text-gray-700 dark:text-gray-200">
            <!-- ROUTINE BUILDER FIELDS -->
            <ng-container *ngIf="mode === 'routineBuilder'">
                <!-- ROUTINE NAME -->
                <div *ngIf="isViewMode">
                    <label
                        class="block text-xl font-black text-gray-700 dark:text-gray-200">{{builderForm.get('name')?.value}}</label>
                </div>
                <div *ngIf="isEditableMode()" class="text-gray-700 dark:text-gray-200">
                    <label for="routineName" class="block text-m font-medium">Routine
                        Name</label>
                    <input type="text" id="routineName" formControlName="name" placeholder="Routine name"
                        class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 dark:border-gray-500"
                        [ngClass]="{'border-red-500 dark:border-red-400': builderForm.get('name')?.invalid && builderForm.get('name')?.touched, 'border-gray-300 dark:border-gray-500': !(builderForm.get('name')?.invalid && builderForm.get('name')?.touched) }">
                    <div *ngIf="builderForm.get('name')?.invalid && (builderForm.get('name')?.dirty || builderForm.get('name')?.touched)"
                        class="text-red-500 dark:text-red-400 text-xs mt-1">
                        <span *ngIf="builderForm.get('name')?.errors?.['required']">Routine name is required</span>
                    </div>
                </div>
                <!-- DESCRIPTION -->
                <div *ngIf="isViewMode">
                    <p class="mt-1 block w-full shadow-sm dark:shadow-none text-gray-700 dark:text-gray-200"
                        [innerHTML]="sanitizedDescription">
                    </p>
                </div>
                <div *ngIf="isEditableMode()">
                    <label for="description"
                        class="block text-m font-medium text-gray-700 dark:text-gray-300">Description (Optional)</label>
                    <textarea id="description" formControlName="description" rows="3"
                        placeholder="Description (optional)"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200"></textarea>
                </div>
                <!-- GOAL -->
                <div *ngIf="isViewMode">
                    <label class="block text-m text-gray-700 dark:text-gray-300">
                        <span class="font-medium">Goal: </span>
                        {{ builderForm.get('goal')?.value?.toUpperCase() || ''}}</label>
                </div>
                <div *ngIf="isEditableMode()" class="text-gray-700 dark:text-gray-200">
                    <label for="goal" class="block text-m font-medium text-gray-700 dark:text-gray-300">Primary
                        Goal</label>
                    <select id="goal" formControlName="goal"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200">
                        <option value="">-- Set routine goal --</option>
                        <option *ngFor="let goalOpt of routineGoals" [value]="goalOpt.value">{{ goalOpt.label }}
                        </option>
                    </select>
                </div>

                <!-- CATEGORY -->
                <!-- PRIMARY CATEGORY -->
                <div *ngIf="isViewMode && builderForm.get('primaryCategory')?.value">
                    <label class="block text-m text-gray-700 dark:text-gray-300">
                        <span class="font-medium">Category: </span>
                        {{ builderForm.get('primaryCategory')?.value }}
                    </label>
                </div>
                <div *ngIf="isEditableMode()">
                    <label for="primaryCategory" class="block text-m font-medium text-gray-700 dark:text-gray-200">
                        Primary Category
                    </label>
                    <select id="primaryCategory" formControlName="primaryCategory"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-md shadow-sm dark:bg-gray-600 text-gray-700 dark:text-gray-200">
                        <option value="">-- Select a category --</option>
                        <option *ngFor="let cat of primaryCategories" [value]="cat.value">{{ cat.label }}</option>
                    </select>
                </div>

                <!-- SECONDARY CATEGORY -->
                <div *ngIf="isViewMode && builderForm.get('secondaryCategory')?.value">
                    <label class="block text-m text-gray-700 dark:text-gray-300">
                        <span class="font-medium">Sub-Category: </span>
                        {{ builderForm.get('secondaryCategory')?.value }}
                    </label>
                </div>
                <div *ngIf="isEditableMode()">
                    <label for="secondaryCategory" class="block text-m font-medium text-gray-700 dark:text-gray-200">
                        Secondary Category (Optional)
                    </label>
                    <input type="text" id="secondaryCategory" formControlName="secondaryCategory"
                        placeholder="e.g., Bodyweight, Hypertrophy Phase 1"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-md shadow-sm text-gray-700 dark:bg-gray-600 dark:text-gray-200">
                </div>

                <!-- TAGS -->
                <div *ngIf="isViewMode && builderForm.get('tags')?.value" class="mt-2">
                    <div class="flex items-center gap-2 flex-wrap">
                        <label class="block text-m font-medium text-gray-700 dark:text-gray-200">Tags: </label>
                        <span *ngFor="let tag of builderForm.get('tags')?.value.split(',')"
                            class="bg-gray-200 text-gray-700 dark:bg-gray-600 text-gray-700 dark:text-gray-200 text-xs font-semibold px-2 py-1 rounded-full">
                            {{ tag.trim() }}
                        </span>
                    </div>
                </div>
                <div *ngIf="isEditableMode()">
                    <label for="tags" class="block text-m font-medium text-gray-700 dark:text-gray-200">
                        Tags (comma-separated)
                    </label>
                    <input type="text" id="tags" formControlName="tags" placeholder="e.g., HIIT, Dumbbells, Full Body"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-md shadow-sm dark:bg-gray-600 text-gray-700 dark:text-gray-200">
                </div>

                <ng-container *ngIf="lastLogForCurrentRoutine() as lastLog; else notPerformedYet">

                    <!-- Display "Last Performed" Date -->
                    <div class="text-m text-gray-500 dark:text-gray-300">
                        <span class="font-medium">Last:</span>
                        <!-- Use the millisecondsDate pipe we created -->
                        {{ lastLog.startTime | millisecondsDate }}
                    </div>

                    <!-- Display "Last Duration" -->
                    <div *ngIf="lastLog.duration" class="text-sm text-gray-500 dark:text-gray-300 flex gap-1">
                        <span class="font-medium">Last duration:</span> {{ lastLog.duration }} min
                    </div>
                </ng-container>

                <!-- This template is shown if the routine has never been performed -->
                <ng-template #notPerformedYet>
                    <div class="text-sm text-gray-500 dark:text-gray-300 italic flex gap-1 mb-2">
                        Not performed yet
                    </div>

                </ng-template>

                <!-- Estimated Duration (this part is unchanged) -->
                <div>
                    <div *ngIf="routine() && getRoutineDuration() > 0" class="text-m text-gray-500 dark:text-gray-300">
                        <span class="font-medium">Est. duration:</span> ~{{ getRoutineDuration() }} min
                    </div>
                </div>

            </ng-container>

            <!-- MANUAL LOG ENTRY FIELDS -->
            <ng-container *ngIf="mode === 'manualLogEntry'">
                <!-- HEADER FOR LOG -->
                <header *ngIf="checkIfLogForProgram()" class="flex items-center justify-between py-2">
                    <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-200">
                        <span *ngIf="isEditableMode">{{getLogTitleForProgramEntry()}}</span>
                    </h1>
                </header>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="workoutDate"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300">Workout Date</label>
                        <input type="date" id="workoutDate" formControlName="workoutDate"
                            class="mt-1 block w-full p-2 border rounded-md shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200"
                            [ngClass]="{'border-red-500 dark:border-red-400': builderForm.get('workoutDate')?.invalid && builderForm.get('workoutDate')?.touched, 'border-gray-300 dark:border-gray-500': !(builderForm.get('workoutDate')?.invalid && builderForm.get('workoutDate')?.touched) }">
                        <div *ngIf="builderForm.get('workoutDate')?.invalid && (builderForm.get('workoutDate')?.dirty || builderForm.get('workoutDate')?.touched)"
                            class="text-red-500 dark:text-red-400 text-xs mt-1">
                            <span *ngIf="builderForm.get('workoutDate')?.errors?.['required']">Date is required</span>
                        </div>
                    </div>
                    <div>
                        <label for="startTime" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Start
                            Time</label>
                        <input type="time" id="startTime" formControlName="startTime"
                            class="mt-1 block w-full p-2 border rounded-md shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200"
                            [ngClass]="{'border-red-500 dark:border-red-400': builderForm.get('startTime')?.invalid && builderForm.get('startTime')?.touched, 'border-gray-300 dark:border-gray-500': !(builderForm.get('startTime')?.invalid && builderForm.get('startTime')?.touched) }">
                        <div *ngIf="builderForm.get('startTime')?.invalid && (builderForm.get('startTime')?.dirty || builderForm.get('startTime')?.touched)"
                            class="text-red-500 dark:text-red-400 text-xs mt-1">
                            <span *ngIf="builderForm.get('startTime')?.errors?.['required']">Start time is
                                required</span>
                        </div>
                    </div>
                    <div>
                        <label for="endTime" class="block text-sm font-medium text-gray-700 dark:text-gray-300">End
                            Time</label>
                        <input type="time" id="endTime" formControlName="endTime"
                            class="mt-1 block w-full p-2 border rounded-md shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200"
                            [ngClass]="{'border-red-500 dark:border-red-400': builderForm.get('endTime')?.invalid && builderForm.get('endTime')?.touched, 'border-gray-300 dark:border-gray-500': !(builderForm.get('endTime')?.invalid && builderForm.get('endTime')?.touched) }"
                            (change)="handleEndTimeChange()">
                        <div *ngIf="builderForm.get('endTime')?.invalid && (builderForm.get('endTime')?.dirty || builderForm.get('endTime')?.touched)"
                            class="text-red-500 dark:text-red-400 text-xs mt-1">
                            <span *ngIf="builderForm.get('endTime')?.errors?.['required']">End time is
                                required</span>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="logWorkoutName"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">Workout Title
                        (Optional)</label>
                    <input type="text" id="logWorkoutName" formControlName="name"
                        placeholder="e.g., Morning Chest Session"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200">
                </div>
                <div>
                    <label for="routineIdForLog"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">Based on Routine
                        (Optional)</label>
                    <select id="routineIdForLog" formControlName="routineIdForLog"
                        [disabled]="builderForm.get('programIdForLog')?.value"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        <option value="">-- Log Ad-hoc Routine --</option>
                        <option *ngFor="let r of availableRoutines" [value]="r.id">{{ r.name }}</option>
                    </select>
                </div>
                <div>
                    <label for="programIdForLog"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">Based on Program
                        (Optional)</label>
                    <select id="programIdForLog" formControlName="programIdForLog"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200">
                        <option value="">-- Log Ad-hoc Program --</option>
                        <option *ngFor="let program of availablePrograms" [value]="program.id">{{ program.name }}
                        </option>
                    </select>
                </div>
                <!-- START: Updated Iteration and Scheduled Day ID fields -->
                <div *ngIf="initialProgramIdForLogEdit">
                    <label for="iterationIdForLog"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">Based on Program Iteration
                        ID</label>
                    <span *ngIf="isEditableMode" class="text-xs text-red-500 dark:text-primary-light">(Select an
                        iteration if logging for a
                        specific program cycle - EDIT IF YOU ONLY KNOW WHAT YOU ARE DOING)</span>
                    <select id="iterationIdForLog" formControlName="iterationIdForLog"
                        [disabled]="!builderForm.get('programIdForLog')?.value || availableIterationIds.length === 0"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        <option value="">-- Select Iteration (Optional) --</option>
                        <option *ngFor="let iterationId of availableIterationIds" [value]="iterationId">{{ iterationId
                            }}</option>
                    </select>
                </div>
                <div *ngIf="initialProgramIdForLogEdit">
                    <label for="scheduledDayIdForLog"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">Based on Program Scheduled ID
                    </label><span *ngIf="isEditableMode" class="text-xs text-red-500 dark:text-primary-light">(Select
                        the scheduled day you are
                        logging - EDIT IF YOU ONLY KNOW WHAT YOU ARE DOING)</span>
                    <select id="scheduledDayIdForLog" formControlName="scheduledDayIdForLog"
                        [disabled]="!builderForm.get('programIdForLog')?.value || availableScheduledDayIds.length === 0"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        <option value="">-- Select Scheduled Day (Optional) --</option>
                        <option *ngFor="let scheduledId of availableScheduledDayInfos" [value]="scheduledId.id">{{
                            scheduledId.weekNumber ? 'Week #' + scheduledId.weekNumber : '' }} - {{ scheduledId.dayName
                            ? 'Day ' + scheduledId.dayName : ''}}</option>
                    </select>
                </div>
                <!-- END: Updated fields -->
                <div>
                    <label for="overallNotesLog"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">Overall Notes
                        (Optional)</label>
                    <textarea id="overallNotesLog" formControlName="overallNotesLog" rows="2"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200"></textarea>
                </div>
            </ng-container>
        </section>

        <section *ngIf="mode === 'manualLogEntry' || builderForm.get('goal')?.value !== 'rest'">
            <div *ngIf="exercisesFormArray.length>0" cdkDropList [cdkDropListData]="exercisesFormArray.controls"
                (cdkDropListDropped)="onExerciseDrop($event)" [cdkDropListDisabled]="!isEditableMode()"
                formArrayName="exercises" class="exercise-list-container">
                <ng-container *ngFor="let exerciseControl of exercisesFormArray.controls; let exIndex = index;">
                    <div class="relative group exercise-card-wrapper"
                        [style.zIndex]="isExerciseActionMenuVisible(exIndex) ? 50 : 'auto'"
                        [ngClass]="getExerciseCardClass(exerciseControl, exIndex)">
                        <div *ngIf="(isEditableMode()) && selectedExerciseIndicesForSuperset().length >= 2 && exIndex === firstSelectedExerciseIndexForSuperset"
                            class="absolute left-1/2 -translate-x-1/2 z-20" style="top: -1rem;">
                            <button *ngIf="!canUngroupSelectedExercises()" type="button"
                                (click)="groupSelectedAsSuperset()" [disabled]="isViewMode"
                                class="bg-green-600 hover:bg-green-700 text-white text-xs font-semibold py-1.5 px-3 rounded-lg shadow-lg">
                                Group Superset ({{ selectedExerciseIndicesForSuperset().length }})
                            </button>
                            <button *ngIf="canUngroupSelectedExercises()" type="button"
                                (click)="ungroupSuperset(exIndex)" [disabled]="isViewMode"
                                class="bg-violet-600 hover:bg-violet-700 text-white text-xs font-semibold py-1.5 px-3 rounded-lg shadow-lg">
                                Ungroup Superset ({{ selectedExerciseIndicesForSuperset().length }})
                            </button>
                        </div>

                        <div cdkDrag [cdkDragDisabled]="!isEditableMode() || isSetExpanded(exIndex, 0)" appLongPressDrag
                            [longPressEnabled]="isEditableMode() && !isSetExpanded(exIndex, 0)" [longPressDelay]="150"
                            longPressClass="is-long-pressing" [cdkDragData]="exerciseControl" [formGroupName]="exIndex"
                            [cdkDragStartDelay]="110" class="transition-all"
                            (click)="toggleSetExpansion(exIndex,0, $event)" appClickOutside
                            (clickOutside)="collapseExpandedSet(false,$event)"
                            [title]="isEditableMode() ? 'Drag to reorder' : ''">

                            <div class="exercise-item-content">
                                <div *ngIf="!isSetExpanded(exIndex, 0) && exerciseControl.get('supersetId')?.value && getSetsFormArray(exerciseControl).controls.length > 0 
                                        && exerciseControl.get('supersetOrder')?.value === 0"
                                    class="px-2 text-md font-medium mt-0.5"
                                    [ngClass]="standarSuperSetOrEmomClass(exerciseControl, false)">
                                    {{ standarSuperSetOrEmomLabel(exerciseControl) }}
                                </div>
                                <!-- COMPACT VIEW / HEADER AREA -->
                                <div class="flex items-center space-x-1 pt-1">
                                    <!-- DRAG HANDLE ICON (Now just a visual cue) -->
                                    <div *ngIf="isEditableMode()"
                                        class="p-1 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 flex-shrink-0 flex item-center cursor-move rounded-md"
                                        title="Drag to reorder">
                                        <app-icon name="reorder"></app-icon>
                                    </div>

                                    <!-- CHECKBOX (if applicable) -->
                                    <input *ngIf="(isEditableMode() || isNewMode) && !isViewMode" type="checkbox"
                                        title="Select the exercise for the Superset" [id]="'superset-select-' + exIndex"
                                        (change)="toggleExerciseSelectionForSuperset(exIndex, $event)"
                                        [checked]="selectedExerciseIndicesForSuperset().includes(exIndex)"
                                        class="h-6 w-6 text-orange-600 border-gray-300 dark:border-gray-600 rounded-md focus:ring-orange-500 flex-shrink-0 disabled:opacity-50"
                                        [disabled]="isViewMode">
                                    <!-- EXERCISE NAME & SUPERSET INFO / SETS SUMMARY FOR COMPACT -->
                                    <div *ngIf="!shouldShowExpandedExercise(exIndex)"
                                        class="flex-grow min-w-0 py-2 px-0">
                                        <!-- COMPACT: Show SETS SUMMARY if in compact view -->
                                        <div *ngIf="!shouldShowExpandedExercise(exIndex) && getSetsFormArray(exerciseControl).controls.length > 0"
                                            class="flex items-center text-s text-gray-500 dark:text-gray-400 mt-0.5 gap-4 pl-2">
                                            <img [src]="getIconPath(exerciseControl.get('exerciseId')?.value) | async"
                                                alt="Exercise Icon" class="w-6 h-6 sm:w-8 sm:h-8 object-contain">
                                            <div class="min-w-0"> <!-- Added min-w-0 for truncation -->
                                                <div class="flex">
                                                    <h3 class="font-semibold text-gray-800 dark:text-gray-100 truncate text-lg"
                                                        [title]="exerciseControl.get('exerciseName')?.value">
                                                        {{ exerciseControl.get('exerciseName')?.value }}
                                                    </h3>
                                                    <app-icon name="info"
                                                        class="h-4 w-4 text-gray-400 dark:text-gray-300 cursor-help"
                                                        *ngIf="exerciseControl.get('exerciseId')?.value" width="20"
                                                        height="20" viewBox="0 0 20 20"
                                                        xmlns="http://www.w3.org/2000/svg"
                                                        (click)="openModal(exerciseControl.value, $event)"
                                                        [appTooltip]="exerciseInfoTooltipString"></app-icon>
                                                </div>
                                                <div class="text-md text-gray-500 dark:text-gray-400 truncate">
                                                    <p
                                                        *ngIf="exerciseControl?.get('sets')?.value?.length >= 1 && checkIfTimedExercise(exerciseControl) && getSetDurationDisplay(exerciseControl)">
                                                        Duration (s):
                                                        {{ getSetDurationDisplay(exerciseControl) }}
                                                    </p>
                                                    <!-- Show info about sets only if !isEmomExercise -->
                                                    <p
                                                        *ngIf="exerciseControl?.get('sets')?.value && exerciseControl?.get('sets')?.value.length >= 1">
                                                        {{ !isEmomExercise(exerciseControl) ? 'Sets: ' +
                                                        exerciseControl?.get('sets')?.value.length : '' }}
                                                        {{
                                                        !isExerciseCardioOnlyCtrl(exerciseControl) &&
                                                        getSetReps(exerciseControl)
                                                        ? '( Reps: ' + getSetReps(exerciseControl) + ' )'
                                                        : ''
                                                        }}
                                                    </p>
                                                    <p
                                                        *ngIf="exerciseControl?.get('sets')?.value && exerciseControl?.get('sets')?.value.length >= 1 && checkIfWeightedExercise(exerciseControl)">
                                                        Weight
                                                        ({{unitService.getWeightUnitSuffix()}}):
                                                        {{getSetWeightsUsed(exerciseControl)}}
                                                    </p>
                                                    <p
                                                        *ngIf="isExerciseCardioOnlyCtrl(exerciseControl) && getSetDistanceDisplay(exerciseControl)">
                                                        Distance ({{unitService.getDistanceMeasureUnitSuffix()}}):
                                                        {{getSetDistanceDisplay(exerciseControl)}}
                                                    </p>
                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                    <!-- COMPACT: Minimal actions for compact view (e.g., small remove icon) -->
                                    <div *ngIf="!shouldShowExpandedExercise(exIndex) && !isViewMode"
                                        class="flex ml-auto pr-2">
                                        <!-- ml-auto to push to the right -->
                                        <button type="button"
                                            (click)="removeExercise(exIndex); $event.stopPropagation()"
                                            title="Remove Exercise"
                                            class="flex items-center p-1 hover:text-red-700 dark:hover:text-red-300 rounded-full hover:bg-red-100 dark:hover:bg-red-900/30 disabled:opacity-50 bg-red-500 text-white">
                                            <app-icon name="trash" class="h-5 w-5"></app-icon>
                                        </button>
                                        <ng-container *ngIf="!isSuperSet(exIndex)">
                                            <button type="button" (click)="openSwitchExerciseModal(exIndex)"
                                                title="Switch exercise"
                                                class="mx-1 flex items-center p-1 rounded-full bg-purple-400 hover:bg-purple-600 disabled:opacity-50 text-white">
                                                <app-icon name="change" class="h-5 w-5"></app-icon>
                                            </button>
                                        </ng-container>
                                    </div>
                                    <div *ngIf="!isViewMode && shouldShowExpandedExercise(exIndex)"
                                        class="w-full flex justify-end pr-2 mt-2">
                                        <button type="button" (click)="removeExercise(exIndex)" title="Remove Exercise"
                                            class="mx-1 flex items-center p-1 rounded-full hover:bg-red-600 disabled:opacity-50 bg-red-500 text-white">
                                            <app-icon name="trash" class="h-5 w-5"></app-icon>
                                        </button>
                                        <button type="button" (click)="fillWithLatestPerformanceData(exIndex)"
                                            title="Fill with latest performance data"
                                            class="mx-1 flex items-center p-1 rounded-full hover:bg-green-600 disabled:opacity-50 bg-green-500 text-white">
                                            <app-icon name="task" class="h-5 w-5"></app-icon>
                                        </button>
                                        <ng-container *ngIf="!isSuperSet(exIndex)">
                                            <button type="button" (click)="convertToSingleExerciseEmom(exerciseControl)"
                                                title="Make EMOM"
                                                class="mx-1 flex items-center p-1 rounded-full bg-teal-400 hover:bg-teal-600 disabled:opacity-50 text-white">
                                                <app-icon name="clock" class="h-5 w-5"></app-icon>
                                            </button>
                                            <button type="button" (click)="openSwitchExerciseModal(exIndex)"
                                                title="Switch exercise"
                                                class="mx-1 flex items-center p-1 rounded-full bg-purple-400 hover:bg-purple-600 disabled:opacity-50 text-white">
                                                <app-icon name="change" class="h-5 w-5"></app-icon>
                                            </button>
                                        </ng-container>
                                    </div>
                                </div>
                                <!-- EXPANDED CONTENT AREA -->
                                <div *ngIf="shouldShowExpandedExercise(exIndex)" class="p-2">
                                    <div class="flex flex-col sm:flex-row justify-between items-start pb-2 pt-1 px-1 sm:pt-0 rounded-md bg-gray-100 dark:bg-gray-800"
                                        [ngClass]="{'rounded-b-none': !isEditableMode()}">
                                        <div class="flex-grow">
                                            <!-- Superset info remains on its own line if visible, which is correct -->
                                            <span *ngIf="exerciseControl.get('supersetId')?.value"
                                                class="text-xs font-mono block mb-1"
                                                [ngClass]="standarSuperSetOrEmomClass(exerciseControl, true)">
                                                Superset exercise [{{ (exerciseControl.get('supersetOrder')?.value ?? 0)
                                                + 1
                                                }} of {{ getSupersetSize(exIndex) }}]
                                            </span>

                                            <div class="flex items-center">
                                                <!-- The Image: Added margin-right for spacing and flex-shrink-0 -->
                                                <img [src]="getIconPath(exerciseControl.get('exerciseId')?.value) | async"
                                                    alt="Exercise Icon" class="object-contain mr-3 flex-shrink-0"
                                                    [ngClass]="{
                                                        'w-8 h-8 ': !isSetExpanded(exIndex, 0),
                                                        'w-10 h-10 py-1': isSetExpanded(exIndex, 0),
                                                        }">

                                                <!-- The Title Text: Now wrapped in its own h3 tag -->
                                                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100">
                                                    {{ exerciseControl.get('exerciseName')?.value || 'Select Exercise'
                                                    }}
                                                </h3>
                                                <app-icon name="info"
                                                    class="h-4 w-4 text-gray-400 dark:text-gray-300 cursor-help"
                                                    *ngIf="exerciseControl.get('exerciseId')?.value" width="20"
                                                    height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"
                                                    (click)="openModal(exerciseControl.value, $event)"
                                                    [appTooltip]="exerciseInfoTooltipString"></app-icon>
                                            </div>
                                        </div>

                                        <div
                                            class="flex flex-col items-end space-y-2 flex-shrink-0 w-full sm:w-auto mt-2 sm:mt-0">

                                            <!-- +++ START: NEW UNIFIED CONTROL PANEL +++ -->
                                            <div *ngIf="isEditableMode() && exerciseControl.get('supersetId')?.value && exerciseControl.get('supersetOrder')?.value === 0"
                                                class="py-2 px-1 bg-gray-100 dark:bg-gray-800 rounded-lg shadow-sm w-full grid grid-cols-2 gap-x-3 gap-y-2">

                                                <!-- Col 1: Round Management -->
                                                <div class="flex items-center gap-x-2">
                                                    <span
                                                        class="text-sm font-semibold text-gray-700 dark:text-gray-300">
                                                        Rounds:
                                                    </span>
                                                    <strong class="text-lg text-gray-900 dark:text-white">{{
                                                        getSetsFormArray(exerciseControl).length }}</strong>
                                                </div>

                                                <!-- Col 2: Round +/- Buttons -->
                                                <div class="flex items-center justify-end gap-x-2">
                                                    <button type="button"
                                                        (click)="removeRoundFromSuperset(exerciseControl, $event)"
                                                        [disabled]="getSetsFormArray(exerciseControl).length <= 1"
                                                        class="p-1.5 rounded-full bg-red-200 hover:bg-red-300 text-red-700 disabled:opacity-50 flex items-center"
                                                        aria-label="Remove Round">
                                                        <app-icon name="minus-circle" class="h-6 w-6"></app-icon>
                                                    </button>
                                                    <button type="button"
                                                        (click)="addRoundToSuperset(exerciseControl, $event)"
                                                        class="p-1.5 rounded-full bg-green-200 hover:bg-green-300 text-green-700 flex items-center"
                                                        aria-label="Add Round">
                                                        <app-icon name="plus-circle" class="h-6 w-6"></app-icon>
                                                    </button>
                                                </div>

                                                <!-- Col 1 & 2: Divider -->
                                                <div class="col-span-2 h-px bg-gray-200 dark:bg-gray-700"></div>

                                                <!-- Col 1: Type Label -->
                                                <div class="flex items-center">
                                                    <span
                                                        class="text-sm font-semibold text-gray-700 dark:text-gray-300">Type:</span>
                                                </div>

                                                <!-- Col 2: Type Value & Change Button -->
                                                <div class="flex items-center justify-end">
                                                    <strong class="text-sm"
                                                        [ngClass]="standarSuperSetOrEmomClass(exerciseControl, true)">
                                                        {{ (exerciseControl.get('supersetType')?.value || 'standard') |
                                                        titlecase }}
                                                    </strong>
                                                    <button type="button" (click)="changeSupersetType(exerciseControl)"
                                                        class="ml-2 text-xs font-semibold text-blue-600 hover:underline dark:text-blue-400">
                                                        (Change)
                                                    </button>
                                                </div>

                                                <!-- EMOM Time Input (Full Width) -->
                                                <div *ngIf="exerciseControl.get('supersetType')?.value === 'emom'"
                                                    class="col-span-2 flex items-center gap-x-2">
                                                    <label [for]="'emomTime-' + exIndex"
                                                        class="text-sm font-semibold text-gray-700 dark:text-gray-300 flex-shrink-0">Time
                                                        (s):</label>
                                                    <input type="number" [id]="'emomTime-' + exIndex"
                                                        formControlName="emomTimeSeconds" min="10"
                                                        class="w-full p-1 text-m border-gray-300 dark:border-gray-500 rounded-md focus:ring-primary dark:bg-gray-600 dark:text-gray-200 text-right">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Exercise Notes -->
                                    <div *ngIf="builderForm.get('notes')?.value || isEditableMode()">
                                        <label [for]="'exerciseNotes-' + exIndex"
                                            class="block text-s font-medium text-gray-600 dark:text-gray-400 mb-0.5">
                                            {{ mode === 'routineBuilder' ? 'Exercise Notes (Optional)' : 'Notes for this
                                            Logged Exercise (Optional)'}}
                                        </label>
                                        <textarea [id]="'exerciseNotes-' + exIndex" formControlName="notes" rows="1"
                                            appAutoGrow
                                            class="mt-0.5 mb-2 block w-full p-1.5 text-sm border-gray-300 dark:border-gray-500 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200"
                                            [readonly]="isViewMode"></textarea>
                                    </div>

                                    <!-- Sets Section (Headers, Collapsed Sets, Expanded Set Form) -->
                                    <!-- EXPANDED Only VIEW MODE - START -->
                                    <div *ngIf="!isCompactView && isViewMode"
                                    class="gap-x-2 gap-y-2 px-2 py-2 bg-white rounded-md rounded-t-none dark:bg-gray-800 text-gray-900 dark:text-white "
                                    [ngClass]="getGridColsForExercise(exerciseControl)"
                                        >

                                        <!-- === GRID HEADER === -->
                                        <div
                                            class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400 text-center">
                                            Set</div>

                                        <!-- Reps Header: Show only if any set has reps -->
                                        <div *ngIf="checkIfRepsIsVisible(exerciseControl)"
                                            class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400 text-center">
                                            Reps</div>

                                        <!-- Weight Header: Show only if it's a weighted exercise -->
                                        <div *ngIf="checkIfWeightIsVisible(exerciseControl)"
                                            class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400 text-center">
                                            Weight</div>

                                        <!-- Distance Header: Show only if any set has distance -->
                                        <div *ngIf="checkIfDistanceIsVisible(exerciseControl)"
                                            class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400 text-center">
                                            Distance</div>

                                        <!-- Time Header: Show for timed exercises, but not EMOMs -->
                                        <div *ngIf="checkIfDurationIsVisible(exerciseControl) && !isEmom(exerciseControl)"
                                            class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400 text-center">
                                            Time (s)</div>

                                        <!-- Rest Header -->
                                        <div
                                            class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400 text-center">
                                            Rest (s)</div>

                                        <!-- Notes Header -->
                                        <div *ngIf="checkIfNotesIsVisible(exerciseControl)"
                                            class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400 text-center">
                                            Notes</div>


                                        <!-- === GRID ROWS (LOOP) === -->
                                        <ng-container
                                            *ngFor="let set of exerciseControl.get('sets')?.value; let i = index; let last = last">

                                            <!-- Set Number -->
                                            <div class="font-medium flex items-center justify-center">{{ i + 1 }}</div>

                                            <!-- Reps Data Cell -->
                                            <div *ngIf="checkIfRepsIsVisible(set)"
                                                class="flex items-center justify-center">
                                                <strong>{{ getSetTargetDisplay(set, 'reps') || '-' }}</strong>
                                            </div>

                                            <!-- Weight Data Cell -->
                                            <div *ngIf="checkIfWeightIsVisible(set)"
                                                class="flex items-center justify-center">
                                                <strong>{{ getSetTargetDisplay(set, 'weight') || '-' }}{{
                                                    getSetTargetDisplay(set, 'weight') !== '-' ? (' ' +
                                                    unitService.getWeightUnitSuffix()) : '' }}</strong>
                                            </div>

                                            <!-- Distance Data Cell -->
                                            <div *ngIf="checkIfDistanceIsVisible(set)"
                                                class="flex items-center justify-center">
                                                <strong>{{ getSetTargetDisplay(set, 'distance') || '-' }}{{
                                                    getSetTargetDisplay(set, 'distance') !== '-' ? (' ' +
                                                    unitService.getDistanceMeasureUnitSuffix()) : '' }}</strong>
                                            </div>

                                            <!-- Time Data Cell -->
                                            <div *ngIf="checkIfDurationIsVisible(set) && !isEmom(exerciseControl)"
                                                class="flex items-center justify-center">
                                                <strong>{{ getSetTargetDisplay(set, 'duration') || '-' }}</strong>
                                            </div>

                                            <!-- Rest Data Cell -->
                                            <div class="flex items-center justify-center">
                                                <strong>{{ set.restAfterSet || '-' }}</strong>
                                            </div>

                                            <!-- Notes Data Cell -->
                                            <div *ngIf="checkIfNotesIsVisible(set)" class="flex items-center justify-center">
                                                <ng-container *ngIf="set.notes; else noNotes">
                                                    <div (click)="showNotesModal(set.notes)" class="cursor-pointer">
                                                        <app-icon name="clipboard-list"
                                                            class="h-8 w-8 text-gray-500 dark:text-white"></app-icon>
                                                    </div>
                                                </ng-container>
                                                <ng-template #noNotes>
                                                    <span>-</span>
                                                </ng-template>
                                            </div>

                                            <!-- Divider -->
                                            <div *ngIf="!last" class="col-span-full h-px bg-gray-200 dark:bg-gray-700">
                                            </div>

                                        </ng-container>

                                    </div>
                                    <!-- EXPANDED Only VIEW MODE - END -->

                                    <!-- EXPANDED Only EDIT MODE - START -->
                                    <div *ngIf="!isCompactView && isEditableMode()" class="space-y-1">
                                        <!-- START: Control Panel for Standard Exercises -->
                                        <div *ngIf="!exerciseControl.get('supersetId')?.value"
                                            class="py-2 px-1 rounded-lg grid grid-cols-2 gap-x-3 gap-y-2">

                                            <!-- Col 1: Sets Count -->
                                            <div class="flex items-center gap-x-2">
                                                <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">
                                                    Sets:
                                                </span>
                                                <strong class="text-lg text-gray-900 dark:text-white">{{
                                                    getSetsFormArray(exerciseControl).length }}</strong>
                                            </div>

                                            <!-- Col 2: Set +/- Buttons -->
                                            <div class="flex items-center justify-end gap-x-2">
                                                <button type="button" (click)="removeLastSet(exerciseControl, $event)"
                                                    [disabled]="getSetsFormArray(exerciseControl).length <= 1"
                                                    class="p-1.5 rounded-full bg-red-200 hover:bg-red-300 text-red-700 disabled:opacity-50 flex items-center"
                                                    aria-label="Remove Last Set">
                                                    <app-icon name="minus-circle" class="h-6 w-6"></app-icon>
                                                </button>
                                                <button type="button"
                                                    (click)="addSet(exerciseControl, exIndex); $event.stopPropagation()"
                                                    class="p-1.5 rounded-full bg-green-200 hover:bg-green-300 text-green-700 flex items-center"
                                                    aria-label="Add Set">
                                                    <app-icon name="plus-circle" class="h-6 w-6"></app-icon>
                                                </button>
                                            </div>
                                        </div>
                                        <!-- END: Control Panel for Standard Exercises -->

                                        <div formArrayName="sets" class="space-y-1.5">
                                            <!-- Set Headers -->
                                            <div *ngIf="getSetsFormArray(exerciseControl).controls.length > 0 && (expandedSetPath()?.exerciseIndex !== exIndex)"
                                                class="grid grid-cols-12 gap-x-1 py-1 px-1.5 text-xs font-medium text-gray-500 dark:text-gray-400 border-b dark:border-gray-600">
                                                <div class="col-span-1 text-center">#</div>
                                                <div class="col-span-2 text-center truncate">Type</div>
                                                <div class="col-span-2 text-center">{{ mode === 'manualLogEntry' ? 'Reps
                                                    Ach.' : 'Reps' }}</div>
                                                <div class="col-span-2 text-center truncate">{{ mode ===
                                                    'manualLogEntry' ?
                                                    'Wt Used' : 'Weight' }} ({{unitService.getWeightUnitSuffix()}})
                                                </div>
                                                <div class="col-span-1 text-center">{{ mode === 'manualLogEntry' ? 'Time
                                                    Perf.' : 'Time' }}</div>
                                                <div class="col-span-2 text-center">{{ mode === 'routineBuilder' ?
                                                    'Rest' :
                                                    'Notes'}}</div>
                                                <div class="col-span-1 text-center">{{ mode === 'routineBuilder' ?
                                                    'Tempo' :
                                                    ''}}</div>
                                                <div class="col-span-1"></div> <!-- Action column -->
                                            </div>

                                            <!-- Loop through sets for collapsed or expanded display -->
                                            <div *ngFor="let setControl of getSetsFormArray(exerciseControl).controls; let setIndex = index"
                                                [formGroupName]="setIndex">
                                                <!-- Collapsed Set View -->
                                                <div *ngIf="!isSetExpanded(exIndex, setIndex)"
                                                    (click)="toggleSetExpansion(exIndex, setIndex, $event)"
                                                    class="grid grid-cols-12 gap-x-1 items-center py-1.5 px-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800/60 cursor-pointer border dark:border-gray-700 dark:text-white"
                                                    [ngClass]="{
                                                    'bg-gray-50 dark:bg-gray-700/50 text-gray-800 dark:text-gray-200': !['warmup', 'dropset', 'failure', 'amrap', 'myorep', 'restpause'].includes(setControl.get('type')?.value ?? '') && !isViewMode,
                                                    'cursor-default': isViewMode
                                                } ">
                                                    <div class="col-span-1 text-s text-center font-medium">{{ setIndex +
                                                        1
                                                        }}</div>
                                                    <div class="col-span-2 text-xs text-center truncate"
                                                        [title]="setControl.get('type')?.value | titlecase">{{
                                                        (setControl.get('type')?.value | titlecase) || 'Standard' }}
                                                    </div>
                                                    <div class="col-span-2 text-s text-center">
                                                        <ng-container *ngIf="mode === 'routineBuilder'">{{
                                                            getSetDisplayValue(setControl, 'reps') }}</ng-container>
                                                        <ng-container *ngIf="mode === 'manualLogEntry'">{{
                                                            setControl.get('repsAchieved')?.value ?? '-'
                                                            }}</ng-container>
                                                    </div>
                                                    <div class="col-span-2 text-s text-center">{{ (setControl.get(mode
                                                        ===
                                                        'manualLogEntry' ? 'weightUsed' : 'targetWeight')?.value) |
                                                        weightUnit:'1.0-2' }}</div>
                                                    <div class="col-span-1 text-s text-center">
                                                        <ng-container *ngIf="mode === 'routineBuilder'">{{
                                                            getSetDisplayValue(setControl, 'duration') &&
                                                            getSetDisplayValue(setControl, 'duration') !== '-' ?
                                                            (getSetDisplayValue(setControl, 'duration') + 's') : '-'
                                                            }}</ng-container>
                                                        <ng-container *ngIf="mode === 'manualLogEntry'">{{
                                                            (setControl.get('durationPerformed')?.value) ?
                                                            (setControl.get('durationPerformed')?.value + 's') : '-'
                                                            }}</ng-container>
                                                    </div>
                                                    <div class="col-span-2 text-s text-center truncate"
                                                        [title]="mode === 'routineBuilder' ? (setControl.get('restAfterSet')?.value + 's') : setControl.get('notes')?.value">
                                                        <ng-container *ngIf="mode === 'routineBuilder'">{{
                                                            setControl.get('restAfterSet')?.value }}s</ng-container>
                                                        <ng-container *ngIf="mode === 'manualLogEntry'">{{
                                                            setControl.get('notes')?.value || '-' }}</ng-container>
                                                    </div>
                                                    <div class="col-span-1 text-s text-center truncate"
                                                        [title]="setControl.get('tempo')?.value">
                                                        <ng-container *ngIf="mode === 'routineBuilder'">{{
                                                            setControl.get('tempo')?.value || '-' }}</ng-container>
                                                    </div>
                                                    <div *ngIf="!isViewMode"
                                                        class="col-span-1 flex items-center justify-end">
                                                        <button type="button"
                                                            (click)="removeSet(exerciseControl, exIndex, setIndex); $event.stopPropagation()"
                                                            [title]="isEmomExercise(exerciseControl) ? 'Remove Round' : 'Remove Set'"
                                                            class="flex items-center text-red-500 hover:text-red-600 dark:text-red-400 dark:hover:text-red-300 p-0.5 rounded-full hover:bg-red-100 dark:hover:bg-red-900/30 disabled:opacity-50">
                                                            <app-icon name="cancel" class="h-4 w-4"></app-icon>
                                                        </button>
                                                    </div>
                                                    <div *ngIf="isViewMode" class="col-span-1"></div>
                                                </div>

                                                <!-- Expanded Set Form -->
                                                <div #expandedSetElement *ngIf="isSetExpanded(exIndex, setIndex)"
                                                    class="p-1 rounded-md shadow-inner space-y-2 border-yellow-400 ring-2 ring-yellow-400 dark:ring-yellow-500 z-10"
                                                    [ngClass]="{
                                                    'bg-gray-100 dark:bg-gray-800/50': !['warmup', 'dropset', 'failure', 'amrap', 'myorep', 'restpause'].includes(setControl.get('type')?.value ?? '')
                                                }">
                                                    <div
                                                        class="grid grid-cols-2 sm:grid-cols-3 gap-x-3 gap-y-2 items-end">
                                                        <div class="col-span-full sm:col-span-1">
                                                            <p [ngClass]="setLabelClass(exerciseControl)">
                                                                #{{setIndex+1}} {{isSuperSet(exIndex) ? 'round':'set'}}
                                                            </p>
                                                            <label [for]="'setType-exp-' + exIndex + '-' + setIndex"
                                                                class="block text-s font-medium text-gray-600 dark:text-gray-400">Set
                                                                Type</label>
                                                            <select [id]="'setType-exp-' + exIndex + '-' + setIndex"
                                                                formControlName="type" [disabled]="isViewMode"
                                                                class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                                <option *ngFor="let typeOpt of availableSetTypes"
                                                                    [value]="typeOpt.value">{{ typeOpt.label }}</option>
                                                            </select>
                                                        </div>
                                                        <!-- Reps Input: Conditional for ranges vs single value -->
                                                        <div *ngIf="!isExerciseCardioOnlyCtrl(exerciseControl)">
                                                            <label [for]="'reps-exp-' + exIndex + '-' + setIndex"
                                                                class="flex items-center justify-between text-s font-medium text-gray-600 dark:text-gray-400">
                                                                <span>Reps {{ mode === 'manualLogEntry' ? '(Achieved)' :
                                                                    ''}}</span>
                                                                <!-- SWITCH BUTTON -->
                                                                <button *ngIf="mode === 'routineBuilder'" type="button"
                                                                    (click)="toggleRepsMode(setControl,$event)"
                                                                    title="Toggle between single value and range"
                                                                    class="text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-semibold p-0.5 rounded">
                                                                    {{ isRangeMode(setControl, 'reps') ? 'Use Single' :
                                                                    'Use
                                                                    Range' }}
                                                                </button>
                                                            </label>
                                                            <!-- ROUTINE BUILDER - REPS -->
                                                            <ng-container *ngIf="mode === 'routineBuilder'">
                                                                <!-- Range Inputs -->
                                                                <div *ngIf="isRangeMode(setControl, 'reps')"
                                                                    class="mt-0.5">
                                                                    <div class="flex items-center space-x-1.5">
                                                                        <input type="number"
                                                                            formControlName="targetRepsMin" min="0"
                                                                            placeholder="Min" [readonly]="isViewMode"
                                                                            class="w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                                        <span
                                                                            class="text-gray-500 dark:text-gray-400 font-bold">-</span>
                                                                        <input type="number"
                                                                            formControlName="targetRepsMax" min="0"
                                                                            placeholder="Max" [readonly]="isViewMode"
                                                                            class="w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed"
                                                                            [ngClass]="{'border-red-500 dark:border-red-400': setControl.get('targetRepsMax')?.hasError('min')}">
                                                                    </div>
                                                                    <div *ngIf="setControl.get('targetRepsMax')?.hasError('min') && setControl.get('targetRepsMax')?.touched"
                                                                        class="text-red-500 dark:text-red-400 text-xs mt-1">
                                                                        Max must be greater than or equal to min.
                                                                    </div>
                                                                </div>
                                                                <!-- Single Value Input -->
                                                                <input *ngIf="!isRangeMode(setControl, 'reps')"
                                                                    type="number" formControlName="targetReps" min="0"
                                                                    placeholder="Reps" [readonly]="isViewMode"
                                                                    class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                            </ng-container>
                                                            <!-- LOG ENTRY - SINGLE REPS ACHIEVED -->
                                                            <input *ngIf="mode === 'manualLogEntry'" type="number"
                                                                [id]="'reps-exp-' + exIndex + '-' + setIndex"
                                                                formControlName="repsAchieved" placeholder="Reps"
                                                                [readonly]="isViewMode"
                                                                class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                        </div>

                                                        <!-- Weight Input -->
                                                        <div>
                                                            <label [for]="'weight-exp-' + exIndex + '-' + setIndex"
                                                                class="flex items-center justify-between text-s font-medium text-gray-600 dark:text-gray-400">
                                                                <span>Weight {{ mode === 'manualLogEntry' ? '(Used)' :
                                                                    ''}}</span>
                                                                <!-- SWITCH BUTTON -->
                                                                <button *ngIf="mode === 'routineBuilder'" type="button"
                                                                    (click)="toggleWeightMode(setControl,$event)"
                                                                    title="Toggle between single value and range"
                                                                    class="text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-semibold p-0.5 rounded">
                                                                    {{ isRangeMode(setControl, 'weight') ? 'Use Single'
                                                                    :
                                                                    'Use
                                                                    Range' }}
                                                                </button>
                                                            </label>
                                                            <!-- ROUTINE BUILDER - WEIGHT -->
                                                            <ng-container *ngIf="mode === 'routineBuilder'">
                                                                <!-- Range Inputs -->
                                                                <div *ngIf="isRangeMode(setControl, 'weight')"
                                                                    class="mt-0.5">
                                                                    <div class="flex items-center space-x-1.5">
                                                                        <input type="number"
                                                                            formControlName="targetWeightMin" min="0"
                                                                            placeholder="Min" [readonly]="isViewMode"
                                                                            class="w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                                        <span
                                                                            class="text-gray-500 dark:text-gray-400 font-bold">-</span>
                                                                        <input type="number"
                                                                            formControlName="targetWeightMax" min="0"
                                                                            placeholder="Max" [readonly]="isViewMode"
                                                                            class="w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed"
                                                                            [ngClass]="{'border-red-500 dark:border-red-400': setControl.get('targetWeightMax')?.hasError('min')}">
                                                                    </div>
                                                                    <div *ngIf="setControl.get('targetWeightMax')?.hasError('min') && setControl.get('targetWeightMax')?.touched"
                                                                        class="text-red-500 dark:text-red-400 text-xs mt-1">
                                                                        Max must be greater than or equal to min.
                                                                    </div>
                                                                </div>
                                                                <!-- Single Value Input -->
                                                                <input *ngIf="!isRangeMode(setControl, 'weight')"
                                                                    type="number" formControlName="targetWeight" min="0"
                                                                    placeholder="Weight" [readonly]="isViewMode"
                                                                    class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                            </ng-container>
                                                            <!-- LOG ENTRY - SINGLE WEIGHT ACHIEVED -->
                                                            <input *ngIf="mode === 'manualLogEntry'" type="number"
                                                                [id]="'weight-exp-' + exIndex + '-' + setIndex"
                                                                formControlName="weightUsed" placeholder="Weight"
                                                                [readonly]="isViewMode"
                                                                class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                        </div>

                                                        <div>
                                                            <label [for]="'distance-exp-' + exIndex + '-' + setIndex"
                                                                class="flex items-center justify-between text-s font-medium text-gray-600 dark:text-gray-400">
                                                                <span>Distance
                                                                    ({{unitService.getDistanceMeasureUnitSuffix()}})</span>
                                                                <button *ngIf="mode === 'routineBuilder'" type="button"
                                                                    (click)="toggleDistanceMode(setControl,$event)"
                                                                    title="Toggle between single value and range"
                                                                    class="text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-semibold p-0.5 rounded">
                                                                    {{ isRangeMode(setControl, 'distance') ? 'Use
                                                                    Single' : 'Use Range' }}
                                                                </button>
                                                            </label>
                                                            <!-- ROUTINE BUILDER - DISTANCE -->
                                                            <ng-container *ngIf="mode === 'routineBuilder'">
                                                                <div *ngIf="isRangeMode(setControl, 'distance')"
                                                                    class="mt-0.5">
                                                                    <div class="flex items-center space-x-1.5">
                                                                        <input type="number"
                                                                            formControlName="targetDistanceMin" min="0"
                                                                            placeholder="Min" [readonly]="isViewMode"
                                                                            class="w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                                        <span
                                                                            class="text-gray-500 dark:text-gray-400 font-bold">-</span>
                                                                        <input type="number"
                                                                            formControlName="targetDistanceMax" min="0"
                                                                            placeholder="Max" [readonly]="isViewMode"
                                                                            class="w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                                    </div>
                                                                </div>
                                                                <input *ngIf="!isRangeMode(setControl, 'distance')"
                                                                    type="number" formControlName="targetDistance"
                                                                    min="0" placeholder="Distance"
                                                                    [readonly]="isViewMode"
                                                                    class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                            </ng-container>
                                                            <!-- LOG ENTRY - SINGLE DISTANCE ACHIEVED -->
                                                            <input *ngIf="mode === 'manualLogEntry'" type="number"
                                                                [id]="'distance-exp-' + exIndex + '-' + setIndex"
                                                                formControlName="distanceAchieved"
                                                                placeholder="Distance" [readonly]="isViewMode"
                                                                class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                        </div>

                                                        <!-- Duration Input: Conditional for ranges vs single value -->
                                                        <!-- Duration Input: VISIBLE only if NOT EMOM -->
                                                        <div *ngIf="!isEmomExercise(exerciseControl)">
                                                            <label [for]="'duration-exp-' + exIndex + '-' + setIndex"
                                                                class="flex items-center justify-between text-s font-medium text-gray-600 dark:text-gray-400">
                                                                <span>Time (s) {{ mode === 'manualLogEntry' ?
                                                                    '(Performed)'
                                                                    : ''}}</span>
                                                                <!-- SWITCH BUTTON -->
                                                                <button *ngIf="mode === 'routineBuilder'" type="button"
                                                                    (click)="toggleDurationMode(setControl,$event)"
                                                                    title="Toggle between single value and range"
                                                                    class="text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-semibold p-0.5 rounded">
                                                                    {{ isRangeMode(setControl, 'duration') ? 'Use
                                                                    Single' :
                                                                    'Use Range' }}
                                                                </button>
                                                            </label>
                                                            <!-- ROUTINE BUILDER - DURATION -->
                                                            <ng-container *ngIf="mode === 'routineBuilder'">
                                                                <!-- Range Inputs -->
                                                                <div *ngIf="isRangeMode(setControl, 'duration')"
                                                                    class="mt-0.5">
                                                                    <div class="flex items-center space-x-1.5">
                                                                        <input type="number"
                                                                            formControlName="targetDurationMin" min="0"
                                                                            placeholder="Min" [readonly]="isViewMode"
                                                                            class="w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                                        <span
                                                                            class="text-gray-500 dark:text-gray-400 font-bold">-</span>
                                                                        <input type="number"
                                                                            formControlName="targetDurationMax" min="0"
                                                                            placeholder="Max" [readonly]="isViewMode"
                                                                            class="w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed"
                                                                            [ngClass]="{'border-red-500 dark:border-red-400': setControl.get('targetDurationMax')?.hasError('min')}">
                                                                    </div>
                                                                    <div *ngIf="setControl.get('targetDurationMax')?.hasError('min') && setControl.get('targetDurationMax')?.touched"
                                                                        class="text-red-500 dark:text-red-400 text-xs mt-1">
                                                                        Max must be greater than or equal to min.
                                                                    </div>
                                                                </div>
                                                                <!-- Single Value Input -->
                                                                <input *ngIf="!isRangeMode(setControl, 'duration')"
                                                                    type="number" formControlName="targetDuration"
                                                                    min="0" placeholder="Secs" [readonly]="isViewMode"
                                                                    class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                            </ng-container>
                                                            <!-- LOG ENTRY - SINGLE DURATION PERFORMED -->
                                                            <input *ngIf="mode === 'manualLogEntry'" type="number"
                                                                [id]="'duration-exp-' + exIndex + '-' + setIndex"
                                                                formControlName="durationPerformed" placeholder="Secs"
                                                                [readonly]="isViewMode"
                                                                class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                        </div>

                                                        <!-- Other inputs for tempo, rest, notes -->
                                                        <div *ngIf="setControl.get('tempo')?.value || isEditableMode()">
                                                            <label [for]="'tempo-exp-' + exIndex + '-' + setIndex"
                                                                class="block text-s font-medium text-gray-600 dark:text-gray-400">Tempo</label>
                                                            <input type="text"
                                                                [id]="'tempo-exp-' + exIndex + '-' + setIndex"
                                                                formControlName="tempo" placeholder="e.g. 2010"
                                                                [readonly]="isViewMode"
                                                                class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                        </div>
                                                        <div>
                                                            <label [for]="'rest-exp-' + exIndex + '-' + setIndex"
                                                                class="block text-s font-medium text-gray-600 dark:text-gray-400">Rest
                                                                (s) {{ mode === 'manualLogEntry' ? '(Done)' :
                                                                ''}}</label>
                                                            <input type="number"
                                                                [id]="'rest-exp-' + exIndex + '-' + setIndex"
                                                                formControlName="restAfterSet" placeholder="Rest"
                                                                [readonly]="isViewMode"
                                                                class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                        </div>
                                                        <div class="col-span-full"
                                                            *ngIf="(setControl.get('notes')?.value || isEditableMode())">
                                                            <label [for]="'setNotes-exp-' + exIndex + '-' + setIndex"
                                                                class="block text-s font-medium text-gray-600 dark:text-gray-400">Set
                                                                Notes</label>
                                                            <input type="text"
                                                                [id]="'setNotes-exp-' + exIndex + '-' + setIndex"
                                                                formControlName="notes" placeholder="e.g. Good form"
                                                                [readonly]="isViewMode"
                                                                class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-md dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                        </div>
                                                    </div>
                                                    <div class="mt-2 text-right">
                                                        <button type="button"
                                                            (click)="collapseExpandedSet(false,$event)"
                                                            title="Collapse set"
                                                            class="bg-blue-200 text-xs text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 font-medium py-1 px-2 rounded-md inline-flex items-center">
                                                            <app-icon name="collapse" class="h-5 w-5"></app-icon>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- EXPANDED Only EDIT MODE - END -->
                                </div> <!-- End of *ngIf="!isCompactView" -->
                            </div>
                        </div>
                    </div>
                </ng-container>
            </div>

            <!-- 
            <div *ngIf="!isViewMode && mode !== 'manualLogEntry' && exercisesFormArray.length === 0 && (builderForm.get('goal')?.value !== 'rest')"
                class="text-center text-gray-500 dark:text-gray-400 border border-dashed dark:border-gray-700 rounded-md mt-4">
                <button type="button" (click)="openExerciseSelectionModal()"
                    class="bg-green-500 hover:bg-green-600 text-white text-m font-medium py-2 px-3 rounded-md">
                    + ADD FIRST EXERCISE
                </button>
            </div>
            -->
            <div *ngIf="mode === 'manualLogEntry' && exercisesFormArray.length === 0 && !builderForm.get('routineIdForLog')?.value"
                class="text-center text-gray-500 dark:text-gray-400 border border-dashed dark:border-gray-700 rounded-md mt-4">
                <p class="mb-2">Select a routine or ADD EXERCISEs manually to log</p>
                <button type="button" (click)="openExerciseSelectionModal()"
                    class="bg-green-500 hover:bg-green-600 text-white text-m font-medium py-2 px-3 rounded-md">
                    + ADD FIRST EXERCISE TO LOG
                </button>
            </div>
            <div *ngIf="mode === 'manualLogEntry' && exercisesFormArray.length === 0 && builderForm.get('routineIdForLog')?.value"
                class="text-center py-4 text-gray-500 dark:text-gray-400">
                The selected routine has no exercises. Add them manually or edit the routine template.
            </div>
        </section>

        <section *ngIf="builderForm.get('goal')?.value === 'rest'"
            class="p-4 bg-blue-50 dark:bg-blue-900/30 rounded-md text-center">
            <p class="text-m text-blue-700 dark:text-blue-300">This is a rest day routine. No exercises are needed</p>
        </section>

        <div *ngIf="!isViewMode" class="py-2 px-1 flex-col gap-2 flex items-center">

            <!-- Button 1: CANCEL -->
            <!-- <button type="button" [routerLink]="mode === 'routineBuilder' ? '/workout' : '/history/list'"
                style="min-width: 180px"
                class="flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-m font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-500">
                <app-icon name="cancel" class="h-5 w-5 mr-1"></app-icon>
                CANCEL
            </button> -->
            <div *ngIf="mode !== 'manualLogEntry' && (builderForm.get('goal')?.value !== 'rest')"
                class="text-center text-gray-500 dark:text-gray-400 border border-dashed dark:border-gray-700 rounded-md mt-4">
                <button type="button" style="min-width: 180px" (click)="openExerciseSelectionModal()"
                    class="flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-800 disabled:opacity-50">
                    <app-icon name="plus-circle" class="h-6 w-6 mr-1"></app-icon>
                    <!-- Button Text -->
                    ADD EXERCISE
                </button>
            </div>

            <!-- Button 2: SUBMIT -->
            <button type="submit" [disabled]="isFormInvalid()" style="min-width: 180px"
                class="flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-dark disabled:opacity-50">
                <app-icon name="save" class="h-6 w-6 mr-1"></app-icon>
                <!-- Button Text -->
                {{ mode === 'routineBuilder' ? 'SAVE ROUTINE' : (isNewMode ? 'LOG WORKOUT' : 'SAVE LOG CHANGES') }}
            </button>

        </div>
    </form>

    <app-exercise-selection-modal [isOpen]="isExerciseModalOpen" [(searchTerm)]="modalSearchTerm"
        title="ADD EXERCISE TO ROUTINE" [exercises]="availableExercises" [showCreateCustomLink]="true"
        itemIconName="plus-circle" itemIconClass="text-primary dark:text-primary-light"
        (exerciseSelected)="selectExerciseFromLibrary($event)" (createCustomClicked)="handleTrulyCustomExerciseEntry()"
        (close)="closeExerciseSelectionModal()">
    </app-exercise-selection-modal>

    <app-exercise-selection-modal [isOpen]="isSwitchExerciseModalOpen()" [(searchTerm)]="modalSearchTerm"
        [title]="isShowingSimilarInSwitchModal() ? 'SIMILAR EXERCISES' : 'SWITCH EXERCISE'"
        [exercises]="exercisesForSwitchModal()" searchPlaceholder="Search for a replacement..."
        [showSimilarButton]="true" [isShowingSimilarView]="isShowingSimilarInSwitchModal()" itemIconName="change"
        itemIconClass="text-green-500" (exerciseSelected)="handleExerciseSwitch($event)"
        (findSimilarClicked)="findAndShowSimilarExercises()" (backToSearchClicked)="onBackToSearchFromSimilar()"
        (close)="closeSwitchExerciseModal()">
    </app-exercise-selection-modal>

    <!-- NOTES MODAL -->
    <app-modal *ngIf="notesModalsData() as data" [isOpen]="!!data" (isOpenChange)="notesModalsData.set(null)"
        [modalTitle]="'Notes'">

        <div class="flex flex-col p-4 text-left text-gray-700 dark:text-gray-200">
            <textarea [disabled]="true" class="font-semibold pb-2 dark:border-gray-600 dark:bg-gray-800" name=""
                id="">{{data}}</textarea>
            <button (click)="notesModalsData.set(null)"
                class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary-light">
                CLOSE
            </button>
        </div>

    </app-modal>

    <app-modal *ngIf="exerciseDetailsId" [(isOpen)]="isSimpleModalOpen" [modalTitle]="exerciseDetailsName">
        <app-exercise-detail [id]="exerciseDetailsId" [isModal]="true"></app-exercise-detail>
    </app-modal>

    <app-fab-menu [actions]="fabMenuItems" [checkForPausedSession]="false" [scrollToBottomDisabled]="true"
        [scrollToTopDisabled]="true" (actionClicked)="onFabAction($event)"></app-fab-menu>
<div *ngIf="errorMessage()"
    class="my-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-xl dark:bg-red-900/30 dark:border-red-600 dark:text-red-300">
    {{ errorMessage() }}
</div>

<div class="container mx-auto">
    <header class="flex items-center justify-between p-2">
        <div class="flex justify-between items-center">
            <button [routerLink]="mode === 'routineBuilder' ? '/workout' : '/history/list'"
                class="text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                <app-icon name="back"></app-icon>
            </button>
            <div class="w-10 h-10"></div> <!-- Spacer -->
        </div>
        <!-- Action Buttons Group -->
        <div class="flex items-center space-x-2 flex-shrink-0">
            <!-- Wrapper for "More Actions" button and its dropdown -->
            <div *ngIf="liveFormAsRoutine() as routine" class="">
                <div *ngIf="routine.id && !isNewMode" class="relative">
                    <button appBumpClick (click)="toggleActions(routine.id, $event)"
                        class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-500 rounded-full focus:outline-none flex items-center">
                        <app-icon name="menu-action" class="h-10 w-10"></app-icon>
                    </button>
                    <app-action-menu *ngIf="areActionsVisible(routine.id)" displayMode="dropdown"
                        [gridClass]="' grid grid-cols-2 '"
                        [items]="getRoutineDropdownActionItems(routine.id, 'dropdown')"
                        [isVisible]="areActionsVisible(routine.id)" (itemClick)="handleActionMenuItemClick($event)"
                        (closeMenu)="onCloseActionMenu()">
                    </app-action-menu>
                </div>
            </div>
        </div>

    </header>

    <form [formGroup]="builderForm" class="space-y-6 mb-6 p-1 rounded-xl shadow-xl overflow-hidden min-h-screen">
        <section class="space-y-2 p-2 rounded-xl shadow-sm dark:shadow-none text-gray-700 dark:text-gray-200">
            <!-- ROUTINE BUILDER FIELDS -->
            <ng-container *ngIf="mode === 'routineBuilder'">
                <!-- ROUTINE NAME -->
                <div *ngIf="isViewMode">
                    <label
                        class="block text-xl font-black text-gray-700 dark:text-gray-200">{{builderForm.get('name')?.value}}</label>
                </div>
                <div *ngIf="isEditableMode()" class="text-gray-700 dark:text-gray-200">
                    <label for="routineName" class="block text-m font-medium">{{
                        'workoutBuilder.routineBuilder.nameLabel' | translate }}</label>
                    <input type="text" id="routineName" formControlName="name"
                        [placeholder]="'workoutBuilder.routineBuilder.namePlaceholder' | translate"
                        class="mt-1 block w-full p-2 border rounded-xl shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 dark:border-gray-500"
                        [ngClass]="{'border-red-500 dark:border-red-400': builderForm.get('name')?.invalid && builderForm.get('name')?.touched, 'border-gray-300 dark:border-gray-500': !(builderForm.get('name')?.invalid && builderForm.get('name')?.touched) }">
                    <div *ngIf="builderForm.get('name')?.invalid && (builderForm.get('name')?.dirty || builderForm.get('name')?.touched)"
                        class="text-red-500 dark:text-red-400 text-xs mt-1">
                        <span *ngIf="builderForm.get('name')?.errors?.['required']">{{
                            'workoutBuilder.routineBuilder.nameRequired' | translate }}</span>
                    </div>
                </div>
                <!-- DESCRIPTION -->
                <div *ngIf="isViewMode">
                    <p class="mt-1 block w-full shadow-sm dark:shadow-none text-gray-700 dark:text-gray-200"
                        [innerHTML]="sanitizedDescription">
                    </p>
                </div>
                <div *ngIf="isEditableMode()">
                    <label for="description" class="block text-m font-medium text-gray-700 dark:text-gray-300">{{
                        'workoutBuilder.routineBuilder.descriptionLabel' | translate }}</label>
                    <textarea id="description" formControlName="description" rows="3"
                        [placeholder]="'workoutBuilder.routineBuilder.descriptionPlaceholder' | translate"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-xl shadow-sm dark:bg-gray-600 dark:text-gray-200"></textarea>
                </div>
                <!-- GOAL -->
                <div *ngIf="isViewMode">
                    <label class="block text-m text-gray-700 dark:text-gray-300">
                        <span class="font-medium">{{ 'workoutBuilder.routineBuilder.goalLabel' | translate }}: </span>
                        {{ builderForm.get('goal')?.value?.toUpperCase() || ''}}</label>
                </div>
                <div *ngIf="isEditableMode()" class="text-gray-700 dark:text-gray-200">
                    <label for="goal" class="block text-m font-medium text-gray-700 dark:text-gray-300">{{
                        'workoutBuilder.routineBuilder.goalLabel' | translate }}</label>
                    <select id="goal" formControlName="goal"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-xl shadow-sm dark:bg-gray-600 dark:text-gray-200">
                        <option value="">{{ 'workoutBuilder.routineBuilder.goalPlaceholder' | translate }}</option>
                        <option *ngFor="let goalOpt of routineGoals" [value]="goalOpt.value">{{ goalOpt.label }}
                        </option>
                    </select>
                </div>

                <!-- CATEGORY -->
                <!-- PRIMARY CATEGORY -->
                <div *ngIf="isViewMode && builderForm.get('primaryCategory')?.value">
                    <label class="block text-m text-gray-700 dark:text-gray-300">
                        <span class="font-medium">{{ 'workoutBuilder.routineBuilder.primaryCategoryLabel' | translate
                            }}: </span>
                        {{ builderForm.get('primaryCategory')?.value }}
                    </label>
                </div>
                <div *ngIf="isEditableMode()">
                    <label for="primaryCategory" class="block text-m font-medium text-gray-700 dark:text-gray-200">
                        {{ 'workoutBuilder.routineBuilder.primaryCategoryLabel' | translate }}
                    </label>
                    <select id="primaryCategory" formControlName="primaryCategory"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-xl shadow-sm dark:bg-gray-600 text-gray-700 dark:text-gray-200">
                        <option value="">{{ 'workoutBuilder.routineBuilder.primaryCategoryPlaceholder' | translate }}
                        </option>
                        <option *ngFor="let cat of primaryCategories" [value]="cat.value">{{ cat.label }}</option>
                    </select>
                </div>

                <!-- SECONDARY CATEGORY -->
                <div *ngIf="isViewMode && builderForm.get('secondaryCategory')?.value">
                    <label class="block text-m text-gray-700 dark:text-gray-300">
                        <span class="font-medium">{{ 'workoutBuilder.routineBuilder.secondaryCategoryLabel' | translate
                            }}: </span>
                        {{ builderForm.get('secondaryCategory')?.value }}
                    </label>
                </div>
                <div *ngIf="isEditableMode()">
                    <label for="secondaryCategory" class="block text-m font-medium text-gray-700 dark:text-gray-200">
                        {{ 'workoutBuilder.routineBuilder.secondaryCategoryLabel' | translate }}
                    </label>
                    <input type="text" id="secondaryCategory" formControlName="secondaryCategory"
                        [placeholder]="'workoutBuilder.routineBuilder.secondaryCategoryPlaceholder' | translate"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-xl shadow-sm text-gray-700 dark:bg-gray-600 dark:text-gray-200">
                </div>

                <!-- TAGS -->
                <div *ngIf="isViewMode && builderForm.get('tags')?.value" class="mt-2">
                    <div class="flex items-center gap-2 flex-wrap">
                        <label class="block text-m font-medium text-gray-700 dark:text-gray-200">{{
                            'workoutBuilder.routineBuilder.tagsLabel' | translate }}: </label>
                        <span *ngFor="let tag of builderForm.get('tags')?.value.split(',')"
                            class="bg-gray-200 text-gray-700 dark:bg-gray-600 text-gray-700 dark:text-gray-200 text-xs font-semibold px-2 py-1 rounded-full">
                            {{ tag.trim() }}
                        </span>
                    </div>
                </div>
                <div *ngIf="isEditableMode()">
                    <label for="tags" class="block text-m font-medium text-gray-700 dark:text-gray-200">
                        {{ 'workoutBuilder.routineBuilder.tagsLabel' | translate }}
                    </label>
                    <input type="text" id="tags" formControlName="tags"
                        [placeholder]="'workoutBuilder.routineBuilder.tagsPlaceholder' | translate"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-xl shadow-sm dark:bg-gray-600 text-gray-700 dark:text-gray-200">
                </div>

                <ng-container *ngIf="lastLogForCurrentRoutine() as lastLog; else notPerformedYet">

                    <!-- Display "Last Performed" Date -->
                    <div class="text-m text-gray-500 dark:text-gray-300">
                        <span class="font-medium">{{ 'workoutBuilder.routineBuilder.lastPerformed' | translate }}</span>
                        <!-- Use the millisecondsDate pipe we created -->
                        {{ lastLog.startTime | millisecondsDate }}
                    </div>

                    <!-- Display "Last Duration" -->
                    <div *ngIf="lastLog.duration" class="text-sm text-gray-500 dark:text-gray-300 flex gap-1">
                        <span class="font-medium">{{ 'workoutBuilder.routineBuilder.lastDuration' | translate }}</span>
                        {{ lastLog.duration }} min
                    </div>
                </ng-container>

                <!-- This template is shown if the routine has never been performed -->
                <ng-template #notPerformedYet>
                    <div class="text-sm text-gray-500 dark:text-gray-300 italic flex gap-1 mb-2">
                        {{ 'workoutBuilder.routineBuilder.notPerformed' | translate }}
                    </div>

                </ng-template>

                <!-- Estimated Duration (this part is unchanged) -->
                <div>
                    <div *ngIf="liveFormAsRoutine() && getRoutineDuration() > 0"
                        class="text-m text-gray-500 dark:text-gray-300">
                        <span class="font-medium">{{ 'workoutBuilder.routineBuilder.estimatedDuration' | translate
                            }}</span> ~{{ getRoutineDuration() }} min
                    </div>
                </div>
                <!-- Tot exercise -->
                <div>
                    <div *ngIf="(liveFormAsRoutine() && liveFormAsRoutine()?.exercises && liveFormAsRoutine()?.exercises?.length) ?? 0"
                        class="text-m text-gray-500 dark:text-gray-300">
                        <span class="font-medium">{{ 'workoutBuilder.routineBuilder.totExercises' | translate
                            }}</span> {{ getTotalExerciseCount() }}
                    </div>
                </div>

            </ng-container>

            <!-- MANUAL LOG ENTRY FIELDS -->
            <ng-container *ngIf="mode === 'manualLogEntry'">
                <!-- HEADER FOR LOG -->
                <header *ngIf="checkIfLogForProgram()" class="flex items-center justify-between py-2">
                    <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-200">
                        <span *ngIf="isEditableMode">{{getLogTitleForProgramEntry()}}</span>
                    </h1>
                </header>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="workoutDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{
                            'workoutBuilder.logEntry.dateLabel' | translate }}</label>
                        <input type="date" id="workoutDate" formControlName="workoutDate"
                            class="mt-1 block w-full p-2 border rounded-xl shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200"
                            [ngClass]="{'border-red-500 dark:border-red-400': builderForm.get('workoutDate')?.invalid && builderForm.get('workoutDate')?.touched, 'border-gray-300 dark:border-gray-500': !(builderForm.get('workoutDate')?.invalid && builderForm.get('workoutDate')?.touched) }">
                        <div *ngIf="builderForm.get('workoutDate')?.invalid && (builderForm.get('workoutDate')?.dirty || builderForm.get('workoutDate')?.touched)"
                            class="text-red-500 dark:text-red-400 text-xs mt-1">
                            <span *ngIf="builderForm.get('workoutDate')?.errors?.['required']">{{
                                'workoutBuilder.logEntry.dateRequired' | translate }}</span>
                        </div>
                    </div>
                    <div>
                        <label for="startTime" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{
                            'workoutBuilder.logEntry.startTimeLabel' | translate }}</label>
                        <input type="time" id="startTime" formControlName="startTime"
                            class="mt-1 block w-full p-2 border rounded-xl shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200"
                            [ngClass]="{'border-red-500 dark:border-red-400': builderForm.get('startTime')?.invalid && builderForm.get('startTime')?.touched, 'border-gray-300 dark:border-gray-500': !(builderForm.get('startTime')?.invalid && builderForm.get('startTime')?.touched) }">
                        <div *ngIf="builderForm.get('startTime')?.invalid && (builderForm.get('startTime')?.dirty || builderForm.get('startTime')?.touched)"
                            class="text-red-500 dark:text-red-400 text-xs mt-1">
                            <span *ngIf="builderForm.get('startTime')?.errors?.['required']">{{
                                'workoutBuilder.logEntry.startTimeRequired' | translate }}</span>
                        </div>
                    </div>
                    <div>
                        <label for="endTime" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{
                            'workoutBuilder.logEntry.endTimeLabel' | translate }}</label>
                        <input type="time" id="endTime" formControlName="endTime"
                            class="mt-1 block w-full p-2 border rounded-xl shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200"
                            [ngClass]="{'border-red-500 dark:border-red-400': builderForm.get('endTime')?.invalid && builderForm.get('endTime')?.touched, 'border-gray-300 dark:border-gray-500': !(builderForm.get('endTime')?.invalid && builderForm.get('endTime')?.touched) }"
                            (change)="handleEndTimeChange()">
                        <div *ngIf="builderForm.get('endTime')?.invalid && (builderForm.get('endTime')?.dirty || builderForm.get('endTime')?.touched)"
                            class="text-red-500 dark:text-red-400 text-xs mt-1">
                            <span *ngIf="builderForm.get('endTime')?.errors?.['required']">{{
                                'workoutBuilder.logEntry.endTimeRequired' | translate }}</span>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="logWorkoutName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{
                        'workoutBuilder.logEntry.titleLabel' | translate }}</label>
                    <input type="text" id="logWorkoutName" formControlName="name"
                        [placeholder]="'workoutBuilder.logEntry.titlePlaceholder' | translate"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-xl shadow-sm dark:bg-gray-600 dark:text-gray-200">
                </div>
                <div>
                    <label for="routineIdForLog" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{
                        'workoutBuilder.logEntry.basedOnRoutineLabel' | translate }}</label>
                    <select id="routineIdForLog" formControlName="routineIdForLog"
                        [disabled]="builderForm.get('programIdForLog')?.value"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-xl shadow-sm dark:bg-gray-600 dark:text-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        <option value="">{{ 'workoutBuilder.logEntry.adHocOption' | translate }}</option>
                        <option *ngFor="let r of availableRoutines" [value]="r.id">{{ r.name }}</option>
                    </select>
                </div>
                <div>
                    <label for="programIdForLog" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{
                        'workoutBuilder.logEntry.basedOnProgramLabel' | translate }}</label>
                    <select id="programIdForLog" formControlName="programIdForLog"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-xl shadow-sm dark:bg-gray-600 dark:text-gray-200">
                        <option value="">{{ 'workoutBuilder.logEntry.adHocProgramOption' | translate }}</option>
                        <option *ngFor="let program of availablePrograms" [value]="program.id">{{ program.name }}
                        </option>
                    </select>
                </div>
                <!-- START: Updated Iteration and Scheduled Day ID fields -->
                <div *ngIf="initialProgramIdForLogEdit">
                    <label for="iterationIdForLog" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{
                        'workoutBuilder.logEntry.iterationLabel' | translate }}</label>
                    <span *ngIf="isEditableMode" class="text-xs text-red-500 dark:text-primary-light">{{
                        'workoutBuilder.logEntry.iterationWarning' | translate }}</span>
                    <select id="iterationIdForLog" formControlName="iterationIdForLog"
                        [disabled]="!builderForm.get('programIdForLog')?.value || availableIterationIds.length === 0"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-xl shadow-sm dark:bg-gray-600 dark:text-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        <option value="">{{ 'workoutBuilder.logEntry.iterationPlaceholder' | translate }}</option>
                        <option *ngFor="let iterationId of availableIterationIds" [value]="iterationId">{{ iterationId
                            }}</option>
                    </select>
                </div>
                <div *ngIf="initialProgramIdForLogEdit">
                    <label for="scheduledDayIdForLog"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{
                        'workoutBuilder.logEntry.scheduledDayLabel' | translate }}
                    </label><span *ngIf="isEditableMode" class="text-xs text-red-500 dark:text-primary-light">{{
                        'workoutBuilder.logEntry.scheduledDayWarning' | translate }}</span>
                    <select id="scheduledDayIdForLog" formControlName="scheduledDayIdForLog"
                        [disabled]="!builderForm.get('programIdForLog')?.value || availableScheduledDayIds.length === 0"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-xl shadow-sm dark:bg-gray-600 dark:text-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        <option value="">{{ 'workoutBuilder.logEntry.scheduledDayPlaceholder' | translate }}</option>
                        <option *ngFor="let scheduledId of availableScheduledDayInfos" [value]="scheduledId.id">{{
                            scheduledId.weekNumber ? ('workoutBuilder.logEntry.weekLabel' | translate:{week:
                            scheduledId.weekNumber}) : '' }} - {{ scheduledId.dayName
                            ? ('workoutBuilder.logEntry.dayLabel' | translate:{day: scheduledId.dayName}) : ''}}
                        </option>
                    </select>
                </div>
                <!-- END: Updated fields -->
                <div>
                    <label for="overallNotesLog" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{
                        'workoutBuilder.logEntry.notesLabel' | translate }}</label>
                    <textarea id="overallNotesLog" formControlName="overallNotesLog" rows="2"
                        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-500 rounded-xl shadow-sm dark:bg-gray-600 dark:text-gray-200"></textarea>
                </div>
            </ng-container>
        </section>

        <section *ngIf="mode === 'manualLogEntry' || builderForm.get('goal')?.value !== metricEnum.rest">
            <div *ngIf="exercisesFormArray.length>0" cdkDropList [cdkDropListData]="exercisesFormArray.controls"
                (cdkDropListDropped)="onExerciseDrop($event)" [cdkDropListDisabled]="!isEditableMode()"
                formArrayName="exercises" class="exercise-list-container">
                <ng-container *ngFor="let exerciseControl of exercisesFormArray.controls; let exIndex = index;">
                    <div class="relative group exercise-card-wrapper" #expandedExerciseCard appClickOutside
                        (clickOutside)="closeExerciseActionMenu()"
                        [style.zIndex]="isExerciseActionMenuVisible(exIndex) ? 50 : 'auto'"
                        [ngClass]="getExerciseCardClass(exerciseControl, exIndex)">
                        <div *ngIf="(isEditableMode()) && selectedExerciseIndicesForSuperset().length >= 2 && exIndex === firstSelectedExerciseIndexForSuperset"
                            class="absolute left-1/2 -translate-x-1/2 z-20 flex space-x-2" style="top: -1.8rem;">
                            <!-- The 'flex' class ensures they are on a single line. -->
                            <!-- The 'space-x-2' adds a gap between them. Adjust as needed (e.g., space-x-4). -->
                            <!-- The 'left-1/2 -translate-x-1/2' on this div centers the entire group of buttons. -->

                            <button *ngIf="canRemoveSelectedExercises()" type="button"
                                (click)="removeSelectedExercises()"
                                class="bg-red-600 hover:bg-red-700 text-white text-xs font-semibold py-1.5 px-3 rounded-lg shadow-lg min-w-[100px]">
                                {{ 'workoutBuilder.superset.removeExercisesButton' | translate:{count:
                                selectedExerciseIndicesForMultipleRemoval().length} }}
                            </button>

                            <!-- Only one of these two buttons will ever be displayed at a time -->
                            <button *ngIf="!canUngroupSelectedExercises()" type="button"
                                (click)="groupSelectedAsSuperset()"
                                class="bg-green-600 hover:bg-green-700 text-white text-xs font-semibold py-1.5 px-3 rounded-lg shadow-lg min-w-[100px]">
                                {{ 'workoutBuilder.superset.groupButton' | translate:{count:
                                selectedExerciseIndicesForSuperset().length} }}
                            </button>
                            <button *ngIf="canUngroupSelectedExercises()" type="button"
                                (click)="ungroupSuperset(exIndex)"
                                class="bg-violet-600 hover:bg-violet-700 text-white text-xs font-semibold py-1.5 px-3 rounded-lg shadow-lg min-w-[100px]">
                                {{ 'workoutBuilder.superset.ungroupButton' | translate:{count:
                                selectedExerciseIndicesForSuperset().length} }}
                            </button>
                        </div>

                        <div cdkDrag [cdkDragDisabled]="!isDraggingEnabled(exIndex)" appLongPressDrag
                            [dragHandleSelector]="shouldShowExpandedExercise(exIndex) ? '[data-drag-handle]' : undefined"
                            [longPressEnabled]="isEditableMode() && !shouldShowExpandedExercise(exIndex)"
                            [longPressDelay]="150" longPressClass="is-long-pressing" [cdkDragData]="exerciseControl"
                            [cdkDragStartDelay]="110" class="transition-all" [formGroupName]="exIndex"
                            (click)="expandExerciseCard(exIndex, $event)"
                            [title]="isEditableMode() && !shouldShowExpandedExercise(exIndex)? ('workoutBuilder.exercise.dragToReorder' | translate) : ''">

                            <div #superSetControlPanel_Info
                                *ngIf="isEditableMode() && isSuperSet(exIndex) && isFirstInSuperset(exIndex)"
                                class="flex flex-col items-end space-y-2 flex-shrink-0 w-full sm:w-auto">

                                <!-- +++ START: NEW UNIFIED CONTROL PANEL +++ -->
                                <div class="p-2 bg-gray-100 dark:bg-gray-800 rounded-lg shadow-sm w-full">
                                    <!-- Col 1: Round Management -->
                                    <div class="flex items-center gap-x-2">
                                        <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">
                                            {{ 'workoutBuilder.superset.rounds' | translate }}:
                                        </span>
                                        <strong class="text-lg text-gray-900 dark:text-white">{{
                                            getSetsFormArray(exerciseControl).length }}</strong>
                                    </div>

                                    <!-- Col 1: Type Label -->
                                    <div class="flex items-center justify-start">
                                        <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">{{
                                            'workoutBuilder.set.type' | translate }}: </span>
                                        <strong class="text-sm ml-1"
                                            [ngClass]="standarSuperSetOrEmomClass(exerciseControl, true)">
                                            {{ (exerciseControl.get('supersetType')?.value || 'standard') |
                                            titlecase }}
                                        </strong>
                                        <button appBumpClick type="button"(click)="changeSupersetType(exerciseControl)"
                                            class="flex items-center ml-2 text-xs font-semibold text-white hover:underline bg-blue-300 hover:bg-blue-500 rounded-xl p-1">
                                            <app-icon name="change" class="h-5 w-5 mr-1"></app-icon>
                                            {{ 'workoutBuilder.changeType' | translate }}
                                        </button>
                                    </div>

                                    <!-- EMOM Time Input (Full Width) -->
                                    <div *ngIf="exerciseControl.get('supersetType')?.value === 'emom'"
                                        class="col-span-2 flex items-center gap-x-2">
                                        <label [for]="'emomTime-' + exIndex"
                                            class="text-sm font-semibold text-gray-700 dark:text-gray-300 flex-shrink-0">{{
                                            'workoutBuilder.set.time' | translate }}
                                            (s):</label>
                                        <input type="number" [id]="'emomTime-' + exIndex"
                                            formControlName="emomTimeSeconds" min="10"
                                            class="w-full p-1 mt-1 text-m border-gray-300 dark:border-gray-500 rounded-xl focus:ring-primary dark:bg-gray-600 dark:text-gray-200 text-right">
                                    </div>
                                </div>
                            </div>

                            <div class="exercise-item-content">
                                <div *ngIf="isFirstInSuperset(exIndex)" class="px-2 text-xl font-medium mt-0.5"
                                    [ngClass]="standarSuperSetOrEmomClass(exerciseControl, false)">
                                    {{ standarSuperSetOrEmomLabel(exerciseControl) }}
                                </div>
                                <!-- COMPACT VIEW / HEADER AREA -->
                                <div class="flex items-center space-x-1 pt-1 px-1">
                                    <!-- DRAG HANDLE ICON (Now just a visual cue) -->
                                    <div *ngIf="isDraggingEnabled(exIndex)" data-drag-handle
                                        class="p-1 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 flex-shrink-0 flex item-center cursor-move rounded-xl"
                                        [title]="'workoutBuilder.exercise.dragToReorder' | translate">
                                        <app-icon name="reorder"></app-icon>
                                    </div>

                                    <!-- CHECKBOX (if applicable) -->
                                    <input
                                        *ngIf="(isEditableMode() || isNewMode) && !isViewMode && !shouldShowExpandedExercise(exIndex)"
                                        type="checkbox"
                                        [title]="'workoutBuilder.exercise.selectForSuperset' | translate"
                                        [id]="'superset-select-' + exIndex"
                                        (change)="toggleExerciseSelection(exIndex, $event)"
                                        [checked]="selectedExerciseIndicesForSuperset().includes(exIndex)"
                                        class="h-6 w-6 text-orange-600 border-gray-300 dark:border-gray-600 rounded-xl focus:ring-orange-500 flex-shrink-0 disabled:opacity-50">
                                    <!-- EXERCISE NAME & SUPERSET INFO / SETS SUMMARY FOR COMPACT -->
                                    <div *ngIf="!shouldShowExpandedExercise(exIndex)"
                                        class="flex-grow min-w-0 py-2 px-0">
                                        <!-- COMPACT: Show SETS SUMMARY if in compact view -->
                                        <div *ngIf="getSetsFormArray(exerciseControl).controls.length > 0"
                                            class="flex items-center text-s text-gray-500 dark:text-gray-400 mt-0.5 gap-4 pl-2">
                                            <!-- <img [src]="getIconPath(exerciseControl.get('exerciseId')?.value) | async"
                                                alt="Exercise Icon" class="w-6 h-6 sm:w-8 sm:h-8 object-contain"> -->
                                            <div class="min-w-0">
                                                <div class="flex">
                                                    <h3 class="font-semibold text-gray-800 dark:text-gray-100 text-wrap text-lg max-exercise-length"
                                                        [title]="exerciseControl.get('exerciseName')?.value">
                                                        {{ exerciseControl.get('exerciseName')?.value }}
                                                    </h3>
                                                    <app-icon name="info"
                                                        class="h-4 w-4 text-gray-400 dark:text-gray-300 cursor-help"
                                                        *ngIf="exerciseControl.get('exerciseId')?.value" width="20"
                                                        height="20" viewBox="0 0 20 20"
                                                        xmlns="http://www.w3.org/2000/svg"
                                                        (click)="openModal(exerciseControl.value, $event)"></app-icon>
                                                </div>
                                                <div class="text-xl text-gray-500 dark:text-gray-400 truncate">
                                                    <ng-container
                                                        *ngIf="getUniformSetValues(exerciseControl) as uniformValues; else detailedSetView">
                                                        <!-- UNIFORM VIEW: Dynamically shows all uniform metrics -->
                                                        <p
                                                            class="max-w-[250px] sm:max-w-full text-wrap text-sm text-gray-500 dark:text-gray-400">
                                                            <!-- Part 1: Sets/Rounds Count -->
                                                            <span>
                                                                {{ (!isSuperSet(exIndex) ?
                                                                ('workoutBuilder.set.totalSets' | translate) + ': ' :
                                                                ('workoutBuilder.superset.rounds' | translate) + ': ') +
                                                                exerciseControl.get('sets')?.value?.length }}
                                                            </span>

                                                            <!-- Part 2: Uniform metrics displayed inside parentheses -->
                                                            <span class="ml-1">
                                                                (
                                                                <!-- Reps/Weight Section -->
                                                                <ng-container
                                                                    *ngIf="uniformValues.reps || uniformValues.weight">
                                                                    <span
                                                                        *ngIf="uniformValues.reps && uniformValues.weight">{{
                                                                        uniformValues.reps }} x {{ uniformValues.weight
                                                                        }} {{ unitService.getWeightUnitSuffix()
                                                                        }}</span>
                                                                    <span
                                                                        *ngIf="uniformValues.reps && !uniformValues.weight">{{
                                                                        'workoutBuilder.set.reps' | translate }}: {{
                                                                        uniformValues.reps }}</span>
                                                                    <span
                                                                        *ngIf="!uniformValues.reps && uniformValues.weight">{{
                                                                        uniformValues.weight }} {{
                                                                        unitService.getWeightUnitSuffix() }}</span>
                                                                </ng-container>

                                                                <!-- Separator 1: Between strength and cardio metrics -->
                                                                <span
                                                                    *ngIf="(uniformValues.reps || uniformValues.weight) && (uniformValues.distance || uniformValues.duration)"
                                                                    class="mx-2">|</span>

                                                                <!-- Distance/Duration Section -->
                                                                <ng-container
                                                                    *ngIf="uniformValues.distance || uniformValues.duration">
                                                                    <span *ngIf="uniformValues.distance">{{
                                                                        uniformValues.distance }} {{
                                                                        unitService.getDistanceMeasureUnitSuffix()
                                                                        }}</span>
                                                                    <span
                                                                        *ngIf="uniformValues.distance && uniformValues.duration"
                                                                        class="mx-1">/</span>
                                                                    <span *ngIf="uniformValues.duration"
                                                                        class="inline-flex items-center">
                                                                        <app-icon name="duration"
                                                                            class="h-4 w-4 mr-1"></app-icon>
                                                                        {{
                                                                        workoutService.formatSecondsToTime(uniformValues.duration)
                                                                        }}
                                                                    </span>
                                                                </ng-container>

                                                                <!-- Separator 2: Before the rest metric -->
                                                                <span
                                                                    *ngIf="(uniformValues.reps || uniformValues.weight || uniformValues.distance || uniformValues.duration) && uniformValues.rest"
                                                                    class="mx-2">|</span>

                                                                <!-- Rest Section -->
                                                                <ng-container *ngIf="uniformValues.rest">
                                                                    <span class="inline-flex items-center">
                                                                        <app-icon name="rest"
                                                                            class="h-4 w-4 mr-1"></app-icon>
                                                                        {{
                                                                        workoutService.formatSecondsToTime(uniformValues.rest)
                                                                        }}
                                                                    </span>
                                                                </ng-container>
                                                                )
                                                            </span>
                                                        </p>
                                                    </ng-container>

                                                    <!-- DETAILED VIEW: The original display for non-uniform sets -->
                                                    <ng-template #detailedSetView>
                                                        <p *ngIf="exerciseControl?.get('sets')?.value?.length >= 1">
                                                            {{ !isEmomExercise(exerciseControl) ?
                                                            ('workoutBuilder.set.set' | translate) + ': ' +
                                                            exerciseControl?.get('sets')?.value.length : '' }}
                                                            {{
                                                            !isExerciseCardioOnlyCtrl(exerciseControl) &&
                                                            getSetReps(exerciseControl)
                                                            ? '( ' + ('workoutBuilder.set.reps' | translate) + ': ' +
                                                            getSetReps(exerciseControl) + ' )'
                                                            : ''
                                                            }}
                                                        </p>
                                                        <p
                                                            *ngIf="exerciseControl?.get('sets')?.value && exerciseControl?.get('sets')?.value.length >= 1 && checkIfWeightedExercise(exerciseControl)">
                                                            {{ 'workoutBuilder.set.weight' | translate }}
                                                            ({{unitService.getWeightUnitSuffix()}}):
                                                            {{getSetWeightsUsed(exerciseControl)}}
                                                        </p>
                                                        <p
                                                            *ngIf="isExerciseCardioOnlyCtrl(exerciseControl) && getSetDistanceDisplay(exerciseControl)">
                                                            {{ 'workoutBuilder.set.distance' | translate }}
                                                            ({{unitService.getDistanceMeasureUnitSuffix()}}):
                                                            {{getSetDistanceDisplay(exerciseControl)}}
                                                        </p>
                                                    </ng-template>

                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- EXPANDED CONTENT AREA -->
                                <div *ngIf="shouldShowExpandedExercise(exIndex)" class="p-2">
                                    <div class="flex flex-col sm:flex-row justify-between items-start pb-2 pt-1 px-1 sm:pt-0 rounded-xl bg-gray-100 dark:bg-gray-800"
                                        (click)="expandExerciseCard(exIndex, $event)"
                                        [ngClass]="{'rounded-b-none': !isEditableMode()}">
                                        <div class="flex-grow">
                                            <!-- Superset info remains on its own line if visible, which is correct -->
                                            <span *ngIf="exerciseControl.get('supersetId')?.value"
                                                class="text-xs font-mono block mb-1"
                                                [ngClass]="standarSuperSetOrEmomClass(exerciseControl, true)">
                                                {{ 'workoutBuilder.superset.exerciseLabel' | translate:{order:
                                                (exerciseControl.get('supersetOrder')?.value ?? 0) + 1, total:
                                                getSupersetSize(exIndex)} }}
                                            </span>

                                            <div class="flex items-center">
                                                <!-- The Image: Added margin-right for spacing and flex-shrink-0 -->
                                                <img [src]="getIconPath(exerciseControl.get('exerciseId')?.value) | async"
                                                    alt="Exercise Icon" class="object-contain mr-3 flex-shrink-0"
                                                    [ngClass]="{
                                                        'w-8 h-8 ': !isSetExpanded(exIndex, 0),
                                                        'w-10 h-10 py-1': isSetExpanded(exIndex, 0),
                                                        }">

                                                <!-- The Title Text: Now wrapped in its own h3 tag -->
                                                <h3
                                                    class="text-lg font-semibold text-gray-800 dark:text-gray-100 max-exercise-length">
                                                    {{ exerciseControl.get('exerciseName')?.value ||
                                                    ('workoutBuilder.exercise.selectPlaceholder' | translate)
                                                    }}
                                                </h3>
                                                <app-icon name="info"
                                                    class="h-4 w-4 text-gray-400 dark:text-gray-300 cursor-help"
                                                    *ngIf="exerciseControl.get('exerciseId')?.value" width="20"
                                                    height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"
                                                    (click)="openModal(exerciseControl.value, $event)"></app-icon>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Exercise Notes -->
                                    <div *ngIf="expandedExerciseNotes() === exIndex">
                                        <label [for]="'exerciseNotes-' + exIndex"
                                            class="block text-s font-medium text-gray-600 dark:text-gray-400 mb-0.5">
                                            {{ (mode === 'routineBuilder' ? 'workoutBuilder.exercise.notesLabel' :
                                            'workoutBuilder.exercise.loggedNotesLabel') | translate }}
                                        </label>
                                        <textarea [id]="'exerciseNotes-' + exIndex" formControlName="notes" rows="1"
                                            appAutoGrow
                                            class="mt-0.5 mb-2 block w-full p-1.5 text-sm border-gray-300 dark:border-gray-500 rounded-xl shadow-sm dark:bg-gray-600 dark:text-gray-200"
                                            [readonly]="isViewMode"></textarea>
                                    </div>


                                    <!-- Sets Section (Headers, Collapsed Sets, Expanded Set Form) -->
                                    <!-- EXPANDED Only VIEW MODE - START -->
                                    <div *ngIf="shouldShowExpandedExercise(exIndex) && isViewMode"
                                        class="gap-x-2 gap-y-2 px-2 py-2 bg-white rounded-xl rounded-t-none dark:bg-gray-800 text-gray-900 dark:text-white "
                                        [ngClass]="getGridColsForViewExercise(exerciseControl)">

                                        <!-- === GRID HEADER === -->
                                        <div
                                            class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400 text-center">
                                            {{ 'workoutBuilder.set.header' | translate }}</div>

                                        <!-- Reps Header: Show only if any set has reps -->
                                        <div *ngIf="checkIfRepsIsVisible(exerciseControl)"
                                            class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400 text-center">
                                            {{ 'workoutBuilder.set.reps' | translate }}</div>

                                        <!-- Weight Header: Show only if it's a weighted exercise -->
                                        <div *ngIf="checkIfWeightIsVisible(exerciseControl)"
                                            class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400 text-center">
                                            {{ 'workoutBuilder.set.weight' | translate }}</div>

                                        <!-- Distance Header: Show only if any set has distance -->
                                        <div *ngIf="checkIfDistanceIsVisible(exerciseControl)"
                                            class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400 text-center">
                                            {{ 'workoutBuilder.set.distance' | translate }}</div>

                                        <!-- Time Header: Show for timed exercises, but not EMOMs -->
                                        <div *ngIf="checkIfDurationIsVisible(exerciseControl) && !isEmom(exerciseControl)"
                                            class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400 text-center">
                                            {{ 'workoutBuilder.set.time' | translate }} (s)</div>

                                        <!-- Rest Header -->
                                        <div *ngIf="checkIfRestIsVisible(exerciseControl) && !isEmom(exerciseControl)"
                                            class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400 text-center">
                                            {{ 'workoutBuilder.set.rest' | translate }} (s)</div>

                                        <!-- Notes Header -->
                                        <div *ngIf="checkIfNotesIsVisible(exerciseControl)"
                                            class="font-bold text-xs uppercase text-gray-500 dark:text-gray-400 text-center">
                                            {{ 'workoutBuilder.set.notes' | translate }}</div>


                                        <!-- === GRID ROWS (LOOP) === -->
                                        <ng-container
                                            *ngFor="let set of exerciseControl.get('sets')?.value; let i = index; let last = last">

                                            <!-- Set Number -->
                                            <div class="font-medium flex items-center justify-center">{{ i + 1 }}</div>

                                            <!-- Reps Data Cell -->
                                            <div *ngIf="checkIfRepsIsVisible(set)"
                                                class="flex items-center justify-center">
                                                <strong>{{ getSetTargetDisplay(set, metricEnum.reps) || '-' }}</strong>
                                            </div>

                                            <!-- Weight Data Cell -->
                                            <div *ngIf="checkIfWeightIsVisible(set)"
                                                class="flex items-center justify-center">
                                                <strong>{{ getSetTargetDisplay(set, metricEnum.weight) || '-' }}{{
                                                    getSetTargetDisplay(set, metricEnum.weight) !== '-' ? (' ' +
                                                    unitService.getWeightUnitSuffix()) : '' }}</strong>
                                            </div>

                                            <!-- Distance Data Cell -->
                                            <div *ngIf="checkIfDistanceIsVisible(set)"
                                                class="flex items-center justify-center">
                                                <strong>{{ getSetTargetDisplay(set, metricEnum.distance) || '-' }}{{
                                                    getSetTargetDisplay(set, metricEnum.distance) !== '-' ? (' ' +
                                                    unitService.getDistanceMeasureUnitSuffix()) : '' }}</strong>
                                            </div>

                                            <!-- Duration Data Cell -->
                                            <div *ngIf="checkIfDurationIsVisible(set) && !isEmom(exerciseControl)"
                                                class="flex items-center justify-center">
                                                <strong>{{ getSetTargetDisplay(set, metricEnum.duration) || '-'
                                                    }}</strong>
                                            </div>

                                            <!-- Rest Data Cell -->
                                            <div *ngIf="checkIfRestIsVisible(set) && !isEmom(exerciseControl)"
                                                class="flex items-center justify-center">
                                                <strong>{{ getSetTargetDisplay(set, metricEnum.rest) || '-'
                                                    }}</strong>
                                            </div>

                                            <!-- Notes Data Cell -->
                                            <div *ngIf="checkIfNotesIsVisible(set)"
                                                class="flex items-center justify-center">
                                                <ng-container *ngIf="set.notes; else noNotes">
                                                    <div (click)="showNotesModal(set.notes)" class="cursor-pointer">
                                                        <app-icon name="clipboard-list"
                                                            class="h-8 w-8 text-gray-500 dark:text-white"></app-icon>
                                                    </div>
                                                </ng-container>
                                                <ng-template #noNotes>
                                                    <span>-</span>
                                                </ng-template>
                                            </div>

                                            <!-- Divider -->
                                            <div *ngIf="!last" class="col-span-full h-px bg-gray-200 dark:bg-gray-700">
                                            </div>

                                        </ng-container>

                                    </div>
                                    <!-- EXPANDED Only VIEW MODE - END -->

                                    <!-- EXPANDED Only EDIT MODE - START -->
                                    <div *ngIf="shouldShowExpandedExercise(exIndex) && isEditableMode()"
                                        class="space-y-1" id="expandedExerciseSetsContainer">
                                        <!-- START: Control Panel for Standard Exercises -->
                                        <div class="flex-col py-2 px-1 flex gap-y-2">

                                            <!-- Col 1: Sets Count -->
                                            <div class="flex items-center gap-x-2">
                                                <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">
                                                    {{ 'workoutBuilder.set.totalSets' | translate }}:
                                                </span>
                                                <strong class="text-lg text-gray-900 dark:text-white">{{
                                                    getSetsFormArray(exerciseControl).length }}</strong>
                                            </div>

                                            <!-- +++ START: NEW COLLAPSIBLE "SET ALL" PANEL +++ -->
                                            <div *ngIf="isEditableMode() && getExerciseSetsLength(exIndex) > 1"
                                                class="px-2 pt-2">
                                                <!-- Toggle Button -->
                                                <button appBumpClick (click)="toggleSetAllPanel(exIndex, $event)"
                                                    class="w-full flex justify-between items-center p-2 text-sm font-semibold text-gray-600 dark:text-gray-300 bg-gray-200 dark:bg-gray-700/60 rounded-xl hover:bg-gray-300 dark:hover:bg-gray-700">
                                                    <span>{{'setValueForAllSets' | translate}}</span>
                                                    <app-icon name="chevron-down"
                                                        class="h-5 w-5 transition-transform duration-200"
                                                        [class.rotate-180]="expandedSetAllPanel() === exIndex"></app-icon>
                                                </button>

                                                <!-- Collapsible Content -->
                                                <div class="overflow-hidden transition-all duration-300 ease-in-out"
                                                    [style.maxHeight]="expandedSetAllPanel() === exIndex ? '500px' : '0px'">
                                                    <div
                                                        class="p-4 border border-t-0 border-gray-200 dark:border-gray-700 rounded-b-xl bg-white dark:bg-gray-800">
                                                        <div class="grid grid-cols-2 gap-4">

                                                            <!-- Reps Input -->
                                                            <div>
                                                                <!-- *ngIf="getVisibleColumnsForExercise(exIndex)[metricEnum.reps]"> -->
                                                                <label
                                                                    class="block text-xs font-medium text-gray-500 dark:text-gray-200">{{
                                                                    'metrics.reps' | translate }}</label>
                                                                <input type="number" [(ngModel)]="repsToSetForAll"
                                                                    [ngModelOptions]="{standalone: true}"
                                                                    class="mt-1 w-full p-1.5 text-sm border-gray-300 dark:border-gray-500 rounded-xl dark:bg-gray-600 dark:text-gray-200">
                                                            </div>

                                                            <!-- Weight Input -->
                                                            <div>
                                                                <!-- *ngIf="getVisibleColumnsForExercise(exIndex)[metricEnum.weight]"> -->
                                                                <label
                                                                    class="block text-xs font-medium text-gray-500 dark:text-gray-200">{{
                                                                    'metrics.weight' | translate }}
                                                                    ({{ unitService.getWeightUnitSuffix() }})</label>
                                                                <input type="number" [(ngModel)]="weightToSetForAll"
                                                                    [ngModelOptions]="{standalone: true}"
                                                                    class="mt-1 w-full p-1.5 text-sm border-gray-300 dark:border-gray-500 rounded-xl dark:bg-gray-600 dark:text-gray-200">
                                                            </div>

                                                            <!-- Duration Input -->
                                                            <div>
                                                                <!-- *ngIf="getVisibleColumnsForExercise(exIndex)[metricEnum.duration]"> -->
                                                                <label
                                                                    class="block text-xs font-medium text-gray-500 dark:text-gray-200">{{
                                                                    'metrics.duration' | translate }}
                                                                    (s)</label>
                                                                <input type="number" [(ngModel)]="durationToSetForAll"
                                                                    [ngModelOptions]="{standalone: true}"
                                                                    class="mt-1 w-full p-1.5 text-sm border-gray-300 dark:border-gray-500 rounded-xl dark:bg-gray-600 dark:text-gray-200">
                                                            </div>

                                                            <!-- Distance Input -->
                                                            <div>
                                                                <!-- *ngIf="getVisibleColumnsForExercise(exIndex)[metricEnum.distance]"> -->
                                                                <label
                                                                    class="block text-xs font-medium text-gray-500 dark:text-gray-200">{{
                                                                    'metrics.distance' | translate }}
                                                                    ({{ unitService.getDistanceMeasureUnitSuffix()
                                                                    }})</label>
                                                                <input type="number" [(ngModel)]="distanceToSetForAll"
                                                                    [ngModelOptions]="{standalone: true}"
                                                                    class="mt-1 w-full p-1.5 text-sm border-gray-300 dark:border-gray-500 rounded-xl dark:bg-gray-600 dark:text-gray-200">
                                                            </div>

                                                            <!-- Rest Input -->
                                                            <div>
                                                                <!-- *ngIf="getVisibleColumnsForExercise(exIndex)[metricEnum.rest]"> -->
                                                                <label
                                                                    class="block text-xs font-medium text-gray-500 dark:text-gray-200">{{
                                                                    'metrics.rest' | translate }}
                                                                    (s)</label>
                                                                <input type="number" [(ngModel)]="restToSetForAll"
                                                                    [ngModelOptions]="{standalone: true}"
                                                                    class="mt-1 w-full p-1.5 text-sm border-gray-300 dark:border-gray-500 rounded-xl dark:bg-gray-600 dark:text-gray-200">
                                                            </div>
                                                        </div>

                                                        <!-- Apply Button -->
                                                        <div class="mt-4 text-right">
                                                            <button appBumpClick (click)="applyToAllSets(exIndex)"
                                                                [disabled]="repsToSetForAll() === null && weightToSetForAll() === null && durationToSetForAll() === null && distanceToSetForAll() === null && restToSetForAll() === null"
                                                                class="px-4 py-2 bg-primary text-white text-sm font-semibold rounded-xl shadow-sm hover:bg-primary-dark disabled:opacity-50 disabled:cursor-not-allowed">
                                                                {{ 'applyToAllSets' | translate }}
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- END: Control Panel for Standard Exercises -->

                                        <div formArrayName="sets" class="space-y-1.5">
                                            <!-- Set Headers -->
                                            <ng-container *ngLet="getVisibleColumnsForExercise(exIndex) as visibleCols">
                                                <div class="flex items-center gap-x-3 py-1 px-2 text-xs font-medium text-gray-500 dark:text-gray-400 border-b dark:border-gray-600"
                                                    [ngClass]="getGridClassForExercise(exIndex)">
                                                    <!-- Header for Set # -->
                                                    <div class="flex-shrink-0 w-8 text-center">{{
                                                        'workoutBuilder.set.header' | translate }}</div>

                                                    <!-- Middle Container for Dynamic Headers -->
                                                    <div class="flex-grow min-w-0">
                                                        <div class="flex items-center justify-start gap-x-4">
                                                            <div *ngIf="visibleCols[metricEnum.reps]"
                                                                class="w-16 text-center">{{
                                                                'workoutBuilder.set.reps' | translate }}</div>
                                                            <div *ngIf="visibleCols[metricEnum.weight]"
                                                                class="w-20 text-center truncate">{{
                                                                'workoutBuilder.set.weight' | translate
                                                                }} ({{unitService.getWeightUnitSuffix()}})</div>
                                                            <div *ngIf="visibleCols[metricEnum.distance]"
                                                                class="w-20 text-center truncate">{{
                                                                'workoutBuilder.set.distance' | translate }}
                                                                ({{unitService.getDistanceMeasureUnitSuffix()}})</div>
                                                            <div *ngIf="visibleCols[metricEnum.duration]"
                                                                class="w-16 text-center">{{ 'workoutBuilder.set.time' |
                                                                translate }} (s)</div>
                                                            <div *ngIf="visibleCols[metricEnum.rest]"
                                                                class="w-24 text-center">{{
                                                                'workoutBuilder.set.rest' | translate }} (s)</div>
                                                        </div>
                                                    </div>

                                                    <!-- Placeholder for Action Button Column -->
                                                    <div class="flex-shrink-0 w-6"></div>
                                                </div>
                                            </ng-container>
                                            <!-- Loop through sets for collapsed or expanded display -->
                                            <div *ngFor="let setControl of getSetsFormArray(exerciseControl).controls; let setIndex = index"
                                                #setElement [formGroupName]="setIndex">
                                                <!-- Collapsed Set View -->
                                                <div *ngIf="!isSetExpanded(exIndex, setIndex)">
                                                    <ng-container
                                                        *ngLet="getVisibleColumnsForExercise(exIndex) as visibleCols">
                                                        <div (click)="toggleSetExpansion(exIndex, setIndex, $event)"
                                                            class="flex items-center gap-x-3 py-1.5 px-2 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800/60 cursor-pointer border dark:border-gray-700 dark:text-white"
                                                            [ngClass]="[getGridClassForExercise(exIndex)]" [ngClass]="{ 'bg-gray-50 dark:bg-gray-700/50': setControl.get('type')?.value === 'standard',
                                                                 'bg-blue-50 dark:bg-blue-700/50': setControl.get('type')?.value === 'warmup' 
                                                             }">

                                                            <!-- Set Number (Fixed Width, Non-Shrinking) -->
                                                            <div
                                                                class="flex-shrink-0 w-8 text-s text-center font-medium">
                                                                #{{ setIndex + 1 }}</div>

                                                            <!-- Middle Container that Grows -->
                                                            <div class="flex-grow min-w-0">
                                                                <div class="flex items-center justify-start gap-x-4">
                                                                    <div *ngIf="visibleCols[metricEnum.reps]"
                                                                        class="w-16 text-s text-center truncate">
                                                                        {{ mode === 'routineBuilder' ?
                                                                        getSetDisplayValue(setControl, metricEnum.reps)
                                                                        :
                                                                        (setControl.get('repsLogged')?.value ?? '-')
                                                                        }}
                                                                    </div>
                                                                    <div *ngIf="visibleCols[metricEnum.weight]"
                                                                        class="w-20 text-s text-center truncate">
                                                                        {{ mode === 'routineBuilder' ?
                                                                        getSetDisplayValue(setControl,
                                                                        metricEnum.weight)
                                                                        :
                                                                        (setControl.get('weightLogged')?.value ?? '-')
                                                                        }}
                                                                    </div>
                                                                    <div *ngIf="visibleCols[metricEnum.distance]"
                                                                        class="w-20 text-s text-center truncate">
                                                                        {{ mode === 'routineBuilder' ?
                                                                        getSetDisplayValue(setControl,
                                                                        metricEnum.distance)
                                                                        :
                                                                        (setControl.get('distanceLogged')?.value ?? '-')
                                                                        }}
                                                                    </div>
                                                                    <div *ngIf="visibleCols[metricEnum.duration]"
                                                                        class="w-16 text-s text-center truncate">
                                                                        {{ mode === 'routineBuilder' ?
                                                                        getSetDisplayValue(setControl,
                                                                        metricEnum.duration)
                                                                        :
                                                                        (setControl.get('durationLogged')?.value ?? '-')
                                                                        }}
                                                                    </div>
                                                                    <div *ngIf="visibleCols[metricEnum.rest]"
                                                                        class="w-24 text-s text-center truncate">
                                                                        {{ mode === 'routineBuilder' ?
                                                                        getSetDisplayValue(setControl, metricEnum.rest)
                                                                        :
                                                                        (setControl.get('restLogged')?.value ?? '-')
                                                                        }}
                                                                    </div>
                                                                    <!-- <div id="notes" *ngIf="setControl?.value?.notes"
                                                                        class="w-16 text-s text-center truncate">
                                                                        {{ mode === 'routineBuilder' ?
                                                                        ((setControl.get('notes')?.value) ?
                                                                        (setControl.get('notes')?.value) : '-') : ''
                                                                        }}
                                                                    </div> -->
                                                                </div>
                                                            </div>

                                                            <!-- Remove Button (Fixed Width, Non-Shrinking, Pushed to the Right) -->
                                                            <div class="flex-shrink-0">
                                                                <button appBumpClick type="button"
                                                                    (click)="removeSet(exerciseControl, exIndex, setIndex, $event)"
                                                                    [title]="'workoutBuilder.set.removeSet' | translate"
                                                                    class="flex items-center text-red-500 hover:text-red-600 dark:text-red-400 dark:hover:text-red-300 p-0.5 rounded-full hover:bg-red-100 dark:hover:bg-red-900/30">
                                                                    <app-icon name="cancel" class="h-4 w-4"></app-icon>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </ng-container>
                                                </div>


                                                <!-- Expanded Set Form -->
                                                <div #expandedSetElement *ngIf="isSetExpanded(exIndex, setIndex)"
                                                    class="p-1 rounded-xl shadow-inner space-y-2 border-gray-400 ring-1 dark:ring-gray-500 z-10"
                                                    [ngClass]="{
                                                            'bg-gray-100 dark:bg-gray-800/50': !['warmup', 'dropset', 'failure', 'amrap', 'myorep', 'restpause'].includes(setControl.get('type')?.value ?? ''),
                                                            'bg-blue-100 dark:bg-blue-800/50': setControl.get('type')?.value === 'warmup',
                                                        }">
                                                    <div (click)="toggleSetExpansion(exIndex, setIndex, $event)"
                                                        [ngClass]="setLabelClass(exerciseControl)">
                                                        #{{setIndex+1}} {{isSuperSet(exIndex) ?
                                                        ('workoutBuilder.set.round' |
                                                        translate):('workoutBuilder.set.set' | translate)}}
                                                        <div class="flex items-center justify-end">
                                                            <div *ngIf="isEditableMode()"
                                                                class="flex w-fit items-center justify-center gap-1 bg-gray-200 dark:bg-gray-900/70 p-2 rounded-full">
                                                                <!-- Remove metric button -->
                                                                <button appBumpClick type="button"
                                                                    (click)="removeSet(exerciseControl, exIndex, setIndex, $event)"
                                                                    [title]="'workoutBuilder.set.removeSet' | translate"
                                                                    class="flex items-center text-red-500 hover:text-red-600 dark:text-red-400 dark:hover:text-red-300 p-0.5 rounded-full hover:bg-red-100 dark:hover:bg-red-900/30">
                                                                    <app-icon name="cancel" class="h-4 w-4"></app-icon>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!-- ADD/REMOVE METRICS BUTTONS -->
                                                    <div class="flex items-center justify-center">
                                                        <div *ngIf="isEditableMode() && !isSuperSet(exIndex)"
                                                            class="flex w-fit items-center justify-center gap-1 bg-gray-200 dark:bg-gray-900/70 py-1 px-2 rounded-full">
                                                            <!-- Remove metric button -->
                                                            <label
                                                                class="flex items-center justify-between text-s font-medium text-gray-600 dark:text-gray-400">{{
                                                                'workoutBuilder.set.metrics' | translate }}:</label>
                                                            <button
                                                                (click)="promptRemoveField(exIndex, setIndex); $event.stopPropagation()"
                                                                class="p-1.5 rounded-full bg-red-500 dark:bg-red-500/80 hover:bg-red-500 text-white disabled:opacity-50 flex items-center">
                                                                <app-icon name="minus"
                                                                    class="h-5 w-5"></app-icon>
                                                            </button>
                                                            <!-- ADD metric -->
                                                            <button
                                                                *ngIf="getFieldsForSet(exIndex, setIndex).hidden.length > 0"
                                                                (click)="promptAddField(exIndex, setIndex); $event.stopPropagation()"
                                                                class="p-1.5 rounded-full bg-blue-500 dark:bg-blue-500/80 hover:bg-blue-500 text-white disabled:opacity-50 flex items-center">
                                                                <app-icon name="plus" class="h-5 w-5"></app-icon>
                                                            </button>
                                                        </div>

                                                    </div>
                                                    <div
                                                        class="grid grid-cols-2 sm:grid-cols-3 gap-x-3 gap-y-2 items-end">
                                                        <div class="col-span-full sm:col-span-1">
                                                            <label [for]="'setType-exp-' + exIndex + '-' + setIndex"
                                                                class="block text-s font-medium text-gray-600 dark:text-gray-400">{{
                                                                'workoutBuilder.set.type' | translate }}</label>
                                                            <select [id]="'setType-exp-' + exIndex + '-' + setIndex"
                                                                formControlName="type" [disabled]="isViewMode"
                                                                class="mt-0.5 w-full p-1.5 text-m border-gray-300 dark:border-gray-500 rounded-xl dark:bg-gray-600 dark:text-gray-200 disabled:opacity-70 disabled:cursor-not-allowed">
                                                                <option *ngFor="let typeOpt of availableSetTypes"
                                                                    [value]="typeOpt.value">{{ typeOpt.label }}</option>
                                                            </select>
                                                        </div>
                                                        <!-- =================== START OF DYNAMIC FIELD RENDERING =================== -->
                                                        <!-- Get the fieldOrder array from the form control -->
                                                        <ng-container
                                                            *ngIf="setControl.get('fieldOrder')?.value as fieldOrder">

                                                            <!-- Loop through the fieldOrder array which dictates the rendering order -->
                                                            <ng-container *ngFor="let field of fieldOrder">
                                                                <!-- Use ng-container with ngSwitch to render the correct template for each field -->
                                                                <ng-container [ngSwitch]="field">
                                                                    <div *ngSwitchCase="metricEnum.reps">
                                                                        <ng-container
                                                                            [ngTemplateOutlet]="repsInputTemplate"
                                                                            [ngTemplateOutletContext]="{exerciseControl: exerciseControl, setControl: setControl, exIndex: exIndex, setIndex: setIndex }"></ng-container>
                                                                    </div>
                                                                    <div *ngSwitchCase="metricEnum.weight">
                                                                        <ng-container
                                                                            [ngTemplateOutlet]="weightInputTemplate"
                                                                            [ngTemplateOutletContext]="{exerciseControl: exerciseControl, setControl: setControl, exIndex: exIndex, setIndex: setIndex }"></ng-container>
                                                                    </div>
                                                                    <div *ngSwitchCase="metricEnum.distance">
                                                                        <ng-container>
                                                                            <ng-container
                                                                                [ngTemplateOutlet]="distanceInputTemplate"
                                                                                [ngTemplateOutletContext]="{exerciseControl: exerciseControl, setControl: setControl, exIndex: exIndex, setIndex: setIndex }"></ng-container>
                                                                        </ng-container>
                                                                    </div>
                                                                    <div *ngSwitchCase="metricEnum.duration">
                                                                        <ng-container>
                                                                            <ng-container
                                                                                [ngTemplateOutlet]="durationInputTemplate"
                                                                                [ngTemplateOutletContext]="{exerciseControl: exerciseControl, setControl: setControl, exIndex: exIndex, setIndex: setIndex }"></ng-container>
                                                                        </ng-container>
                                                                    </div>
                                                                    <div *ngSwitchCase="metricEnum.tempo">
                                                                        <ng-container
                                                                            [ngTemplateOutlet]="tempoInputTemplate"
                                                                            [ngTemplateOutletContext]="{ setControl: setControl, exIndex: exIndex, setIndex: setIndex }"></ng-container>
                                                                    </div>
                                                                    <div *ngSwitchCase="metricEnum.rest">
                                                                        <ng-container
                                                                            [ngTemplateOutlet]="restInputTemplate"
                                                                            [ngTemplateOutletContext]="{ setControl: setControl, exIndex: exIndex, setIndex: setIndex }"></ng-container>
                                                                    </div>
                                                                </ng-container>
                                                            </ng-container>

                                                            <!-- GHOST BUTTON LOGIC -->
                                                            <!-- Renders in the next available grid slot if there are fields left to add -->
                                                            <div *ngIf="isGhostFieldVisible(fieldOrder, exIndex)"
                                                                class="flex items-center justify-center h-full">
                                                                <button
                                                                    (click)="promptAddField(exIndex, setIndex); $event.stopPropagation()"
                                                                    class="flex items-center justify-center w-full p-2 h-16 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl text-gray-400 hover:bg-gray-200/50 dark:hover:bg-gray-700/50 transition-colors">
                                                                    <app-icon name="plus-circle"
                                                                        class="h-6 w-6"></app-icon>
                                                                </button>
                                                            </div>
                                                        </ng-container>
                                                        <!-- =================== END OF DYNAMIC FIELD RENDERING =================== -->



                                                    </div>
                                                    <!-- Expanded set - SET NOTES -->
                                                    <div *ngIf="setControl.get('notes')?.value">
                                                        <label [for]="'setNotes-' + exIndex + setIndex"
                                                            class="block text-s font-medium text-gray-600 dark:text-gray-400 mb-0.5">
                                                            {{ (mode === 'routineBuilder' ? 'workoutBuilder.set.notes' :
                                                            'workoutBuilder.set.notes') | translate }}
                                                        </label>
                                                        <textarea [id]="'setNotes-' + exIndex + setIndex"
                                                            formControlName="notes" rows="1" appAutoGrow
                                                            class="mt-0.5 mb-2 block w-full p-1.5 text-sm border-gray-300 dark:border-gray-500 rounded-xl shadow-sm dark:bg-gray-600 dark:text-gray-200"
                                                            [readonly]="isViewMode"></textarea>
                                                    </div>
                                                </div>

                                            </div>
                                        </div>
                                        <!-- Col 2: Set +/- SETS Buttons -->
                                        <div *ngIf="!isSuperSet(exIndex)" class="flex items-center justify-center py-2">
                                            <div
                                                class="flex w-fit items-center justify-center gap-1 bg-gray-200 dark:bg-gray-900/70 py-1 px-2 rounded-full shadow-md">
                                                <label
                                                    class="flex items-center justify-between text-s font-medium text-gray-600 dark:text-gray-400">{{'workoutBuilder.set.set'
                                                    |
                                                    translate}}:</label>
                                                <button appBumpClick type="button"(click)="removeLastSet(exerciseControl, $event)"
                                                    class="p-1.5 rounded-full bg-red-500 dark:bg-red-500/80 hover:bg-red-500 text-white disabled:opacity-50 flex items-center"
                                                    [aria-label]="'workoutBuilder.set.removeLastSet' | translate">
                                                    <app-icon name="minus" class="h-5 w-5"></app-icon>
                                                </button>
                                                <button appBumpClick type="button"
                                                    (click)="addSet(exerciseControl, exIndex); $event.stopPropagation()"
                                                    class="p-1.5 rounded-full bg-green-500 dark:bg-green-500/80 hover:bg-green-500 text-white flex items-center"
                                                    [aria-label]="'workoutBuilder.set.addSet' | translate">
                                                    <app-icon name="plus" class="h-5 w-5"></app-icon>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- EXPANDED Only EDIT MODE - END -->
                                </div>
                            </div>

                            <!-- Col 2: Round +/- Buttons -->

                            <div #superSetControlPanel_rounds class="flex items-center justify-center py-2"
                                *ngIf="isEditableMode() && isSuperSet(exIndex) && isLastInSuperset(exIndex)">
                                <div
                                    class="flex w-fit items-center justify-center gap-1 bg-gray-200 dark:bg-gray-900/70 py-1 px-2 rounded-full">
                                    <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">
                                        {{ 'workoutBuilder.superset.rounds' | translate }}:
                                    </span>
                                    <button appBumpClick type="button"(click)="removeRoundFromSuperset(exerciseControl, $event)"
                                        [disabled]="getSetsFormArray(exerciseControl).length <= 1"
                                        class="p-1.5 rounded-full bg-red-500 dark:bg-red-500/80 hover:bg-red-500 text-white disabled:opacity-50 flex items-center"
                                        [aria-label]="'workoutBuilder.set.removeLastSet' | translate">
                                        <app-icon name="minus" class="h-6 w-6"></app-icon>
                                    </button>
                                    <button appBumpClick type="button"(click)="addRoundToSuperset(exerciseControl, $event)"
                                        class="p-1.5 rounded-full bg-green-500 dark:bg-green-500/80 hover:bg-green-500 text-white disabled:opacity-50 flex items-center"
                                        [aria-label]="'workoutBuilder.set.addSet' | translate">
                                        <app-icon name="plus" class="h-6 w-6"></app-icon>
                                    </button>
                                </div>


                            </div>
                        </div>
                        <div class="absolute top-1 right-1 z-20" [ngClass]="{ 'top-3': isSuperSet(exIndex) }">
                            <!-- Expanded View Actions (Delete, Fill, EMOM, Switch, More Actions Menu) -->
                            <div *ngIf="isEditableMode()&& (!isSuperSet(exIndex) || (isSuperSet(exIndex) && isFirstInSuperset(exIndex)))"
                                class="flex items-center space-x-1">
                                <!-- The "More Actions" Menu Itself -->
                                <div class="relative" #exerciseActionMenuContainer>
                                    <button appBumpClick (click)="toggleExerciseActionMenu(exIndex, $event)"
                                        class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-500 rounded-full focus:outline-none flex items-center">
                                        <app-icon name="menu-action" class="h-10 w-10"></app-icon>
                                    </button>
                                    <app-action-menu *ngIf="isExerciseActionMenuVisible(exIndex)" displayMode="dropdown"
                                        [items]="getExerciseActionMenuItems(exerciseControl)"
                                        [isVisible]="isExerciseActionMenuVisible(exIndex)"
                                        (itemClick)="handleExerciseActionMenuItemClick($event, exIndex, exerciseControl)"
                                        (closeMenu)="closeExerciseActionMenu()">
                                    </app-action-menu>
                                </div>
                            </div>
                        </div>

                    </div>
                </ng-container>
            </div>

            <div *ngIf="mode === 'manualLogEntry' && exercisesFormArray.length === 0 && !builderForm.get('routineIdForLog')?.value"
                class="text-center text-gray-500 dark:text-gray-400 border border-dashed dark:border-gray-700 rounded-xl mt-4">
                <p class="mb-2">Select a routine or ADD EXERCISEs manually to log</p>
                <button appBumpClick type="button" (click)="openExerciseSelectionModal()"
                    class="bg-green-500 hover:bg-green-600 text-white text-m font-medium py-2 px-3 rounded-xl">
                    + {{ 'workoutBuilder.logEntry.addFirstExercise' | translate }}
                </button>
            </div>
            <div *ngIf="mode === 'manualLogEntry' && exercisesFormArray.length === 0 && builderForm.get('routineIdForLog')?.value"
                class="text-center py-4 text-gray-500 dark:text-gray-400">
                {{ 'workoutBuilder.logEntry.noExercisesInRoutine' | translate }}
            </div>
        </section>

        <section *ngIf="builderForm.get('goal')?.value === metricEnum.rest"
            class="p-4 bg-blue-50 dark:bg-blue-900/30 rounded-xl text-center">
            <p class="text-m text-blue-700 dark:text-blue-300">{{ 'workoutBuilder.restDayMessage' | translate }}</p>
        </section>

        <div *ngIf="!isViewMode" class="py-2 px-1 flex-col gap-2 flex items-center">

            <div *ngIf="mode !== 'manualLogEntry' && (builderForm.get('goal')?.value !== metricEnum.rest)"
                class="text-center text-gray-500 dark:text-gray-400 border border-dashed dark:border-gray-700 rounded-xl mt-4">
                <button appBumpClick type="button" (click)="openExerciseSelectionModal()"
                    class="flex items-center justify-center px-4 py-2 border border-transparent rounded-xl shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-800 disabled:opacity-50 min-w-[220px] ">
                    <app-icon name="plus-circle" class="h-6 w-6 mr-1"></app-icon>
                    <!-- Button Text -->
                    {{ 'workoutBuilder.addExerciseButton' | translate }}
                </button>
            </div>

            <!-- Button 2: SUBMIT -->
            <button appBumpClick type="button" [disabled]="isFormInvalid()" (click)="onSubmit()"
                class="flex items-center justify-center px-4 py-2 border border-transparent rounded-xl shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-dark disabled:opacity-50 min-w-[220px]">
                <app-icon name="save" class="h-6 w-6 mr-1"></app-icon>
                <!-- Button Text -->
                {{ (mode === 'routineBuilder' ? 'workoutBuilder.routineBuilder.saveButton' : (isNewMode ?
                'workoutBuilder.logEntry.logButton' : 'workoutBuilder.logEntry.saveLogButton')) | translate }}
            </button>

            <!-- WORKOUT GENERATOR -->
            <div *ngIf="isGeneratedRoutine()">
                <button appBumpClick *ngIf="isGeneratedRoutine()" type="button" (click)="regenerateWorkout()"
                    class="flex items-center justify-center px-4 py-2 border border-transparent rounded-xl shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 min-w-[220px]">
                    <app-icon name="random" class="h-6 w-6 mr-1"></app-icon>
                    {{'workoutBuilder.buttons.regenButton' | translate }}
                </button>
            </div>

        </div>
    </form>
</div>

<app-exercise-selection-modal [isOpen]="isExerciseModalOpen" [(searchTerm)]="modalSearchTerm" [isMultiSelect]="true"
    [title]="'workoutBuilder.modal.addTitle' | translate" [exercises]="availableExercises" itemIconName="plus-circle"
    itemIconClass="text-primary dark:text-primary-light" (exercisesSelected)="selectExercisesFromLibrary($event)"
    (createCustomClicked)="handleTrulyCustomExerciseEntry()" (close)="closeExerciseSelectionModal()">
</app-exercise-selection-modal>

<app-exercise-selection-modal [isOpen]="isSwitchExerciseModalOpen()" [(searchTerm)]="modalSearchTerm"
    [title]="(isShowingSimilarInSwitchModal() ? 'workoutBuilder.modal.similarTitle' : 'workoutBuilder.modal.switchTitle') | translate"
    [exercises]="exercisesForSwitchModal()" [searchPlaceholder]="'workoutBuilder.modal.searchPlaceholder' | translate"
    [showSimilarButton]="true" [isShowingSimilarView]="isShowingSimilarInSwitchModal()" itemIconName="change"
    itemIconClass="text-green-500" (exerciseSelected)="handleExerciseSwitch($event)"
    (findSimilarClicked)="findAndShowSimilarExercises()" (backToSearchClicked)="onBackToSearchFromSimilar()"
    (close)="closeSwitchExerciseModal()">
</app-exercise-selection-modal>

<!-- NOTES MODAL -->
<app-modal *ngIf="notesModalsData() as data" [isOpen]="!!data" (isOpenChange)="notesModalsData.set(null)"
    [modalTitle]="'workoutBuilder.modal.notesTitle' | translate">

    <div class="flex flex-col p-4 text-left text-gray-700 dark:text-gray-200">
        <textarea [disabled]="true" class="font-semibold pb-2 dark:border-gray-600 dark:bg-gray-800" name=""
            id="">{{data}}</textarea>
        <div class="flex justify-center">
            <button appBumpClick (click)="notesModalsData.set(null)"
                class="w-fit px-4 py-2 bg-primary text-white rounded-xl hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary-light flex items-center">
                <app-icon name="done" class="h-6 w-6 mr-1"></app-icon>
                {{ 'workoutBuilder.modal.close' | translate }}
            </button>
        </div>
    </div>

</app-modal>

<app-modal [forceFullScreen]="true" *ngIf="exerciseDetailsId" [(isOpen)]="isSimpleModalOpen"
    [modalTitle]="exerciseDetailsName">
    <app-exercise-detail [id]="exerciseDetailsId" [isModal]="true"></app-exercise-detail>
</app-modal>

<app-fab-menu [actions]="fabMenuItems" [checkForPausedSession]="false" [scrollToBottomDisabled]="true"
    [scrollToTopDisabled]="true" (actionClicked)="onFabAction($event)">
</app-fab-menu>


<!-- DISTANCE INPUT TEMPLATE -->
<ng-template #distanceInputTemplate let-setControl="setControl" let-exIndex="exIndex" let-setIndex="setIndex">
    <div [formGroup]="setControl">
        <label [for]="'distance-exp-' + exIndex + '-' + setIndex"
            class="flex items-center justify-between text-s font-medium text-gray-600 dark:text-gray-400">
            <span>{{ 'workoutBuilder.set.distance' | translate }}
                ({{unitService.getDistanceMeasureUnitSuffix()}})</span>
            <button *ngIf="mode === 'routineBuilder'" type="button" (click)="toggleDistanceMode(setControl, $event)"
                [title]="'workoutBuilder.set.toggleRange' | translate"
                class="text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-semibold p-0.5 rounded">
                {{ (isRangeMode(setControl, metricEnum.distance) ? 'workoutBuilder.set.useSingle' :
                'workoutBuilder.set.useRange') |
                translate }}
            </button>
        </label>
        <!-- ROUTINE BUILDER - DISTANCE -->
        <ng-container *ngIf="mode === 'routineBuilder'">
            <div *ngIf="isRangeMode(setControl, metricEnum.distance)" class="mt-0.5">
                <div class="wrapper_ranged_input_number_class">
                    <input type="number" formControlName="targetDistanceMin" min="0" placeholder="Min"
                        [readonly]="isViewMode" class="input_number_class">
                    <span class="input_number_class_separator">-</span>
                    <input type="number" formControlName="targetDistanceMax" min="0" placeholder="Max"
                        [readonly]="isViewMode" class="input_number_class">
                </div>
            </div>
            <ng-container *ngIf="!isRangeMode(setControl, metricEnum.distance)">
                <ng-container [ngTemplateOutlet]="incrementerInputTemplate"
                    [ngTemplateOutletContext]="{ setControl: setControl, field: metricEnum.distance }"></ng-container>
            </ng-container>
        </ng-container>
        <!-- LOG ENTRY - SINGLE DISTANCE ACHIEVED -->
        <ng-container *ngIf="mode === 'manualLogEntry'">
            <ng-container [ngTemplateOutlet]="incrementerInputTemplate"
                [ngTemplateOutletContext]="{ setControl: setControl, field: metricEnum.distance }"></ng-container>
        </ng-container>
    </div>
</ng-template>


<!-- DURATION INPUT TEMPLATE -->
<ng-template #durationInputTemplate let-setControl="setControl" let-exIndex="exIndex" let-setIndex="setIndex">
    <div [formGroup]="setControl">
        <label [for]="'duration-exp-' + exIndex + '-' + setIndex"
            class="flex items-center justify-between text-s font-medium text-gray-600 dark:text-gray-400">
            <span>{{ 'workoutBuilder.set.time' | translate }} (s) </span>
            <button *ngIf="mode === 'routineBuilder'" type="button" (click)="toggleDurationMode(setControl, $event)"
                [title]="'workoutBuilder.set.toggleRange' | translate"
                class="text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-semibold p-0.5 rounded">
                {{ (isRangeMode(setControl, metricEnum.duration) ? 'workoutBuilder.set.useSingle' :
                'workoutBuilder.set.useRange') |
                translate }}
            </button>
        </label>
        <!-- ROUTINE BUILDER - DURATION -->
        <ng-container *ngIf="mode === 'routineBuilder'">
            <div *ngIf="isRangeMode(setControl, metricEnum.duration)" class="mt-0.5">
                <div class="wrapper_ranged_input_number_class">
                    <input type="number" formControlName="targetDurationMin" min="0" placeholder="Min"
                        [readonly]="isViewMode" class="input_number_class">
                    <span class="input_number_class_separator">-</span>
                    <input type="number" formControlName="targetDurationMax" min="0" placeholder="Max"
                        [readonly]="isViewMode" class="input_number_class"
                        [ngClass]="{'border-red-500 dark:border-red-400': setControl.get('targetDurationMax')?.hasError('min')}">
                </div>
                <div *ngIf="setControl.get('targetDurationMax')?.hasError('min') && setControl.get('targetDurationMax')?.touched"
                    class="text-red-500 dark:text-red-400 text-xs mt-1">
                    {{ 'workoutBuilder.set.rangeError' | translate }}
                </div>
            </div>
            <ng-container *ngIf="!isRangeMode(setControl, metricEnum.duration)">
                <ng-container [ngTemplateOutlet]="incrementerInputTemplate"
                    [ngTemplateOutletContext]="{ setControl: setControl, field: metricEnum.duration }"></ng-container>
            </ng-container>
        </ng-container>
        <!-- LOG ENTRY - SINGLE DURATION PERFORMED -->
        <ng-container *ngIf="mode === 'manualLogEntry'">
            <ng-container [ngTemplateOutlet]="incrementerInputTemplate"
                [ngTemplateOutletContext]="{ setControl: setControl, field: metricEnum.duration }"></ng-container>
        </ng-container>
    </div>
</ng-template>

<!-- TEMPO INPUT TEMPLATE -->
<ng-template #tempoInputTemplate let-setControl="setControl" let-exIndex="exIndex" let-setIndex="setIndex">
    <div [formGroup]="setControl">
        <label [for]="'tempo-exp-' + exIndex + '-' + setIndex"
            class="flex items-center justify-between text-s font-medium text-gray-600 dark:text-gray-400">
            <span>{{ 'workoutBuilder.set.tempo' | translate }}</span>
        </label>
        <!-- ROUTINE BUILDER - TEMPO -->
        <ng-container *ngIf="mode === 'routineBuilder'">
            <input type="text" formControlName="targetTempo"
                [placeholder]="'workoutBuilder.set.tempoPlaceholder' | translate" [readonly]="isViewMode"
                class="mt-0.5 input_number_class">
        </ng-container>
        <!-- LOG ENTRY - SINGLE TEMPO -->
        <input *ngIf="mode === 'manualLogEntry'" type="text" [id]="'tempo-exp-' + exIndex + '-' + setIndex"
            formControlName="targetTempo" [placeholder]="'workoutBuilder.set.tempoPlaceholder' | translate"
            [readonly]="isViewMode" class="mt-0.5 input_number_class">
    </div>
</ng-template>

<!-- REST INPUT TEMPLATE -->
<ng-template #restInputTemplate let-setControl="setControl" let-exIndex="exIndex" let-setIndex="setIndex">
    <div [formGroup]="setControl">
        <label [for]="'rest-exp-' + exIndex + '-' + setIndex"
            class="flex items-center justify-between text-s font-medium text-gray-600 dark:text-gray-400">
            <span>{{ 'workoutBuilder.set.rest' | translate }} (s) </span>
            <button *ngIf="mode === 'routineBuilder'" type="button" (click)="toggleRestMode(setControl, $event)"
                [title]="'workoutBuilder.set.toggleRange' | translate"
                class="text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-semibold p-0.5 rounded">
                {{ (isRangeMode(setControl, metricEnum.rest) ? 'workoutBuilder.set.useSingle' :
                'workoutBuilder.set.useRange') |
                translate }}
            </button>
        </label>
        <!-- ROUTINE BUILDER - REST -->
        <ng-container *ngIf="mode === 'routineBuilder'">
            <div *ngIf="isRangeMode(setControl, metricEnum.rest)" class="mt-0.5">
                <div class="wrapper_ranged_input_number_class">
                    <input type="number" formControlName="targetRestMin" min="0" placeholder="Min"
                        [readonly]="isViewMode" class="input_number_class">
                    <span class="input_number_class_separator">-</span>
                    <input type="number" formControlName="targetRestMax" min="0" placeholder="Max"
                        [readonly]="isViewMode" class="input_number_class"
                        [ngClass]="{'border-red-500 dark:border-red-400': setControl.get('targetRestMax')?.hasError('min')}">
                </div>
                <div *ngIf="setControl.get('targetRestMax')?.hasError('min') && setControl.get('targetRestMax')?.touched"
                    class="text-red-500 dark:text-red-400 text-xs mt-1">
                    {{ 'workoutBuilder.set.rangeError' | translate }}
                </div>
            </div>
            <ng-container *ngIf="!isRangeMode(setControl, metricEnum.rest)">
                <ng-container [ngTemplateOutlet]="incrementerInputTemplate"
                    [ngTemplateOutletContext]="{ setControl: setControl, field: metricEnum.rest }"></ng-container>
            </ng-container>
        </ng-container>
        <!-- LOG ENTRY - SINGLE REST USED -->
        <ng-container *ngIf="mode === 'manualLogEntry'">
            <ng-container [ngTemplateOutlet]="incrementerInputTemplate"
                [ngTemplateOutletContext]="{ setControl: setControl, field: metricEnum.rest }"></ng-container>
        </ng-container>
    </div>
</ng-template>

<app-generate-workout-modal [isOpen]="isGeneratorModalOpen()" (close)="isGeneratorModalOpen.set(false)"
    (generate)="handleWorkoutGeneration($event)">
</app-generate-workout-modal>


<ng-template #incrementerInputTemplate let-setControl="setControl" let-field="field">
    <!-- THE FIX: Add [formGroup]="setControl" here to provide context to the input inside -->
    <div [formGroup]="setControl">
        <div class="flex items-stretch w-full shadow-sm mt-0.5">
            <button appBumpClick type="button"appPress (shortPress)="onShortPressDecrement(setControl, field)"
                (longPress)="onLongPressDecrement(setControl, field)" (pressRelease)="onPressRelease()"
                class="flex items-center p-1 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-l-xl border-y border-l border-gray-200 dark:border-gray-700 transition-colors">
                <app-icon name="minus" class="h-5 w-5 pointer-events-none"></app-icon>
            </button>

            <div class="flex items-center w-full p-0.5 justify-center bg-gray-200 dark:bg-gray-700">
                <!-- <input [type]="(field === metricEnum.duration || field === metricEnum.rest) ? 'text' : 'number'" -->
                <input [type]="'number'" [formControlName]="getFormControlName(field)" [readonly]="isViewMode"
                    class="w-full p-1.5 text-center text-m font-bold bg-gray-50 dark:bg-gray-800 border-y border-gray-200 dark:border-gray-700 text-black dark:text-gray-200 focus:ring-2 focus:ring-primary dark:focus:ring-primary-light focus:outline-none z-10 relative rounded-xl">

            </div>


            <button appBumpClick type="button"appPress (shortPress)="onShortPressIncrement(setControl, field)"
                (longPress)="onLongPressIncrement(setControl, field)" (pressRelease)="onPressRelease()"
                class="flex items-center p-1 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-r-xl border-y border-r border-gray-200 dark:border-gray-700 transition-colors">
                <app-icon name="plus" class="h-5 w-5 pointer-events-none"></app-icon>
            </button>
        </div>
    </div>
</ng-template>

<!-- REPS INPUT TEMPLATE -->
<ng-template #repsInputTemplate let-setControl="setControl" let-exIndex="exIndex" let-setIndex="setIndex">
    <!-- THE FIX: The [formGroup] directive is put back here -->
    <div [formGroup]="setControl">
        <label [for]="'reps-exp-' + exIndex + '-' + setIndex"
            class="flex items-center justify-between text-s font-medium text-gray-600 dark:text-gray-400">
            <span>{{ 'workoutBuilder.set.reps' | translate }} </span>
            <button *ngIf="mode === 'routineBuilder'" type="button" (click)="toggleRepsMode(setControl, $event)"
                [title]="'workoutBuilder.set.toggleRange' | translate"
                class="text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-semibold p-0.5 rounded">
                {{ (isRangeMode(setControl, metricEnum.reps) ? 'workoutBuilder.set.useSingle' :
                'workoutBuilder.set.useRange') | translate }}
            </button>
        </label>

        <ng-container *ngIf="mode === 'routineBuilder'">
            <div *ngIf="isRangeMode(setControl, metricEnum.reps)" class="mt-0.5">
                <div class="wrapper_ranged_input_number_class">
                    <input type="number" formControlName="targetRepsMin" min="0" placeholder="Min"
                        [readonly]="isViewMode" class="input_number_class">
                    <span class="input_number_class_separator">-</span>
                    <input type="number" formControlName="targetRepsMax" min="0" placeholder="Max"
                        [readonly]="isViewMode" class="input_number_class"
                        [ngClass]="{'border-red-500 dark:border-red-400': setControl.get('targetRepsMax')?.hasError('min')}">
                </div>
            </div>
            <ng-container *ngIf="!isRangeMode(setControl, metricEnum.reps)">
                <ng-container [ngTemplateOutlet]="incrementerInputTemplate"
                    [ngTemplateOutletContext]="{ setControl: setControl, field: metricEnum.reps }"></ng-container>
            </ng-container>
        </ng-container>

        <ng-container *ngIf="mode === 'manualLogEntry'">
            <ng-container [ngTemplateOutlet]="incrementerInputTemplate"
                [ngTemplateOutletContext]="{ setControl: setControl, field: metricEnum.reps }"></ng-container>
        </ng-container>
    </div>
</ng-template>


<!-- WEIGHT INPUT TEMPLATE -->
<ng-template #weightInputTemplate let-setControl="setControl" let-exIndex="exIndex" let-setIndex="setIndex">
    <!-- THE FIX: The [formGroup] directive is put back here -->
    <div [formGroup]="setControl">
        <label [for]="'weight-exp-' + exIndex + '-' + setIndex"
            class="flex items-center justify-between text-s font-medium text-gray-600 dark:text-gray-400">
            <span>{{ 'workoutBuilder.set.weight' | translate }}
                ({{unitService.getWeightUnitSuffix()}})</span>
            <button *ngIf="mode === 'routineBuilder'" type="button" (click)="toggleWeightMode(setControl, $event)"
                [title]="'workoutBuilder.set.toggleRange' | translate"
                class="text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-semibold p-0.5 rounded">
                {{ (isRangeMode(setControl, metricEnum.weight) ? 'workoutBuilder.set.useSingle' :
                'workoutBuilder.set.useRange') | translate }}
            </button>
        </label>

        <ng-container *ngIf="mode === 'routineBuilder'">
            <div *ngIf="isRangeMode(setControl, metricEnum.weight)" class="mt-0.5">
                <div class="wrapper_ranged_input_number_class">
                    <input type="number" formControlName="targetWeightMin" min="0" placeholder="Min"
                        [readonly]="isViewMode" class="input_number_class">
                    <span class="input_number_class_separator">-</span>
                    <input type="number" formControlName="targetWeightMax" min="0" placeholder="Max"
                        [readonly]="isViewMode" class="input_number_class"
                        [ngClass]="{'border-red-500 dark:border-red-400': setControl.get('targetWeightMax')?.hasError('min')}">
                </div>
            </div>
            <ng-container *ngIf="!isRangeMode(setControl, metricEnum.weight)">
                <ng-container [ngTemplateOutlet]="incrementerInputTemplate"
                    [ngTemplateOutletContext]="{ setControl: setControl, field: metricEnum.weight }"></ng-container>
            </ng-container>
        </ng-container>

        <ng-container *ngIf="mode === 'manualLogEntry'">
            <ng-container [ngTemplateOutlet]="incrementerInputTemplate"
                [ngTemplateOutletContext]="{ setControl: setControl, field: metricEnum.weight }"></ng-container>
        </ng-container>
    </div>
</ng-template>



<div class="hidden p-2.5"></div>
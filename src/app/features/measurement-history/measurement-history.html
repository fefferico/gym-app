<div class="container mx-auto p-2 sm:p-4 text-gray-800 dark:text-gray-200">
    <!-- Header with Add Button -->
    <header class="flex justify-between items-center pb-4 border-b border-gray-200 dark:border-gray-700 mb-4">
        <h1 class="text-2xl font-bold">Measurement History</h1>
        <button (click)="openAddEntryModal()"
            class="px-4 py-2 bg-primary hover:bg-primary-dark text-white font-semibold rounded-md shadow-sm transition-colors inline-flex items-center text-sm">
            <app-icon name="plus-circle"></app-icon>
            ADD PAST ENTRY
        </button>
    </header>

    <section class="bg-white dark:bg-gray-800 p-4 rounded-md shadow-md mb-6">
        <h3 class="font-semibold mb-2">Side-by-Side Comparison</h3>
        <div class="flex flex-col sm:flex-row gap-4 items-center">

            <!--
          CHANGE: Call the new onCompareFromChange method and pass the $event object.
        -->
            <select (change)="onCompareFromChange($event)"
                class="flex-1 p-2 border dark:border-gray-600 rounded-md dark:bg-gray-700">
                <option value="">-- Select Start Date --</option>
                <option *ngFor="let entry of measurementHistory" [value]="entry.date">{{entry.date | date:'mediumDate'}}
                </option>
            </select>

            <!--
          CHANGE: Call the new onCompareToChange method and pass the $event object.
        -->
            <select (change)="onCompareToChange($event)"
                class="flex-1 p-2 border dark:border-gray-600 rounded-md dark:bg-gray-700">
                <option value="">-- Select End Date --</option>
                <option *ngFor="let entry of measurementHistory" [value]="entry.date">{{entry.date | date:'mediumDate'}}
                </option>
            </select>

            <!-- This part is already correct and does not need to be changed -->
            <button (click)="openCompareModal(compareFromDate, compareToDate)"
                [disabled]="!compareFromDate || !compareToDate"
                class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-md disabled:opacity-50 flex items-center">
                <app-icon name="magnifier" class="h-6 w-6 mr-1" [strokeWidth]="2"></app-icon>
                COMPARE
            </button>
        </div>
    </section>

    <div *ngIf="measurementHistory.length > 0; else noData">
        <!-- Chart Section with Goal Line -->
        <section class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-md shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Progress Chart</h2>
            <div class="mb-4">
                <select (change)="updateChart($event)"
                    class="p-2 border dark:border-gray-600 rounded-md dark:bg-gray-700">
                    <option *ngFor="let metric of availableMetrics" [value]="metric.key">{{ metric.label }}</option>
                </select>
            </div>
            <div class="w-full h-[300px]">
                <ngx-charts-line-chart [results]="chartData" [scheme]="colorScheme" [xAxis]="true" [yAxis]="true"
                    [legend]="true" [showXAxisLabel]="true" [showYAxisLabel]="true" [xAxisLabel]="'Date'"
                    [yAxisLabel]="yAxisLabel" [autoScale]="true" [referenceLines]="referenceLines">
                </ngx-charts-line-chart>
            </div>
        </section>

        <!-- History List with Notes & Image Zoom -->
        <section class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-md shadow-md">
            <h2 class="text-xl font-semibold mb-4">Log History</h2>
            <div *ngFor="let entry of measurementHistory" class="border-b dark:border-gray-700 py-4 last:border-b-0">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-start">
                    <!-- Left Column: Date, Photo, and DELETE BUTTON -->
                    <div class="flex flex-col items-center">
                        <p class="font-medium text-lg mb-2">{{ entry.date | date:'fullDate' }}</p>
                        <img *ngIf="entry.photoUrl" [src]="entry.photoUrl" (click)="openFullScreenImage(entry.photoUrl)"
                            alt="Progress photo"
                            class="w-24 h-24 object-cover rounded-md shadow-lg cursor-pointer hover:opacity-80 transition-opacity">
                        <label class="cursor-pointer text-sm text-primary dark:text-primary-dark hover:underline mt-2">
                            {{ entry.photoUrl ? 'Change Photo' : 'Add Photo' }}
                            <input type="file" accept="image/*" (change)="uploadPhoto($event, entry.date)"
                                class="hidden">
                        </label>
                        <div>
                            <button (click)="confirmDeleteEntry(entry.date)" title="Delete Entry"
                                class="p-1 rounded-full text-gray-400 hover:bg-red-100 hover:text-red-500 dark:hover:bg-red-900/50 transition-colors">
                                <app-icon name="trash" class="w-4 h-4"></app-icon>
                            </button>
                            <button (click)="editEntry(entry.date)" title="Edit Entry"
                                class="p-1 rounded-full text-gray-400 hover:bg-red-100 hover:text-red-500 dark:hover:bg-red-900/50 transition-colors">
                                <app-icon name="edit" class="w-4 h-4"></app-icon>
                            </button>
                        </div>
                    </div>
                    <!-- Middle Column: Measurements -->
                    <div class="text-sm grid grid-cols-2 gap-x-4 gap-y-1">
                        <p><strong>Weight:</strong> {{ entry.weightKg || 'N/A' }} kg</p>
                        <p><strong>Chest:</strong> {{ entry.chestCm || 'N/A' }} cm</p>
                        <p><strong>Waist:</strong> {{ entry.waistCm || 'N/A' }} cm</p>
                        <p><strong>Hips:</strong> {{ entry.hipsCm || 'N/A' }} cm</p>
                        <p><strong>Neck:</strong> {{ entry.neckCm || 'N/A' }} cm</p>
                        <p><strong>R. Arm:</strong> {{ entry.rightArmCm || 'N/A' }} cm</p>
                    </div>
                    <!-- Right Column: Notes -->
                    <div>
                        <label class="font-semibold text-sm">Notes:</label>
                        <textarea [value]="entry.notes || ''" (input)="updateNotes(entry.date, $event)"
                            placeholder="Add notes..."
                            class="w-full p-2 mt-1 border rounded-md dark:bg-gray-700 dark:border-gray-600 h-24"></textarea>
                    </div>
                </div>
            </div>
        </section>
    </div>
    <ng-template #noData>
        <div class="text-center bg-white dark:bg-gray-800 p-10 rounded-md shadow-md">
            <p class="text-lg">No measurement history found.</p>
            <p class="text-gray-500 dark:text-gray-400 mt-2">Go to your profile settings to add your first entry!</p>
        </div>
    </ng-template>
</div>

<!-- MODALS -->
<!-- Full Screen Image Modal -->
<div *ngIf="fullScreenImageUrl" (click)="closeFullScreenImage()"
    class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
    <img [src]="fullScreenImageUrl" class="max-w-full max-h-full object-contain">
</div>

<!-- Add/Edit Entry Modal -->
<div *ngIf="isAddEntryModalOpen"
    class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 text-gray-800 dark:text-gray-200 backdrop-blur-sm animate-fade-in">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
        <h2 class="text-xl font-bold mb-4">Add Measurement Entry</h2>
        <form [formGroup]="entryForm" (ngSubmit)="saveEntry()">
            <label for="date" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Date</label>
            <input type="date" formControlName="date" id="date"
                class="w-full p-2 border rounded mb-4 dark:bg-gray-700 dark:border-gray-600">
            <!-- Add inputs for weight, waist, neck, etc. from entryForm -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="weightKg" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Target
                        Weight (kg)</label>
                    <input type="number" formControlName="weightKg" id="weightKg" placeholder="Weight (kg)"
                        class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                </div>
                <!-- Add all other measurement inputs here -->
                <div>
                    <label for="chestCm" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Chest
                        (cm)</label>
                    <input type="number" formControlName="chestCm" id="chestCm" placeholder="Chest (cm)"
                        class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div>
                    <label for="waistCm" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Waist
                        (cm)</label>
                    <input type="number" formControlName="waistCm" id="waistCm" placeholder="Waist (cm)"
                        class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div>
                    <label for="hipsCm" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Hips
                        (cm)</label>
                    <input type="number" formControlName="hipsCm" id="hipsCm" placeholder="Hips (cm)"
                        class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div>
                    <label for="neckCm" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Neck
                        (cm)</label>
                    <input type="number" formControlName="neckCm" id="neckCm" placeholder="Neck (cm)"
                        class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div>
                    <label for="rightArmCm" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Right Arm
                        (cm)</label>
                    <input type="number" formControlName="rightArmCm" id="rightArmCm" placeholder="Right Arm (cm)"
                        class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                </div>
                <!-- <div>
                    <label for="leftArmCm" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Left Arm (cm)</label>
                    <input type="number" formControlName="leftArmCm" id="leftArmCm" placeholder="Left Arm (cm)"
                        class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                </div> -->
                <!-- <div>
                    <label for="rightLegCm" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Right Leg (cm)</label>
                    <input type="number" formControlName="rightLegCm" id="rightLegCm" placeholder="Right Leg (cm)"
                        class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div>
                    <label for="leftLegCm" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Left Leg (cm)</label>
                    <input type="number" formControlName="leftLegCm" id="leftLegCm" placeholder="Left Leg (cm)"
                        class="p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                </div> -->
            </div>
            <textarea formControlName="notes" placeholder="Notes..."
                class="w-full p-2 border rounded mb-4 h-24 dark:bg-gray-700 dark:border-gray-600"></textarea>
            <div class="flex justify-end gap-4 text-white">
                <button type="button" (click)="isAddEntryModalOpen = false" class="px-4 py-2 rounded flex items-center">
                    <app-icon name="cancel" class="h-6 w-6 text-white"></app-icon>
                    CANCEL</button>
                <button type="submit" [disabled]="entryForm.invalid"
                    class="px-4 py-2 bg-primary text-white rounded disabled:opacity-50 flex items-center">
                    <app-icon name="save" class="h-7 w-7 mr-1"></app-icon>SAVE</button>
            </div>
        </form>
    </div>
</div>

<!-- Comparison Modal -->
<div *ngIf="comparisonData"
    class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 animate-fade-in text-gray-800 dark:text-gray-200">
    <div
        class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-4 sm:p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">

        <!-- Header -->
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl sm:text-2xl font-bold">Side-by-Side Comparison</h2>
            <button (click)="comparisonData = null" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200">
                <app-icon name="cancel" class="h-6 w-6"></app-icon>
            </button>
        </div>

        <!-- Photo Comparison -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="text-center">
                <img [src]="comparisonData.from.photoUrl || './assets/images/no_data.png'" alt="Start photo"
                    class="w-full h-48 sm:h-64 object-cover rounded-md bg-gray-200 dark:bg-gray-700">
                <p class="mt-2 font-semibold text-sm">{{ comparisonData.from.date | date:'fullDate' }}</p>
            </div>
            <div class="text-center">
                <img [src]="comparisonData.to.photoUrl || './assets/images/no_data.png'" alt="End photo"
                    class="w-full h-48 sm:h-64 object-cover rounded-md bg-gray-200 dark:bg-gray-700">
                <p class="mt-2 font-semibold text-sm">{{ comparisonData.to.date | date:'fullDate' }}</p>
            </div>
        </div>

        <!-- Measurement Table -->
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
                <thead
                    class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400 rounded-lg">
                    <tr>
                        <th scope="col" class="px-4 py-3 rounded-l-lg">Metric</th>
                        <th scope="col" class="px-4 py-3 text-center">{{ comparisonData.from.date | date:'shortDate' }}
                        </th>
                        <th scope="col" class="px-4 py-3 text-center">{{ comparisonData.to.date | date:'shortDate' }}
                        </th>
                        <th scope="col" class="px-4 py-3 text-center rounded-r-lg">Change</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- [ngClass]="{
                                'text-green-500': row.difference !== null && row.difference > 0,
                                'text-red-500': row.difference !== null && row.difference < 0,
                                'text-gray-500': row.difference === 0 || row.difference === null
                            }" -->
                    <tr *ngFor="let row of comparisonData.rows" class="border-b dark:border-gray-700">
                        <th scope="row" class="px-4 py-4 font-medium whitespace-nowrap">{{ row.metricLabel }}</th>
                        <td class="px-4 py-4 text-center">{{ row.fromValue }} <span *ngIf="row.fromValue !== 'N/A'">{{
                                row.unit }}</span></td>
                        <td class="px-4 py-4 text-center">{{ row.toValue }} <span *ngIf="row.toValue !== 'N/A'">{{
                                row.unit }}</span></td>
                        <td class="px-4 py-4 text-center font-bold" [ngClass]="{
                                'text-yellow-500': row.difference !== null && row.difference !== null,
                                'text-gray-500': row.difference === 0 || row.difference === null
                            }">
                            <ng-container *ngIf="row.difference !== null">
                                {{ row.difference > 0 ? '+' : '' }}{{ row.difference }} {{ row.unit }}
                            </ng-container>
                            <ng-container *ngIf="row.difference === null">N/A</ng-container>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Close Button -->
        <div class="flex justify-end mt-6">
            <button (click)="comparisonData = null"
                class="px-5 py-2.5 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-700 text-sm font-medium flex items-center">
                <app-icon name="cancel"></app-icon>
                CLOSE</button>
        </div>
    </div>
</div>
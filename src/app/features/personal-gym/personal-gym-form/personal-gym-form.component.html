<div class="container mx-auto max-w-2xl p-4 sm:p-6">
  <header class="mb-6 flex items-center">
    <button [routerLink]="['/personal-gym']" class="text-gray-600 dark:text-gray-300 hover:text-primary p-2 -ml-2">
      <app-icon name="back" class="w-6 h-6"></app-icon>
    </button>
    <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-200 ml-4">{{ pageTitle() }}</h1>
  </header>

  <form [formGroup]="equipmentForm" (ngSubmit)="onSubmit()"
    class="space-y-6 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <label for="category" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ 'personalGym.form.categoryLabel' | translate }}</label>
        <select id="category" formControlName="category"
          class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 text-lg dark:text-gray-200">
          <option [ngValue]="null" disabled>{{ 'personalGym.form.categoryPlaceholder' | translate }}</option>
          <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
        </select>
      </div>
      <div>
        <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ 'personalGym.form.nameLabel' | translate }}</label>
        <input type="text" id="name" formControlName="name"
          class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 text-lg dark:text-gray-200"
          [placeholder]="'personalGym.form.namePlaceholder' | translate">
      </div>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label for="quantity" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ 'personalGym.form.quantityLabel' | translate }}</label>
        <input type="number" id="quantity" formControlName="quantity"
          class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 text-lg dark:text-gray-200">
      </div>
      <div>
        <label for="brand" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ 'personalGym.form.brandLabel' | translate }}</label>
        <input type="text" id="brand" formControlName="brand"
          class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 text-lg dark:text-gray-200">
      </div>
    </div>

    <!-- DYNAMIC FIELDS SECTION -->
    <ng-container [ngSwitch]="equipmentForm.get('category')?.value">

      <!-- Dumbbell, Kettlebell, Macebell, Club -->
      <ng-container
        *ngIf="['Dumbbell', 'Kettlebell', 'Macebell', 'Club'].includes(equipmentForm.get('category')?.value)">
        <div class="space-y-4 pt-4 border-t dark:border-gray-600">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ 'personalGym.form.weightTypeLabel' | translate }}</label>
          <div class="flex space-x-4">
            <label *ngFor="let wt of weightTypes" class="flex items-center">
              <input type="radio" [value]="wt" formControlName="weightType" class="form-radio">
              <span class="text-gray-700 dark:text-gray-300 ml-2">{{ 'personalGym.form.weightTypes.' + wt | translate }}</span>
            </label>
          </div>

          <div *ngIf="equipmentForm.get('weightType')?.value === 'fixed'">
            <label for="weight" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ 'personalGym.form.weightLabel' | translate }} ({{unitService.getWeightUnitSuffix()}})</label>
            <input type="number" id="weight" formControlName="weight"
              class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 text-lg dark:text-gray-200">
          </div>

          <div *ngIf="equipmentForm.get('weightType')?.value === 'adjustable'" class="grid grid-cols-3 gap-4">
            <div>
              <label for="minweight" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ 'personalGym.form.minWeightLabel' | translate }} ({{unitService.getWeightUnitSuffix()}})</label>
              <input type="number" id="minweight" formControlName="minweight"
                class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 text-lg dark:text-gray-200">
            </div>
            <div>
              <label for="maxweight" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ 'personalGym.form.maxWeightLabel' | translate }} ({{unitService.getWeightUnitSuffix()}})</label>
              <input type="number" id="maxweight" formControlName="maxweight"
                class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 text-lg dark:text-gray-200">
            </div>
            <div>
              <label for="increment" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ 'personalGym.form.stepLabel' | translate }} ({{unitService.getWeightUnitSuffix()}})</label>
              <input type="number" id="increment" formControlName="increment"
                class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 text-lg dark:text-gray-200">
            </div>
          </div>
        </div>
      </ng-container>

      <ng-container *ngSwitchCase="'Plate'">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-6 pt-4 border-t dark:border-gray-600">
          <div>
            <label for="weight" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ 'personalGym.form.weightLabel' | translate }} ({{unitService.getWeightUnitSuffix()}})</label>
            <input type="number" id="weight" formControlName="weight"
              class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 text-lg dark:text-gray-200">
          </div>
          <div class="flex items-center justify-between sm:mt-7">
            <label for="isOlympic" class="text-sm font-medium text-gray-700 dark:text-gray-300">{{ 'personalGym.form.isOlympicLabel' | translate }}</label>
            <label class="toggle-switch">
              <input type="checkbox" id="isOlympic" formControlName="isOlympic">
              <span class="slider round"></span>
            </label>
          </div>
          <div>
            <label for="color" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
              {{ 'personalGym.form.colorLabel' | translate }}
              <span *ngIf="equipmentForm.get('isOlympic')?.value" class="text-xs text-gray-500">{{ 'personalGym.form.colorAutomatic' | translate }}</span>
              <span *ngIf="!equipmentForm.get('isOlympic')?.value" class="text-xs text-gray-500">{{ 'personalGym.form.colorCustom' | translate }}</span>
            </label>
            <div class="flex items-center space-x-2 mt-1">
              <input type="color" formControlName="color"
                class="h-10 w-12 p-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm dark:bg-gray-600">
              <input type="text" id="color" formControlName="color"
                class="block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 text-lg dark:text-gray-200">
            </div>
          </div>
        </div>
      </ng-container>

      <ng-container *ngSwitchCase="'Barbell'">
        <div class="grid grid-cols-2 gap-4 pt-4 border-t dark:border-gray-600">
          <div>
            <label for="weight" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ 'personalGym.form.barWeightLabel' | translate }} ({{unitService.getWeightUnitSuffix()}})</label>
            <input type="number" id="weight" formControlName="weight"
              class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 text-lg dark:text-gray-200">
          </div>
          <div>
            <label for="barType" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ 'personalGym.form.barTypeLabel' | translate }}</label>
            <select id="barType" formControlName="barType"
              class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 text-lg dark:text-gray-200">
              <option *ngFor="let bt of barTypes" [value]="bt">{{ 'personalGym.form.barTypes.' + bt | translate }}</option>
            </select>
          </div>
        </div>
      </ng-container>

      <ng-container *ngSwitchCase="'Band'">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-4 border-t dark:border-gray-600">
          <div>
            <label for="bandType" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ 'personalGym.form.bandTypeLabel' | translate }}</label>
            <select id="bandType" formControlName="bandType"
              class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 text-lg dark:text-gray-200">
              <option *ngFor="let bt of bandTypes" [value]="bt">{{ 'personalGym.form.bandTypes.' + bt | translate }}</option>
            </select>
          </div>
          <div>
            <label for="resistanceLevel" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ 'personalGym.form.resistanceLevelLabel' | translate }}</label>
            <select id="resistanceLevel" formControlName="resistanceLevel"
              class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 text-lg dark:text-gray-200">
              <option *ngFor="let level of resistanceLevels" [value]="level">{{ 'personalGym.form.resistanceLevels.' + level | translate }}</option>
            </select>
          </div>
          <div>
            <label for="resistance" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ 'personalGym.form.resistanceLabel' | translate }} ({{unitService.getWeightUnitSuffix()}})</label>
            <input type="number" id="resistance" formControlName="resistance"
              class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 text-lg dark:text-gray-200">
          </div>
          <div>
            <label for="color" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ 'personalGym.form.colorLabel' | translate }} (Optional)</label>
            <input type="text" id="color" formControlName="color"
              class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 text-lg dark:text-gray-200">
          </div>
          <div>
            <label for="length" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ 'personalGym.form.lengthLabel' | translate }} ({{unitService.getMeasureUnitSuffix()}})</label>
            <input type="number" id="length" formControlName="length"
              class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 text-lg dark:text-gray-200">
          </div>
        </div>
      </ng-container>

      <ng-container *ngSwitchCase="'Machine'">
        <div class="grid grid-cols-2 gap-4 pt-4 border-t dark:border-gray-600">
          <div>
            <label for="loadType" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ 'personalGym.form.loadTypeLabel' | translate }}</label>
            <select id="loadType" formControlName="loadType"
              class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 text-lg dark:text-gray-200">
              <option *ngFor="let lt of machineLoadTypes" [value]="lt">{{ 'personalGym.form.machineLoadTypes.' + lt | translate }}</option>
            </select>
          </div>
          <div>
            <label for="maxLoad" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ 'personalGym.form.maxLoadLabel' | translate }} ({{unitService.getWeightUnitSuffix()}})</label>
            <input type="number" id="maxLoad" formControlName="maxLoad"
              class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 text-lg dark:text-gray-200">
          </div>
        </div>
      </ng-container>

      <ng-container *ngSwitchCase="'Custom'">
        <div class="space-y-4 pt-4 border-t dark:border-gray-600">
          <div>
            <label for="customCategoryName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ 'personalGym.form.customTypeLabel' | translate }}</label>
            <input type="text" id="customCategoryName" formControlName="customCategoryName"
              class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 text-lg dark:text-gray-200"
              [placeholder]="'personalGym.form.customTypePlaceholder' | translate">
          </div>
          <div formArrayName="properties" class="space-y-3">
            <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300">{{ 'personalGym.form.customPropsLabel' | translate }}</h3>
            <div *ngFor="let prop of customProperties.controls; let i = index" [formGroupName]="i"
              class="flex items-center space-x-2">
              <input type="text" formControlName="key" class="input-field flex-1" [placeholder]="'personalGym.form.propKeyPlaceholder' | translate">
              <input type="text" formControlName="value" class="input-field flex-1"
                [placeholder]="('personalGym.form.propValuePlaceholder' | translate) + ' ' + unitService.getWeightUnitSuffix()">
              <button type="button" (click)="removeCustomProperty(i)"
                class="p-2 text-red-500 hover:bg-red-100 rounded-full">
                <app-icon name="trash" class="w-5 h-5"></app-icon>
              </button>
            </div>
            <button type="button" (click)="addCustomProperty()" class="text-sm text-primary hover:underline">{{ 'personalGym.form.addProperty' | translate }}</button>
          </div>
        </div>
      </ng-container>
    </ng-container>

    <!-- Notes -->
    <div>
      <label for="notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ 'personalGym.form.notesLabel' | translate }}</label>
      <textarea id="notes" formControlName="notes" rows="3"
        class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-600 text-lg dark:text-gray-200"></textarea>
    </div>

    <!-- Submit Button -->
    <div class="pt-4 border-t border-gray-200 dark:border-gray-600 flex justify-end">
      <button type="submit" [disabled]="equipmentForm.invalid"
        class="flex items-center bg-primary text-white hover:bg-primary-dark font-semibold py-2 px-4 rounded-md disabled:opacity-50">
        <app-icon name="save" class="h-6 w-6 mr-1"></app-icon>
        {{ (isEditMode() ? 'personalGym.form.saveChanges' : 'personalGym.form.addToGym') | translate }}
      </button>
    </div>
  </form>
</div>
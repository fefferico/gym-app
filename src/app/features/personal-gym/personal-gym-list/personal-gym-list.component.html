<div class="container mx-auto p-2 sm:p-4">
  <header class="flex justify-between items-center pb-2">
    <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-200">{{ 'personalGym.list.title' | translate }}</h1>
    <button (click)="toggleFiltersVisibility()" type="button"
      class="rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary dark:focus:ring-primary-light transition-all duration-300 ease-in-out">
      <app-icon name="filter" class="w-10 h-10 transition-transform duration-300"
        [class.rotate-180]="filtersVisible() === true"></app-icon>
    </button>
  </header>

  <!-- 
    NEW: Collapsible container for the filters.
    This div wraps the original filter section and controls its visibility and animation.
  -->
  <div class="overflow-hidden transition-all duration-500 ease-in-out"
    [style.maxHeight]="filtersVisible() ? '1000px' : '0px'" [class.mb-6]="filtersVisible()">
    <!-- The original filter section is now inside the collapsible div -->
    <section class="p-4 bg-white dark:bg-gray-700 rounded-md shadow-md border dark:border-gray-600 mt-2">
      <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">{{ 'routineList.filters.title' | translate }}</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <input type="text" id="search-term" [placeholder]="'personalGym.list.searchPlaceholder' | translate" [value]="searchTerm()"
          (input)="onSearchChange($event)"
          class="block w-full p-2 border rounded-md dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200">

        <select id="category-filter" (change)="onCategoryChange($event)" [value]="selectedCategory() || ''"
          class="block w-full p-2 border rounded-md dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200">
          <option value="">{{ 'personalGym.list.allCategories' | translate }}</option>
          <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
        </select>

        <button (click)="clearFilters()"
          class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 inline-flex items-center justify-center">
          <app-icon name="trash" class="h-6 w-6 mr-1"></app-icon>
          {{ 'personalGym.list.clearFilters' | translate }}
        </button>
      </div>
    </section>
  </div>

  <!-- Equipment List -->
  <div *ngIf="allEquipment().length > 0; else noEquipmentState">
    <div *ngIf="filteredEquipment().length > 0; else noFilterResultsState"
      class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <div *ngFor="let item of filteredEquipment(); trackBy: trackById" (click)="navigateToForm(item.id)"
        class="bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer p-4 flex flex-col justify-between relative">
        <div>
          <h2 class="text-lg font-bold text-primary dark:text-primary-light">{{ item.name }}</h2>
          <p class="text-sm text-gray-500 dark:text-gray-400">
            {{ isCustom(item) ? item.customCategoryName : item.category }}
          </p>
          <div class="text-sm text-gray-600 dark:text-gray-300 mt-2">
            <p><strong>{{ 'personalGym.list.quantity' | translate }}:</strong> {{ item.quantity }}</p>

            <div *ngIf="isFixedWeight(item)">
              <p><strong>{{ 'personalGym.list.weight' | translate }}:</strong> {{ item.weight }}
                {{unitService.getWeightUnitSuffix()}}</p>
            </div>
            <div *ngIf="isAdjustableWeight(item)">
              <p><strong>{{ 'personalGym.list.range' | translate }}:</strong> {{ item.minweight }} - {{ item.maxweight
                }} {{unitService.getWeightUnitSuffix()}}</p>
            </div>
            <div *ngIf="isWeightPlate(item)">
              <p><strong>{{ 'personalGym.list.weight' | translate }}:</strong> {{ item.weight }}
                {{unitService.getWeightUnitSuffix()}}</p>
            </div>
            <div *ngIf="isBand(item)">
              <p><strong>{{ 'personalGym.list.type' | translate }}:</strong> {{ item.bandType }}</p>
            </div>
            <div *ngIf="isCustom(item)">
              <div *ngFor="let prop of item.properties">
                <p><strong>{{ prop.key }}:</strong> {{ prop.value }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Wrapper for "More Actions" button and its dropdown -->
        <div class="absolute top-2 right-2">
          <div class="relative">
            <button (click)="toggleActions(item.id, $event)"
              class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-500 rounded-full focus:outline-none flex items-center">
              <app-icon name="menu-action" class="h-10 w-10"></app-icon>
            </button>
            <app-action-menu *ngIf="areActionsVisible(item.id) && (menuModeDropdown || menuModeModal)" [modalTitle]="''"
              class="action-menu-container" [displayMode]="menuModeDropdown ? 'dropdown' : 'modal'"
              [gridClass]="' grid grid-cols-2 '"
              [items]="getGymActionItems(item.id, menuModeDropdown ? 'dropdown' : 'modal')"
              [isVisible]="areActionsVisible(item.id)" (itemClick)="handleActionMenuItemClick($event)"
              (closeMenu)="onCloseActionMenu()">
            </app-action-menu>
          </div>
        </div>

        <app-action-menu *ngIf="areActionsVisible(item.id) && menuModeCompact" displayMode="compact"
          [items]="getGymActionItems(item.id, 'compact')" [isVisible]="areActionsVisible(item.id)"
          (itemClick)="handleActionMenuItemClick($event)" (closeMenu)="onCloseActionMenu()">
        </app-action-menu>
      </div>
    </div>
  </div>

  <!-- Template for when no equipment exists at all -->
  <ng-template #noEquipmentState>
    <div class="text-center py-12 px-6 bg-white dark:bg-gray-700 rounded-md shadow-md justify-center">
      <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300">{{ 'personalGym.list.noEquipmentTitle' |
        translate }}</h3>
      <p class="text-gray-500 dark:text-gray-400 mt-2 mb-6">{{ 'personalGym.list.noEquipmentMessage' | translate }}</p>
      <button (click)="navigateToForm()"
        class="bg-primary hover:bg-primary-dark text-white font-semibold py-2 px-6 rounded-md inline-flex items-center">
        <app-icon name="plus-circle" class="w-6 h-6 mr-1"></app-icon>
        {{ 'personalGym.list.addFirstItem' | translate }}
      </button>
    </div>
  </ng-template>

  <!-- Template for when filters yield no results -->
  <ng-template #noFilterResultsState>
    <div class="text-center py-12 px-6 bg-white dark:bg-gray-700 rounded-md shadow-md">
      <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300">{{ 'personalGym.list.noMatchTitle' | translate
        }}</h3>
      <p class="text-gray-500 dark:text-gray-400 mt-2">{{ 'personalGym.list.noMatchMessage' | translate }}</p>
    </div>
  </ng-template>
</div>

<app-fab-menu [actions]="fabMenuItems" (actionClicked)="onFabAction($event)"></app-fab-menu>

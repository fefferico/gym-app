import{a as L}from"./chunk-APSF4EBJ.js";import{Ac as _,D as I,Ec as j,Fc as M,H as b,L as A,P as v,a as u,ac as p,b as g,g as m,k as T,o as S,q as R,r as h,s as O,xc as w,yc as k,zc as E}from"./chunk-P7HT3SPI.js";function D(y,e){return j(y,e?.in).getDay()}var $=class y{storageService=v(k);workoutService=v(E);alertService=v(w);toastService=v(_);PROGRAMS_STORAGE_KEY="fitTrackPro_trainingPrograms";programsSubject=new T(this._loadProgramsFromStorage());programs$=this.programsSubject.asObservable();constructor(){}_loadProgramsFromStorage(){let e=this.storageService.getItem(this.PROGRAMS_STORAGE_KEY);return e||[]}_saveProgramsToStorage(e){this.storageService.setItem(this.PROGRAMS_STORAGE_KEY,e),this.programsSubject.next([...e])}getAllPrograms(){return this.programs$}getProgramById(e){return this.programs$.pipe(h(r=>r.find(t=>t.id===e)))}addProgram(e){return m(this,null,function*(){let r=this.programsSubject.getValue(),t=g(u({},e),{id:p(),isActive:!1,schedule:e.schedule.map(a=>g(u({},a),{id:p()}))}),o=[...r,t];return this._saveProgramsToStorage(o),this.toastService.success(`Program "${t.name}" created.`,3e3,"Program Created"),t})}updateProgram(e){return m(this,null,function*(){let r=this.programsSubject.getValue(),t=r.findIndex(o=>o.id===e.id);if(t>-1){let o=e.schedule.map(n=>g(u({},n),{id:n.id||p()})),a=g(u({},e),{schedule:o}),i=[...r];return i[t]=a,a.isActive&&(i=i.map(n=>n.id===a.id?n:g(u({},n),{isActive:!1}))),this._saveProgramsToStorage(i),this.toastService.success(`Program "${a.name}" updated.`,3e3,"Program Updated"),a}this.toastService.error(`Program with ID ${e.id} not found.`,0,"Update Error")})}deleteProgram(e){return m(this,null,function*(){let r=yield R(this.getProgramById(e).pipe(I(1)));if(!r){this.toastService.error("Program not found.",0,"Delete Error");return}let t=yield this.alertService.showConfirm("Delete Program",`Are you sure you want to delete the program "${r.name}"? This action cannot be undone.`,"Delete");if(t&&t.data){let a=this.programsSubject.getValue().filter(i=>i.id!==e);this._saveProgramsToStorage(a),this.toastService.info(`Program "${r.name}" deleted.`,3e3,"Program Deleted")}})}setActiveProgram(e){return m(this,null,function*(){let r=this.programsSubject.getValue(),t=r.find(a=>a.id===e);if(!t){this.toastService.error("Program not found to activate.",0,"Activation Error");return}let o=r.map(a=>g(u({},a),{isActive:a.id===e}));this._saveProgramsToStorage(o),this.toastService.success(`Program "${t.name}" is now active.`,3e3,"Program Activated")})}deactivateAllPrograms(){return m(this,null,function*(){let e=this.programsSubject.getValue();if(e.length>0){let r=e.map(t=>g(u({},t),{isActive:!1}));this._saveProgramsToStorage(r)}})}deactivateProgram(e){return m(this,null,function*(){let r=this.programsSubject.getValue(),t=r.find(a=>a.id===e);if(!t){this.toastService.error("Program not found to deactivate.",0,"Deactivation Error");return}if(!t.isActive){this.toastService.info(`Program "${t.name}" is already inactive.`,3e3,"Already Inactive");return}let o=r.map(a=>a.id===e?g(u({},a),{isActive:!1}):a);this._saveProgramsToStorage(o),this.toastService.info(`Program "${t.name}" has been deactivated.`,3e3,"Program Deactivated")})}getActiveProgram(){return this.programs$.pipe(h(e=>e.find(r=>r.isActive)))}getRoutineForDay(e){return this.getActiveProgram().pipe(b(r=>{if(!r)return S(null);let t;if(r.cycleLength&&r.cycleLength>0&&r.startDate){let a=new Date(r.startDate),i=Math.abs(e.getTime()-a.getTime()),l=Math.floor(i/(1e3*60*60*24))%r.cycleLength+1;t=s=>s.dayOfWeek===l}else{let a=D(e);t=i=>i.dayOfWeek===a}let o=r.schedule.find(t);return o?this.workoutService.getRoutineById(o.routineId).pipe(h(a=>a?{routine:a,scheduledDayInfo:o}:(console.warn(`Routine with ID ${o.routineId} not found for scheduled day.`),null))):S(null)}))}getScheduledRoutinesForDateRange(e,r){return this.getActiveProgram().pipe(b(t=>{if(!t||!t.schedule||t.schedule.length===0)return S([]);let o=[],a=new Date(e);for(;a<=r;){let i,n=new Date(a);if(t.cycleLength&&t.cycleLength>0&&t.startDate){let s=new Date(t.startDate),c=Math.abs(n.getTime()-s.getTime()),d=n>=s?Math.floor(c/(1e3*60*60*24)):-1;if(d>=0){let f=d%t.cycleLength+1;i=P=>P.dayOfWeek===f}else i=()=>!1}else{let s=D(n);i=c=>c.dayOfWeek===s}let l=t.schedule.find(i);l&&o.push(this.workoutService.getRoutineById(l.routineId).pipe(h(s=>s?{date:n,routine:s,scheduledDayInfo:l}:null))),a.setDate(a.getDate()+1)}return o.length===0?S([]):O(o).pipe(h(i=>i.filter(n=>n!==null)))}))}getScheduledRoutinesForDateRangeByProgramId(e,r,t){return this.getProgramById(e).pipe(h(o=>{if(!o||!o.schedule||o.schedule.length===0)return[];let a=L({start:r,end:t}),i=[],n=o.cycleLength&&o.cycleLength>0?o.cycleLength:7,l=o.startDate?M(o.startDate):new Date(1970,0,1),s=new Map;return o.schedule.forEach(c=>{let d=c.dayOfWeek%n;s.has(d)||s.set(d,[]),s.get(d).push(c)}),a.forEach(c=>{if(!(c<l))if(n===7){let d=D(c);s.has(d)&&s.get(d).forEach(f=>{i.push({date:c,scheduledDayInfo:f})})}else{let f=Math.floor((c.getTime()-l.getTime())/864e5)%n;s.has(f)&&s.get(f).forEach(P=>{i.push({date:c,scheduledDayInfo:P})})}}),i}))}static \u0275fac=function(r){return new(r||y)};static \u0275prov=A({token:y,factory:y.\u0275fac,providedIn:"root"})};export{$ as a};

import{G as A,K as h,Sb as k,a as l,b as f,d as g,h as w,k as B,mc as y,n as d,nc as I,oc as W,rc as L,sc as T,tc as x,uc as P,y as D}from"./chunk-MAKRABO3.js";function v(n,e){let t=()=>x(e?.in,NaN),r=e?.additionalDigits??2,s=$(n),i;if(s.date){let u=_(s.date,r);i=M(u.restDateString,u.year)}if(!i||isNaN(+i))return t();let o=+i,a=0,c;if(s.time&&(a=F(s.time),isNaN(a)))return t();if(s.timezone){if(c=j(s.timezone),isNaN(c))return t()}else{let u=new Date(o+a),S=P(0,e?.in);return S.setFullYear(u.getUTCFullYear(),u.getUTCMonth(),u.getUTCDate()),S.setHours(u.getUTCHours(),u.getUTCMinutes(),u.getUTCSeconds(),u.getUTCMilliseconds()),S}return P(o+a+c,e?.in)}var m={dateTimeDelimiter:/[T ]/,timeZoneDelimiter:/[Z ]/i,timezone:/([Z+-].*)$/},E=/^-?(?:(\d{3})|(\d{2})(?:-?(\d{2}))?|W(\d{2})(?:-?(\d{1}))?|)$/,U=/^(\d{2}(?:[.,]\d*)?)(?::?(\d{2}(?:[.,]\d*)?))?(?::?(\d{2}(?:[.,]\d*)?))?$/,N=/^([+-])(\d{2})(?::?(\d{2}))?$/;function $(n){let e={},t=n.split(m.dateTimeDelimiter),r;if(t.length>2)return e;if(/:/.test(t[0])?r=t[0]:(e.date=t[0],r=t[1],m.timeZoneDelimiter.test(e.date)&&(e.date=n.split(m.timeZoneDelimiter)[0],r=n.substr(e.date.length,n.length))),r){let s=m.timezone.exec(r);s?(e.time=r.replace(s[1],""),e.timezone=s[1]):e.time=r}return e}function _(n,e){let t=new RegExp("^(?:(\\d{4}|[+-]\\d{"+(4+e)+"})|(\\d{2}|[+-]\\d{"+(2+e)+"})$)"),r=n.match(t);if(!r)return{year:NaN,restDateString:""};let s=r[1]?parseInt(r[1]):null,i=r[2]?parseInt(r[2]):null;return{year:i===null?s:i*100,restDateString:n.slice((r[1]||r[2]).length)}}function M(n,e){if(e===null)return new Date(NaN);let t=n.match(E);if(!t)return new Date(NaN);let r=!!t[4],s=p(t[1]),i=p(t[2])-1,o=p(t[3]),a=p(t[4]),c=p(t[5])-1;if(r)return G(e,a,c)?C(e,a,c):new Date(NaN);{let u=new Date(0);return!V(e,i,o)||!K(e,s)?new Date(NaN):(u.setUTCFullYear(e,i,Math.max(s,o)),u)}}function p(n){return n?parseInt(n):1}function F(n){let e=n.match(U);if(!e)return NaN;let t=b(e[1]),r=b(e[2]),s=b(e[3]);return z(t,r,s)?t*T+r*L+s*1e3:NaN}function b(n){return n&&parseFloat(n.replace(",","."))||0}function j(n){if(n==="Z")return 0;let e=n.match(N);if(!e)return 0;let t=e[1]==="+"?-1:1,r=parseInt(e[2]),s=e[3]&&parseInt(e[3])||0;return H(r,s)?t*(r*T+s*L):NaN}function C(n,e,t){let r=new Date(0);r.setUTCFullYear(n,0,4);let s=r.getUTCDay()||7,i=(e-1)*7+t+1-s;return r.setUTCDate(r.getUTCDate()+i),r}var Y=[31,null,31,30,31,30,31,31,30,31,30,31];function O(n){return n%400===0||n%4===0&&n%100!==0}function V(n,e,t){return e>=0&&e<=11&&t>=1&&t<=(Y[e]||(O(n)?29:28))}function K(n,e){return e>=1&&e<=(O(n)?366:365)}function G(n,e,t){return e>=1&&e<=53&&t>=0&&t<=6}function z(n,e,t){return n===24?e===0&&t===0:t>=0&&t<60&&e>=0&&e<60&&n>=0&&n<25}function H(n,e){return e>=0&&e<=59}var R=class n{storageService=h(I);alertService=h(y);workoutService=h(W);WORKOUT_LOGS_STORAGE_KEY="fitTrackPro_workoutLogs";PERSONAL_BESTS_STORAGE_KEY="fitTrackPro_personalBests";workoutLogsSubject=new w(this.loadWorkoutLogsFromStorage());workoutLogs$=this.workoutLogsSubject.asObservable();personalBestsSubject=new w(this.loadPBsFromStorage());personalBests$=this.personalBestsSubject.asObservable();constructor(){}loadWorkoutLogsFromStorage(){let e=this.storageService.getItem(this.WORKOUT_LOGS_STORAGE_KEY);return e?e.sort((t,r)=>new Date(r.date).getTime()-new Date(t.date).getTime()):[]}saveWorkoutLogsToStorage(e){this.storageService.setItem(this.WORKOUT_LOGS_STORAGE_KEY,e),this.workoutLogsSubject.next([...e].sort((t,r)=>new Date(r.date).getTime()-new Date(t.date).getTime()))}addWorkoutLog(e){let t=k(),r=this.workoutLogsSubject.getValue(),s=e.exercises.map(a=>f(l({},a),{workoutLogId:t,sets:a.sets.map(c=>f(l({},c),{id:c.id??k(),workoutLogId:t}))})),i=f(l({},e),{exercises:s,id:t,date:new Date(e.startTime).toISOString().split("T")[0]});i.startTime&&i.endTime&&!i.durationMinutes&&(i.durationMinutes=Math.round((i.endTime-i.startTime)/(1e3*60)));let o=[i,...r];return this.saveWorkoutLogsToStorage(o),this.updateAllPersonalBestsFromLog(i),console.log("Added workout log:",i),i}getWorkoutLogById(e){return this.workoutLogs$.pipe(d(t=>t.find(r=>r.id===e)))}clearAllWorkoutLogs_DEV_ONLY(){return this.alertService.showConfirm("Info","DEVELOPMENT: Are you sure you want to delete ALL workout logs? This cannot be undone.").then(e=>g(this,null,function*(){e&&e.data&&(this.saveWorkoutLogsToStorage([]),yield this.alertService.showAlert("Info","All workout logs cleared!"))}))}getLastPerformanceForExercise(e){return this.workoutLogs$.pipe(d(t=>{for(let r of t){let s=r.exercises.find(i=>i.exerciseId===e);if(s&&s.sets.length>0)return{lastPerformedDate:r.date,workoutLogId:r.id,sets:[...s.sets]}}return null}))}findPreviousSetPerformance(e,t,r){return!e||!e.sets||e.sets.length===0?null:r<e.sets.length?e.sets[r]:null}loadPBsFromStorage(){return this.storageService.getItem(this.PERSONAL_BESTS_STORAGE_KEY)||{}}savePBsToStorage(e){this.storageService.setItem(this.PERSONAL_BESTS_STORAGE_KEY,e),this.personalBestsSubject.next(l({},e))}updateAllPersonalBestsFromLog(e){let t=l({},this.personalBestsSubject.getValue());e.exercises.forEach(r=>{t[r.exerciseId]||(t[r.exerciseId]=[]);let s=t[r.exerciseId],i=r.workoutLogId||e.id;r.sets.forEach(o=>{if(o.weightUsed===void 0||o.weightUsed===null||o.weightUsed===0){o.repsAchieved>0&&this.updateSpecificPB(s,o,"Max Reps (Bodyweight)"),o.durationPerformed&&o.durationPerformed>0&&this.updateSpecificPB(s,o,"Max Duration");return}if(o.repsAchieved===1&&this.updateSpecificPB(s,o,"1RM (Actual)"),o.repsAchieved===3&&this.updateSpecificPB(s,o,"3RM (Actual)"),o.repsAchieved===5&&this.updateSpecificPB(s,o,"5RM (Actual)"),this.updateSpecificPB(s,o,"Heaviest Lifted"),o.repsAchieved>1){let a=o.weightUsed*(1+o.repsAchieved/30),c=f(l({},o),{repsAchieved:1,weightUsed:parseFloat(a.toFixed(2))});this.updateSpecificPB(s,c,"1RM (Estimated)")}}),t[r.exerciseId]=s.sort((o,a)=>(a.weightUsed??0)-(o.weightUsed??0))}),this.savePBsToStorage(t),console.log("Personal Bests updated:",t)}updateSpecificPB(e,t,r){let s=f(l({},t),{pbType:r,workoutLogId:t.workoutLogId}),i=e.findIndex(a=>a.pbType===r),o=!1;if(i>-1){let a=e[i];r.includes("Max Reps")?(t.repsAchieved>a.repsAchieved||t.repsAchieved===a.repsAchieved&&(t.weightUsed??-1)>(a.weightUsed??-1))&&(o=!0):r.includes("Max Duration")?(t.durationPerformed??0)>(a.durationPerformed??0)&&(o=!0):(t.weightUsed??-1)>(a.weightUsed??-1)&&(o=!0),o&&(e[i]=s)}else o=!0,e.push(s)}getPersonalBestForExerciseByType(e,t){return this.personalBests$.pipe(d(r=>r[e]?.find(i=>i.pbType===t)||null))}getAllPersonalBestsForExercise(e){return this.personalBests$.pipe(d(t=>t[e]||[]))}getAllPersonalWorkouts(){return this.workoutLogs$}clearAllPersonalBests_DEV_ONLY(){return this.alertService.showConfirm("Info","DEVELOPMENT: Are you sure you want to delete ALL personal bests? This cannot be undone.").then(e=>g(this,null,function*(){e&&e.data&&(this.savePBsToStorage({}),yield this.alertService.showAlert("Info","All personal bests cleared!"))}))}getExercisePerformanceHistory(e){return this.workoutLogs$.pipe(d(t=>{let r=[];return t.filter(i=>i.exercises.some(o=>o.exerciseId===e)).sort((i,o)=>v(i.date).getTime()-v(o.date).getTime()).forEach(i=>{let o,a;i.exercises.forEach(c=>{c.exerciseId===e&&c.sets.forEach(u=>{u.weightUsed!==void 0&&u.weightUsed!==null&&(o===void 0||u.weightUsed>o?(o=u.weightUsed,a=u.repsAchieved):u.weightUsed===o&&(a===void 0||u.repsAchieved>a)&&(a=u.repsAchieved))})}),o!==void 0&&r.push({date:v(i.date),value:o,reps:a,logId:i.id})}),r}))}getLogsForBackup(){return this.workoutLogsSubject.getValue()}getPBsForBackup(){return this.personalBestsSubject.getValue()}replaceLogs(e){if(!Array.isArray(e)){console.error("TrackingService: Imported data for logs is not an array.");return}this.saveWorkoutLogsToStorage(e),console.log("TrackingService: Logs replaced with imported data.")}replacePBs(e){if(typeof e!="object"||e===null||Array.isArray(e)){console.error("TrackingService: Imported data for PBs is not an object.");return}this.savePBsToStorage(e),console.log("TrackingService: PBs replaced with imported data.")}getWorkoutLogsByRoutineId(e){return e?this.workoutLogs$.pipe(d(t=>t.filter(r=>r.routineId===e))):B([])}clearWorkoutLogsByRoutineId(e){return g(this,null,function*(){if(!e)return console.warn("TrackingService: clearWorkoutLogsByRoutineId called with no routineId."),this.alertService.showAlert("Warning","No routine ID provided to clear logs."),!1;let t=this.workoutLogsSubject.getValue(),r=t.filter(o=>o.routineId!==e),s=t.length-r.length,i="";if(this.workoutService.getRoutineById(e).pipe(D(1),d(o=>o?.name||"")).subscribe(o=>{i=o}),s===0)return this.alertService.showConfirm("Info","Are you sure you want to delete this routine? This action cannot be undone.").then(o=>(console.log(o),o&&o.data?(this.workoutService.deleteRoutine(e),this.alertService.showAlert("Info",`Routine "${i}" deleted successfully!`),!0):!1)),!1;{let o=yield this.alertService.showConfirm("Confirm Deletion",`Are you sure you want to delete this routine? There are ${s} workout log(s) associated with this routine: if you confirm you'll delete the routine and loose your previously logged workouts. This action cannot be undone.`);return o&&o.data?(this.saveWorkoutLogsToStorage(r),this.workoutService.deleteRoutine(e),this.alertService.showAlert("Success",`${s} workout log(s) for the routine have been cleared and the routine itself (${i}) it's been deleted.`),console.log(`Cleared ${s} logs for routineId: ${e}`),!0):!1}})}updateWorkoutLog(e){return g(this,null,function*(){if(!e||!e.id)throw console.error("TrackingService: updateWorkoutLog called with invalid data or missing ID."),new Error("Invalid log data for update.");let t=this.workoutLogsSubject.getValue(),r=t.findIndex(s=>s.id===e.id);if(r>-1){let s=[...t];s[r]=l({},e),this.saveWorkoutLogsToStorage(s),this.updateAllPersonalBestsFromLog(e),console.log("Updated workout log:",e)}else throw console.error(`TrackingService: WorkoutLog with ID ${e.id} not found for update.`),new Error(`WorkoutLog with ID ${e.id} not found.`)})}handleExerciseDeletion(e){return g(this,null,function*(){console.log(`Handling deletion repercussions for exercise ID: ${e}`);let t=this.workoutLogsSubject.getValue(),r=!1,s=t.map(o=>{let a=o.exercises.length,c=o.exercises.filter(u=>u.exerciseId!==e);return c.length<a?(r=!0,c.length===0?(console.log(`Workout log ${o.id} will be deleted as it becomes empty after removing exercise ${e}.`),null):f(l({},o),{exercises:c})):o}).filter(o=>o!==null);r&&(console.log("Some workout logs were modified or deleted due to exercise deletion."),this.saveWorkoutLogsToStorage(s));let i=this.personalBestsSubject.getValue();if(i[e]){let o=l({},i);delete o[e],this.savePBsToStorage(o),console.log(`Personal bests cleared for deleted exercise ID: ${e}`)}})}static \u0275fac=function(t){return new(t||n)};static \u0275prov=A({token:n,factory:n.\u0275fac,providedIn:"root"})};export{v as a,R as b};
